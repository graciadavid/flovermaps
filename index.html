<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Flovermaps ‚Äì Planta una flor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Google Fonts: Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { margin:0; font-family:'Poppins',sans-serif; background:#fafafa; color:#111; }

    /* HEADER con logo + men√∫ */
    header {
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 20px; background:#fff; border-bottom:1px solid #eee;
      position:sticky; top:0; z-index:2000;
    }
    /* Cuando tengas tu imagen, reemplaza este DIV por <img src="URL_DE_TU_LOGO" class="logo"> */
    .logo { font-weight:700; font-size:1.1rem; display:flex; align-items:center; gap:.5rem; }
    nav a {
      margin-left:20px; text-decoration:none; color:#111; font-weight:600;
    }
    nav a:hover { color:#d00; }

    .wrap { display:flex; min-height:calc(100vh - 60px); }
    #map { flex:1; min-height:calc(100vh - 60px); position:relative; }
    .panel { width:420px; max-width:100%; padding:22px; border-left:1px solid #eee; background:#fff; overflow-y:auto; }

    h1 { font-size:1.3rem; margin:0 0 14px; }
    label { display:block; margin:12px 0 6px; }
    input, textarea, button { width:100%; padding:12px; font-size:1rem; border:1px solid #ddd; border-radius:12px; }
    textarea { min-height:96px; }
    .small { color:#666; font-size:.9rem; min-height:1.2em; }
    .ok { color:#0a7d25; }
    .error { color:#b30000; }
    button { cursor:pointer; background:#111; color:#fff; border:0; border-radius:12px; margin-top:10px; font-weight:600; }

    /* Contador centrado arriba del mapa */
    .top-center-banner {
      position:absolute; left:50%; top:12px; transform:translateX(-50%);
      background:rgba(255,255,255,0.94); padding:10px 16px; border-radius:16px;
      box-shadow:0 4px 16px rgba(0,0,0,0.15); z-index:1000;
    }
    .counter{ font-size:1.2rem; font-weight:700; }

    /* Marcador emoji (hasta que pongamos tu PNG) */
    .emoji-marker{ background:transparent; border:none; font-size:28px; line-height:28px; transform:translate(-14px,-14px); pointer-events:none; }
    .leaflet-marker-icon[src*="marker-icon"]{ display:none!important; }
    .leaflet-marker-shadow{ display:none!important; }

    @media(max-width:900px){
      .wrap{ flex-direction:column; }
      .panel{ width:100%; border-left:0; border-top:1px solid #eee; }
    }
  </style>
</head>
<body>
<header>
  <div class="logo">üå∏ FLOVERMAPS</div>
  <nav>
    <a href="#plantar">Plantar flor</a>
    <a href="#mapa" onclick="document.getElementById('map').scrollIntoView({behavior:'smooth'});return false;">Ver mapa</a>
  </nav>
</header>

<div class="wrap">
  <div id="map">
    <div class="top-center-banner">
      <div id="counter" class="counter">üå∏ 0 flores plantadas</div>
    </div>
  </div>

  <div class="panel" id="plantar">
    <h1>Planta una flor üå∏</h1>
    <label>¬øQui√©n la env√≠a?</label><input id="fromName" placeholder="Tu nombre" />
    <label>¬øPara qui√©n?</label><input id="toName" placeholder="Nombre del destinatario" />
    <label>Mensaje</label><textarea id="message" placeholder="Escribe algo bonito‚Ä¶"></textarea>
    <label>Ubicaci√≥n</label><input id="place" placeholder="Ej. Sagrada Fam√≠lia, Barcelona" list="suggestions" />
    <datalist id="suggestions"></datalist>
    <div class="small">Escribe y pulsa ‚ÄúConfirmar ubicaci√≥n‚Äù, o haz clic en el mapa / usa tu GPS.</div>
    <div style="display:flex; gap:10px; margin-top:8px;">
      <button id="confirmBtn" type="button" style="background:#444;">‚úÖ Confirmar ubicaci√≥n</button>
      <button id="geoBtn" type="button" style="background:#444;">üìç Usar mi ubicaci√≥n</button>
    </div>
    <input id="lat" type="hidden" /><input id="lng" type="hidden" />
    <button id="plantBtn">Plantar flor</button>
    <button id="shareBtn" style="display:none; background:#0066cc;">üîó Compartir flor</button>
    <button id="resetBtn" style="display:none; background:#666;">‚ûï Plantar otra</button>
    <div id="status" class="small"></div>
  </div>
</div>

<script>
  /* === CONFIG === */
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxKcq4xqM1PB_wfIXibeotizuxw0-UgrPJ0LN70U-bva2Isk8EMwdsWeOk8l2w1DvFmJQ/exec";
  const NOMINATIM_EMAIL = "gracia.david@gmail.com";

  /* Mapa CARTO Voyager (mar azul, colores agradables) */
  const voyager = L.tileLayer("https://basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png", { attribution:'¬© OpenStreetMap ¬© CARTO', maxZoom:19 });
  const map = L.map("map", { layers:[voyager] }).setView([40.4168,-3.7038], 13);

  /* Marcador (emoji) ‚Äì cuando tengas tu PNG, cambia a L.icon y usa iconUrl */
  const flowerIcon = L.divIcon({ html:"üå∏", className:"emoji-marker", iconSize:[28,28], iconAnchor:[14,14] });

  let marker=null;
  const seen=new Set();
  const $=sel=>document.querySelector(sel);
  const statusEl=$("#status"), counterEl=$("#counter");

  function setStatus(msg,cls=""){ statusEl.className="small "+cls; statusEl.textContent=msg; }
  function escapeHtml(s){ return String(s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
  function fmtDate(d){ return `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}/${d.getFullYear()}`; }
  function popupHtml(from,to,msg,dateStr){ return `De ${escapeHtml(from)}<br>Para ${escapeHtml(to)}<br>üå∏ ${escapeHtml(msg)}${dateStr?`<br><small>üìÖ ${dateStr}</small>`:""}`; }
  function setPoint(lat,lon){ $("#lat").value=lat; $("#lng").value=lon; if(marker)map.removeLayer(marker); marker=L.marker([lat,lon],{icon:flowerIcon}).addTo(map); map.setView([lat,lon],14); }

  // üëâ Marcadores que hacen ZOOM 19 al hacer clic
  function addFlower(lat, lng, html, openNow=false){
    const m = L.marker([+lat, +lng], { icon: flowerIcon }).addTo(map).bindPopup(html);
    m.on("click", ()=>{ map.setView(m.getLatLng(), 19); m.openPopup(); });
    if(openNow){ map.setView([+lat, +lng], 19); m.openPopup(); }
    return m;
  }

  async function fillSuggestions(q){
    try{
      const url="https://nominatim.openstreetmap.org/search?format=json&limit=5&q="+encodeURIComponent(q)+"&email="+encodeURIComponent(NOMINATIM_EMAIL);
      const res=await fetch(url,{ headers:{ 'Accept':'application/json' }});
      return await res.json();
    }catch{ return []; }
  }
  async function searchAndFix(q){ if(!q)return; setStatus("Buscando‚Ä¶"); const r=await fillSuggestions(q); if(r.length>0){ const f=r[0]; setPoint(f.lat,f.lon); setStatus(""); } else setStatus("No se encontr√≥ esa ubicaci√≥n","error"); }

  $("#confirmBtn").onclick=()=>searchAndFix($("#place").value.trim());
  $("#geoBtn").onclick=()=>navigator.geolocation && navigator.geolocation.getCurrentPosition(p=>setPoint(p.coords.latitude,p.coords.longitude));
  map.on("click",e=>setPoint(e.latlng.lat,e.latlng.lng));

  async function loadFlowers(){
    try{
      const res=await fetch(SCRIPT_URL);
      const data=await res.json();
      (data.items||[]).forEach(f=>{
        if(!f.lat||!f.lng) return;
        const k = `${+f.lat},${+f.lng}|${f.fromName||''}|${f.toName||''}|${f.message||''}|${f.timestamp||''}`;
        if(seen.has(k)) return;
        seen.add(k);
        let dateStr=f.timestamp?fmtDate(new Date(f.timestamp)):"";
        addFlower(f.lat, f.lng, popupHtml(f.fromName||"",f.toName||"",f.message||"",dateStr), false);
      });
      counterEl.textContent=`üå∏ ${seen.size} flores plantadas`;
    }catch{}
  }

  $("#plantBtn").onclick=async()=>{
    const from=$("#fromName").value.trim(), to=$("#toName").value.trim(), msg=$("#message").value.trim();
    const lat=$("#lat").value.trim(), lng=$("#lng").value.trim(), place=$("#place").value.trim();
    if(!from||!to||!msg||!lat||!lng) return setStatus("Completa todos los campos y confirma la ubicaci√≥n","error");
    setStatus("Guardando‚Ä¶");
    try{
      const body=new URLSearchParams({fromName:from,toName:to,message:msg,place,lat,lng}).toString();
      const res=await fetch(SCRIPT_URL,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body});
      const data=await res.json();
      if(data.ok){
        const dateStr=fmtDate(new Date());
        addFlower(lat, lng, popupHtml(from,to,msg,dateStr), true); // üëà zoom 19 y popup
        counterEl.textContent=`üå∏ ${seen.size} flores plantadas`;
        // Botones virales
        $("#shareBtn").style.display="block";
        $("#resetBtn").style.display="block";
        const iso=new Date().toISOString().slice(0,10);
        const url=`${location.origin}${location.pathname}?lat=${lat}&lng=${lng}&from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&msg=${encodeURIComponent(msg)}&d=${iso}`;
        $("#shareBtn").onclick=()=>{ navigator.clipboard.writeText(url); setStatus("Enlace copiado ‚úÖ","ok"); };
        $("#resetBtn").onclick=()=>{ $("#fromName").value=""; $("#toName").value=""; $("#message").value=""; $("#place").value=""; $("#lat").value=""; $("#lng").value=""; $("#shareBtn").style.display="none"; $("#resetBtn").style.display="none"; setStatus("Formulario listo para otra flor."); };
      } else setStatus("Error: "+(data.error||"Desconocido"),"error");
    }catch{ setStatus("Error de red","error"); }
  };

  // Deep-link (si viene con ?lat=.. muestra esa flor con zoom 19)
  (function(){
    const p=new URLSearchParams(location.search);
    if(p.has("lat") && p.has("lng")){
      const lat=p.get("lat"), lng=p.get("lng"), from=p.get("from")||"", to=p.get("to")||"", msg=p.get("msg")||"", d=p.get("d")||"";
      let dateStr=""; if(d){ const dd=new Date(d); if(!isNaN(dd)) dateStr=fmtDate(dd); }
      addFlower(lat, lng, popupHtml(from,to,msg,dateStr), true); // üëà zoom 19 y popup
    }
    loadFlowers();
    setInterval(loadFlowers, 30000);
  })();
</script>
</body>
</html>
