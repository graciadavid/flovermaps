<!DOCTYPE html>
<html lang="es" data-mode="explore">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Flovermaps</title>

<!-- Favicon üå∏ -->
<link rel="icon" type="image/svg+xml" href='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 64 64"><text x="6" y="54" font-size="52">üå∏</text></svg>'>

<meta name="theme-color" content="#f6fff9" />
<meta name="description" content="Planta flores en el mapa y dedica mensajes bonitos." />
<meta property="og:title" content="Flovermaps">
<meta property="og:description" content="Planta flores en el mapa y dedica mensajes bonitos.">
<meta property="og:type" content="website">
<meta property="og:image" content="logo.png">
<meta name="twitter:card" content="summary_large_image">

<!-- Tipograf√≠a -->
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  :root{ --ink:#0f172a; --muted:#64748b; --accent:#01c064; --accent-weak: rgba(1,192,100,.08); --bg:#f6fff9; }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:'Plus Jakarta Sans',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--ink);
    background:
      radial-gradient(circle at 12% 18%, var(--accent-weak) 1.2px, transparent 1.2px) 0 0/18px 18px,
      radial-gradient(circle at 70% 40%, rgba(1,192,100,.06) 1.4px, transparent 1.4px) 0 0/22px 22px,
      linear-gradient(180deg, #f6fff9 0%, #ecfaf2 60%, #e8f8ef 100%);
  }

  /* Header */
  .site-header{display:flex; align-items:center; justify-content:center; padding:12px;}
  .header-card{display:flex; align-items:center; justify-content:center; background:#fff; border:1px solid #e8e8e8; border-radius:12px; padding:8px 14px; min-height:64px; box-shadow:0 6px 18px rgba(2,6,12,.06); margin:2px}
  .logo-img{display:block; height:72px; width:auto; max-width:100%; object-fit:contain}
  @media (min-width:900px){ .logo-img{height:96px} }

  /* Tabs */
  .tabs{display:flex; justify-content:center; gap:8px; padding:6px 8px}
  .tab-btn{
    border:1px solid #e6e6e6; background:#fff; color:#0f172a; border-radius:999px; padding:8px 14px; cursor:pointer; font-weight:700;
    box-shadow:0 4px 10px rgba(2,6,12,.04);
  }
  .tab-btn.active{ background:#0f172a; color:#fff; border-color:#0f172a; }

  /* Contador */
  .counter-wrap{display:flex; justify-content:center}
  .counter-mini{
    margin:8px 12px 6px; padding:6px 10px; border-radius:999px; background:#fff; border:1px solid #eee;
    display:inline-flex; align-items:center; gap:6px; font-weight:700; font-size:.92rem; color:#0f172a;
    box-shadow:0 4px 10px rgba(2,6,12,.04); letter-spacing:.2px; font-variant-numeric: tabular-nums;
  }
  .counter-mini .unit{font-weight:600; color:var(--muted)}

  /* Grid layout (desktop) */
  .wrap{
    display:grid; gap:0; min-height:calc(100vh - 52px - 56px);
    grid-template-columns: 420px 1fr 360px;
    grid-template-areas: "panel map feed";
    align-items:start;
  }
  .panel{grid-area:panel; max-width:100%; padding:14px}
  .mapArea{grid-area:map; padding:14px}
  .feedCol{grid-area:feed; padding:14px}

  .card{border:1px solid #e8e8e8; border-radius:12px; padding:14px; background:#fff; color:var(--ink); margin:4px; box-shadow:0 6px 18px rgba(2,6,12,.05)}
  .row2{display:grid; grid-template-columns:1fr 1fr; gap:8px}
  .muted{color:var(--muted); font-size:.85rem}
  label{display:block; margin:6px 0 4px; font-size:.92rem}

  /* Inputs y botones */
  input,.btn{width:100%; padding:10px; border:1px solid #ddd; border-radius:10px; font-size:.95rem}
  input:required:invalid{outline:0}
  .btn{border:0; border-radius:10px; cursor:pointer}
  .btn-dark{background:#444;color:#fff}
  .btn-share{background:#0066cc;color:#fff}
  .btn-muted{background:#e9ecef;color:#556; cursor:not-allowed}

  /* Autocomplete */
  .sbox{position:relative}
  .slist{position:absolute; left:0; right:0; top:100%; margin-top:4px; background:#fff; border:1px solid #e6e6e6; border-radius:10px; max-height:260px; overflow:auto; display:none; z-index:20}
  .sitem{padding:8px 10px; border-bottom:1px solid #f3f3f3; cursor:pointer; font-size:.95rem}
  .sitem:last-child{border-bottom:0}
  .hl{font-weight:700}

  /* Mapa */
  .frame{position:relative; border:1px solid #e8e8e8; border-radius:12px; overflow:hidden; background:#fff; margin:4px; box-shadow:0 6px 18px rgba(2,6,12,.05)}
  #map{width:100%; height:560px}
  @media (max-width:1200px){ #map{height:50vh} }
  @media (max-width:1024px){
    .wrap{grid-template-columns:1fr; grid-template-areas: "map" "panel" "feed";}
    .panel,.feedCol{padding-top:0}
    #map{height:44vh}
  }

  /* Ticker */
  .ticker{display:flex; align-items:center; gap:8px; padding:8px 12px; border:1px solid #e8e8e8; background:#fff; border-radius:10px; margin:4px 4px 10px; box-shadow:0 4px 12px rgba(2,6,12,.05); font-size:.95rem}
  .dot{width:8px; height:8px; border-radius:50%; background:#22c55e; box-shadow:0 0 0 0 rgba(34,197,94,.6); animation:pulse 1.4s infinite}
  @keyframes pulse{ 0%{ box-shadow:0 0 0 0 rgba(34,197,94,.6)} 70%{ box-shadow:0 0 0 10px rgba(34,197,94,0)} 100%{ box-shadow:0 0 0 0 rgba(34,197,94,0)} }

  /* Bot√≥n flotante peque√±o pegado a la flor */
  .map-fab{
    position:absolute; z-index:902; display:none;
    border:0; cursor:pointer; background:#22c55e; color:#fff;
    box-shadow:0 6px 16px rgba(0,0,0,.18); transform:translate(-50%,0);
    font-size:.86rem; line-height:1; padding:7px 10px; border-radius:10px; white-space:nowrap;
    width:auto; max-width:200px;
  }
  @keyframes bounceIn{0%{transform:translate(-50%,10px) scale(.9)}60%{transform:translate(-50%,0) scale(1.05)}100%{transform:translate(-50%,0) scale(1)}}
  .map-fab.pop{animation:bounceIn .28s ease}

  /* Marcador emoji */
  .leaflet-marker-icon[src*="marker-icon"], .leaflet-marker-shadow{display:none!important}
  .emoji-marker{background:transparent; transform:translate(-14px,-28px)}
  .emoji-marker .e{font-size:30px; line-height:30px; text-shadow:0 1px 0 #fff,0 -1px 0 #fff,1px 0 0 #fff,-1px 0 0 #fff,0 0 4px rgba(0,0,0,.25)}
  @media (min-width:900px){ .emoji-marker .e{font-size:34px; line-height:34px} }

  /* Toast */
  .toast{position:fixed; left:50%; bottom:88px; transform:translateX(-50%); background:#111; color:#fff; padding:10px 12px; border-radius:10px; z-index:11000; opacity:0; pointer-events:none; transition:opacity .18s, bottom .18s}
  .toast.show{opacity:1; bottom:98px}

  /* Sticky pill (ver mapa global) */
  .global-pill{
    position:fixed; right:14px; bottom:14px; z-index:10000; display:none;
    background:#0f172a; color:#fff; border:0; border-radius:999px; padding:10px 14px; box-shadow:0 10px 24px rgba(0,0,0,.18); cursor:pointer;
    font-weight:700;
  }

  /* Modal √©xito */
  .modal{position:fixed; inset:0; background:rgba(0,0,0,.28); display:none; align-items:center; justify-content:center; z-index:12000}
  .modal .box{background:#fff; width:min(520px,92vw); border-radius:16px; padding:16px; box-shadow:0 20px 60px rgba(0,0,0,.25)}
  .modal h3{margin:4px 0 10px}
  .actions-row{display:flex; gap:8px; flex-wrap:wrap}
  .btn-outline{background:#fff; color:#0f172a; border:1px solid #e6e6e6}
  .btn-green{background:#22c55e; color:#fff}

  /* Visibilidad por modo */
  body[data-mode="explore"] .panel{display:none}
  body[data-mode="explore"] .feedCol{display:block}
  body[data-mode="plant"] .panel{display:block}
  body[data-mode="plant"] .feedCol{display:none}
</style>
</head>
<body data-mode="explore">

<header class="site-header">
  <div class="header-card">
    <img src="logo.png" alt="FLOVERMAPS" class="logo-img" onerror="this.style.display='none'">
  </div>
</header>

<!-- Tabs -->
<nav class="tabs" role="tablist" aria-label="Cambiar vista">
  <button id="tabExplore" class="tab-btn active" role="tab" aria-selected="true">üó∫Ô∏è Explorar</button>
  <button id="tabPlant" class="tab-btn" role="tab" aria-selected="false">üå∏ Plantar</button>
</nav>

<!-- Contador peque√±o -->
<div class="counter-wrap">
  <div class="counter-mini" aria-live="polite">
    <span id="heroCount">0</span> üå∏ <span class="unit">flores plantadas en el mundo</span>
  </div>
</div>

<div class="wrap">
  <!-- Panel (Plantar) -->
  <section class="panel" aria-labelledby="tabPlant">
    <div class="card" id="formCard">
      <h1>Planta una flor</h1>
      <div class="row2">
        <div><label for="fromName">¬øQui√©n la env√≠a?</label><input id="fromName" placeholder="Tu nombre" required></div>
        <div><label for="toName">¬øPara qui√©n?</label><input id="toName" placeholder="Nombre del destinatario" required></div>
      </div>

      <label for="message" style="margin-top:8px">Mensaje <span class="muted" id="chars">(0/30)</span></label>
      <input id="message" maxlength="30" placeholder="Ese rinc√≥n especial‚Ä¶ (m√°x. 30)" inputmode="text" autocomplete="off" required />

      <label for="place" style="margin-top:8px">Ubicaci√≥n</label>
      <div class="sbox" role="combobox" aria-expanded="false" aria-owns="slist" aria-haspopup="listbox">
        <input id="place" placeholder="Ej. Puerta del Sol, Madrid" autocomplete="off" aria-autocomplete="list" aria-controls="slist">
        <div id="slist" class="slist" role="listbox"></div>
      </div>
      <div class="muted" id="help">Escribe y elige una sugerencia, o haz clic en el mapa. Al arrastrar, actualizamos la direcci√≥n.</div>
      <div id="fixed" class="muted" style="display:none;margin-top:4px">‚úÖ Ubicaci√≥n fijada</div>

      <div class="actions" style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap">
        <button id="confirmBtn" class="btn btn-dark" style="flex:1 1 160px">‚úÖ Confirmar direcci√≥n</button>
        <button id="gpsBtn" class="btn btn-dark" style="flex:1 1 160px; display:none">üìç Usar mi ubicaci√≥n</button>
      </div>

      <!-- Placeholder Flor Premium (desactivada) -->
      <div class="card" style="margin-top:12px; background:#f7f9fb">
        <strong>üåü Flor Premium</strong> <span class="muted">(pr√≥ximamente)</span>
        <div class="muted" style="margin:6px 0 8px">A√±ade m√∫sica, v√≠deo o mensajes secretos. Disponible muy pronto.</div>
        <button class="btn btn-muted" title="Pr√≥ximamente" disabled>Desbloquear Premium</button>
      </div>

      <input type="hidden" id="lat"><input type="hidden" id="lng">
    </div>
  </section>

  <!-- Mapa + Ticker -->
  <section class="mapArea" aria-labelledby="tabExplore">
    <div class="ticker" id="liveTicker" style="display:none"><span class="dot"></span><span id="tickerText">Actividad reciente‚Ä¶</span></div>
    <div class="frame" id="mapFrame">
      <div id="map"></div>
      <button id="plantFab" class="map-fab" type="button" aria-label="Plantar aqu√≠">‚úÖ Plantar aqu√≠</button>
    </div>
    <div style="display:flex;justify-content:center;padding:10px 0">
      <button id="shareBtn" class="btn btn-share" style="display:none">üîó Compartir</button>
    </div>
  </section>

  <!-- Feed lateral (Explorar) -->
  <aside class="feedCol">
    <div class="card">
      <h3 style="margin:0 0 8px">üå∏ √öltimas dedicatorias</h3>
      <div id="recentList" class="muted">Cargando‚Ä¶</div>
    </div>
    <div class="card">
      <h3 style="margin:0 0 8px">üèôÔ∏è Top ciudades (7 d√≠as)</h3>
      <ol id="topCities" class="muted" style="margin:0; padding-left:18px"></ol>
    </div>
  </aside>
</div>

<!-- Toast + Sticky pill + Modal -->
<div id="toast" class="toast" role="status" aria-live="polite"></div>
<button id="globalPill" class="global-pill">üåç Ver mapa global</button>

<div id="successModal" class="modal" aria-modal="true" role="dialog">
  <div class="box">
    <h3>üéâ ¬°Tu flor ya florece en el mapa!</h3>
    <p class="muted" id="successText">Comparte el enlace o explora el mapa global.</p>
    <div class="actions-row" style="margin-top:10px">
      <button id="mShare" class="btn btn-outline">üîó Compartir</button>
      <button id="mGlobal" class="btn btn-outline">üåç Ver mapa global</button>
      <button id="mAnother" class="btn btn-green">‚ûï Plantar otra</button>
    </div>
  </div>
</div>

<script>
/* === CONFIG === */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxhGMS7D1i76f59sBjHim9P6PaNuCibePYkkXk297nQ_7asT0LJxPmIC_mKx8B5G3UhDQ/exec";

/* === JSONP helper === */
function jsonp(url, timeoutMs=12000){
  return new Promise((resolve, reject)=>{
    const cb='__fp_cb_'+Math.random().toString(36).slice(2);
    const s=document.createElement('script'); const sep=url.includes('?')?'&':'?';
    s.src=url+sep+'callback='+cb+'&_ts='+Date.now(); s.id=cb; s.async=true;
    let to; function cleanup(){ clearTimeout(to); try{ delete window[cb]; }catch{}; s.remove(); }
    window[cb]=(data)=>{ cleanup(); resolve(data); };
    s.onerror=()=>{ cleanup(); reject(new Error('JSONP load failed')); };
    document.head.appendChild(s);
    to=setTimeout(()=>{ cleanup(); reject(new Error('JSONP timeout')); }, timeoutMs);
  });
}

/* === STATE === */
let map, baseTiles, fallbackTiles, tileFallbackUsed=false;
let flowersLayer=null;
let editMarker=null;
let pollTimer=null;
let didFitBounds=false;
let serverCount=0, heroTimer=null;
let saving=false; // guardia anti doble env√≠o
let lastShareUrl='';

/* === DOM === */
const $=s=>document.querySelector(s);
const place=$("#place"), slist=$("#slist"), fixedBadge=$("#fixed");
const plantFab=$("#plantFab"), shareBtn=$("#shareBtn"), gpsBtn=$("#gpsBtn");
const heroCountEl=$("#heroCount"), msgInput=$("#message");
const recentList=$("#recentList"), topCitiesEl=$("#topCities");
const ticker=$("#liveTicker"), tickerText=$("#tickerText");
const globalPill=$("#globalPill");
const successModal=$("#successModal"), mShare=$("#mShare"), mGlobal=$("#mGlobal"), mAnother=$("#mAnother");

/* === Tabs === */
const tabExplore=$("#tabExplore"), tabPlant=$("#tabPlant");
function setMode(mode){
  document.body.setAttribute('data-mode', mode);
  tabExplore.classList.toggle('active', mode==='explore');
  tabPlant.classList.toggle('active', mode==='plant');
  tabExplore.setAttribute('aria-selected', mode==='explore');
  tabPlant.setAttribute('aria-selected', mode==='plant');
  // Ajustar altura del mapa al cambiar layout
  setTimeout(()=>{ syncMapHeight(); map && map.invalidateSize(); }, 120);
}
tabExplore.addEventListener('click', ()=> setMode('explore'));
tabPlant.addEventListener('click', ()=> setMode('plant'));

/* === Utils === */
function toast(msg, ok=true){ const t=$("#toast"); t.textContent=msg; t.style.background=ok?"#111":"#b30000"; t.classList.add("show"); setTimeout(()=>t.classList.remove('show'),1600); }
function fmtDateTime(d){ try{ return new Intl.DateTimeFormat('es-ES',{timeZone:'Europe/Madrid', day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit', hour12:false}).format(d).replace(',', ''); }catch{ const dd=String(d.getDate()).padStart(2,"0"), mm=String(d.getMonth()+1).padStart(2,"0"), yy=d.getFullYear(), hh=String(d.getHours()).padStart(2,"0"), mi=String(d.getMinutes()).padStart(2,"0"); return `${dd}/${mm}/${yy} ${hh}:${mi}`; } }
function formatES(n){ try{ return new Intl.NumberFormat('es-ES').format(n); }catch{return String(n);} }
function popupHtml(from,to,msg,dtStr){ const esc=s=>String(s||'').replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); return `<div>${esc(dtStr)} <strong>${esc(from)}</strong> para <strong>${esc(to)}</strong>: ${esc(msg)}.</div>`; }
function emojiIcon(){ const html='<span class="e" role="img" aria-label="flor">üå∏</span>'; return L.divIcon({className:'emoji-marker', html, iconSize:[28,28], iconAnchor:[14,28], popupAnchor:[0,-30]}); }
function toNum(v){ if(v===null||v===undefined) return NaN; if(typeof v==='number') return v; const s=String(v).trim().replace(/\s+/g,'').replace(',', '.'); const n=Number(s); return isFinite(n)? n : NaN; }
function extractCityFromPlace(place){ if(!place) return ''; const parts=String(place).split(',').map(s=>s.trim()).filter(Boolean); if(parts.length>=2) return parts[parts.length-1]; return parts[0]||''; }
function relTime(ts){ const t=Number(ts)||Date.parse(ts)||Date.now(); const s=Math.max(1, Math.floor((Date.now()-t)/1000)); if(s<60) return `hace ${s} s`; const m=Math.floor(s/60); if(m<60) return `hace ${m} min`; const h=Math.floor(m/60); if(h<24) return `hace ${h} h`; const d=Math.floor(h/24); return `hace ${d} d`; }

/* === Mapa === */
function initMap(){
  baseTiles=L.tileLayer('https://basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',{attribution:'¬© OpenStreetMap ¬© CARTO',maxZoom:19});
  baseTiles.on('tileerror', ()=>{ if(!tileFallbackUsed){ tileFallbackUsed=true; try{ map && map.removeLayer(baseTiles);}catch{} fallbackTiles=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap contributors',maxZoom:19}); fallbackTiles.addTo(map);} });
  map=L.map('map',{layers:[baseTiles],zoomControl:true, worldCopyJump:true});

  /* HOME: Espa√±a (zoom 5) */
  map.setView([40.2, -3.7], 5);

  flowersLayer=L.layerGroup().addTo(map);

  setTimeout(()=>{ map.invalidateSize(); syncMapHeight(); },150);
  addEventListener('resize', ()=> setTimeout(()=>{ map.invalidateSize(); syncMapHeight(); },120));
  map.on('click', e=>{ setMode('plant'); setEditPoint(e.latlng.lat.toFixed(6), e.latlng.lng.toFixed(6), 14, true); });
  map.on('move zoom zoomend', updateFabPosition);
}
function syncMapHeight(){
  const mq=window.matchMedia('(min-width:1025px)');
  const mapEl=$("#map"), formCard=$("#formCard");
  if(!mapEl||!formCard) return;
  if(mq.matches){ const h=Math.max(420, formCard.offsetHeight); mapEl.style.height=h+'px'; if(map) setTimeout(()=>map.invalidateSize(),50); }
  else{ mapEl.style.height='44vh'; if(map) setTimeout(()=>map.invalidateSize(),50); }
}

/* Editar / arrastrar la flor */
async function setEditPoint(lat,lng,zoom=14,showHint=false){
  $("#lat").value=lat; $("#lng").value=lng;
  if(editMarker){ editMarker.setLatLng([lat,lng]); }
  else{
    editMarker=L.marker([lat,lng],{icon:emojiIcon(),draggable:true,zIndexOffset:2000}).addTo(map);
    const lock=()=>{ if(map && map.dragging) map.dragging.disable(); };
    const unlock=()=>{ if(map && map.dragging) map.dragging.enable(); };
    editMarker.on('mousedown',lock); editMarker.on('touchstart',lock,{passive:true}); editMarker.on('dragstart',lock);
    editMarker.on('mouseup',unlock); editMarker.on('touchend',unlock,{passive:true});
    editMarker.on('dragend', async e=>{
      unlock();
      const p=e.target.getLatLng(); const lat2=p.lat.toFixed(6), lng2=p.lng.toFixed(6);
      $("#lat").value=lat2; $("#lng").value=lng2; fixedBadge.style.display='inline'; updateFabPosition();
      try{
        const r=await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&accept-language=es&lat=${lat2}&lon=${lng2}&addressdetails=1`);
        if(r.ok){ const j=await r.json(); const a=j.address||{};
          const road=a.road||a.pedestrian||a.cycleway||a.footway||a.path||a.neighbourhood||a.suburb||"";
          const hn=a.house_number||a.housenumber||"";
          const city=a.city||a.town||a.village||a.municipality||a.state||"";
          const display=[[road,hn].filter(Boolean).join(" "),city].filter(Boolean).join(", ");
          if(display) place.value=display;
        }
      }catch{}
    });
    if(showHint){ editMarker.bindTooltip('Arrastra para ajustar',{permanent:true, direction:'top', offset:[0,-24]}).openTooltip(); }
    editMarker.on('drag', updateFabPosition);
  }
  map.setView([lat,lng],zoom);
  showFab();
}

/* Bot√≥n flotante bajo la flor */
function updateFabPosition(){
  if(!plantFab || !editMarker || !map) return;
  const mapEl=map.getContainer(), frameEl=mapEl.parentElement;
  const p=map.latLngToContainerPoint(editMarker.getLatLng());
  const mr=mapEl.getBoundingClientRect(), fr=frameEl.getBoundingClientRect();
  const left=p.x+(mr.left-fr.left), top=p.y+(mr.top-fr.top)+34;
  const pad=8, maxX=fr.width-pad, maxY=fr.height-pad;
  plantFab.style.left=Math.max(pad, Math.min(left, maxX))+'px';
  plantFab.style.top =Math.max(pad, Math.min(top , maxY))+'px';
}
function showFab(){ updateFabPosition(); plantFab.style.display='inline-flex'; plantFab.classList.remove('pop'); void plantFab.offsetWidth; plantFab.classList.add('pop'); }
function hideFab(){ plantFab.style.display='none'; }

/* Autocomplete con n√∫meros */
let suggestTimer=null, abortCtrl=null, currentSuggest=[];
function hasNumber(s){ return /[0-9]/.test(s); }
function extractNumber(s){ const m=s.match(/([0-9]{1,5})/); return m? m[1]:null; }
function normalizeStreet(q){
  const hasType=/(carrer|calle|avinguda|av\.|avenida|paseo|ps\.|pla√ßa|plaza)/i.test(q);
  if(hasType) return [q];
  const base=q.replace(/\s+/g,' ').trim();
  return ['Calle '+base,'Carrer de '+base,'Avinguda '+base,base];
}
async function searchPlacesPlain(q, sig){
  const r=await fetch('https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=7&countrycodes=es&accept-language=es&q='+encodeURIComponent(q),{signal:sig});
  if(!r.ok) throw new Error('nominatim'); return r.json();
}
async function searchPlacesStructured(q, sig){
  let raw=q, city=''; if(q.includes(',')){ const parts=q.split(','); raw=parts[0].trim(); city=parts.slice(1).join(',').trim(); }
  const variants=normalizeStreet(raw);
  const results = await Promise.allSettled(
    variants.map(street =>
      fetch('https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=7&countrycodes=es&accept-language=es&street='+encodeURIComponent(street)+'&city='+encodeURIComponent(city),{signal:sig})
        .then(r=>r.ok?r.json():[])
        .catch(()=>[])
    )
  );
  return results.flatMap(r => r.status==='fulfilled' ? r.value : []);
}
async function searchPlaces(q){
  if(abortCtrl) abortCtrl.abort();
  abortCtrl=new AbortController(); const sig=abortCtrl.signal;
  try{
    const hasNum=hasNumber(q);
    const [A,B] = await Promise.all([
      searchPlacesPlain(q,sig).catch(()=>[]),
      hasNum? searchPlacesStructured(q,sig).catch(()=>[]) : Promise.resolve([])
    ]);
    const list=[...A,...B]; const seenIds=new Set(); const merged=[];
    for(const it of list){ const id=(it.place_id||it.lat+'|'+it.lon); if(!seenIds.has(id)){ seenIds.add(id); merged.push(it); } }
    if(hasNum){ const num=extractNumber(q); merged.sort((x,y)=>{ const xn=(x.address&&(x.address.house_number||x.address.housenumber))||''; const yn=(y.address&&(y.address.house_number||y.address.housenumber))||''; return (String(yn)===String(num)) - (String(xn)===String(num)); }); }
    return merged.slice(0,10);
  }catch{ return []; }
}
function renderSuggest(list){
  const q=place.value.trim(); const num=extractNumber(q);
  slist.innerHTML=""; list.forEach((it,idx)=>{
    const row=document.createElement('div'); row.className='sitem'; row.setAttribute('role','option');
    const road=it.address?.road || it.address?.pedestrian || it.address?.footway || it.address?.residential || it.address?.path || it.address?.neighbourhood || '';
    const hn=it.address?.house_number || it.address?.housenumber || '';
    let primary=(road||hn) ? (road+(hn?' '+hn:'')) : (it.display_name||'').split(',')[0];
    const city=it.address?.city || it.address?.town || it.address?.village || it.address?.municipality || '';
    const state=it.address?.state || it.address?.province || it.address?.state_district || '';
    const meta=[city,state].filter(Boolean).join(', ');
    if(num){ primary=primary.replace(new RegExp('('+num+')'),' <span class="hl">$1</span> '); }
    row.innerHTML=primary+(meta?' <small>'+meta+'</small>':'');
    row.onclick=()=>selectSuggest(idx);
    slist.appendChild(row);
  });
  slist.style.display = list.length ? 'block' : 'none';
  document.querySelector('.sbox').setAttribute('aria-expanded', list.length ? 'true' : 'false');
}
async function selectSuggest(i){
  const it=currentSuggest[i]; if(!it) return;
  place.value=it.display_name; slist.style.display='none';
  setEditPoint(Number(it.lat).toFixed(6), Number(it.lon).toFixed(6), 14, true);
  fixedBadge.style.display='inline';
}
place.addEventListener('input', e=>{
  fixedBadge.style.display='none';
  const q=e.target.value.trim();
  clearTimeout(suggestTimer);
  if(!q){ slist.style.display='none'; document.querySelector('.sbox').setAttribute('aria-expanded','false'); return; }
  suggestTimer=setTimeout(async()=>{ try{ currentSuggest=await searchPlaces(q); renderSuggest(currentSuggest);}catch{} }, 250);
});
place.addEventListener('keydown', e=>{
  if(e.key==='Escape'){ slist.style.display='none'; document.querySelector('.sbox').setAttribute('aria-expanded','false'); }
});
$("#confirmBtn").addEventListener('click', async ()=>{
  const q=place.value.trim(); if(!q){ toast('Escribe una direcci√≥n', false); return; }
  try{
    const r=await searchPlaces(q);
    if(r.length){ const f=r[0]; setEditPoint(Number(f.lat).toFixed(6), Number(f.lon).toFixed(6), 14, true); fixedBadge.style.display='inline'; }
    else toast('No encontrada', false);
  }catch{}
});
addEventListener('click', e=>{ const box=document.querySelector('.sbox'); if(box && !box.contains(e.target)) slist.style.display='none'; });

/* Mensaje 1 l√≠nea / 30 chars */
msgInput.addEventListener('input', ()=>{ msgInput.value=msgInput.value.replace(/\r?\n/g,'').slice(0,30); $("#chars").textContent='(' + msgInput.value.length + '/30)'; });
msgInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); }});

/* GPS */
function setupGpsBtn(){
  if(!('geolocation' in navigator)) return;
  const show = ()=>{ gpsBtn.style.display='inline-block'; };
  const hide = ()=>{ gpsBtn.style.display='none'; };
  if(navigator.permissions && navigator.permissions.query){
    navigator.permissions.query({name:'geolocation'}).then(st=>{
      (st.state!=='denied')?show():hide();
      st.onchange=()=>{ (st.state!=='denied')?show():hide(); };
    }).catch(show);
  } else { show(); }
  gpsBtn.onclick=()=> navigator.geolocation.getCurrentPosition(async pos=>{
    const lat=pos.coords.latitude.toFixed(6), lng=pos.coords.longitude.toFixed(6);
    setMode('plant');
    setEditPoint(lat,lng,14,true); fixedBadge.style.display='inline';
    try{
      const r=await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&accept-language=es&lat=${lat}&lon=${lng}&addressdetails=1`);
      if(r.ok){ const j=await r.json(); const a=j.address||{};
        const road=a.road||a.pedestrian||a.cycleway||a.footway||a.path||a.neighbourhood||a.suburb||"";
        const hn=a.house_number||a.housenumber||"";
        const city=a.city||a.town||a.village||a.municipality||a.state||"";
        const display=[[road,hn].filter(Boolean).join(" "),city].filter(Boolean).join(", ");
        if(display) place.value=display;
      }
    }catch{}
  }, ()=>toast('Ubicaci√≥n no disponible (activa permisos)', false), {timeout:8000});
}
setupGpsBtn();

/* Guardar flor ‚Üí re-listar y repintar TODO */
async function saveFlower(){
  if(saving) return; saving=true;
  const from=$("#fromName").value.trim(), to=$("#toName").value.trim(), msg=$("#message").value.trim();
  const lat=$("#lat").value.trim(), lng=$("#lng").value.trim(), placeText=place.value.trim();
  if(!from||!to||!msg||!lat||!lng){ toast('Completa los campos y fija ubicaci√≥n', false); saving=false; return; }
  if(msg.length>30){ toast('M√°ximo 30 caracteres', false); saving=false; return; }
  plantFab.disabled=true; const prev=plantFab.textContent; plantFab.textContent='‚è≥';
  try{
    const url = SCRIPT_URL + '?action=add'
      + '&fromName='+encodeURIComponent(from)
      + '&toName='  +encodeURIComponent(to)
      + '&message=' +encodeURIComponent(msg)
      + '&place='   +encodeURIComponent(placeText)
      + '&lat='     +encodeURIComponent(lat)
      + '&lng='     +encodeURIComponent(lng);
    const data = await jsonp(url);
    if(data && data.ok){
      await refetch(); // pinta lo del servidor (y actualiza feed/ticker)
      const dtStr=fmtDateTime(new Date());
      const html=popupHtml(from,to,msg,dtStr);
      const mk=L.marker([+lat,+lng],{icon:emojiIcon(), zIndexOffset:1500}).addTo(flowersLayer).bindPopup(html);
      mk.on('click',()=>{ map.setView(mk.getLatLng(),17); mk.openPopup(); }); 
      map.setView([+lat,+lng],17); // vista un poco m√°s lejana que 19
      mk.openPopup();

      lastShareUrl=`${location.origin}${location.pathname}?lat=${lat}&lng=${lng}&from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&msg=${encodeURIComponent(msg)}`;
      shareBtn.style.display='inline-block';
      shareBtn.onclick=async()=>{ try{ if(navigator.share){ await navigator.share({title:'Flovermaps',text:`Una flor para ${to}`,url:lastShareUrl}); } else { await navigator.clipboard.writeText(lastShareUrl); shareBtn.textContent='‚úÖ Copiado'; setTimeout(()=>shareBtn.textContent='üîó Compartir',1200); } }catch{} };

      // Mostrar modal √©xito + pill global
      $("#successText").textContent = `De ${from} para ${to}.`;
      successModal.style.display='flex';
      showGlobalPillTemporarily();

      hideFab(); $("#lat").value=''; $("#lng").value='';
    } else { toast('No se pudo guardar', false); }
  }catch(e){ toast('Error al plantar', false); }
  plantFab.disabled=false; plantFab.textContent=prev;
  saving=false;
}
plantFab.addEventListener('click', saveFlower);

/* Modal acciones */
function closeModal(){ successModal.style.display='none'; }
mShare.onclick = async ()=>{
  try{
    if(lastShareUrl){
      if(navigator.share){ await navigator.share({title:'Flovermaps', text:'Mira esta flor üå∏', url:lastShareUrl}); }
      else{ await navigator.clipboard.writeText(lastShareUrl); toast('Enlace copiado'); }
    }
  }catch{}
};
mGlobal.onclick = ()=>{ closeModal(); viewGlobal(); };
mAnother.onclick = ()=>{ closeModal(); setMode('plant'); toast('Vamos a plantar otra üå∏'); };

/* Sticky pill */
function showGlobalPillTemporarily(){
  globalPill.style.display='inline-flex';
  setTimeout(()=>{ globalPill.style.display='none'; }, 12000);
}
globalPill.onclick = ()=>{ viewGlobal(); globalPill.style.display='none'; };
function viewGlobal(){ map.setView([40.2, -3.7], 5); setMode('explore'); }

/* Render completo SIEMPRE con lo que devuelve el servidor */
function renderAllMarkers(list){
  if(!map || !flowersLayer) return;
  try{ flowersLayer.clearLayers(); }catch{}
  const bounds=L.latLngBounds();
  let i=0, n=list.length;
  (function chunk(){
    const t0=performance.now();
    while(i<n && (performance.now()-t0)<24){
      const f=list[i++]; const lat=parseFloat(f.lat), lng=parseFloat(f.lng);
      if(!isFinite(lat)||!isFinite(lng)) continue;
      const dtStr=f.timestamp?fmtDateTime(new Date(Number(f.timestamp)||Date.parse(f.timestamp)||Date.now())):"";
      const html=popupHtml(f.fromName||'', f.toName||'', (f.message||'').slice(0,30), dtStr);
      const mk=L.marker([lat,lng],{icon:emojiIcon(), zIndexOffset:1200}).addTo(flowersLayer).bindPopup(html);
      mk.on('click',function(){ map.setView(this.getLatLng(),17); this.openPopup(); });
      bounds.extend([lat,lng]);
    }
    if(i<n){ requestAnimationFrame(chunk); }
    else{
      try{ flowersLayer.bringToFront(); }catch{}
      if(!didFitBounds && list.length){ didFitBounds=true; map.fitBounds(bounds.pad(0.15), {maxZoom:7}); }
    }
  })();
}

/* Normaliza items del WebApp (acepta m√∫ltiples nombres de columnas) */
function normalizeItems(items){
  const out=[];
  for(const f of (items||[])){
    const lat = toNum(f.lat ?? f.latitude ?? f.Latitude ?? f.LAT ?? f.latitud ?? f.y ?? f.Y ?? f.Lat);
    const lng = toNum(f.lng ?? f.lon ?? f.long ?? f.longitude ?? f.Longitude ?? f.LON ?? f.longitud ?? f.x ?? f.X ?? f.Lng);
    if(!isFinite(lat)||!isFinite(lng)) continue;
    const fromName = f.fromName ?? f.from ?? f.de ?? f.sender ?? f.quien ?? '';
    const toName   = f.toName   ?? f.to   ?? f.para ?? f.recipient ?? f.destinatario ?? '';
    const message  = (f.message ?? f.msg  ?? f.text ?? f.mensaje ?? f.note ?? '').slice(0,30);
    const place    = f.place    ?? f.address ?? f.direccion ?? f.location ?? '';
    const timestamp= f.timestamp?? f.ts ?? f.time ?? f.fecha ?? f.createdAt ?? f.created_at ?? '';
    out.push({ lat, lng, fromName, toName, message, place, timestamp });
  }
  return out;
}

/* Feed (10 √∫ltimas) + Top ciudades + Ticker */
function updateFeedAndMeta(items){
  const sorted=[...items].sort((a,b)=>(Number(b.timestamp)||Date.parse(b.timestamp)||0)-(Number(a.timestamp)||Date.parse(a.timestamp)||0));
  // Ticker
  if(sorted.length){
    const it=sorted[0];
    const city=extractCityFromPlace(it.place);
    tickerText.textContent = `${it.fromName||'Alguien'} plant√≥ una flor ${city?('en '+city+' '):''}${relTime(it.timestamp)}.`;
    ticker.style.display='flex';
  } else {
    ticker.style.display='none';
  }
  // Recent 10
  const ten=sorted.slice(0,10);
  if(!ten.length){ recentList.innerHTML='<span class="muted">A√∫n no hay flores recientes.</span>'; }
  else{
    recentList.innerHTML = ten.map(it=>{
      const city=extractCityFromPlace(it.place);
      const when=relTime(it.timestamp);
      const esc=s=>String(s||'').replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
      return `
        <div class="card" style="margin:8px 0; padding:10px">
          <div><strong>${esc(it.fromName)}</strong> ‚Üí <strong>${esc(it.toName)}</strong></div>
          <div class="muted" style="margin:2px 0">${esc(it.message)}</div>
          <div class="muted">${city?esc(city):'‚Äî'} ¬∑ ${when}</div>
          <div style="margin-top:6px"><button class="btn btn-outline" onclick="prefillCity('${encodeURIComponent(city||'')}')">Plantar en esta ciudad</button></div>
        </div>`;
    }).join('');
  }
  // Top ciudades (√∫ltimos 7 d√≠as)
  const weekAgo=Date.now()-7*24*3600*1000;
  const counts={};
  for(const it of items){
    const t=Number(it.timestamp)||Date.parse(it.timestamp)||0;
    if(!t || t<weekAgo) continue;
    const city=(extractCityFromPlace(it.place)||'‚Äî');
    counts[city]=(counts[city]||0)+1;
  }
  const top=Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,5);
  topCitiesEl.innerHTML = top.length? top.map(([c,n])=>`<li><strong>${c}</strong> ¬∑ ${n}</li>`).join('') : '<li class="muted">A√∫n sin actividad reciente.</li>';
  // Contador global
  serverCount=items.length; heroCountEl.textContent=formatES(serverCount);
}
window.prefillCity = function(cityEnc){
  const city=decodeURIComponent(cityEnc||'');
  setMode('plant');
  if(city){ place.value=city; fixedBadge.style.display='none'; toast(`Ciudad preseleccionada: ${city}`); }
  document.getElementById('fromName').focus();
};

/* Trae del servidor y repinta TODO (con cach√© local) */
async function refetch(){
  try{
    const data=await jsonp(SCRIPT_URL+'?action=list', 12000);
    if(data && Array.isArray(data.items)){
      localStorage.setItem('flowers_cache', JSON.stringify(data.items));
      const norm=normalizeItems(data.items);
      renderAllMarkers(norm);
      updateFeedAndMeta(norm);
      return;
    }
  }catch(e){}
  // fallback a cache si hay
  const cached=localStorage.getItem('flowers_cache');
  if(cached){
    const items=normalizeItems(JSON.parse(cached));
    renderAllMarkers(items);
    updateFeedAndMeta(items);
  }
}

/* Polling + contador */
function startPolling(){
  if(pollTimer) clearInterval(pollTimer);
  pollTimer=setInterval(refetch, 10000);
  document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) refetch(); });
}
function startHeroTimer(){
  if(heroTimer) clearInterval(heroTimer);
  heroTimer=setInterval(()=>{ heroCountEl.textContent=formatES(serverCount); }, 5000);
}

/* Abrir flor compartida si viene en la URL (zoom 17) */
function tryOpenShared(){
  const u=new URL(location.href);
  const lat=u.searchParams.get('lat'), lng=u.searchParams.get('lng');
  const from=u.searchParams.get('from')||'', to=u.searchParams.get('to')||'', msg=u.searchParams.get('msg')||'';
  if(lat && lng){
    const go=()=>{ map.setView([+lat,+lng], 17);
      L.marker([+lat,+lng],{icon:emojiIcon(),zIndexOffset:1600})
        .addTo(flowersLayer)
        .bindPopup(popupHtml(from,to,msg,fmtDateTime(new Date())))
        .openPopup();
      setMode('explore');
    };
    if(flowersLayer){ go(); } else { setTimeout(go, 400); }
  }
}

/* Inicio */
document.addEventListener('DOMContentLoaded', ()=>{
  $("#chars").textContent='(0/30)';
  initMap();
  refetch();        // pinta / feed / ticker
  startPolling();   // sigue sincronizando
  startHeroTimer(); // contador
  tryOpenShared();  // abre flor compartida si aplica
  if(document.fonts && document.fonts.ready){ document.fonts.ready.then(syncMapHeight); } else { syncMapHeight(); }
});
</script>
</body>
</html>
