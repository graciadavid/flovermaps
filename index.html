<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Flovermaps ‚Äì Planta una flor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:#fafafa; }
    .wrap { display:flex; min-height:100vh; }
    #map { flex:1; min-height:100vh; }
    .panel { width:420px; max-width:100%; padding:20px; border-left:1px solid #eee; background:#fff; }
    .panel h1 { font-size:1.25rem; margin:0 0 12px; }
    label { display:block; font-size:.9rem; margin:12px 0 6px; }
    input, textarea, button { width:100%; padding:10px; font-size:1rem; border:1px solid #ddd; border-radius:8px; }
    textarea { min-height:90px; resize:vertical; }
    .row { display:flex; gap:10px; }
    .row > div { flex:1; }
    .small { color:#666; font-size:.85rem; min-height:1.2em; }
    .ok { color:#0a7d25; }
    .error { color:#b30000; }
    button { cursor:pointer; background:#111; color:#fff; border:0; border-radius:10px; }
    .btn-row { display:flex; gap:10px; margin-top:8px; }
    .btn-secondary { background:#444; }
    .hint { font-size:.8rem; color:#444; margin-top:6px; }

    /* Icono emoji como marcador */
    .emoji-marker {
      background: transparent;
      border: none;
      font-size: 26px;
      line-height: 26px;
      transform: translate(-13px, -13px); /* centra el emoji */
      pointer-events: none; /* el clic pasa al propio marker */
    }
  </style>
</head>
<body>
<div class="wrap">
  <div id="map"></div>
  <div class="panel">
    <h1>Planta una flor üå∏</h1>

    <label>¬øQui√©n la env√≠a?</label>
    <input id="fromName" placeholder="Tu nombre" autocomplete="name" />

    <label>¬øPara qui√©n?</label>
    <input id="toName" placeholder="Nombre del destinatario" />

    <label>Mensaje</label>
    <textarea id="message" placeholder="Escribe algo bonito‚Ä¶"></textarea>

    <label>Ubicaci√≥n</label>
    <input id="place" placeholder="Ej. Sagrada Fam√≠lia, Barcelona" list="suggestions" />
    <datalist id="suggestions"></datalist>

    <div class="btn-row">
      <button id="confirmBtn" class="btn-secondary" type="button">‚úÖ Confirmar ubicaci√≥n</button>
      <button id="geoBtn" class="btn-secondary" type="button">üìç Usar mi ubicaci√≥n</button>
    </div>
    <div class="hint">Escribe y pulsa ‚ÄúConfirmar ubicaci√≥n‚Äù, o haz clic en el mapa / usa tu GPS.</div>

    <!-- Lat/Lon ocultos -->
    <input id="lat" type="hidden" />
    <input id="lng" type="hidden" />

    <button id="plantBtn" style="margin-top:12px;">Plantar flor</button>
    <div id="status" class="small"></div>
  </div>
</div>

<script>
  /* === CONFIG === */
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxKcq4xqM1PB_wfIXibeotizuxw0-UgrPJ0LN70U-bva2Isk8EMwdsWeOk8l2w1DvFmJQ/exec';
  const NOMINATIM_EMAIL = 'gracia.david@gmail.com';

  /* === MAPA === */
  const map = L.map('map').setView([40.4168, -3.7038], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap'
  }).addTo(map);

  // Icono emoji üå∏
  const flowerIcon = L.divIcon({
    html: 'üå∏',
    className: 'emoji-marker',
    iconSize: [26, 26],
    iconAnchor: [13, 13]
  });

  let marker = null;
  const $ = sel => document.querySelector(sel);
  const statusEl = $('#status');
  function setStatus(msg, cls='') { statusEl.className = 'small ' + cls; statusEl.textContent = msg; }
  function escapeHtml(s) { return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  function popupHtml(fromName, toName, message) {
    return `De ${escapeHtml(fromName||'')}<br>Para ${escapeHtml(toName||'')}<br>üå∏ ${escapeHtml(message||'')}`;
  }

  function setPoint(lat, lon, labelForPopup) {
    $('#lat').value = Number(lat).toFixed(6);
    $('#lng').value = Number(lon).toFixed(6);
    if (marker) map.removeLayer(marker);
    marker = L.marker([lat, lon], { icon: flowerIcon }).addTo(map)
      .bindPopup(labelForPopup || 'üå∏')
      .openPopup();
    map.setView([lat, lon], 12);
  }

  // Autocompletado (sugerencias)
  let typingTimer = null;
  $('#place').addEventListener('input', e => {
    const q = e.target.value.trim();
    clearTimeout(typingTimer);
    if (!q) { $('#suggestions').innerHTML=''; return; }
    typingTimer = setTimeout(async () => { await fillSuggestions(q); }, 500);
  });

  // Confirmar ubicaci√≥n: usa el primer resultado disponible
  $('#confirmBtn').addEventListener('click', async () => {
    await searchAndFix($('#place').value.trim());
  });

  // Enter en el campo = confirmar
  $('#place').addEventListener('keydown', async (e) => {
    if (e.key === 'Enter') { e.preventDefault(); await searchAndFix($('#place').value.trim()); }
  });

  // GPS
  $('#geoBtn').addEventListener('click', () => {
    if (!navigator.geolocation) return setStatus('El navegador no soporta geolocalizaci√≥n.', 'error');
    setStatus('Obteniendo tu ubicaci√≥n‚Ä¶');
    navigator.geolocation.getCurrentPosition(
      pos => { setPoint(pos.coords.latitude, pos.coords.longitude, 'üå∏'); setStatus(''); },
      err => setStatus('No se pudo obtener tu ubicaci√≥n.', 'error'),
      { enableHighAccuracy:true, timeout:10000 }
    );
  });

  // Click en el mapa
  map.on('click', e => { setPoint(e.latlng.lat, e.latlng.lng, 'üå∏'); setStatus(''); });

  async function fillSuggestions(query) {
    try {
      const url = 'https://nominatim.openstreetmap.org/search?format=json&limit=5&addressdetails=0&q='
                + encodeURIComponent(query) + '&email=' + encodeURIComponent(NOMINATIM_EMAIL);
      const res = await fetch(url, { headers: { 'Accept': 'application/json' }});
      const list = await res.json();
      const dl = $('#suggestions'); dl.innerHTML = '';
      (list || []).forEach(item => {
        const opt = document.createElement('option');
        opt.value = item.display_name;
        opt.dataset.lat = item.lat;
        opt.dataset.lon = item.lon;
        dl.appendChild(opt);
      });
      return list || [];
    } catch { return []; }
  }

  async function searchAndFix(query) {
    if (!query) return setStatus('Escribe una direcci√≥n o haz clic en el mapa.', 'error');
    setStatus('Buscando‚Ä¶');
    const results = await fillSuggestions(query);
    if (results.length > 0) {
      const first = results[0];
      $('#place').value = first.display_name; // dejamos la direcci√≥n completa en el input
      setPoint(parseFloat(first.lat), parseFloat(first.lon), 'üå∏');
      setStatus('');
    } else {
      setStatus('No se encontr√≥ esa ubicaci√≥n. Prueba otra m√°s concreta.', 'error');
    }
  }

  // Cargar flores guardadas
  async function loadFlowers() {
    try {
      const res = await fetch(SCRIPT_URL);
      const data = await res.json();
      if (!data.ok) return;
      (data.items || []).forEach(f => {
        if (f.lat && f.lng) {
          L.marker([Number(f.lat), Number(f.lng)], { icon: flowerIcon })
            .addTo(map)
            .bindPopup(popupHtml(f.fromName, f.toName, f.message));
        }
      });
    } catch {}
  }

  // Guardar flor
  $('#plantBtn').addEventListener('click', async () => {
    const fromName = $('#fromName').value.trim();
    const toName   = $('#toName').value.trim();
    const message  = $('#message').value.trim();
    const place    = $('#place').value.trim();
    const lat      = $('#lat').value.trim();
    const lng      = $('#lng').value.trim();

    if (!fromName || !toName || !message || !place || !lat || !lng) {
      return setStatus('Completa todos los campos y confirma la ubicaci√≥n (bot√≥n, mapa o GPS).', 'error');
    }
    setStatus('Guardando flor‚Ä¶');

    try {
      const body = new URLSearchParams({ fromName, toName, message, place, lat, lng }).toString();
      const res = await fetch(SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
        body
      });
      const data = await res.json();
      if (data.ok) {
        setStatus('¬°Flor plantada! Ya est√° guardada.', 'ok');
        const latN = Number(lat), lngN = Number(lng);
        if (marker) marker.remove();
        L.marker([latN, lngN], { icon: flowerIcon })
          .addTo(map)
          .bindPopup(popupHtml(fromName, toName, message))
          .openPopup();
        map.setView([latN, lngN], 12);
      } else {
        setStatus('No se pudo guardar: ' + (data.error||'Error desconocido'), 'error');
      }
    } catch {
      setStatus('Error de red al guardar la flor.', 'error');
    }
  });

  loadFlowers();
</script>
</body>
</html>
