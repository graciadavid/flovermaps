<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Flovermaps</title>

<!-- Favicon y meta -->
<link rel="icon" href="logo.png" type="image/png">
<meta name="theme-color" content="#01c064" />
<meta name="description" content="Planta flores en el mapa y dedica mensajes bonitos." />

<!-- Tipograf√≠a y Leaflet CSS -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- Leaflet JS primario + fallbacks -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" id="leaflet-cdn"></script>
<script>
  (function ensureLeaflet(){
    if(window.L) return; // unpkg ok
    var a=document.createElement('script');
    a.src='https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js';
    a.onerror=function(){
      var b=document.createElement('script');
      b.src='https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js';
      document.head.appendChild(b);
    };
    document.head.appendChild(a);
  })();
</script>

<style>
  :root{--ink:#111;--muted:#666; --bg:#01c064; --green:#22c55e}
  *{box-sizing:border-box}
  body{margin:0;font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#fff}

  /* Header con marco blanco */
  .site-header{position:sticky; top:0; z-index:10000; display:flex; align-items:center; justify-content:center; padding:12px; background:var(--bg);}
  .header-card{display:flex; align-items:center; justify-content:center; background:#fff; border:1px solid #e8e8e8; border-radius:12px; padding:8px 14px; min-height:64px}
  .logo-img{display:block; height:72px; width:auto; max-width:100%; object-fit:contain}
  @media (min-width:900px){ .logo-img{height:96px} }
  .logo-fallback{font-weight:800;letter-spacing:1px; display:none; color:#111}

  /* Contador (total + √∫ltima) */
  .counter{margin:8px 12px 0; padding:10px 12px; border-radius:14px; background:#fff; border:1px solid #eee; color:#111; display:flex; align-items:center; gap:12px}
  .count-num{font-weight:800; font-size:1.2rem}
  .count-label{color:#666}
  .last-msg{margin-left:auto; color:#444; font-size:.9rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:60ch}

  /* Layout */
  .wrap{display:flex; gap:0; min-height:calc(100vh - 52px - 56px)}
  .panel{width:420px; max-width:100%; padding:12px; border-right:0; overflow:auto; background:transparent}
  .card{border:1px solid #e8e8e8; border-radius:12px; padding:12px; background:#fff; color:#111}
  h1{font-size:1.25rem; margin:0 0 8px}
  label{display:block; margin:6px 0 4px; font-size:.92rem}
  input,textarea,button{width:100%; padding:10px; border:1px solid #ddd; border-radius:10px; font-size:.95rem}
  textarea{min-height:56px; resize:vertical}
  .muted{color:#666; font-size:.85rem}
  .row2{display:grid; grid-template-columns:1fr 1fr; gap:8px}

  .actions{display:flex; gap:8px; flex-direction:column; margin-top:8px}
  @media (min-width:900px){ .actions{flex-direction:row; align-items:center} }
  .btn{border:0; border-radius:10px; cursor:pointer}
  .btn-dark{background:#444;color:#fff}
  .btn-share{background:#0066cc;color:#fff}
  .badge{display:none; color:#0a7d25; font-size:.85rem; margin-top:6px}

  /* Radio pushbuttons */
  .choice{display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:8px}
  .choice input{display:none}
  .choice label{border:1px solid #ddd; border-radius:10px; padding:10px; text-align:center; cursor:pointer; background:#fafafa; user-select:none}
  .choice input:checked + label{border-color:#22c55e; background:#eafff2; font-weight:600}
  .choice label.disabled{opacity:.55; cursor:not-allowed}

  /* Autocomplete */
  .sbox{position:relative}
  .slist{position:absolute; left:0; right:0; top:100%; margin-top:4px; background:#fff; border:1px solid #e6e6e6; border-radius:10px; max-height:260px; overflow:auto; display:none; z-index:20}
  .sitem{padding:8px 10px; border-bottom:1px solid #f3f3f3; cursor:pointer; font-size:.95rem}
  .sitem:last-child{border-bottom:0}
  .sitem small{color:#777}
  .hl{font-weight:700}

  /* Mapa */
  .mapArea{flex:1; padding:10px 12px; background:transparent}
  .frame{position:relative; border:1px solid #e8e8e8; border-radius:12px; overflow:hidden; background:#fff}
  #map{width:100%; height:520px}
  @media (max-width:1024px){ #map{height:50vh} .wrap{flex-direction:column;} .panel{width:100%; border-right:0;} }

  /* Emoji marker */
  .leaflet-marker-icon[src*="marker-icon"], .leaflet-marker-shadow{display:none!important}
  .emoji-marker{background:transparent; border:none; display:flex; align-items:center; justify-content:center; transform:translate(-14px,-28px)}
  .emoji-marker .e{font-size:30px; line-height:30px; text-shadow: 0 1px 0 #fff, 0 -1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff, 0 0 4px rgba(0,0,0,.25)}
  @media (min-width:900px){ .emoji-marker .e{font-size:34px; line-height:34px} }
  .emoji-marker.is-selected .e{transform:translateY(-1px) scale(1.05)}

  /* Bot√≥n flotante PEQUE√ëO dentro del mapa (debajo del pin) + micro rebote */
  .map-fab{
    position:absolute; z-index:900; display:none; align-items:center; gap:8px;
    padding:6px 10px; border-radius:999px; border:0; cursor:pointer;
    background:#22c55e; color:#fff; box-shadow:0 6px 20px rgba(0,0,0,.18);
    transform:translate(-50%, 0); pointer-events:auto; transition:transform .15s ease, opacity .15s ease;
    width:auto; white-space:nowrap; font-size:.9rem;
  }
  .map-fab:disabled{opacity:.6; cursor:not-allowed}
  .map-fab::after{content:"Plantar aqu√≠"}
  @keyframes bounceIn{0%{transform:translate(-50%,10px) scale(.9)}60%{transform:translate(-50%,0) scale(1.05)}100%{transform:translate(-50%,0) scale(1)}}
  .map-fab.pop{animation:bounceIn .28s ease}

  /* Toast */
  .toast{position:fixed; left:50%; bottom:82px; transform:translateX(-50%); background:#111; color:#fff; padding:10px 12px; border-radius:10px; z-index:11000; opacity:0; pointer-events:none; transition:opacity .18s, bottom .18s}
  .toast.show{opacity:1; bottom:92px}
</style>
</head>
<body>

<!-- Header con marco blanco -->
<header class="site-header">
  <div class="header-card">
    <img src="logo.png" alt="FLOVERMAPS" class="logo-img" onerror="this.style.display='none'; document.getElementById('logoFallback').style.display='inline-block'">
    <span id="logoFallback" class="logo-fallback">FLOVERMAPS</span>
  </div>
</header>

<!-- Contador simple -->
<div class="counter" id="counter">
  <div class="count-num" id="countNum">0</div>
  <div class="count-label">flores plantadas</div>
  <div class="last-msg" id="lastMsg">S√© el primero en plantar hoy üíê</div>
</div>

<div class="wrap">
  <!-- FORMULARIO -->
  <section class="panel" id="panel">
    <div class="card">
      <h1>Planta una flor</h1>

      <div class="row2">
        <div><label for="fromName">¬øQui√©n la env√≠a?</label><input id="fromName" placeholder="Tu nombre"></div>
        <div><label for="toName">¬øPara qui√©n?</label><input id="toName" placeholder="Nombre del destinatario"></div>
      </div>

      <label for="message" style="margin-top:8px">Mensaje <span class="muted" id="chars">(0/90)</span></label>
      <textarea id="message" maxlength="90" placeholder="Escribe algo bonito‚Ä¶"></textarea>

      <!-- Radio pushbuttons: Flor / Flor Premium -->
      <div class="choice" aria-label="Tipo de flor">
        <input type="radio" id="flowerBasic" name="flowerType" value="basic" checked>
        <label for="flowerBasic">üå∏ Flor</label>

        <input type="radio" id="flowerPremium" name="flowerType" value="premium" disabled>
        <label for="flowerPremium" class="disabled">üåπ Flor Premium</label>
      </div>
      <div class="muted" style="margin-top:4px">La opci√≥n Premium estar√° disponible pr√≥ximamente.</div>

      <label for="place" style="margin-top:8px">Ubicaci√≥n</label>
      <div class="sbox">
        <input id="place" placeholder="Ej. Puerta del Sol, Madrid" autocomplete="off">
        <div id="slist" class="slist"></div>
      </div>
      <div class="muted" id="help">Escribe y elige una sugerencia, o haz clic en el mapa.</div>
      <div class="badge" id="fixed">‚úÖ Ubicaci√≥n fijada</div>

      <div class="actions">
        <button id="confirmBtn" type="button" class="btn btn-dark">‚úÖ Confirmar direcci√≥n</button>
        <button id="gpsBtn" type="button" class="btn btn-dark" style="display:none">üìç Usar mi ubicaci√≥n</button>
      </div>

      <input type="hidden" id="lat"><input type="hidden" id="lng">
    </div>
  </section>

  <!-- MAPA -->
  <section class="mapArea">
    <div class="frame">
      <div id="map"></div>
      <button id="plantFab" class="map-fab" type="button">‚úÖ</button>
    </div>
    <div class="below" style="display:flex;justify-content:center;padding:10px 0">
      <button id="shareBtn" class="btn btn-share" style="display:none">üîó Compartir</button>
    </div>
  </section>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* === CONFIG === */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxKcq4xqM1PB_wfIXibeotizuxw0-UgrPJ0LN70U-bva2Isk8EMwdsWeOk8l2w1DvFmJQ/exec";

/* === STATE === */
const seen = new Set();
let editMarker = null;
let usedGPS = false, usedMapClick = false;
let map, baseTiles, fallbackTiles, tileFallbackUsed=false;
let allFlowers = [];
let currentCityName = ""; // ciudad detectada para el popup actual

/* === DOM helpers === */
const $ = s => document.querySelector(s);
const slist = $("#slist"), place = $("#place");
const plantFab = $("#plantFab"), shareBtn = $("#shareBtn"), fixedBadge = $("#fixed");
const countNum = $("#countNum"), lastMsg = $("#lastMsg");

/* === Utils === */
function toast(msg, ok=true){ const t=$("#toast"); t.textContent=msg; t.style.background=ok?"#111":"#b30000"; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),1600); }
function esc(s){ return String(s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
function fmtDateTime(d){
  const dd=String(d.getDate()).padStart(2,"0");
  const mm=String(d.getMonth()+1).padStart(2,"0");
  const yy=d.getFullYear();
  const hh=String(d.getHours()).padStart(2,"0");
  const mi=String(d.getMinutes()).padStart(2,"0");
  return `${dd}/${mm}/${yy} ${hh}:${mi}`;
}
function normalizeCityFromPlace(txt){
  if(!txt) return "";
  const parts = txt.split(",").map(s=>s.trim()).filter(Boolean);
  if(parts.length>=2) return parts[1];
  return "";
}
async function reverseGeocodeCity(lat,lng){
  try{
    const url=`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}&addressdetails=1`;
    const r=await fetch(url,{headers:{'Accept':'application/json'}}); if(!r.ok) return "";
    const j=await r.json();
    const a=j.address||{};
    return a.city || a.town || a.village || a.municipality || a.state || "";
  }catch{ return ""; }
}
function popupHtml(city, from, to, msg, dtStr){
  const cityTxt = city ? city : "tu zona";
  const line = `üå∏ Flor Plantada en ${esc(cityTxt)} üå∏ ${esc(from)} a ${esc(to)}: ${esc(msg)} ${esc(dtStr)}.`;
  return `<div>${line}</div>`;
}
function animateNumber(el, to){
  const from = Number(el.textContent.replace(/\D/g,'')) || 0;
  const start = performance.now();
  const dur = 400;
  function step(t){
    const k = Math.min(1, (t-start)/dur);
    el.textContent = Math.round(from+(to-from)*k);
    if(k<1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}
function norm(s){ return String(s||'').trim().toLowerCase(); }
function makeKey(lat,lng,from,to,msg){ return `${(+lat).toFixed(5)},${(+lng).toFixed(5)}|${norm(from)}|${norm(to)}|${norm(msg)}`; }

/* === Icono === */
function emojiIcon(){
  const html = '<span class="e" role="img" aria-label="flor">üå∏</span>';
  return L.divIcon({className:'emoji-marker', html, iconSize:[28,28], iconAnchor:[14,28], popupAnchor:[0,-30]});
}

/* === MAPA (robusto) === */
function initMap(){
  if(!window.L){ toast('Mapa no disponible (Leaflet no carg√≥)', false); return; }
  if(map){ return; }

  baseTiles = L.tileLayer('https://basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',{attribution:'¬© OpenStreetMap ¬© CARTO',maxZoom:19});
  baseTiles.on('tileerror', ()=>{
    if(!tileFallbackUsed){
      tileFallbackUsed=true;
      try{ map && map.removeLayer(baseTiles); }catch(e){}
      fallbackTiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap contributors', maxZoom:19});
      fallbackTiles.addTo(map);
      toast('Usando mapa alternativo OSM', true);
    }
  });

  map = L.map('map',{layers:[baseTiles],zoomControl:true});
  map.setView([40.41694, -3.70361], 13); // Puerta del Sol, Madrid
  setTimeout(()=>map.invalidateSize(), 150);
  addEventListener('resize', ()=> setTimeout(()=>map.invalidateSize(), 120));

  // Crear/editar punto al hacer click
  map.on('click', e=>{
    usedMapClick=true; usedGPS=false;
    setEditPoint(e.latlng.lat.toFixed(6), e.latlng.lng.toFixed(6), 18, true);
  });

  // Reposicionar el bot√≥n bajo el pin cuando el mapa se mueve/zoomea
  map.on('move zoom zoomend', updateFabPosition);
}

async function updateCurrentCity(lat,lng){
  currentCityName = normalizeCityFromPlace(place.value) || await reverseGeocodeCity(lat,lng) || "";
}

function setEditPoint(lat,lng,zoom=18,showHint=false){
  $("#lat").value=lat; $("#lng").value=lng;

  if(editMarker){
    editMarker.setLatLng([lat,lng]);
  } else {
    editMarker = L.marker([lat,lng],{icon:emojiIcon(),draggable:true}).addTo(map);

    // üîí Evita que el mapa se mueva mientras arrastras el pin (m√≥vil y desktop)
    const lockMap = ()=>{ if(map && map.dragging) map.dragging.disable(); };
    const unlockMap = ()=>{ if(map && map.dragging) map.dragging.enable(); };

    editMarker.on('mousedown', lockMap);
    editMarker.on('touchstart', lockMap, {passive:true});
    editMarker.on('dragstart', lockMap);
    editMarker.on('mouseup', unlockMap);
    editMarker.on('touchend', unlockMap, {passive:true});
    editMarker.on('dragend', e=>{
      unlockMap();
      const p=e.target.getLatLng();
      $("#lat").value=p.lat.toFixed(6);
      $("#lng").value=p.lng.toFixed(6);
      fixedBadge.style.display='inline';
      updateFabPosition();
      updateCurrentCity($("#lat").value, $("#lng").value);
    });

    if(showHint){
      editMarker.bindTooltip('Arrastra para ajustar',{permanent:true, direction:'top', offset:[0,-24]}).openTooltip();
    }
    editMarker.on('drag', updateFabPosition);
  }

  map.setView([lat,lng], zoom);
  showFab();
  updateCurrentCity(lat,lng); // async
}

/* === Bot√≥n flotante ‚ÄúPlantar aqu√≠‚Äù === */
function updateFabPosition(){
  if(!plantFab || !editMarker || !map) return;
  const mapEl   = map.getContainer();
  const frameEl = mapEl.parentElement; // .frame

  const p = map.latLngToContainerPoint(editMarker.getLatLng());

  const mapRect   = mapEl.getBoundingClientRect();
  const frameRect = frameEl.getBoundingClientRect();

  const left = p.x + (mapRect.left - frameRect.left);
  const top  = p.y + (mapRect.top  - frameRect.top) + 34; // 34px debajo del pin

  const pad = 8, maxX = frameRect.width - pad, maxY = frameRect.height - pad;
  plantFab.style.left = Math.max(pad, Math.min(left, maxX)) + 'px';
  plantFab.style.top  = Math.max(pad, Math.min(top,  maxY)) + 'px';
}
function showFab(){ if(!plantFab) return; updateFabPosition(); plantFab.style.display='inline-flex'; plantFab.classList.remove('pop'); void plantFab.offsetWidth; plantFab.classList.add('pop'); }
function hideFab(){ if(!plantFab) return; plantFab.style.display='none'; }

/* === AUTOCOMPLETE (Nominatim + estructurado + Photon) === */
let suggestTimer=null, abortCtrl=null, currentSuggest=[];
function hasNumber(s){ return /[0-9]/.test(s); }
function extractNumber(s){ const m=s.match(/([0-9]{1,5})/); return m? m[1]:null; }
function normalizeStreet(q){
  const hasType = /(carrer|calle|avinguda|av\.|avenida|paseo|ps\.|pla√ßa|plaza)/i.test(q);
  if(hasType) return [q];
  const base=q.replace(/\s+/g,' ').trim();
  return ['Calle '+base,'Carrer de '+base,'Avinguda '+base,base];
}
async function searchPlacesPlain(q, signal){
  const url='https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=7&countrycodes=es&q='+encodeURIComponent(q);
  const r=await fetch(url,{signal, headers:{'Accept':'application/json'}}); if(!r.ok) throw new Error('nominatim'); return r.json();
}
async function searchPlacesStructured(q, signal){
  let raw=q, city='';
  if(q.includes(',')){ const parts=q.split(','); raw=parts[0].trim(); city=parts.slice(1).join(',').trim(); }
  const variants = normalizeStreet(raw);
  const all=[];
  for(const street of variants){
    const url='https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=7&countrycodes=es&street='+encodeURIComponent(street)+'&city='+encodeURIComponent(city);
    const r=await fetch(url,{signal, headers:{'Accept':'application/json'}}).catch(()=>null);
    if(r && r.ok){ all.push(...(await r.json())); }
  }
  return all;
}
async function searchPhoton(q, signal){
  const url='https://photon.komoot.io/api/?lang=es&limit=7&q='+encodeURIComponent(q);
  const r=await fetch(url,{signal, headers:{'Accept':'application/json'}}).catch(()=>null);
  if(!r || !r.ok) return [];
  const j=await r.json();
  return (j.features||[]).map(f=>({
    place_id: 'ph'+(f.properties.osm_id||Math.random()),
    lat: f.geometry.coordinates[1],
    lon: f.geometry.coordinates[0],
    display_name: f.properties.name+', '+(f.properties.city||f.properties.town||f.properties.village||'')+', '+(f.properties.state||''),
    address: {
      road: f.properties.street || f.properties.name,
      house_number: f.properties.housenumber,
      city: f.properties.city||f.properties.town||f.properties.village,
      state: f.properties.state
    }
  }));
}
async function searchPlaces(q){
  if(abortCtrl) abortCtrl.abort();
  abortCtrl = new AbortController();
  const sig=abortCtrl.signal;
  try{
    const hasNum = hasNumber(q);
    const A = await searchPlacesPlain(q, sig).catch(()=>[]);
    const B = hasNum ? await searchPlacesStructured(q, sig).catch(()=>[]) : [];
    const C = hasNum ? await searchPhoton(q, sig).catch(()=>[]) : [];
    const list=[...A, ...B, ...C];
    const seenIds=new Set();
    const merged=[]; for(const it of list){ const id=(it.place_id||it.lat+'|'+it.lon); if(!seenIds.has(id)){ seenIds.add(id); merged.push(it); } }
    if(hasNum){
      const num=extractNumber(q);
      merged.sort((x,y)=>{
        const xn=(x.address&&x.address.house_number)||''; const yn=(y.address&&y.address.house_number)||'';
        const xs=(String(xn)===String(num))?1:0; const ys=(String(yn)===String(num))?1:0;
        return ys-xs;
      });
    }
    return merged.slice(0,10);
  } catch(e){ return []; }
}
function renderSuggest(list){
  const q=place.value.trim(); const num=extractNumber(q);
  slist.innerHTML=""; list.forEach((it,idx)=>{
    const row=document.createElement('div'); row.className='sitem';
    const road = it.address?.road || it.address?.pedestrian || it.address?.footway || it.address?.residential || it.address?.path || it.address?.neighbourhood || '';
    const hn = it.address?.house_number || '';
    let primary = (road||hn) ? (road + (hn? ' '+hn: '')) : (it.display_name||'').split(',')[0];
    const city = it.address?.city || it.address?.town || it.address?.village || it.address?.municipality || '';
    const state = it.address?.state || it.address?.province || it.address?.state_district || '';
    const meta = [city, state].filter(Boolean).join(', ');
    if(num){ primary = primary.replace(new RegExp('('+num+')'),' <span class="hl">$1</span> '); }
    row.innerHTML = primary + (meta? ' <small>'+meta+'</small>': '');
    row.onclick=()=>selectSuggest(idx);
    slist.appendChild(row);
  });
  slist.style.display = list.length ? 'block' : 'none';
}
async function selectSuggest(idx){
  const it=currentSuggest[idx]; if(!it) return;
  place.value = it.display_name; slist.style.display='none';
  usedGPS=false; usedMapClick=false;
  const lat = Number(it.lat).toFixed(6), lng = Number(it.lon).toFixed(6);
  setEditPoint(lat,lng,18,true);
  fixedBadge.style.display='inline';
  currentCityName = it.address?.city || it.address?.town || it.address?.village || normalizeCityFromPlace(it.display_name) || currentCityName;
}
place.addEventListener('input', e=>{
  fixedBadge.style.display='none';
  const q=e.target.value.trim();
  clearTimeout(suggestTimer);
  if(!q){ slist.style.display='none'; return; }
  suggestTimer=setTimeout(async()=>{
    try{ currentSuggest = await searchPlaces(q); renderSuggest(currentSuggest); }
    catch{}
  }, 250);
});
addEventListener('click', e=>{ const box=document.querySelector('.sbox'); if(box && !box.contains(e.target)) slist.style.display='none'; });

/* === CONFIRMAR / GPS === */
$("#confirmBtn").onclick = async ()=>{
  const q=place.value.trim(); if(!q){ toast('Escribe una direcci√≥n', false); return; }
  try{
    const r=await searchPlaces(q);
    if(r.length){ const f=r[0]; setEditPoint(Number(f.lat).toFixed(6), Number(f.lon).toFixed(6), 18, true); fixedBadge.style.display='inline'; currentCityName = f.address?.city || f.address?.town || f.address?.village || normalizeCityFromPlace(f.display_name) || currentCityName; }
    else toast('No encontrada', false);
  }catch{ toast('Error buscando direcci√≥n', false); }
};
const gpsBtn = $("#gpsBtn");
if('geolocation' in navigator){
  if(navigator.permissions && navigator.permissions.query){
    navigator.permissions.query({name:'geolocation'}).then(st=>{
      if(st.state !== 'denied'){ gpsBtn.style.display='inline-block'; }
      st.onchange = ()=>{ gpsBtn.style.display = (st.state !== 'denied') ? 'inline-block' : 'none'; };
    }).catch(()=>{ gpsBtn.style.display='inline-block'; });
  } else { gpsBtn.style.display='inline-block'; }
}
gpsBtn.onclick = ()=> navigator.geolocation && navigator.geolocation.getCurrentPosition(async pos=>{
  const lat=pos.coords.latitude.toFixed(6), lng=pos.coords.longitude.toFixed(6);
  usedGPS=true; usedMapClick=false; setEditPoint(lat,lng,18,true); fixedBadge.style.display='inline';
  await updateCurrentCity(lat,lng);
}, ()=>{ toast('Ubicaci√≥n no disponible (activa permisos)', false); gpsBtn.remove(); });

/* === PLANTAR === */
document.getElementById('message').addEventListener('input', ()=>{
  const m=document.getElementById('message'); if(m.value.length>90) m.value=m.value.slice(0,90);
  document.getElementById('chars').textContent='('+m.value.length+'/90)';
});
async function saveFlower(){
  const from=document.getElementById('fromName').value.trim(),
        to=document.getElementById('toName').value.trim(),
        msg=document.getElementById('message').value.trim(),
        type=(document.querySelector('input[name="flowerType"]:checked')||{}).value||'basic';
  const lat=document.getElementById('lat').value.trim(),
        lng=document.getElementById('lng').value.trim();
  let placeText = place.value.trim();
  if(!from||!to||!msg||!lat||!lng){ toast('Completa los campos y fija ubicaci√≥n', false); return; }
  if(!placeText && usedGPS) placeText='Mi ubicaci√≥n';
  if(!placeText && usedMapClick) placeText='Punto del mapa';

  if(!currentCityName) currentCityName = normalizeCityFromPlace(placeText) || await reverseGeocodeCity(lat,lng) || "";

  plantFab.disabled=true; const prevTxt=plantFab.textContent; plantFab.textContent='‚è≥';
  try{
    const body=new URLSearchParams({fromName:from,toName:to,message:msg,place:placeText,lat,lng,flowerType:type}).toString();
    const res=await fetch(SCRIPT_URL,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},body});
    const data=await res.json();
    if(data.ok){
      if(editMarker){ map.removeLayer(editMarker); editMarker=null; }
      const dtStr = fmtDateTime(new Date());
      const html = popupHtml(currentCityName, from, to, msg, dtStr);
      const m=L.marker([+lat,+lng],{icon:emojiIcon()}).addTo(map).bindPopup(html);
      m.on('click',()=>{ map.setView(m.getLatLng(),19); m.openPopup(); });
      map.setView([+lat,+lng],19); m.openPopup();

      const item={lat:+lat,lng:+lng,fromName:from,toName:to,message:msg,timestamp:Date.now(), city: currentCityName, type};
      const key = makeKey(lat, lng, from, to, msg);
      seen.add(key);
      allFlowers.push(item);
      updateCounterUI();

      toast('Flor plantada üå∏');
      const shareUrl=`${location.origin}${location.pathname}?lat=${lat}&lng=${lng}&from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&msg=${encodeURIComponent(msg)}`;
      shareBtn.style.display='inline-block';
      shareBtn.onclick=async()=>{
        try{
          if(navigator.share){ await navigator.share({title:'Flovermaps',text:`Una flor para ${to}`,url:shareUrl}); }
          else { await navigator.clipboard.writeText(shareUrl); shareBtn.textContent='‚úÖ Copiado'; setTimeout(()=>shareBtn.textContent='üîó Compartir',1200); }
        }catch{}
      };

      hideFab();
      document.getElementById('lat').value='';
      document.getElementById('lng').value='';
      fixedBadge.style.display='none';
      currentCityName = "";
    }else{
      toast('No se pudo guardar', false);
    }
  }catch{
    toast('Error de red', false);
  }
  plantFab.disabled=false; plantFab.textContent=prevTxt;
}
if(plantFab){ plantFab.addEventListener('click', saveFlower); }

/* === Cargar flores existentes === */
function guessCityFromPlace(place){
  return normalizeCityFromPlace(place||"");
}
async function addMarkerWithCity(f){
  const lat=+f.lat, lng=+f.lng;
  let city = f.city || guessCityFromPlace(f.place) || "";
  if(!city){ city = await reverseGeocodeCity(lat,lng); }
  const dtStr = f.timestamp ? fmtDateTime(new Date(f.timestamp)) : "";
  const html = popupHtml(city, f.fromName||'', f.toName||'', f.message||'', dtStr);
  const mk=L.marker([lat,lng],{icon:emojiIcon()}).addTo(map).bindPopup(html);
  mk.on('click',()=>{map.setView(mk.getLatLng(),19); mk.openPopup();});
}
async function loadFlowersOnce(){
  try{
    const r=await fetch(SCRIPT_URL, {headers:{'Accept':'application/json','Cache-Control':'no-cache'}});
    const data=await r.json();
    const items=(data.items||[]);
    for(const f of items){
      if(!f.lat||!f.lng) continue;
      const key = makeKey(f.lat, f.lng, f.fromName||'', f.toName||'', f.message||'');
      if(seen.has(key)) continue;
      seen.add(key);
      await addMarkerWithCity(f);
    }
    allFlowers = items.map(f=>({lat:+f.lat,lng:+f.lng,fromName:f.fromName||'',toName:f.toName||'',message:f.message||'',timestamp: f.timestamp ? +new Date(f.timestamp) : Date.now(), place:f.place||'', type:f.flowerType||'basic'}));
    updateCounterUI(true);
  }catch{}
}

function updateCounterUI(initial=false){
  const total = seen.size;
  animateNumber(countNum, total);
  const last = [...allFlowers].sort((a,b)=>b.timestamp-a.timestamp)[0];
  if(last){
    const msg = (last.message||'').slice(0,90);
    lastMsg.textContent = `${last.fromName||'Alguien'} plant√≥ una flor para ${last.toName||'alguien'}: ${msg}`;
  }
}

/* === Arranque === */
document.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('chars').textContent='(0/90)';
  (function waitLeaflet(attempts=12){
    if(window.L){ initMap(); loadFlowersOnce(); }
    else { if(attempts<=0){ toast('No se pudo inicializar el mapa', false); return; } setTimeout(()=>waitLeaflet(attempts-1), 250); }
  })();
});
</script>
</body>
</html>
