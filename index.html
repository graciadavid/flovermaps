<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Flovermaps ‚Äî Sprint 1</title>

<!-- Fuente -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  :root{--pink:#ffe6f0;--sheet:#fff;--ink:#111;--muted:#666;--brand:#111;--ok:#0a7d25;--err:#b30000}
  *{box-sizing:border-box}
  body{margin:0;font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--pink);color:var(--ink)}
  header{position:sticky;top:0;z-index:50;background:#fff;border-bottom:1px solid #eee;padding:10px 14px;font-weight:800}
  .app{position:relative;height:calc(100dvh - 52px)}

  /* Mapa */
  #map{position:absolute;inset:0}
  .mapFab{position:absolute;right:12px;bottom:88px;display:flex;gap:8px;z-index:20}
  .fab{width:44px;height:44px;border-radius:50%;border:none;background:#fff;box-shadow:0 6px 20px rgba(0,0,0,.15);display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer}
  .fab:active{transform:scale(.98)}
  /* Crosshair */
  .crosshair{position:absolute;left:50%;top:50%;transform:translate(-50%,-58%);pointer-events:none;z-index:15;font-size:30px;filter:drop-shadow(0 2px 8px rgba(0,0,0,.25))}
  .crosshair .dot{font-size:30px}

  /* Bottom Sheet */
  .sheet{position:absolute;left:0;right:0;bottom:0;background:var(--sheet);border-radius:16px 16px 0 0;box-shadow:0 -10px 28px rgba(0,0,0,.18);z-index:30}
  .sheetHeader{display:flex;justify-content:center;padding:8px 0}
  .drag{width:40px;height:4px;border-radius:99px;background:#ddd}
  .sheetBody{padding:10px 14px 14px}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  label{display:block;margin:8px 0 4px;font-size:.92rem}
  input,textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:12px;font-size:.95rem}
  textarea{min-height:56px;max-height:80px;resize:vertical}
  .muted{color:var(--muted);font-size:.85rem}
  .help{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .cta{width:100%;padding:14px;border:none;border-radius:12px;background:var(--brand);color:#fff;font-weight:800;margin-top:10px;font-size:1rem;cursor:pointer}
  .cta:disabled{opacity:.45;cursor:not-allowed}

  /* Sugerencias */
  .sbox{position:relative}
  .slist{position:absolute;left:0;right:0;top:100%;margin-top:4px;background:#fff;border:1px solid #e6e6e6;border-radius:12px;box-shadow:0 12px 28px rgba(0,0,0,.12);max-height:240px;overflow:auto;display:none;z-index:40}
  .sitem{padding:10px;cursor:pointer;border-bottom:1px solid #f1f1f1;display:flex;align-items:center;gap:8px}
  .sitem:last-child{border-bottom:0}
  .sitem small{color:var(--muted)}
  .sitem:hover,.sitem[aria-selected="true"]{background:#f7f7f7}

  /* Badge fijado */
  .fixed{display:none;color:var(--ok);font-size:.85rem;margin-top:6px}

  /* Toasts */
  .toast{position:fixed;left:50%;bottom:86px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 12px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.25);z-index:60;opacity:0;pointer-events:none;transition:opacity .2s, bottom .2s}
  .toast.show{opacity:1;bottom:96px}
  .toast[aria-live]{position:fixed}

  /* Desktop layout */
  @media (min-width: 980px){
    .app{display:grid;grid-template-columns:420px 1fr;height:calc(100vh - 52px)}
    #map{position:relative}
    .sheet{position:relative;border-radius:0;box-shadow:none;border-right:1px solid #eee}
    .mapFab{bottom:18px}
  }

  /* Leaflet tweaks */
  .leaflet-marker-icon[src*="marker-icon"]{display:none!important}.leaflet-marker-shadow{display:none!important}
  .emoji-marker{background:transparent;border:none;font-size:28px;line-height:28px;transform:translate(-14px,-28px);pointer-events:none}
</style>
</head>
<body>
<header>üå∏ FLOVERMAPS</header>

<div class="app">
  <!-- MAPA -->
  <div id="map" aria-label="Mapa"></div>
  <div class="crosshair"><span class="dot">üå∏</span></div>

  <!-- FABs dentro del mapa -->
  <div class="mapFab" aria-label="Acciones de mapa">
    <button class="fab" id="locateBtn" title="Usar mi ubicaci√≥n">üß≠</button>
    <button class="fab" id="recenterBtn" title="Recentrar">üîÑ</button>
  </div>

  <!-- SHEET -->
  <section class="sheet" id="sheet" role="dialog" aria-modal="false">
    <div class="sheetHeader"><div class="drag"></div></div>
    <div class="sheetBody">
      <h2 style="margin:0 0 6px;font-size:1.05rem">Planta una flor</h2>

      <!-- Paso 1 y 2 -->
      <div class="row2">
        <div><label>¬øQui√©n la env√≠a?</label><input id="fromName" placeholder="Tu nombre"></div>
        <div><label>¬øPara qui√©n?</label><input id="toName" placeholder="Nombre del destinatario"></div>
      </div>

      <label style="margin-top:8px">Mensaje <span class="muted" id="chars">(0/90)</span></label>
      <textarea id="message" maxlength="90" placeholder="Escribe algo bonito‚Ä¶"></textarea>

      <!-- Paso 3 -->
      <label style="margin-top:8px">Ubicaci√≥n</label>
      <div class="sbox">
        <input id="place" placeholder="Busca un lugar (opcional si usas üß≠)" autocomplete="off" aria-autocomplete="list" aria-expanded="false" aria-controls="slist">
        <div id="slist" class="slist" role="listbox"></div>
      </div>
      <div id="help" class="muted help">Introduce una direcci√≥n y ajusta el punto moviendo el mapa.</div>
      <div id="fixed" class="fixed" role="status">‚úÖ Ubicaci√≥n fijada</div>

      <button id="cta" class="cta" disabled>Continuar</button>

      <!-- hidden inputs -->
      <input type="hidden" id="lat"><input type="hidden" id="lng">
    </div>
  </section>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>
</div>

<script>
  /* ======= Config ======= */
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxKcq4xqM1PB_wfIXibeotizuxw0-UgrPJ0LN70U-bva2Isk8EMwdsWeOk8l2w1DvFmJQ/exec";
  const NOMINATIM_EMAIL = "gracia.david@gmail.com";

  /* ======= Estado ======= */
  let step = 1; // 1: datos, 2: elegir sitio, 3: plantar
  let usedGPS = false;      // si puls√≥ üß≠
  let hasFixedFromSuggestion = false; // eligi√≥ sugerencia
  let currentSuggest = [];  // resultados √∫ltimos
  let suggestIndex = -1;    // navegaci√≥n teclado
  const seen = new Set();   // para no duplicar flores

  const $ = s => document.querySelector(s);

  /* ======= Mapa (Leaflet) ======= */
  const tiles = L.tileLayer("https://basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png",{attribution:"¬© OpenStreetMap ¬© CARTO",maxZoom:19});
  const map = L.map("map",{layers:[tiles],zoomControl:true}).setView([40.4168,-3.7038], 13);
  const flowerIcon = L.divIcon({html:"üå∏",className:"emoji-marker",iconSize:[28,28],iconAnchor:[14,28]});

  function addFlower(lat,lng,html,open=false){
    const m=L.marker([+lat,+lng],{icon:flowerIcon}).addTo(map).bindPopup(html);
    m.on("click",()=>{map.setView(m.getLatLng(),19);m.openPopup();});
    if(open){map.setView([+lat,+lng],19);m.openPopup();}
    return m;
  }

  /* ======= Utilidades ======= */
  function toast(msg, ok=true){
    const el=$("#toast");
    el.textContent = msg;
    el.style.background = ok ? "#111" : "#b30000";
    el.classList.add("show");
    setTimeout(()=>el.classList.remove("show"), 1800);
  }
  function chars(){ $("#chars").textContent = `${$("#message").value.length}/90`; }
  function setLatLng(lat,lng){ $("#lat").value=lat; $("#lng").value=lng; }
  function enableCTA(){ const ready = $("#fromName").value.trim() && $("#toName").value.trim() && $("#message").value.trim().length>0; $("#cta").disabled = !ready; }
  function popupHtml(from,to,msg,dateStr){ return `De ${esc(from)}<br>Para ${esc(to)}<br>üå∏ ${esc(msg)}${dateStr?`<br><small>üìÖ ${dateStr}</small>`:""}`; }
  function esc(s){ return String(s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;","&gt;":">","\"":"&quot;","'":"&#39;"}[m])); }

  /* ======= Sugerencias ======= */
  const slist = $("#slist"), place = $("#place");
  let suggestTimer = null;
  async function searchPlaces(q){
    try{
      const url=`https://nominatim.openstreetmap.org/search?format=json&limit=6&addressdetails=1&q=${encodeURIComponent(q)}&email=${encodeURIComponent(NOMINATIM_EMAIL)}`;
      const r=await fetch(url); return await r.json();
    }catch{ return []; }
  }
  function renderSuggest(list){
    slist.innerHTML="";
    list.forEach((it,idx)=>{
      const city = it.address?.city || it.address?.town || it.address?.village || "";
      const row = document.createElement("div");
      row.className="sitem"; row.setAttribute("role","option"); row.setAttribute("data-idx", idx);
      row.innerHTML = `üìç ${esc(it.display_name.split(",")[0])} <small>${esc(city || it.type || "")}</small>`;
      row.onclick = ()=>selectSuggest(idx);
      slist.appendChild(row);
    });
    slist.style.display = list.length ? "block" : "none";
    place.setAttribute("aria-expanded", list.length ? "true" : "false");
  }
  async function selectSuggest(idx){
    const it = currentSuggest[idx]; if(!it) return;
    place.value = it.display_name;
    slist.style.display="none"; place.setAttribute("aria-expanded","false");
    hasFixedFromSuggestion = true; usedGPS = false;
    const lat = Number(it.lat).toFixed(6), lng = Number(it.lon).toFixed(6);
    setLatLng(lat,lng);
    map.setView([lat,lng], 18);
    $("#fixed").style.display="block";
    step = 3; updateCTA();
  }

  place.addEventListener("input", e=>{
    $("#fixed").style.display="none"; hasFixedFromSuggestion=false;
    const q = e.target.value.trim();
    clearTimeout(suggestTimer);
    if(!q){ slist.style.display="none"; place.setAttribute("aria-expanded","false"); return; }
    suggestTimer = setTimeout(async ()=>{
      currentSuggest = await searchPlaces(q);
      suggestIndex = -1; renderSuggest(currentSuggest);
    }, 220);
  });
  place.addEventListener("keydown", e=>{
    if(slist.style.display!=="block") return;
    const max = currentSuggest.length-1;
    if(e.key==="ArrowDown"){ e.preventDefault(); suggestIndex = Math.min(max, suggestIndex+1); highlightSuggest(); }
    else if(e.key==="ArrowUp"){ e.preventDefault(); suggestIndex = Math.max(0, suggestIndex-1); highlightSuggest(); }
    else if(e.key==="Enter"){ e.preventDefault(); if(suggestIndex>=0) selectSuggest(suggestIndex); }
    else if(e.key==="Escape"){ slist.style.display="none"; place.setAttribute("aria-expanded","false"); }
  });
  function highlightSuggest(){
    [...slist.children].forEach((c,i)=>c.setAttribute("aria-selected", i===suggestIndex ? "true":"false"));
    slist.children[suggestIndex]?.scrollIntoView({block:"nearest"});
  }
  document.addEventListener("click", e=>{ if(!$(".sbox").contains(e.target)) { slist.style.display="none"; place.setAttribute("aria-expanded","false"); }});

  /* ======= FABs ======= */
  $("#locateBtn").onclick = ()=> navigator.geolocation && navigator.geolocation.getCurrentPosition(pos=>{
    const lat = pos.coords.latitude.toFixed(6), lng = pos.coords.longitude.toFixed(6);
    map.setView([lat,lng], 18);
    setLatLng(lat,lng);
    usedGPS = true; hasFixedFromSuggestion=false;
    $("#fixed").style.display="block";
    step = 3; updateCTA();
  });
  $("#recenterBtn").onclick = ()=> map.setView(map.getCenter(), 16);

  /* ======= CTA √∫nico ======= */
  function updateCTA(){
    if(step===1) $("#cta").textContent = "Continuar";
    else if(step===2) $("#cta").textContent = "Elegir sitio";
    else $("#cta").textContent = "Plantar aqu√≠";
  }
  updateCTA();

  $("#fromName,#toName,#message").forEach?null:null; // older browsers safe guard
  ["fromName","toName","message"].forEach(id=>{ $("#"+id).addEventListener("input", ()=>{ enableCTA(); chars(); }); });
  enableCTA(); chars();

  $("#cta").onclick = async ()=>{
    if(step===1){ step=2; updateCTA(); toast("Paso 2: elige el sitio moviendo el mapa"); return; }
    if(step===2){
      // Si no fij√≥ por sugerencia o GPS, usa el centro del mapa
      const c = map.getCenter();
      setLatLng(c.lat.toFixed(6), c.lng.toFixed(6));
      $("#fixed").style.display="block";
      step=3; updateCTA(); return;
    }
    if(step===3){ await plantHere(); }
  };

  // Cuando se mueve el mapa en el paso 2, borra el ‚Äúfijado‚Äù
  map.on("movestart", ()=>{
    if(step===2){ $("#fixed").style.display="none"; }
  });

  /* ======= Guardar flor ======= */
  async function plantHere(){
    const from=$("#fromName").value.trim(), to=$("#toName").value.trim(), msg=$("#message").value.trim();
    let placeText = $("#place").value.trim();
    const lat=$("#lat").value.trim(), lng=$("#lng").value.trim();
    // permitir vac√≠o si us√≥ GPS o eligi√≥ del mapa (paso 2)
    if(!placeText && (usedGPS || !hasFixedFromSuggestion)) placeText = "Punto del mapa";

    if(!from||!to||!msg||!lat||!lng){ toast("Completa los datos y la ubicaci√≥n", false); return; }

    $("#cta").disabled = true; $("#cta").textContent = "Plantando‚Ä¶";
    try{
      const body=new URLSearchParams({fromName:from,toName:to,message:msg,place:placeText,lat,lng}).toString();
      const res=await fetch(SCRIPT_URL,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body});
      const data=await res.json();
      if(data.ok){
        // pintar optimista
        const dateStr = new Date().toLocaleDateString("es-ES");
        addFlower(lat, lng, popupHtml(from,to,msg,dateStr), true);
        toast(`Flor para ${to} lista üíñ`);
        shareNow(from,to,msg,lat,lng);
        // reset suave
        $("#message").value=""; $("#chars").textContent="0/90";
        $("#cta").disabled=false; $("#cta").textContent="Continuar"; step=1; updateCTA();
        $("#fixed").style.display="none"; usedGPS=false; hasFixedFromSuggestion=false;
      }else{
        toast("No se pudo guardar. Intenta de nuevo.", false);
        $("#cta").disabled=false; updateCTA();
      }
    }catch{
      toast("Sin conexi√≥n. Intenta m√°s tarde.", false);
      $("#cta").disabled=false; updateCTA();
    }
  }

  /* ======= Compartir ======= */
  function shareNow(from,to,msg,lat,lng){
    const url=`${location.origin}${location.pathname}?lat=${lat}&lng=${lng}&from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&msg=${encodeURIComponent(msg)}`;
    if(navigator.share){
      navigator.share({title:"Flovermaps",text:`Una flor para ${to}`,url}).catch(()=>{});
    }else{
      navigator.clipboard.writeText(url).then(()=>toast("Enlace copiado üìã"));
    }
  }

  /* ======= Cargar flores existentes ======= */
  async function loadFlowers(){
    try{
      const r=await fetch(SCRIPT_URL); const data=await r.json();
      (data.items||[]).forEach(f=>{
        if(!f.lat||!f.lng) return;
        const k=`${+f.lat},${+f.lng}|${f.fromName||''}|${f.toName||''}|${f.message||''}|${f.timestamp||''}`;
        if(seen.has(k)) return; seen.add(k);
        const dateStr = f.timestamp ? new Date(f.timestamp).toLocaleDateString("es-ES") : "";
        addFlower(f.lat, f.lng, popupHtml(f.fromName||"", f.toName||"", f.message||"", dateStr), false);
      });
    }catch{/* silencio */}
  }
  loadFlowers(); setInterval(loadFlowers, 30000);

  /* ======= Helpers varios ======= */
  // Tocar fuera de la sheet en m√≥vil la baja un poco (decorativo)
  if (matchMedia("(max-width: 979px)").matches){
    const sheet = $("#sheet");
    let startY=null, startTop=null;
    sheet.addEventListener("touchstart", (e)=>{ startY=e.touches[0].clientY; startTop=sheet.offsetTop; }, {passive:true});
    sheet.addEventListener("touchmove", (e)=>{
      if(startY==null) return;
      const dy = e.touches[0].clientY - startY;
      const newTop = Math.max(0, startTop + dy);
      if(newTop<window.innerHeight*0.35) return; // l√≠mite superior
      sheet.style.transform=`translateY(${Math.min(dy, 200)}px)`;
    }, {passive:true});
    sheet.addEventListener("touchend", ()=>{ sheet.style.transform="translateY(0)"; startY=null; }, {passive:true});
  }
</script>
</body>
</html>
