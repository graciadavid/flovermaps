<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Flovermaps</title>

<!-- Favicon y meta -->
<link rel="icon" href="https://drive.google.com/uc?export=view&id=1M6rOGfSV-YotIBXnYT_KCiXKSLmL5SzW" type="image/png">
<meta name="theme-color" content="#ffffff" />
<meta name="description" content="Planta flores en el mapa y dedica mensajes bonitos." />

<!-- Tipograf√≠a y Leaflet -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  :root{--ink:#111;--muted:#666; --pink:#ffe6f0}
  *{box-sizing:border-box}
  body{margin:0;font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--pink);color:var(--ink)}

  /* Header con logo (con fallback robusto) */
  .site-header{\n    position:sticky; top:0; z-index:10;\n    display:flex; align-items:center; justify-content:center; gap:10px;\n    padding:16px 18px; background:#fff; border-bottom:1px solid #eee;\n    min-height:88px\n  }
  .logo-img{display:block; height:64px; width:auto; max-width:100%; object-fit:contain}
  .logo-fallback{display:none;font-weight:800;letter-spacing:1px}
  @media (min-width:900px){ .logo-img{height:96px} }

  /* Contador simple */
  .counter{margin:8px 12px 0; padding:8px 12px; border-radius:12px; background:#fff}
  .counter .top{font-weight:800}

  /* Layout */
  .wrap{display:flex; gap:0; min-height:calc(100vh - 52px - 56px)}
  .panel{
    width:420px; max-width:100%; padding:12px; border-right:1px solid #eee; overflow:auto;
    background:var(--pink)
  }
  .card{border:1px solid #e8e8e8; border-radius:12px; padding:12px; background:#fff}
  h1{font-size:1.05rem; margin:0 0 8px}
  label{display:block; margin:6px 0 4px; font-size:.92rem}
  input,textarea,button{width:100%; padding:10px; border:1px solid #ddd; border-radius:10px; font-size:.95rem}
  textarea{min-height:56px; resize:vertical}
  .muted{color:var(--muted); font-size:.85rem}
  .row2{display:grid; grid-template-columns:1fr 1fr; gap:8px}
  .actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:6px}
  .actions button{padding:9px 10px; font-size:.9rem}
  .badge{display:none; color:#0a7d25; font-size:.85rem; margin-top:6px}

  /* Autocomplete */
  .sbox{position:relative}
  .slist{
    position:absolute; left:0; right:0; top:100%; margin-top:4px; background:#fff;
    border:1px solid #e6e6e6; border-radius:10px; max-height:200px; overflow:auto;
    display:none; z-index:20
  }
  .sitem{padding:8px 10px; border-bottom:1px solid #f3f3f3; cursor:pointer; font-size:.95rem}
  .sitem:last-child{border-bottom:0}
  .sitem small{color:#777}
  .sitem:hover{background:#f8f8f8}

  /* Mapa */
  .mapArea{flex:1; padding:10px 12px; background:var(--pink)}
  .frame{position:relative; border:1px solid #e8e8e8; border-radius:12px; overflow:hidden; background:#fff}
  #map{width:100%; height:520px}
  @media (max-width:1024px){ #map{height:50vh} }

  .below{display:flex; gap:8px; justify-content:center; padding:10px 0; flex-wrap:wrap}
  #plantBtn{max-width:320px; display:none; background:#444; color:#fff; border:0; border-radius:10px}
  #shareBtn{background:#0066cc; color:#fff; border:0; border-radius:10px; max-width:320px; display:none}

  /* Leaflet */
  .leaflet-marker-icon[src*="marker-icon"]{display:none!important}
  .leaflet-marker-shadow{display:none!important}
  .emoji-marker{background:transparent; border:none; font-size:28px; line-height:28px; transform:translate(-14px,-28px); pointer-events:none}

  /* Responsive: mapa debajo del formulario */
  @media (max-width: 1024px){
    .wrap{flex-direction:column;}
    .panel{width:100%; border-right:0;}
  }

  /* Toast */
  .toast{position:fixed; left:50%; bottom:82px; transform:translateX(-50%); background:#111; color:#fff;
    padding:10px 12px; border-radius:10px; z-index:50; opacity:0; pointer-events:none; transition:opacity .18s, bottom .18s}
  .toast.show{opacity:1; bottom:92px}
</style>
</head>
<body>

<!-- Header con LOGO (con fallback a texto si el enlace de Drive falla) -->
<header class="site-header">\n  <img\n    id="logoImg"\n    src="logo.png"\n    data-drive="https://drive.google.com/uc?export=view&id=1M6rOGfSV-YotIBXnYT_KCiXKSLmL5SzW"\n    alt="FLOVERMA

<!-- Contador -->
<div class="counter"><div class="top" id="countTop">üå∏ 0 PLANTADAS</div></div>

<div class="wrap">
  <!-- FORMULARIO -->
  <section class="panel" id="panel">
    <div class="card">
      <h1>Planta una flor</h1>

      <div class="row2">
        <div><label for="fromName">¬øQui√©n la env√≠a?</label><input id="fromName" placeholder="Tu nombre" /></div>
        <div><label for="toName">¬øPara qui√©n?</label><input id="toName" placeholder="Nombre del destinatario" /></div>
      </div>

      <label for="message" style="margin-top:8px">Mensaje <span class="muted" id="chars">(0/90)</span></label>
      <textarea id="message" maxlength="90" placeholder="Escribe algo bonito‚Ä¶"></textarea>

      <label for="place" style="margin-top:8px">Ubicaci√≥n</label>
      <div class="sbox">
        <input id="place" placeholder="Ej. Sagrada Fam√≠lia, Barcelona 12" autocomplete="off" />
        <div id="slist" class="slist"></div>
      </div>
      <div class="muted" id="help">Escribe y elige una sugerencia, o haz clic en el mapa. Si tu navegador permite geolocalizaci√≥n, aparecer√° el bot√≥n.</div>
      <div class="badge" id="fixed">‚úÖ Ubicaci√≥n fijada</div>

      <div class="actions">
        <button id="confirmBtn" type="button" style="background:#444;color:#fff;border:0;border-radius:10px">‚úÖ Confirmar direcci√≥n</button>
        <button id="gpsBtn" type="button" style="background:#444;color:#fff;border:0;border-radius:10px; display:none">üìç Usar mi ubicaci√≥n</button>
      </div>

      <input type="hidden" id="lat"><input type="hidden" id="lng">
    </div>
  </section>

  <!-- MAPA -->
  <section class="mapArea">
    <div class="frame"><div id="map"></div></div>
    <div class="below">
      <button id="plantBtn">‚úÖ Plantar aqu√≠</button>
      <button id="shareBtn">üîó Compartir</button>
    </div>
  </section>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* === CONFIG === */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxKcq4xqM1PB_wfIXibeotizuxw0-UgrPJ0LN70U-bva2Isk8EMwdsWeOk8l2w1DvFmJQ/exec";
const NOMINATIM_EMAIL = "gracia.david@gmail.com";

/* === STATE === */
const seen = new Set();
let editMarker = null; // √öNICA declaraci√≥n
let usedGPS = false, usedMapClick = false;

/* === DOM === */
const $ = s => document.querySelector(s);
const slist = document.getElementById("slist"), place = document.getElementById("place");
const plantBtn = document.getElementById("plantBtn"), shareBtn = document.getElementById("shareBtn"), fixedBadge = document.getElementById("fixed");

/* === MAP === */
const tiles = L.tileLayer("https://basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png",{attribution:"¬© OpenStreetMap ¬© CARTO",maxZoom:19});
const map = L.map("map",{layers:[tiles],zoomControl:true});
map.setView([40.4168,-3.7038], 13);  // Madrid por defecto
setTimeout(()=>map.invalidateSize(), 100);

const flowerIcon = L.divIcon({html:"üå∏",className:"emoji-marker",iconSize:[28,28],iconAnchor:[14,28]});

/* === HELPERS === */
function toast(msg, ok=true){ const t=document.getElementById("toast"); t.textContent=msg; t.style.background=ok?"#111":"#b30000"; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),1600); }
function esc(s){ return String(s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
function popupHtml(from,to,msg,dateStr){ return `De ${esc(from)}<br>Para ${esc(to)}<br>üå∏ ${esc(msg)}${dateStr?`<br><small>üìÖ ${dateStr}</small>`:""}`; }
function fmtDate(d){ return `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}/${d.getFullYear()}`; }
function updateCount(){ document.getElementById("countTop").textContent = `üå∏ ${seen.size} PLANTADAS`; }
function setLatLng(lat,lng){ document.getElementById("lat").value=lat; document.getElementById("lng").value=lng; plantBtn.style.display="inline-block"; }

/* === SUGERENCIAS (con cancelaci√≥n) === */
let suggestTimer=null, abortCtrl=null, currentSuggest=[];
async function searchPlaces(q){
  if(abortCtrl) abortCtrl.abort();
  abortCtrl = new AbortController();
  const url=`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=5&q=${encodeURIComponent(q)}&email=${encodeURIComponent(NOMINATIM_EMAIL)}`;
  const r=await fetch(url,{signal:abortCtrl.signal, headers:{"Accept":"application/json"}});
  if(!r.ok) throw new Error("Nominatim error");
  return await r.json();
}
function renderSuggest(list){
  slist.innerHTML=""; list.forEach((it,idx)=>{
    const row=document.createElement("div"); row.className="sitem";
    const road = it.address?.road || it.address?.pedestrian || it.address?.footway || it.address?.residential || it.address?.path || it.address?.neighbourhood;
    const hn = it.address?.house_number;
    const primary = (road || hn) ? `${esc(road||"")} ${esc(hn||"")}`.trim() : (it.display_name||"").split(",")[0];
    const city = it.address?.city || it.address?.town || it.address?.village || it.address?.municipality;
    const state = it.address?.state || it.address?.province || it.address?.state_district;
    const meta = [city, state].filter(Boolean).join(", ");
    row.innerHTML = `${primary} <small>${esc(meta)}</small>`;
    row.onclick=()=>selectSuggest(idx);
    slist.appendChild(row);
  });
  slist.style.display = list.length ? "block" : "none";
}
async function selectSuggest(idx){
  const it=currentSuggest[idx]; if(!it) return;
  place.value = it.display_name; slist.style.display="none";
  usedGPS=false; usedMapClick=false;
  const lat = Number(it.lat).toFixed(6), lng = Number(it.lon).toFixed(6);
  setEditPoint(lat,lng,18,true);
  fixedBadge.style.display="inline";
}
place.addEventListener("input", e=>{
  fixedBadge.style.display="none";
  const q=e.target.value.trim();
  clearTimeout(suggestTimer);
  if(!q){ slist.style.display="none"; return; }
  suggestTimer=setTimeout(async()=>{
    try{ currentSuggest = await searchPlaces(q); renderSuggest(currentSuggest); }
    catch{ /* cancelada o error de red */ }
  }, 250);
});
// cerrar lista si clic fuera
addEventListener("click", e=>{ const box=document.querySelector(".sbox"); if(box && !box.contains(e.target)) slist.style.display="none"; });

/* === CONFIRMAR / GPS === */
document.getElementById("confirmBtn").onclick = async ()=>{
  const q=place.value.trim(); if(!q){ toast("Escribe una direcci√≥n", false); return; }
  try{
    const r=await searchPlaces(q);
    if(r.length){ const f=r[0]; setEditPoint(Number(f.lat).toFixed(6), Number(f.lon).toFixed(6), 18, true); fixedBadge.style.display="inline"; }
    else toast("No encontrada", false);
  }catch{ toast("Error buscando direcci√≥n", false); }
};
const gpsBtn = document.getElementById("gpsBtn");
if('geolocation' in navigator){
  // Mostrar solo si permisos no est√°n denegados
  if(navigator.permissions && navigator.permissions.query){
    navigator.permissions.query({name:'geolocation'}).then(st=>{
      if(st.state !== 'denied'){ gpsBtn.style.display='inline-block'; }
      st.onchange = ()=>{ gpsBtn.style.display = (st.state !== 'denied') ? 'inline-block' : 'none'; };
    }).catch(()=>{ gpsBtn.style.display='inline-block'; });
  } else {
    gpsBtn.style.display='inline-block';
  }
}
gpsBtn.onclick = ()=> navigator.geolocation && navigator.geolocation.getCurrentPosition(pos=>{
  const lat=pos.coords.latitude.toFixed(6), lng=pos.coords.longitude.toFixed(6);
  usedGPS=true; usedMapClick=false; setEditPoint(lat,lng,18,true); fixedBadge.style.display="inline";
}, ()=>{ toast("Ubicaci√≥n no disponible (activa permisos)", false); gpsBtn.remove(); });

/* === EDITAR PUNTO (arrastrable) === */
function setEditPoint(lat,lng,zoom=18,showHint=false){
  setLatLng(lat,lng);
  if(editMarker){ editMarker.setLatLng([lat,lng]); }
  else{
    editMarker = L.marker([lat,lng],{icon:flowerIcon,draggable:true}).addTo(map);
    if(showHint){ editMarker.bindTooltip("Arrastra para ajustar",{permanent:true, direction:"top", offset:[0,-24]}).openTooltip(); }
    editMarker.on("dragend", e=>{
      const p=e.target.getLatLng(); setLatLng(p.lat.toFixed(6), p.lng.toFixed(6)); fixedBadge.style.display="inline";
    });
  }
  map.setView([lat,lng], zoom);
}
map.on("click", e=>{
  usedMapClick=true; usedGPS=false;
  setEditPoint(e.latlng.lat.toFixed(6), e.latlng.lng.toFixed(6), 18, true);
});

/* === PLANTAR === */
document.getElementById("message").addEventListener("input", ()=>{
  const m=document.getElementById("message"); if(m.value.length>90) m.value=m.value.slice(0,90);
  document.getElementById("chars").textContent=`(${m.value.length}/90)`;
});
plantBtn.onclick = saveFlower;

async function saveFlower(){
  const from=document.getElementById("fromName").value.trim(), to=document.getElementById("toName").value.trim(), msg=document.getElementById("message").value.trim();
  const lat=document.getElementById("lat").value.trim(), lng=document.getElementById("lng").value.trim();
  let placeText = place.value.trim();
  if(!from||!to||!msg||!lat||!lng){ toast("Completa los campos y fija ubicaci√≥n", false); return; }
  if(!placeText && usedGPS) placeText="Mi ubicaci√≥n";
  if(!placeText && usedMapClick) placeText="Punto del mapa";

  plantBtn.disabled=true; plantBtn.textContent="Plantando‚Ä¶";
  try{
    const body=new URLSearchParams({fromName:from,toName:to,message:msg,place:placeText,lat,lng}).toString();
    const res=await fetch(SCRIPT_URL,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body});
    const data=await res.json();
    if(data.ok){
      // convierto a flor definitiva
      if(editMarker){ map.removeLayer(editMarker); editMarker=null; }
      const html = popupHtml(from,to,msg,fmtDate(new Date()));
      const m=L.marker([+lat,+lng],{icon:flowerIcon}).addTo(map).bindPopup(html);
      m.on("click",()=>{ map.setView(m.getLatLng(),19); m.openPopup(); });
      map.setView([+lat,+lng],19); m.openPopup();
      seen.add(`${lat},${lng}|${from}|${to}|${msg}`); updateCount();
      toast("Flor plantada üå∏");
      // compartir
      const shareUrl=`${location.origin}${location.pathname}?lat=${lat}&lng=${lng}&from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&msg=${encodeURIComponent(msg)}`;
      shareBtn.style.display="inline-block";
      shareBtn.onclick=async()=>{
        try{
          if(navigator.share){ await navigator.share({title:"Flovermaps",text:`Una flor para ${to}`,url:shareUrl}); }
          else{ await navigator.clipboard.writeText(shareUrl); shareBtn.textContent="‚úÖ Copiado"; setTimeout(()=>shareBtn.textContent="üîó Compartir",1200); }
        }catch{}
      };
      // reset suave
      plantBtn.style.display="none"; plantBtn.disabled=false; plantBtn.textContent="‚úÖ Plantar aqu√≠";
      fixedBadge.style.display="none"; document.getElementById("lat").value=""; document.getElementById("lng").value="";
    }else{
      toast("No se pudo guardar", false);
      plantBtn.disabled=false; plantBtn.textContent="‚úÖ Plantar aqu√≠";
    }
  }catch{
    toast("Error de red", false);
    plantBtn.disabled=false; plantBtn.textContent="‚úÖ Plantar aqu√≠";
  }
}

/* === Cargar flores existentes (una vez) === */
async function loadFlowersOnce(){
  try{
    const r=await fetch(SCRIPT_URL, {headers:{"Accept":"application/json"}}); const data=await r.json();
    (data.items||[]).forEach(f=>{
      if(!f.lat||!f.lng) return;
      const key=`${+f.lat},${+f.lng}|${f.fromName||''}|${f.toName||''}|${f.message||''}|${f.timestamp||''}`;
      if(seen.has(key)) return; seen.add(key);
      const dateStr = f.timestamp ? new Date(f.timestamp).toLocaleDateString("es-ES") : "";
      const m=L.marker([+f.lat,+f.lng],{icon:flowerIcon}).addTo(map).bindPopup(popupHtml(f.fromName||"", f.toName||"", f.message||"", dateStr));
      m.on("click",()=>{map.setView(m.getLatLng(),19); m.openPopup();});
    });
    updateCount();
  }catch{ /* silencio */ }
}

/* === URL params para abrir una flor compartida === */
function initFromURL(){
  const u=new URL(location.href);
  const lat=u.searchParams.get('lat'), lng=u.searchParams.get('lng');
  const from=u.searchParams.get('from')||"", to=u.searchParams.get('to')||"", msg=u.searchParams.get('msg')||"";
  if(lat && lng){
    const m=L.marker([+lat,+lng],{icon:flowerIcon}).addTo(map).bindPopup(popupHtml(from,to,msg));
    map.setView([+lat,+lng], 17); m.openPopup();
  }
}

document.addEventListener("DOMContentLoaded", ()=>{
  document.getElementById("chars").textContent="(0/90)";
  loadFlowersOnce();
  initFromURL();
});
</script>
</body>
</html>
