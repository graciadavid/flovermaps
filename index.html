<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Flovermaps â€“ Planta una flor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Leaflet (mapa gratis con OpenStreetMap) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#fafafa; }
    .wrap { display:flex; min-height:100vh; }
    #map { flex:1; min-height:100vh; }
    .panel { width:380px; max-width:100%; padding:20px; border-left: 1px solid #eee; background:#fff; }
    .panel h1 { font-size:1.25rem; margin:0 0 12px; }
    label { display:block; font-size:.9rem; margin:12px 0 6px; }
    input, textarea, button { width:100%; padding:10px; font-size:1rem; border:1px solid #ddd; border-radius:8px; }
    textarea { min-height:90px; resize:vertical; }
    .row { display:flex; gap:10px; }
    .row > div { flex:1; }
    .small { color:#666; font-size:.85rem; }
    .ok { color: #0a7d25; }
    .error { color: #b30000; }
    .footer { margin-top:14px; font-size:.85rem; color:#555; }
    button { cursor:pointer; background:#111; color:#fff; border:0; border-radius:10px; }
  </style>
</head>
<body>
<div class="wrap">
  <div id="map"></div>
  <div class="panel">
    <h1>Planta una flor ðŸŒ¸</h1>

    <label>Â¿QuiÃ©n la envÃ­a?</label>
    <input id="fromName" placeholder="Tu nombre" autocomplete="name" />

    <label>Â¿Para quiÃ©n?</label>
    <input id="toName" placeholder="Nombre del destinatario" />

    <label>Mensaje</label>
    <textarea id="message" placeholder="Escribe algo bonitoâ€¦"></textarea>

    <label>UbicaciÃ³n (escribe y elige una sugerencia)</label>
    <input id="place" placeholder="Ej. Parc GÃ¼ell, Barcelona" list="suggestions" />
    <datalist id="suggestions"></datalist>
    <div class="small">Escribe, espera 1 segundo y elige una sugerencia para fijar el punto.</div>

    <div class="row">
      <div>
        <label>Lat</label>
        <input id="lat" placeholder="latitud" readonly />
      </div>
      <div>
        <label>Lon</label>
        <input id="lng" placeholder="longitud" readonly />
      </div>
    </div>

    <button id="plantBtn">Plantar flor</button>
    <div id="status" class="small"></div>

    <div class="footer">
      Mapa: OpenStreetMap + Leaflet (gratis). Geocoding: vÃ­a tu Apps Script (Nominatim).
    </div>
  </div>
</div>

<script>
  // === Config ===
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzPc0nFfMUoC-chPR5KYLIeEH1I79-7JO3zztxZNGUfRekUK1qjzX-3Su7caKdLEBZoYQ/exec';

  // === Mapa ===
  const map = L.map('map').setView([40.4168, -3.7038], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap'
  }).addTo(map);

  let marker = null;

  // === UI helpers ===
  const $ = sel => document.querySelector(sel);
  const statusEl = $('#status');
  function setStatus(msg, cls='') { statusEl.className='small '+cls; statusEl.textContent=msg; }

  // === Autocompletado (consulta a tu Apps Script, que llama a Nominatim) ===
  let typingTimer = null;
  $('#place').addEventListener('input', e => {
    const q = e.target.value.trim();
    clearTimeout(typingTimer);
    if (!q) { $('#suggestions').innerHTML=''; return; }
    typingTimer = setTimeout(async () => {
      try {
        const res = await fetch(SCRIPT_URL + '?q=' + encodeURIComponent(q));
        const data = await res.json();
        if (!data.ok) return;
        const list = data.items || [];
        const dl = $('#suggestions');
        dl.innerHTML = '';
        list.forEach(item => {
          const opt = document.createElement('option');
          opt.value = item.display_name;
          opt.dataset.lat = item.lat;
          opt.dataset.lon = item.lon;
          dl.appendChild(opt);
        });
      } catch (err) {
        // silencio: puede fallar si escriben muy rÃ¡pido
      }
    }, 800); // espera breve para no saturar
  });

  // Cuando el usuario sale del input "place", si coincide con una sugerencia, fijamos lat/lon y marcador
  $('#place').addEventListener('change', () => {
    const val = $('#place').value;
    const options = Array.from($('#suggestions').children);
    const match = options.find(o => o.value === val);
    if (match) {
      const lat = parseFloat(match.dataset.lat);
      const lon = parseFloat(match.dataset.lon);
      $('#lat').value = lat.toFixed(6);
      $('#lng').value = lon.toFixed(6);
      if (marker) map.removeLayer(marker);
      marker = L.marker([lat, lon]).addTo(map).bindPopup(val).openPopup();
      map.setView([lat, lon], 12);
    }
  });

  // === Cargar flores existentes ===
  async function loadFlowers() {
    try {
      const res = await fetch(SCRIPT_URL);
      const data = await res.json();
      if (!data.ok) return;
      (data.items || []).forEach(f => {
        if (f.lat && f.lng) {
          L.marker([Number(f.lat), Number(f.lng)])
            .addTo(map)
            .bindPopup(`ðŸŒ¸ <b>${escapeHtml(f.toName||'')}</b><br>${escapeHtml(f.message||'')}<br><small>Por ${escapeHtml(f.fromName||'')} â€¢ ${escapeHtml(f.place||'')}</small>`);
        }
      });
    } catch (err) {
      // si falla, no rompemos nada
    }
  }

  // === Plantar flor (guardar en Google Sheet) ===
  $('#plantBtn').addEventListener('click', async () => {
    const fromName = $('#fromName').value.trim();
    const toName   = $('#toName').value.trim();
    const message  = $('#message').value.trim();
    const place    = $('#place').value.trim();
    const lat      = $('#lat').value.trim();
    const lng      = $('#lng').value.trim();

    if (!fromName || !toName || !message || !place || !lat || !lng) {
      setStatus('Completa todos los campos y elige una sugerencia para fijar la ubicaciÃ³n.', 'error');
      return;
    }
    setStatus('Guardando florâ€¦');

    try {
      const res = await fetch(SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ fromName, toName, message, place, lat, lng })
      });
      const data = await res.json();
      if (data.ok) {
        setStatus('Â¡Flor plantada! Recarga para verla junto a las demÃ¡s.', 'ok');
        const latN = Number(lat), lngN = Number(lng);
        if (marker) marker.remove();
        L.marker([latN, lngN])
          .addTo(map)
          .bindPopup(`ðŸŒ¸ <b>${escapeHtml(toName)}</b><br>${escapeHtml(message)}<br><small>Por ${escapeHtml(fromName)} â€¢ ${escapeHtml(place)}</small>`)
          .openPopup();
        map.setView([latN, lngN], 12);
      } else {
        setStatus('No se pudo guardar: ' + (data.error||'Error desconocido'), 'error');
      }
    } catch (err) {
      setStatus('Error de red al guardar la flor.', 'error');
    }
  });

  function escapeHtml(s) { return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  // iniciar
  loadFlowers();
</script>
</body>
</html>
