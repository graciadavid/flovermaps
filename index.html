<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flovermaps â€” Estable (Leaflet + Apps Script)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
  <style>
    :root{
      --bg:#0b0f14; --panel:#111823; --accent:#26c281; --accent-2:#ff6fa9; --text:#e6eef7; --muted:#9fb3c8; --border:#1f2a3a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:500 15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial}
    a{color:var(--accent)}
    .wrap{display:grid;grid-template-columns:1.5fr 1fr;gap:0;min-height:100vh}
    #map{height:100vh;width:100%}
    .panel{background:linear-gradient(180deg, #0e1420 0%, #0b0f14 100%);border-left:1px solid var(--border);display:flex;flex-direction:column}
    header{padding:14px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
    .badge{background:#0f1a28;border:1px solid var(--border);padding:4px 8px;border-radius:999px;color:var(--muted);font-size:12px}
    form{padding:16px;display:grid;gap:12px}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{width:100%;background:#0e1622;border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:12px;outline:none}
    input::placeholder,textarea::placeholder{color:#6b7f96}
    textarea{min-height:84px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 14px;background:var(--accent);color:#041215;font-weight:700;cursor:pointer}
    .btn.secondary{background:#142031;color:var(--text);border:1px solid var(--border)}
    .hint{color:var(--muted);font-size:12px}
    .list{padding:12px 16px 18px 16px;border-top:1px solid var(--border);}
    .item{padding:10px 0;border-bottom:1px dashed var(--border);cursor:pointer}
    .item:last-child{border-bottom:0}
    @media (max-width: 960px){ .wrap{grid-template-columns:1fr; } #map{height:56vh} }
  </style>
</head>
<body>
  <div class="wrap">
    <div id="map"></div>

    <aside class="panel">
      <header>
        <div style="width:10px;height:10px;border-radius:999px;background:var(--accent)"></div>
        <div style="font-weight:700">Flovermaps</div>
        <div class="badge">Plant Love Forever</div>
      </header>

      <form id="flowerForm" autocomplete="off">
        <div>
          <label for="address">UbicaciÃ³n</label>
          <div class="row">
            <input id="address" name="address" placeholder="Calle, ciudadâ€¦" />
            <button type="button" class="btn secondary" id="btnSearch">Buscar</button>
          </div>
          <div class="row" style="margin-top:8px">
            <button type="button" class="btn secondary" id="btnUseLocation">Usar mi ubicaciÃ³n</button>
            <button type="button" class="btn secondary" id="btnConfirmAddress">Confirmar direcciÃ³n</button>
          </div>
          <div class="hint">Mueve el pin si necesitas ajustar unos metros.</div>
        </div>

        <div class="row">
          <div>
            <label for="from">Â¿QuiÃ©n envÃ­a?</label>
            <input id="from" name="from" placeholder="Tu nombre" />
          </div>
          <div>
            <label for="to">Â¿Para quiÃ©n?</label>
            <input id="to" name="to" placeholder="Nombre del destinatario" />
          </div>
        </div>

        <div>
          <label for="message">Mensaje</label>
          <textarea id="message" name="message" placeholder="Escribe unas palabras bonitasâ€¦"></textarea>
        </div>

        <div class="row">
          <div>
            <label for="ngo">ONG</label>
            <select id="ngo" name="ngo">
              <option value="">â€” Elige una ONG â€”</option>
              <option>CRUZ ROJA</option>
              <option>MÃ‰DICOS SIN FRONTERAS</option>
              <option>UNICEF</option>
              <option>WWF</option>
              <option>ACNUR</option>
            </select>
          </div>
          <div>
            <label for="amount">DonaciÃ³n (â‚¬)</label>
            <input id="amount" name="amount" type="number" inputmode="decimal" min="0" step="0.5" placeholder="5" />
          </div>
        </div>

        <input type="hidden" id="lat" name="lat" />
        <input type="hidden" id="lng" name="lng" />
        <input type="hidden" id="city" name="city" />

        <button type="submit" class="btn" id="btnPlant">ðŸŒ¸ Plantar flor</button>
        <div class="hint">Tras plantar, verÃ¡s la tarjeta en el mapa y se aÃ±adirÃ¡ a la lista.</div>
      </form>

      <div class="list" id="recent">
        <div class="hint" style="margin-bottom:8px">Ãšltimas flores plantadas</div>
        <div id="items"></div>
      </div>
    </aside>
  </div>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <script>
    // ====== CONFIG ======
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxhGMS7D1i76f59sBjHim9P6PaNuCibePYkkXk297nQ_7asT0LJxPmIC_mKx8B5G3UhDQ/exec';
    const NOMINATIM = 'https://nominatim.openstreetmap.org/search?format=json&limit=1&q=';

    // ====== MAPA (Leaflet) ======
    const map = L.map('map').setView([40.4168, -3.7038], 12); // Madrid por defecto
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    const flowerIcon = L.icon({
      iconUrl: 'data:image/svg+xml;utf8,' + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 48 48">
          <defs>
            <filter id="s" x="-50%" y="-50%" width="200%" height="200%">
              <feDropShadow dx="0" dy="1" stdDeviation="1.5" flood-color="#000" flood-opacity="0.35"/>
            </filter>
          </defs>
          <circle cx="24" cy="24" r="18" fill="#1bc27a" filter="url(#s)"/>
          <g transform="translate(24,24)">
            <g transform="scale(0.85)">
              <circle cx="0" cy="0" r="3.2" fill="#ffd7e6"/>
              <path d="M0,-11 C5,-11 6,-7 0,-6 C-6,-7 -5,-11 0,-11z" fill="#ff6fa9"/>
              <path d="M11,0 C11,5 7,6 6,0 C7,-6 11,-5 11,0z" fill="#ff6fa9"/>
              <path d="M0,11 C-5,11 -6,7 0,6 C6,7 5,11 0,11z" fill="#ff6fa9"/>
              <path d="M-11,0 C-11,-5 -7,-6 -6,0 C-7,6 -11,5 -11,0z" fill="#ff6fa9"/>
            </g>
          </g>
        </svg>
      `),
      iconSize: [40,40],
      iconAnchor: [20,20],
      popupAnchor: [0,-20]
    });

    let marker = null;

    function setMarker(lat, lng){
      if(!marker){
        marker = L.marker([lat, lng], { draggable:true, icon: flowerIcon }).addTo(map);
        marker.on('dragend', () => {
          const {lat, lng} = marker.getLatLng();
          setLatLngInputs(lat, lng);
        });
      } else {
        marker.setLatLng([lat, lng]);
      }
      setLatLngInputs(lat, lng);
      if(map.getZoom() < 17) map.setZoom(17);
      map.panTo([lat, lng]);
    }

    function setLatLngInputs(lat, lng){
      document.getElementById('lat').value = (+lat).toFixed(6);
      document.getElementById('lng').value = (+lng).toFixed(6);
    }

    // ====== BÃšSQUEDA DIRECCIÃ“N (Nominatim) ======
    async function geocodeAddress(query){
      const res = await fetch(NOMINATIM + encodeURIComponent(query), {
        headers: { 'Accept': 'application/json' }
      });
      if(!res.ok) throw new Error('No se pudo geocodificar');
      const arr = await res.json();
      if(!arr || !arr.length) throw new Error('Sin resultados');
      const hit = arr[0];
      const lat = parseFloat(hit.lat), lng = parseFloat(hit.lon);
      document.getElementById('address').value = hit.display_name;
      document.getElementById('city').value = extractCityFromDisplayName(hit);
      setMarker(lat, lng);
    }

    function extractCityFromDisplayName(hit){
      // Nominatim devuelve un display_name largo; intentamos extraer ciudad a grandes rasgos
      if(hit && hit.display_name){
        const parts = hit.display_name.split(',').map(s=>s.trim());
        if(parts.length >= 3) return parts[parts.length - 4] || parts[parts.length - 3] || '';
      }
      return '';
    }

    async function confirmAddress(){
      const q = document.getElementById('address').value.trim();
      if(!q){ alert('Escribe una direcciÃ³n.'); return; }
      try{ await geocodeAddress(q); } catch(e){ alert('No se pudo confirmar esa direcciÃ³n.'); }
    }

    // ====== UBICACIÃ“N DEL USUARIO ======
    function useMyLocation(){
      if(!navigator.geolocation){ alert('Tu navegador no permite geolocalizaciÃ³n.'); return; }
      navigator.geolocation.getCurrentPosition(pos => {
        const {latitude, longitude} = pos.coords;
        setMarker(latitude, longitude);
      }, _ => alert('No se pudo obtener tu ubicaciÃ³n.'), { enableHighAccuracy:true, timeout:8000, maximumAge:0 });
    }

    // ====== INFO POPUP ======
    function openPopup(lat, lng, data){
      const html = `
        <div style="max-width:260px">
          <div style="font-weight:800;margin-bottom:6px">ðŸŒ¸ Flor para ${escapeHtml(data.to||'ALGUIEN')}</div>
          <div style="margin-bottom:6px;color:#b9c8d9">${escapeHtml(data.message||'')}</div>
          <div class="hint">Por ${escapeHtml(data.from||'AnÃ³nimo')} en ${escapeHtml(data.city||'')}</div>
          <div style="margin-top:8px"><a target="_blank" href="https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}#map=18/${lat}/${lng}">Abrir en OSM</a></div>
        </div>`;
      if(!marker){ setMarker(lat, lng); }
      marker.setPopupContent(html).openPopup();
    }

    // ====== LISTA UI ======
    function addListItem(data){
      const el = document.createElement('div');
      el.className = 'item';
      el.innerHTML = `<div><strong>${escapeHtml(data.to||'ALGUIEN')}</strong> â€” ${escapeHtml(data.city||'')}</div>
                      <div class="hint">${new Date(data.timestamp||Date.now()).toLocaleString()}</div>`;
      el.addEventListener('click', ()=>{
        if(data.lat && data.lng){
          const lat = +data.lat, lng = +data.lng;
          setMarker(lat, lng);
          openPopup(lat, lng, data);
        }
      });
      document.getElementById('items').prepend(el);
    }

    // ====== APPS SCRIPT (tu URL) ======
    async function saveFlower(payload){
      // header text/plain evita preflight; Apps Script leerÃ¡ JSON del body
      const res = await fetch(WEB_APP_URL + '?action=create', {
        method:'POST',
        headers:{ 'Content-Type':'text/plain;charset=utf-8' },
        body: JSON.stringify(payload)
      });
      if(!res.ok) throw new Error('Error al guardar (red)');
      return res.json();
    }

    async function listFlowersNear(lat, lng){
      const url = new URL(WEB_APP_URL);
      url.searchParams.set('action','list');
      if(!isNaN(lat) && !isNaN(lng)){ url.searchParams.set('lat', lat); url.searchParams.set('lng', lng); }
      const res = await fetch(url.toString());
      if(!res.ok) throw new Error('Error al listar');
      return res.json();
    }

    async function tryLoadNearby(){
      try{
        if(navigator.geolocation){
          navigator.geolocation.getCurrentPosition(async pos=>{
            const {latitude, longitude} = pos.coords;
            const data = await listFlowersNear(latitude, longitude);
            (data.items||[]).slice(0,20).forEach(addListItem);
          }, async _=>{
            const data = await listFlowersNear();
            (data.items||[]).slice(0,20).forEach(addListItem);
          }, {timeout:4000});
        } else {
          const data = await listFlowersNear();
          (data.items||[]).slice(0,20).forEach(addListItem);
        }
      }catch(e){ console.warn(e); }
    }

    // ====== EVENTOS UI ======
    const escapeHtml = s => (s+"").replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));

    document.addEventListener('click', (e)=>{
      if(e.target.id==='btnUseLocation'){ e.preventDefault(); useMyLocation(); }
      if(e.target.id==='btnConfirmAddress'){ e.preventDefault(); confirmAddress(); }
      if(e.target.id==='btnSearch'){ e.preventDefault(); confirmAddress(); }
    });

    document.getElementById('flowerForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const from = document.getElementById('from').value.trim();
      const to   = document.getElementById('to').value.trim();
      const message = document.getElementById('message').value.trim();
      const address = document.getElementById('address').value.trim();
      const ngo = document.getElementById('ngo').value.trim();
      const amount = parseFloat(document.getElementById('amount').value || '0') || 0;
      const lat = parseFloat(document.getElementById('lat').value);
      const lng = parseFloat(document.getElementById('lng').value);
      const city= document.getElementById('city').value.trim();

      if(!address || Number.isNaN(lat) || Number.isNaN(lng)) { alert('Selecciona o confirma una ubicaciÃ³n vÃ¡lida.'); return; }

      const payload = { from, to, message, address, city, lat, lng, ngo, amount };

      try{
        // Plantar visualmente
        setMarker(lat, lng);
        openPopup(lat, lng, payload);

        // Guardar en la hoja (Apps Script)
        const out = await saveFlower(payload);
        if(out && (out.ok || out.timestamp)){
          addListItem({ ...payload, timestamp: out.timestamp || Date.now() });
        } else {
          alert('Guardado parcial: se ve en el mapa, pero no quedÃ³ en la hoja.');
        }
      }catch(err){
        console.error(err);
        alert('No se pudo guardar en la hoja. La flor se ha plantado localmente en el mapa.');
      }
    });

    // ====== INICIO ======
    tryLoadNearby();
  </script>
</body>
</html>
