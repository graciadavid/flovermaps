<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Flovermaps ‚Äî Plant a Flower, Change the World</title>

  <!-- Leaflet + MarkerCluster (sin llaves) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">

  <style>
    :root{
      --bg:#f3f6fb; --text:#0b0f14; --accent:#26c281; --pink:#ff6fa9;
    }
    html,body{height:100%}
    body{margin:0;background:#fff;color:var(--text);font:500 16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial}
    #map{position:fixed; inset:0}

    /* Logo flotante centrado arriba */
    .brand {
      position:fixed; left:50%; top:14px; transform:translateX(-50%);
      background:#fff; border-radius:16px; padding:10px 18px; box-shadow:0 10px 30px rgba(0,0,0,.18);
      display:flex; align-items:center; gap:12px; z-index:1000; border:1px solid #e6ecf3;
    }
    .brand h1 {
      margin:0; font-weight:900; letter-spacing:.3px; font-size:26px; color:#57c06f;
    }
    .brand .sub {
      margin:0; font-weight:800; font-size:14px; color:#ff5fa0;
    }

    /* Barra de acciones inferior (p√≠ldoras) */
    .actions {
      position:fixed; left:50%; bottom:110px; transform:translateX(-50%); z-index:1000;
      display:grid; grid-template-columns:1fr 1fr; gap:14px; width:min(920px, 92vw);
    }
    .pill {
      background:#fff; border:1px solid #e6ecf3; border-radius:999px; padding:14px 18px;
      box-shadow:0 8px 24px rgba(0,0,0,.12); font-weight:800; cursor:pointer; text-align:center;
    }
    .pill:active{ transform:scale(.995) }

    /* Barra de b√∫squeda */
    .searchwrap{
      position:fixed; left:50%; bottom:50px; transform:translateX(-50%); z-index:1000;
      width:min(920px, 92vw);
    }
    .search{
      display:flex; align-items:center; gap:10px; background:#fff; border:1px solid #e6ecf3;
      border-radius:999px; padding:12px 16px; box-shadow:0 8px 24px rgba(0,0,0,.12);
    }
    .search input{
      flex:1; border:0; outline:none; font:inherit; color:#22313f; background:transparent;
    }

    /* Toast gu√≠a */
    .toast{
      position:fixed; left:50%; bottom:10px; transform:translateX(-50%); z-index:1000;
      background:#101826; color:#e9f3ff; padding:10px 14px; border-radius:10px; font-size:14px; display:none;
    }

    @media (max-width:680px){
      .brand h1{font-size:22px}
      .brand .sub{font-size:12px}
      .actions{bottom:120px; grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Marca superior -->
  <div class="brand">
    <h1>Flovermaps</h1>
    <p class="sub">üå∏ Plant a Flower, Change the World üå∏</p>
  </div>

  <!-- P√≠ldoras inferiores -->
  <div class="actions">
    <button class="pill" id="btnPlant">üå∏ Plantar desde el mapa</button>
    <button class="pill" id="btnLocate">üìç Mi ubicaci√≥n</button>
  </div>

  <!-- B√∫squeda -->
  <div class="searchwrap">
    <div class="search">
      <span>üîé</span>
      <input id="search" placeholder="Buscar un lugar (calle, ciudad‚Ä¶)" />
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">Toca en el mapa para plantar la flor. Se guardar√° tras completar los datos.</div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script>
    /* ====== CONFIG ====== */
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxhGMS7D1i76f59sBjHim9P6PaNuCibePYkkXk297nQ_7asT0LJxPmIC_mKx8B5G3UhDQ/exec";
    const NOMINATIM = "https://nominatim.openstreetmap.org/search?format=json&limit=1&q=";
    const MIN_STREET_ZOOM = 17;
    const FIXED_FEE = 0.90; // info de popup

    /* ====== MAPA (CARTO Positron) ====== */
    const map = L.map("map", { zoomControl:true }).setView([42.5, 2.5], 5);
    L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap &copy; CARTO'
    }).addTo(map);

    /* ====== ICONOS ====== */
    const flowerSVG = 'data:image/svg+xml;utf8,' + encodeURIComponent(`
      <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 48 48">
        <defs><filter id="s" x="-50%" y="-50%" width="200%" height="200%"><feDropShadow dx="0" dy="1" stdDeviation="1.5" flood-color="#000" flood-opacity="0.35"/></filter></defs>
        <circle cx="24" cy="24" r="18" fill="#1bc27a" filter="url(#s)"/>
        <g transform="translate(24,24)"><g transform="scale(0.85)">
          <circle cx="0" cy="0" r="3.2" fill="#ffd7e6"/>
          <path d="M0,-11 C5,-11 6,-7 0,-6 C-6,-7 -5,-11 0,-11z" fill="#ff6fa9"/>
          <path d="M11,0 C11,5 7,6 6,0 C7,-6 11,-5 11,0z" fill="#ff6fa9"/>
          <path d="M0,11 C-5,11 -6,7 0,6 C6,7 5,11 0,11z" fill="#ff6fa9"/>
          <path d="M-11,0 C-11,-5 -7,-6 -6,0 C-7,6 -11,5 -11,0z" fill="#ff6fa9"/>
        </g></g>
      </svg>
    `);
    const flowerIcon = L.icon({ iconUrl: flowerSVG, iconSize:[40,40], iconAnchor:[20,20], popupAnchor:[0,-20] });

    /* ====== CLUSTERS ====== */
    const clusters = L.markerClusterGroup({ showCoverageOnHover:false, spiderfyOnMaxZoom:true });
    map.addLayer(clusters);

    /* ====== UTIL ====== */
    const toast = (msg, ms=2500)=>{
      const t = document.getElementById('toast'); t.textContent = msg; t.style.display='block';
      setTimeout(()=> t.style.display='none', ms);
    };
    const escapeHtml = s => (s+"").replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));

    function popupHtml(data){
      const net = Math.max(0, (+data.amount||0)-FIXED_FEE).toFixed(2);
      return `
        <div style="max-width:260px">
          <div style="font-weight:800;margin-bottom:6px">üå∏ Flor para ${escapeHtml(data.to||'ALGUIEN')}</div>
          <div style="margin-bottom:6px;color:#556a80">${escapeHtml(data.message||'')}</div>
          <div style="font-size:12px;color:#7a8ea3">Por ${escapeHtml(data.from||'An√≥nimo')} en ${escapeHtml(data.city||'')}</div>
          <hr style="border:none;border-top:1px solid #e7eef6; margin:8px 0" />
          <div style="font-size:13px">Donaci√≥n: <strong>${(+data.amount||0).toFixed(2)} ‚Ç¨</strong><br>
            ONG recibe: <strong>${net} ‚Ç¨</strong> <span style="color:#8aa0b7">(‚àí0,90 ‚Ç¨ mantenimiento)</span>
          </div>
        </div>`;
    }

    /* ====== APPS SCRIPT ====== */
    async function listFlowersNear(lat, lng){
      const url = new URL(WEB_APP_URL);
      url.searchParams.set('action','list');
      if(!isNaN(lat) && !isNaN(lng)){ url.searchParams.set('lat', lat); url.searchParams.set('lng', lng); }
      const res = await fetch(url.toString());
      if(!res.ok) throw new Error('Error al listar');
      return res.json();
    }
    async function saveFlower(payload){
      const res = await fetch(WEB_APP_URL + '?action=create', {
        method:'POST',
        headers:{ 'Content-Type':'text/plain;charset=utf-8' }, // evita preflight CORS
        body: JSON.stringify(payload)
      });
      if(!res.ok) throw new Error('Error al guardar');
      return res.json();
    }

    function addFlowerMarker(item){
      if(!item.lat || !item.lng) return;
      const m = L.marker([+item.lat, +item.lng], { icon: flowerIcon });
      m.bindPopup(popupHtml(item));
      clusters.addLayer(m);
      return m;
    }

    async function bootstrap(){
      try{
        if(navigator.geolocation){
          navigator.geolocation.getCurrentPosition(async pos=>{
            map.setView([pos.coords.latitude, pos.coords.longitude], 6);
            const data = await listFlowersNear(pos.coords.latitude, pos.coords.longitude);
            (data.items||[]).forEach(addFlowerMarker);
          }, async _=>{
            const data = await listFlowersNear();
            (data.items||[]).forEach(addFlowerMarker);
          }, {timeout:4000});
        } else {
          const data = await listFlowersNear();
          (data.items||[]).forEach(addFlowerMarker);
        }
      }catch(e){ console.warn(e); }
    }

    /* ====== B√öSQUEDA ====== */
    async function geocode(q){
      const res = await fetch(NOMINATIM + encodeURIComponent(q), { headers:{Accept:'application/json'} });
      if(!res.ok) throw new Error('No geocode');
      const arr = await res.json();
      if(!arr || !arr.length) throw new Error('Sin resultados');
      const hit = arr[0];
      return { lat: parseFloat(hit.lat), lng: parseFloat(hit.lon), display: hit.display_name };
    }

    document.getElementById('search').addEventListener('keydown', async (e)=>{
      if(e.key === 'Enter'){
        const q = e.currentTarget.value.trim();
        if(!q) return;
        try{
          const g = await geocode(q);
          map.setView([g.lat, g.lng], 14);
        }catch{ toast('No se encontr√≥ esa ubicaci√≥n'); }
      }
    });

    /* ====== PLANTAR DESDE EL MAPA ====== */
    let plantMode = false;
    let clickOnceHandler = null;

    document.getElementById('btnPlant').addEventListener('click', ()=>{
      plantMode = true;
      toast('Toca en el mapa para plantar');
      if(clickOnceHandler) { map.off('click', clickOnceHandler); }
      clickOnceHandler = async (ev)=>{
        map.off('click', clickOnceHandler);
        plantMode = false;
        const lat = ev.latlng.lat, lng = ev.latlng.lng;

        // Datos r√°pidos con prompts (como la versi√≥n simple)
        const to   = prompt('¬øPara qui√©n es la flor? (TO)') || '';
        const from = prompt('¬øQui√©n env√≠a? (FROM)') || '';
        const message = prompt('Mensaje (opcional)') || '';
        const ngo = prompt('ONG (CRUZ ROJA / MSF / UNICEF / WWF / ACNUR)') || '';
        const amount = parseFloat(prompt('Donaci√≥n en ‚Ç¨ (opcional, ej. 5)') || '0') || 0;

        // Ciudad aproximada por Nominatim (reverse simple)
        let address = `(${lat.toFixed(5)}, ${lng.toFixed(5)})`, city = '';
        try{
          const rev = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`, { headers:{Accept:'application/json'} });
          if(rev.ok){
            const j = await rev.json();
            address = j.display_name || address;
            city = j.address?.city || j.address?.town || j.address?.village || j.address?.county || '';
          }
        }catch{}

        const payload = { from, to, message, address, city, lat, lng, ngo, amount };

        try{
          const out = await saveFlower(payload);
          const stamp = out?.timestamp || Date.now();
          const marker = addFlowerMarker({ ...payload, timestamp: stamp });
          if(marker){ marker.openPopup(); }
          toast('üå∏ ¬°Flor plantada!');
        }catch(e){
          console.error(e);
          const marker = addFlowerMarker(payload);
          if(marker){ marker.openPopup(); }
          toast('Guardado local. No se pudo escribir en la hoja.');
        }
      };
      map.once('click', clickOnceHandler);
    });

    /* ====== MI UBICACI√ìN ====== */
    document.getElementById('btnLocate').addEventListener('click', ()=>{
      if(!navigator.geolocation){ toast('Tu navegador no permite geolocalizaci√≥n'); return; }
      navigator.geolocation.getCurrentPosition(pos=>{
        map.setView([pos.coords.latitude, pos.coords.longitude], 14);
      }, _=> toast('No se pudo obtener tu ubicaci√≥n'), { enableHighAccuracy:true, timeout:8000, maximumAge:0 });
    });

    /* ====== INICIO ====== */
    bootstrap();
  </script>
</body>
</html>
