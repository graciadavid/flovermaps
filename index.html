<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Planta una flor en el lugar que lo cambiÃ³ todo â€” Flovermaps</title>

<link rel="icon" type="image/svg+xml" href='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 64 64"><text x="6" y="54" font-size="52">ğŸŒ¸</text></svg>'>
<meta name="theme-color" content="#f6fff9" />
<meta name="description" content="Planta flores en el mapa, dedica un mensaje y compÃ¡rtelo para siempre." />
<meta property="og:title" content="Flovermaps">
<meta property="og:description" content="Planta flores en el mapa y dedica mensajes bonitos.">
<meta property="og:type" content="website">
<meta property="og:image" content='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="630" viewBox="0 0 1200 630"><rect width="100%" height="100%" fill="%23f6fff9"/><text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle" font-size="300">ğŸŒ¸</text></svg>'>
<meta name="twitter:card" content="summary_large_image">

<link rel="preconnect" href="https://unpkg.com">
<link rel="preconnect" href="https://basemaps.cartocdn.com">
<link rel="preconnect" href="https://nominatim.openstreetmap.org">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- MarkerCluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
<script defer src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<style>
  :root{ --ink:#0f172a; --muted:#64748b; --accent:#01c064; --accent-weak: rgba(1,192,100,.08); --bg:#f6fff9;
         --tabh:58px; --hdrh:76px; }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:'Plus Jakarta Sans',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--ink);
    background:
      radial-gradient(circle at 12% 18%, var(--accent-weak) 1.2px, transparent 1.2px) 0 0/18px 18px,
      radial-gradient(circle at 70% 40%, rgba(1,192,100,.06) 1.4px, transparent 1.4px) 0 0/22px 22px,
      linear-gradient(180deg, #f6fff9 0%, #ecfaf2 60%, #e8f8ef 100%);
  }
  /* Header */
  .site-header{display:flex; align-items:center; justify-content:center; padding:12px; height:var(--hdrh);}
  .header-card{display:flex; align-items:center; justify-content:center; background:#fff; border:1px solid #e8e8e8; border-radius:12px; padding:8px 14px; min-height:64px; box-shadow:0 6px 18px rgba(2,6,12,.06); margin:2px; cursor:pointer}
  .logo-img{display:block; height:72px; width:auto; max-width:100%; object-fit:contain}
  @media (min-width:900px){ .logo-img{height:96px} }

  .container{max-width:1300px; margin:0 auto; padding:0 14px}
  .grid3{display:block; gap:12px}
  @media (min-width:1100px){
    .grid3{display:grid; grid-template-columns: 320px 1fr 380px; align-items:start; gap:12px}
  }

  .card{border:1px solid #e8e8e8; border-radius:12px; padding:12px; background:#fff; color:var(--ink); margin:6px 0; box-shadow:0 6px 18px rgba(2,6,12,.05)}
  .muted{color:var(--muted); font-size:.95rem}
  label{display:block; margin:6px 0 4px; font-size:.9rem}
  .row2{display:grid; grid-template-columns:1fr; gap:6px}
  @media (min-width:640px){ .row2{grid-template-columns:1fr 1fr} }

  /* Inputs y botones */
  input,.btn,select{width:100%; padding:8px; border:1px solid #ddd; border-radius:10px; font-size:.92rem}
  .btn{border:0; border-radius:10px; cursor:pointer}
  .btn-dark{background:#444;color:#fff}
  .btn-outline{background:#fff; color:#0f172a; border:1px solid #e6e6e6}
  .btn-green{background:#22c55e; color:#fff}

  /* Mapa */
  .frame{position:relative; border:1px solid #e8e8e8; border-radius:12px; overflow:hidden; background:#fff; margin:6px 0; box-shadow:0 6px 18px rgba(2,6,12,.05)}
  #map{width:100%; height:560px}
  @media (max-width:1024px){
    body{overflow:hidden}
    .container{height:calc(100dvh - var(--hdrh) - var(--tabh)); padding:0 10px 0}
    .grid3{height:100%}
    .form-col,.map-col,.explore-col{display:none; height:100%; overflow:hidden}
    .form-col.is-active,.map-col.is-active,.explore-col.is-active{display:block}
    .map-col .frame,.form-col .card,.explore-col .card{height:100%}
    #map{height:100%}
  }

  /* Crosshair + direcciÃ³n bajo el pin */
  .crosshair{
    position:absolute; left:50%; top:50%; transform:translate(-50%,-100%);
    z-index:901; font-size:30px; text-shadow:0 1px 0 #fff,0 -1px 0 #fff,1px 0 0 #fff,-1px 0 0 #fff,0 0 4px rgba(0,0,0,.25)
  }
  .addr-badge{
    position:absolute; left:50%; top:calc(50% + 6px); transform:translate(-50%,0);
    z-index:901; background:#fff; border:1px solid #e6e6e6; border-radius:999px; padding:6px 10px; font-size:.9rem; box-shadow:0 4px 12px rgba(0,0,0,.06);
    max-width:min(90%,520px); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }

  /* BotÃ³n flotante plantar: centrado abajo en mÃ³vil */
  .map-fab{
    position:absolute; z-index:902; display:none;
    border:0; cursor:pointer; background:#22c55e; color:#fff;
    box-shadow:0 6px 16px rgba(0,0,0,.18); font-size:.9rem; line-height:1; padding:10px 12px; border-radius:12px; white-space:nowrap;
  }
  @keyframes bounceIn{0%{transform:translateY(8px) scale(.94)}60%{transform:translateY(0) scale(1.04)}100%{transform:translateY(0) scale(1)}}
  .map-fab.pop{animation:bounceIn .28s ease}
  @media (max-width:1024px){
    .map-fab{left:50%; transform:translateX(-50%); bottom:calc(var(--tabh) + 12px);}
  }

  /* Emoji marker (solo desktop cuando mostramos un pin puntual) */
  .leaflet-marker-icon[src*="marker-icon"], .leaflet-marker-shadow{display:none!important}
  .emoji-marker{background:transparent; transform:translate(-14px,-28px)}
  .emoji-marker .e{font-size:30px; line-height:30px; text-shadow:0 1px 0 #fff,0 -1px 0 #fff,1px 0 0 #fff,-1px 0 0 #fff,0 0 4px rgba(0,0,0,.25)}
  @media (min-width:900px){ .emoji-marker .e{font-size:34px; line-height:34px} }

  /* Toast */
  .toast{position:fixed; left:50%; bottom:88px; transform:translateX(-50%); background:#111; color:#fff; padding:10px 12px; border-radius:10px; z-index:11000; opacity:0; pointer-events:none; transition:opacity .18s, bottom .18s}
  .toast.show{opacity:1; bottom:98px}

  /* Ãšltimas (sin scroll) */
  .scroll-list{overflow:hidden; max-height:none}
  .latest-wrap{display:flex; flex-direction:column; gap:10px; height:100%}
  .latest-list{flex:1 1 auto; overflow:hidden}
  .latest-list > div{max-height:100%; overflow:hidden}
  .latest-grid{display:grid; gap:10px}
  .recent-row{display:flex; align-items:center; gap:10px; justify-content:space-between}
  .recent-text{min-width:0}
  .latest-actions{display:flex; gap:8px}
  .latest-foot{padding-top:4px; display:flex; justify-content:center; gap:8px}
  .btn-xxs{padding:6px 8px; font-size:.85rem}

  /* Tab bar mÃ³vil */
  .tabbar{position:fixed; bottom:0; left:0; right:0; height:var(--tabh); background:#fff; border-top:1px solid #e6e6e6; display:none; z-index:12001}
  .tabbar .tabs{height:100%; display:grid; grid-template-columns: 1fr 1fr 1fr}
  .tabbar button{background:none; border:0; font:inherit; cursor:pointer; padding:6px 4px}
  .tabbar .t{display:flex; flex-direction:column; align-items:center; justify-content:center; gap:2px; color:#445; font-size:.86rem}
  .tabbar .t[aria-selected="true"]{color:#0a0a0a; font-weight:700}
  @media (max-width:1024px){ .tabbar{display:block} }

  /* Desktop mapa altura acompasada al formulario */
  @media (min-width:1100px){
    #map{height:auto}
  }
</style>
</head>
<body>

<header class="site-header">
  <div class="header-card" id="logoBtn">
    <img src="logo.png" alt="FLOVERMAPS" class="logo-img" onerror="this.style.display='none'">
  </div>
</header>

<div class="container">
  <!-- GRID 3 columnas (desktop) | pestaÃ±as full-screen (mÃ³vil) -->
  <div class="grid3">

    <!-- 1) FORMULARIO -->
    <section class="form-col" id="view-form" role="tabpanel" aria-labelledby="tab-form">
      <div class="card" id="formCard">
        <h1 style="margin-top:0">Planta una flor</h1>

        <label for="place" style="margin-top:4px">Buscar lugar</label>
        <div class="sbox" role="combobox" aria-expanded="false" aria-owns="slist" aria-haspopup="listbox">
          <input id="place" placeholder="Ej. Times Square, New York" autocomplete="off" aria-autocomplete="list" aria-controls="slist">
          <div id="slist" class="slist" role="listbox"></div>
        </div>
        <div class="muted" id="help">Elige una sugerencia: te llevamos al mapa para ajustar.</div>
        <div id="fixed" class="muted" style="display:none;margin-top:4px">âœ… PosiciÃ³n ajustada</div>

        <div class="row2" style="margin-top:10px">
          <div><label for="fromName">Â¿QuiÃ©n la envÃ­a?</label><input id="fromName" placeholder="Tu nombre" required></div>
          <div><label for="toName">Â¿Para quiÃ©n?</label><input id="toName" placeholder="Nombre del destinatario" required></div>
        </div>

        <label for="message" style="margin-top:8px">Mensaje <span class="muted" id="chars">(0/30)</span></label>
        <input id="message" maxlength="30" placeholder="Ese rincÃ³n especialâ€¦ (mÃ¡x. 30)" inputmode="text" autocomplete="off" required />

        <div class="actions" style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap">
          <button id="gpsBtn" class="btn btn-dark" style="flex:1 1 140px">ğŸ“ Usar mi ubicaciÃ³n</button>
          <button id="saveBtn" class="btn btn-green" style="flex:1 1 140px">ğŸ’¾ Guardar flor</button>
        </div>

        <input type="hidden" id="lat"><input type="hidden" id="lng">
      </div>
    </section>

    <!-- 2) MAPA -->
    <section class="map-col" id="view-map" aria-label="Mapa" role="tabpanel" aria-labelledby="tab-map">
      <div class="frame" id="mapFrame">
        <div id="map"></div>
        <!-- Crosshair + direcciÃ³n viva -->
        <div id="crosshair" class="crosshair" aria-hidden="true">ğŸ“</div>
        <div id="addrLabel" class="addr-badge" aria-live="polite">Mueve el mapa para ajustarâ€¦</div>
        <button id="plantFab" class="map-fab" type="button" aria-label="Plantar aquÃ­">âœ… Plantar aquÃ­</button>
      </div>
    </section>

    <!-- 3) ÃšLTIMAS -->
    <aside class="explore-col" id="view-latest" role="tabpanel" aria-labelledby="tab-latest">
      <div class="card latest-wrap">
        <h3 style="margin:0 0 8px">ğŸŒ¸ Ãšltimas dedicatorias</h3>
        <div class="latest-list">
          <div id="recentList" class="muted latest-grid" aria-live="polite">Cargandoâ€¦</div>
        </div>
        <div class="latest-foot">
          <button id="prevPage" class="btn btn-outline btn-xxs">â—€ï¸</button>
          <button id="nextPage" class="btn btn-outline btn-xxs">â–¶ï¸</button>
        </div>
      </div>
    </aside>

  </div>
</div>

<!-- Tab bar mÃ³vil -->
<nav class="tabbar" role="tablist" aria-label="Vistas">
  <div class="tabs">
    <button id="tab-map" class="t" role="tab" aria-selected="true" aria-controls="view-map">ğŸŒ<span>Mapa</span></button>
    <button id="tab-form" class="t" role="tab" aria-selected="false" aria-controls="view-form">ğŸŒ¸<span>Plantar</span></button>
    <button id="tab-latest" class="t" role="tab" aria-selected="false" aria-controls="view-latest">ğŸ•Šï¸<span>Ãšltimas</span></button>
  </div>
</nav>

<!-- Toast + Modal -->
<div id="toast" class="toast" role="status" aria-live="polite"></div>

<div id="successModal" class="modal" aria-modal="true" role="dialog" style="display:none; align-items:center; justify-content:center; inset:0; position:fixed; background:rgba(0,0,0,.28); z-index:12000">
  <div class="box" style="background:#fff; width:min(520px,92vw); border-radius:16px; padding:16px; box-shadow:0 20px 60px rgba(0,0,0,.25)">
    <h3 style="margin:4px 0 10px">ğŸ‰ Â¡Tu flor ya florece en el mapa!</h3>
    <p class="muted" id="successText">Comparte el enlace o abre la flor.</p>
    <div class="actions-row" style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px">
      <button id="mShare" class="btn btn-outline">ğŸ”— Compartir</button>
      <button id="mOpen" class="btn btn-green">ğŸª„ Ver flor ahora</button>
    </div>
  </div>
</div>

<script>
/* === CONFIG === */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxhGMS7D1i76f59sBjHim9P6PaNuCibePYkkXk297nQ_7asT0LJxPmIC_mKx8B5G3UhDQ/exec";

/* === JSONP helper === */
function jsonp(url, timeoutMs=12000){
  return new Promise((resolve, reject)=>{
    const cb='__fp_cb_'+Math.random().toString(36).slice(2);
    const s=document.createElement('script'); const sep=url.includes('?')?'&':'?';
    s.src=url+sep+'callback='+cb+'&_ts='+Date.now(); s.id=cb; s.async=true;
    let to; function cleanup(){ clearTimeout(to); try{ delete window[cb]; }catch{}; s.remove(); }
    window[cb]=(data)=>{ cleanup(); resolve(data); };
    s.onerror=()=>{ cleanup(); reject(new Error('JSONP load failed')); };
    document.head.appendChild(s);
    to=setTimeout(()=>{ cleanup(); reject(new Error('JSONP timeout')); }, timeoutMs);
  });
}

/* === STATE === */
let map, baseTiles, fallbackTiles, tileFallbackUsed=false;
let flowersLayer=null; let useCluster=null;
let pollTimer=null; let didFitBounds=false;
let saving=false; let lastShareUrl=''; let lastTs=0;
let plantedOnce=false; let allowPlanting=true;
let centerMoveTimer=null, centerAbort=null;
let mobile = window.matchMedia('(max-width:1024px)').matches;
let currentView = 'map';
let page=0, pageSize=8, latestItems=[];

/* === DOM === */
const $=s=>document.querySelector(s);
const place=$("#place"), slist=$("#slist"), fixedBadge=$("#fixed");
const plantFab=$("#plantFab"), gpsBtn=$("#gpsBtn");
const msgInput=$("#message");
const recentList=$("#recentList");
const successModal=$("#successModal"), mShare=$("#mShare"), mOpen=$("#mOpen");
const addrLabel=$("#addrLabel");
const saveBtn=$("#saveBtn");
const tabs={map:$("#tab-map"), form:$("#tab-form"), latest:$("#tab-latest")};
const views={map:$("#view-map"), form:$("#view-form"), latest:$("#view-latest")};
const prevPage=$("#prevPage"), nextPage=$("#nextPage");

/* === Utils === */
const ACCEPT_LANG = (()=>{ 
  try{
    const langs = (navigator.languages && navigator.languages.length) ? navigator.languages : [navigator.language || 'es'];
    const set = Array.from(new Set([...langs.map(l=>String(l||'').split('-')[0]), 'es','en']));
    return set.join(',');
  }catch{ return 'es,en'; }
})();
function toast(msg, ok=true){ const t=$("#toast"); t.textContent=msg; t.style.background=ok?"#111":"#b30000"; t.classList.add("show"); setTimeout(()=>t.classList.remove('show'),1600); }
function fmtDateTime(d){ try{ return new Intl.DateTimeFormat('es-ES',{timeZone:'Europe/Madrid', day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit', hour12:false}).format(d).replace(',', ''); }catch{ const dd=String(d.getDate()).padStart(2,"0"), mm=String(d.getMonth()+1).padStart(2,"0"), yy=d.getFullYear(), hh=String(d.getHours()).padStart(2,"0"), mi=String(d.getMinutes()).padStart(2,"0"); return `${dd}/${mm}/${yy} ${hh}:${mi}`; } }
function popupHtml(from,to,msg,dtStr){ const esc=s=>String(s||'').replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;","&quot;":"&quot;","'":"&#39;",">":"&gt;"}[m])); return `<div>${esc(dtStr)} <strong>${esc(from)}</strong> para <strong>${esc(to)}</strong>: ${esc(msg)}.</div>`; }
function emojiIcon(){ const html='<span class="e" role="img" aria-label="flor">ğŸŒ¸</span>'; return L.divIcon({className:'emoji-marker', html, iconSize:[28,28], iconAnchor:[14,28], popupAnchor:[0,-30]}); }
function toNum(v){ if(v===null||v===undefined) return NaN; if(typeof v==='number') return v; const s=String(v).trim().replace(/\s+/g,'').replace(',', '.'); const n=Number(s); return isFinite(n)? n : NaN; }
function relTime(ts){ const t=Number(ts)||Date.parse(ts)||Date.now(); const s=Math.max(1, Math.floor((Date.now()-t)/1000)); if(s<60) return `hace ${s} s`; const m=Math.floor(s/60); if(m<60) return `hace ${m} min`; const h=Math.floor(m/60); if(h<24) return `hace ${h} h`; const d=Math.floor(h/24); return `hace ${d} d`; }
function escAttr(s){ return encodeURIComponent(String(s||'')); }
function unescAttr(s){ return decodeURIComponent(String(s||'')); }

/* === MAPA === */
function initMap(){
  baseTiles=L.tileLayer('https://basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',{attribution:'Â© OpenStreetMap Â© CARTO',maxZoom:19});
  baseTiles.on('tileerror', ()=>{ if(!tileFallbackUsed){ tileFallbackUsed=true; try{ map && map.removeLayer(baseTiles);}catch{} fallbackTiles=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OpenStreetMap contributors',maxZoom:19}); fallbackTiles.addTo(map);} });
  map=L.map('map',{layers:[baseTiles],zoomControl:true, worldCopyJump:true});
  map.setView([40.4168,-3.7038],6);
  flowersLayer = L.layerGroup().addTo(map);
  useCluster = false;

  setTimeout(()=>{ map.invalidateSize(); syncMapHeights(); updateCenterAddress(true); showFab(); },150);
  addEventListener('resize', ()=> setTimeout(()=>{ map.invalidateSize(); syncMapHeights(); },120));
  map.on('moveend', ()=>updateCenterAddress(false));
}
function syncMapHeights(){
  const mapEl=$("#map"), formCard=$("#formCard");
  if(!mapEl) return;
  if(window.matchMedia('(min-width:1100px)').matches){
    const h=Math.max(560, formCard ? formCard.offsetHeight : 560);
    mapEl.style.height=h+'px';
  } else {
    mapEl.style.height='100%';
  }
}

/* DirecciÃ³n viva bajo el crosshair (reverse geocode del centro) */
async function updateCenterAddress(initial){
  if(centerAbort){ try{centerAbort.abort();}catch{} }
  const ctl = new AbortController(); centerAbort=ctl;
  const c = map.getCenter();
  const url=`https://nominatim.openstreetmap.org/reverse?format=jsonv2&accept-language=${encodeURIComponent(ACCEPT_LANG)}&lat=${c.lat}&lon=${c.lng}&zoom=18&addressdetails=1`;
  addrLabel.textContent = initial ? 'Mueve el mapa para ajustarâ€¦' : 'Buscando direcciÃ³nâ€¦';
  try{
    const r=await fetch(url,{signal:ctl.signal});
    if(!r.ok) throw 0;
    const j=await r.json();
    const a=j.address||{};
    const road=a.road||a.pedestrian||a.cycleway||a.footway||a.path||a.neighbourhood||a.suburb||a.city_district||"";
    const hn=a.house_number||a.housenumber||"";
    const city=a.city||a.town||a.village||a.municipality||a.state||"";
    const label=[[road,hn].filter(Boolean).join(" "),city].filter(Boolean).join(", ");
    addrLabel.textContent = label || (j.display_name||'UbicaciÃ³n aproximada');
  }catch{ addrLabel.textContent='UbicaciÃ³n aproximada'; }
}

/* === UI: Vistas mÃ³viles (tabs) === */
function setView(v){
  currentView=v;
  for(const k of Object.keys(views)){
    if(k===v){ views[k].classList.add('is-active'); tabs[k].setAttribute('aria-selected','true'); }
    else { views[k].classList.remove('is-active'); tabs[k].setAttribute('aria-selected','false'); }
  }
  if(v==='map'){ setTimeout(()=>map && map.invalidateSize(),110); }
}
tabs.map.addEventListener('click', ()=>setView('map'));
tabs.form.addEventListener('click', ()=>setView('form'));
tabs.latest.addEventListener('click', ()=>setView('latest'));

/* === Autocomplete global (Nominatim) === */
let suggestTimer=null, abortCtrl=null, currentSuggest=[];
function hasNumber(s){ return /[0-9]/.test(s); }
function extractNumber(s){ const m=s.match(/([0-9]{1,6})/); return m? m[1]:null; }
function containsStreetType(q){
  return /(calle|carrer|avenida|av\.?|avinguda|paseo|ps\.?|plaÃ§a|plaza|street|st\.?|road|rd\.?|avenue|ave\.?|blvd\.?|boulevard|place|square|piazza|rua|rue|straÃŸe|strasse|ulica|via|cours|allee)/i.test(q);
}
function normalizeStreet(q){
  const base=q.replace(/\s+/g,' ').trim();
  if(!base) return [];
  if(containsStreetType(base)) return [base];
  return [ base, `Calle ${base}`, `Avenida ${base}`, `Carrer de ${base}`, `Street ${base}`, `Avenue ${base}`, `Road ${base}`, `Boulevard ${base}`, `Rue ${base}`, `Rua ${base}`, `Via ${base}` ];
}
async function searchPlacesPlain(q, sig){
  const url = 'https://nominatim.openstreetmap.org/search'
    + '?format=json&addressdetails=1&limit=10'
    + '&accept-language=' + encodeURIComponent(ACCEPT_LANG)
    + '&q=' + encodeURIComponent(q);
  const r = await fetch(url, {signal:sig});
  if(!r.ok) throw new Error('nominatim');
  return r.json();
}
async function searchPlacesStructured(q, sig){
  let raw=q, tail='';
  if(q.includes(',')){ const parts=q.split(','); raw=parts[0].trim(); tail=parts.slice(1).join(',').trim(); }
  const variants=normalizeStreet(raw);
  const tasks = variants.map(street => {
    const url = 'https://nominatim.openstreetmap.org/search'
      + '?format=json&addressdetails=1&limit=7'
      + '&accept-language=' + encodeURIComponent(ACCEPT_LANG)
      + '&street=' + encodeURIComponent(street)
      + (tail ? ('&city=' + encodeURIComponent(tail)) : '');
    return fetch(url, {signal:sig})
      .then(r=>r.ok?r.json():[])
      .catch(()=>[]);
  });
  const results = await Promise.allSettled(tasks);
  return results.flatMap(r => r.status==='fulfilled' ? r.value : []);
}
async function searchPlaces(q){
  if(abortCtrl) abortCtrl.abort();
  abortCtrl=new AbortController(); const sig=abortCtrl.signal;
  try{
    const withNum=hasNumber(q);
    const [A,B] = await Promise.all([
      searchPlacesPlain(q,sig).catch(()=>[]),
      withNum? searchPlacesStructured(q,sig).catch(()=>[]) : Promise.resolve([])
    ]);
    const list=[...A,...B]; const seen=new Set(); const merged=[];
    for(const it of list){ const id=(it.place_id||it.lat+'|'+it.lon); if(!seen.has(id)){ seen.add(id); merged.push(it); } }
    if(withNum){ 
      const num=extractNumber(q);
      merged.sort((x,y)=>{
        const xn=(x.address&&(x.address.house_number||x.address.housenumber))||'';
        const yn=(y.address&&(y.address.house_number||y.address.housenumber))||'';
        return (String(yn)===String(num)) - (String(xn)===String(num));
      }); 
    }
    return merged.slice(0,10);
  }catch{ return []; }
}
function renderSuggest(list){
  const q=place.value.trim(); const num=extractNumber(q);
  slist.innerHTML="";
  list.forEach((it,idx)=>{
    const row=document.createElement('div'); row.className='sitem'; row.setAttribute('role','option');
    const dn = (it.display_name||'').split(',').map(s=>s.trim());
    const primary = dn[0] || '';
    const city = it.address?.city || it.address?.town || it.address?.village || it.address?.municipality || '';
    const state = it.address?.state || it.address?.province || it.address?.state_district || '';
    const country = it.address?.country || (dn[dn.length-1]||'');
    const meta = [city || dn[1] || '', state || dn[2] || ''].filter(Boolean).join(', ') || country;
    const safe=(s)=>String(s||'').replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;","&quot;":"&quot;","'":"&#39;",">":"&gt"}[m]));
    const hlNum = num ? safe(primary).replace(new RegExp('('+num+')'),' <span class="hl">$1</span> ') : safe(primary);
    row.innerHTML = hlNum + (meta?` <small>${safe(meta)}</small>`:'');
    row.onclick=()=>selectSuggest(idx);
    slist.appendChild(row);
  });
  slist.style.display = list.length ? 'block' : 'none';
  document.querySelector('.sbox').setAttribute('aria-expanded', list.length ? 'true' : 'false');
}
async function selectSuggest(i){
  const it=currentSuggest[i]; if(!it) return;
  place.value=it.display_name; slist.style.display='none';
  setView('map');
  map.setView([Number(it.lat), Number(it.lon)], 15);
  fixedBadge.style.display='inline';
  updateCenterAddress(false);
}
place.addEventListener('input', e=>{
  fixedBadge.style.display='none';
  const q=e.target.value.trim();
  clearTimeout(suggestTimer);
  if(!q){ slist.style.display='none'; document.querySelector('.sbox').setAttribute('aria-expanded','false'); return; }
  suggestTimer=setTimeout(async()=>{ try{ currentSuggest=await searchPlaces(q); renderSuggest(currentSuggest);}catch{} }, 250);
});
place.addEventListener('keydown', e=>{
  if(e.key==='Escape'){ slist.style.display='none'; document.querySelector('.sbox').setAttribute('aria-expanded','false'); }
});
addEventListener('click', e=>{ const box=document.querySelector('.sbox'); if(box && !box.contains(e.target)) slist.style.display='none'; });

/* Mensaje 1 lÃ­nea / 30 chars */
msgInput.addEventListener('input', ()=>{ msgInput.value=msgInput.value.replace(/\r?\n/g,'').slice(0,30); document.getElementById('chars').textContent='(' + msgInput.value.length + '/30)'; });
msgInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); }});

/* GPS (centra el mapa) */
function setupGpsBtn(){
  if(!('geolocation' in navigator)) return;
  gpsBtn.onclick=()=> navigator.geolocation.getCurrentPosition(async pos=>{
    map.setView([pos.coords.latitude, pos.coords.longitude], 15);
    setView('map');
    fixedBadge.style.display='inline';
    updateCenterAddress(false);
  }, ()=>toast('UbicaciÃ³n no disponible (activa permisos)', false), {timeout:8000});
}
setupGpsBtn();

/* Guardar flor */
async function saveFlower(){
  if(saving) return;
  if(plantedOnce){ toast('Solo puedes plantar una flor por sesiÃ³n.', false); return; }

  // Coordenadas desde el centro del mapa
  const c = map.getCenter();
  const lat=c.lat.toFixed(6), lng=c.lng.toFixed(6);
  $("#lat").value=lat; $("#lng").value=lng;

  const from=$("#fromName").value.trim(), to=$("#toName").value.trim(), msg=$("#message").value.trim();
  if(!from || !to || !msg){ setView('form'); const firstEmpty = !from? "#fromName" : !to? "#toName" : "#message"; setTimeout(()=>$(firstEmpty).focus(), 60); toast('Completa el formulario', false); return; }

  saving=true; plantFab.disabled=true; saveBtn.disabled=true; const prevText=plantFab.textContent; plantFab.textContent='â³';
  try{
    const url = SCRIPT_URL + '?action=add'
      + '&fromName='+encodeURIComponent(from)
      + '&toName='  +encodeURIComponent(to)
      + '&message=' +encodeURIComponent(msg)
      + '&place='   +encodeURIComponent(addrLabel.textContent || '')
      + '&lat='     +encodeURIComponent(lat)
      + '&lng='     +encodeURIComponent(lng);
    const data = await jsonp(url);
    if(data && data.ok){
      if (data.ts && Number(data.ts) > lastTs) lastTs = Number(data.ts);
      await refetch(true);

      // Popup inmediato en mapa
      const dtStr=fmtDateTime(new Date());
      const mk=L.marker([+lat,+lng],{icon:emojiIcon(), zIndexOffset:1500}).bindPopup(popupHtml(from,to,msg,dtStr));
      flowersLayer ? flowersLayer.addLayer(mk) : mk.addTo(map);
      smoothFlyTo([+lat,+lng],17);
      mk.openPopup();

      // Enlace de compartir SIEMPRE con parÃ¡metros
      lastShareUrl = `${location.origin}${location.pathname}?lat=${lat}&lng=${lng}&from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&msg=${encodeURIComponent(msg)}`;

      document.getElementById('successText').textContent = `De ${from} para ${to}.`;
      successModal.style.display='flex';

      // Bloquea mÃ¡s plantaciones
      plantedOnce=true; allowPlanting=false;
    } else { toast('No se pudo guardar', false); }
  }catch(e){ toast('Error al plantar', false); }
  saving=false; plantFab.disabled=false; saveBtn.disabled=false; plantFab.textContent=prevText;
}
plantFab.addEventListener('click', saveFlower);
saveBtn.addEventListener('click', saveFlower);

/* Modal acciones */
mShare.onclick = async ()=>{
  try{
    if(lastShareUrl){
      if(navigator.share){ await navigator.share({title:'Flovermaps', text:'Mira esta flor ğŸŒ¸', url:lastShareUrl}); }
      else{ await navigator.clipboard.writeText(lastShareUrl); toast('Enlace copiado'); }
    }
  }catch{}
  successModal.style.display='none';
};
mOpen.onclick = ()=>{
  try{ if(lastShareUrl) window.open(lastShareUrl, '_blank'); }catch{}
  successModal.style.display='none';
};

/* Logo â†’ refrescar */
document.getElementById('logoBtn').addEventListener('click', ()=>{ location.reload(); });

/* --- LISTA SIN DUPLICADOS POR ID --- */
function normalizeItems(items){
  const out=[];
  for(const f of (items||[])){
    const lat = toNum(f.lat ?? f.latitude ?? f.Latitude ?? f.LAT ?? f.latitud ?? f.y ?? f.Y ?? f.Lat);
    const lng = toNum(f.lng ?? f.lon ?? f.long ?? f.longitude ?? f.Longitude ?? f.LON ?? f.longitud ?? f.x ?? f.X ?? f.Lng);
    if(!isFinite(lat)||!isFinite(lng)) continue;
    const id       = String(f.id ?? f.ID ?? f.Id ?? `${lat},${lng},${f.timestamp ?? ''}`);
    const fromName = f.fromName ?? f.from ?? f.de ?? f.sender ?? f.quien ?? '';
    const toName   = f.toName   ?? f.to   ?? f.para ?? f.recipient ?? f.destinatario ?? '';
    const message  = (f.message ?? f.msg  ?? f.text ?? f.mensaje ?? f.note ?? '');
    const place    = f.place    ?? f.address ?? f.direccion ?? f.location ?? '';
    const timestamp= f.timestamp?? f.ts ?? f.time ?? f.fecha ?? f.createdAt ?? f.created_at ?? '';
    out.push({ id, lat, lng, fromName, toName, message, place, timestamp });
  }
  return out;
}
function mergeUniqueById(oldList, newList){
  const m = new Map();
  for(const it of (oldList||[])) m.set(it.id, it);
  for(const it of (newList||[])) m.set(it.id, it);
  return Array.from(m.values());
}

/* Render con capa condicional (cluster si >=10) */
function ensureFlowersLayer(wantCluster){
  if(useCluster===wantCluster && flowersLayer){ try{flowersLayer.clearLayers();}catch{} return; }
  if(flowersLayer){ try{ map.removeLayer(flowersLayer);}catch{} }
  flowersLayer = wantCluster
    ? L.markerClusterGroup({ showCoverageOnHover:false, spiderfyOnEveryZoom:false, disableClusteringAtZoom:16, maxClusterRadius:60 })
    : L.layerGroup();
  flowersLayer.addTo(map);
  useCluster=wantCluster;
}
function renderAllMarkers(list){
  if(!map) return;
  window._lastItems = list;
  const wantCluster = list.length >= 10;
  ensureFlowersLayer(wantCluster);

  try{ flowersLayer.clearLayers(); }catch{}
  const bounds=L.latLngBounds();
  let i=0, n=list.length;
  (function chunk(){
    const t0=performance.now();
    const batch=[];
    while(i<n && (performance.now()-t0)<24){
      const f=list[i++]; const lat=parseFloat(f.lat), lng=parseFloat(f.lng);
      if(!isFinite(lat)||!isFinite(lng)) continue;
      const dtStr=f.timestamp?fmtDateTime(new Date(Number(f.timestamp)||Date.parse(f.timestamp)||Date.now())):"";
      const html=popupHtml(f.fromName||'', f.toName||'', (f.message||'').slice(0,30), dtStr);
      const mk=L.marker([lat,lng],{icon:emojiIcon(), zIndexOffset:1200}).bindPopup(html);
      batch.push(mk); bounds.extend([lat,lng]);
    }
    if(batch.length){ if(useCluster) flowersLayer.addLayers(batch); else batch.forEach(m=>flowersLayer.addLayer(m)); }
    if(i<n){ requestAnimationFrame(chunk); }
    else{ try{ useCluster && flowersLayer.refreshClusters(); }catch{} if(!didFitBounds && list.length){ didFitBounds=true; map.fitBounds(bounds.pad(0.15), {maxZoom:7}); } }
  })();
}

/* Ãšltimas (sin scroll, con paginaciÃ³n simple) */
function renderLatest(){
  const start = page*pageSize;
  const slice = latestItems.slice(start, start+pageSize);
  if(!slice.length){ recentList.innerHTML='<span class="muted">AÃºn no hay flores recientes.</span>'; return; }
  recentList.innerHTML = slice.map(it=>{
    const when=relTime(it.timestamp);
    const escHtml=s=>String(s||'').replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;","&quot;":"&quot;","'":"&#39;",">":"&gt;"}[m]));
    const escAttrVal=s=>escAttr(String(s||''));
    const shareUrl = `${location.origin}${location.pathname}?lat=${it.lat}&lng=${it.lng}&from=${escAttrVal(it.fromName)}&to=${escAttrVal(it.toName)}&msg=${escAttrVal(it.message)}`;
    return `
      <div class="card recent-row">
        <div class="recent-text">
          <div><strong>${escHtml(it.fromName)}</strong> â†’ <strong>${escHtml(it.toName)}</strong></div>
          <div class="muted" style="margin:2px 0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap">${escHtml(it.message)}</div>
          <div class="muted" style="font-size:.9rem">Â· ${when}</div>
        </div>
        <div class="latest-actions">
          <button class="btn btn-outline btn-xxs"
            onclick="viewFlower('${it.lat}','${it.lng}','${escAttrVal(it.fromName)}','${escAttrVal(it.toName)}','${escAttrVal(it.message)}','${escAttrVal(it.timestamp)}')">Ver</button>
          <button class="btn btn-outline btn-xxs" onclick="shareAny('${shareUrl}')">Compartir</button>
        </div>
      </div>`;
  }).join('');
}
prevPage.addEventListener('click', ()=>{ page=Math.max(0, page-1); renderLatest(); });
nextPage.addEventListener('click', ()=>{ const maxPage=Math.max(0, Math.ceil(latestItems.length/pageSize)-1); page=Math.min(maxPage, page+1); renderLatest(); });

/* Compartir helper */
window.shareAny = async function(url){
  try{
    if(navigator.share){ await navigator.share({title:'Flovermaps', text:'Mira esta flor ğŸŒ¸', url}); }
    else{ await navigator.clipboard.writeText(url); toast('Enlace copiado'); }
  }catch{}
};

/* Ver flor (popup y foco) */
window.viewFlower = function(lat,lng,fromEnc,toEnc,msgEnc,tsEnc){
  setView('map');
  const from=unescAttr(fromEnc), to=unescAttr(toEnc), msg=unescAttr(msgEnc);
  const dtStr = fmtDateTime(new Date(Number(tsEnc)||Date.parse(tsEnc)||Date.now()));
  const html = popupHtml(from,to,msg,dtStr);
  const mk=L.marker([+lat,+lng],{icon:emojiIcon(), zIndexOffset:1600}).addTo(map).bindPopup(html);
  smoothFlyTo([+lat,+lng], 17);
  mk.openPopup();
  setTimeout(()=>{ try{ map.removeLayer(mk); }catch{} }, 12000);
};

/* Smooth fly */
function smoothFlyTo(latlng, z=17){
  try{ map.flyTo(latlng, z, {animate:true, duration:0.8, easeLinearity:0.25}); }
  catch{ map.setView(latlng, z); }
}

/* Refetch incremental */
async function refetch(incremental=true){
  try{
    const url = SCRIPT_URL + '?action=list' + (incremental && lastTs ? ('&since='+encodeURIComponent(lastTs)) : '');
    const data = await jsonp(url, 12000);
    if (data && Array.isArray(data.items)) {
      const newNorm = normalizeItems(data.items);
      latestItems = incremental && lastTs ? mergeUniqueById(window._lastItems||[], newNorm) : newNorm;
      window._lastItems = latestItems.slice();
      renderAllMarkers(latestItems);
      renderLatest();
      for (const it of data.items) {
        const t = Number(it.timestamp)||Date.parse(it.timestamp)||0;
        if (t > lastTs) lastTs = t;
      }
      try{ localStorage.setItem('flowers_cache', JSON.stringify(window._lastItems||[])); }catch{}
      return;
    }
  } catch(e){/* usa cache */ }

  const cached=localStorage.getItem('flowers_cache');
  if(cached){
    latestItems=normalizeItems(JSON.parse(cached));
    window._lastItems=latestItems.slice();
    renderAllMarkers(latestItems);
    renderLatest();
  }
}

/* Polling */
function startPolling(){
  if(pollTimer) clearInterval(pollTimer);
  pollTimer=setInterval(()=>refetch(true), 15000);
  document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) refetch(true); });
}

/* Deep link: abrir flor compartida por params */
function tryOpenShared(){
  const u=new URL(location.href);
  const lat=u.searchParams.get('lat'), lng=u.searchParams.get('lng');
  const from=u.searchParams.get('from')||'', to=u.searchParams.get('to')||'', msg=u.searchParams.get('msg')||'';
  if(lat && lng){
    const go=()=>{ 
      setView('map');
      smoothFlyTo([+lat,+lng], 17);
      const mk=L.marker([+lat,+lng],{icon:emojiIcon(),zIndexOffset:1600}).bindPopup(popupHtml(from,to,msg,fmtDateTime(new Date())));
      flowersLayer ? flowersLayer.addLayer(mk) : mk.addTo(map);
      mk.openPopup();
    };
    if(flowersLayer){ go(); } else { setTimeout(go, 400); }
  }
}

/* Inicio */
document.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('chars').textContent='(0/30)';
  // Vistas: mapa por defecto en mÃ³vil
  if(window.matchMedia('(max-width:1024px)').matches){
    setView('map');
  } else {
    // En desktop mostramos las 3 a la vez; marcamos activas
    views.map.classList.add('is-active'); views.form.classList.add('is-active'); views.latest.classList.add('is-active');
  }
  initMap();
  refetch(false);
  startPolling();
  tryOpenShared();

  // Guardar desde botÃ³n
  document.getElementById('saveBtn').addEventListener('click', saveFlower);

  // Cerrar modal al clicar fuera
  document.addEventListener('click', e=>{
    if(e.target===successModal) successModal.style.display='none';
  });

  // Recalcular vh en iOS cuando rota
  window.addEventListener('orientationchange', ()=>setTimeout(()=>map && map.invalidateSize(), 300));

  // Logo â†’ refrescar
  document.getElementById('logoBtn').addEventListener('click', ()=>{ location.reload(); });
});
</script>
</body>
</html>
