<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Flovermaps ‚Äì Planta una flor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Google Fonts: Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root { --banner-bg: rgba(255,255,255,0.94); }
    * { box-sizing: border-box; }
    body { margin:0; font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:#fafafa; color:#111; }

    /* HEADER */
    header {
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 16px; background:#fff; border-bottom:1px solid #eee;
      position:sticky; top:0; z-index:2000;
    }
    .logo { font-weight:700; font-size:1.1rem; display:flex; align-items:center; gap:.5rem; }
    nav a { margin-left:16px; text-decoration:none; color:#111; font-weight:700; letter-spacing:.3px; }
    nav a:hover { color:#d00; }

    /* LAYOUT */
    .wrap { display:flex; min-height:calc(100vh - 56px); }
    .view-map { flex:1; position:relative; min-height:calc(100vh - 56px); }
    #map { position:relative; width:100%; height:100%; min-height:100%; }

    .panel { width:420px; max-width:100%; padding:20px; border-left:1px solid #eee; background:#fff; overflow:auto; }
    h1 { font-size:1.25rem; margin:0 0 12px; }
    label { display:block; margin:10px 0 6px; }
    input, textarea, button { width:100%; padding:12px; font-size:1rem; border:1px solid #ddd; border-radius:12px; }
    textarea { min-height:96px; resize:vertical; }
    .field-row { display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .small { color:#666; font-size:.9rem; min-height:1.2em; }
    .ok { color:#0a7d25; }
    .error { color:#b30000; }
    button { cursor:pointer; background:#111; color:#fff; border:0; border-radius:12px; margin-top:10px; font-weight:600; }

    /* Contador centrado sobre el mapa */
    .top-center-banner {
      position:absolute; left:50%; top:12px; transform:translateX(-50%);
      background:var(--banner-bg); padding:10px 16px; border-radius:16px;
      box-shadow:0 4px 16px rgba(0,0,0,0.15); z-index:1000; font-weight:700;
    }

    /* Bot√≥n flotante (solo m√≥vil) */
    .fab-plant {
      position:absolute; left:50%; bottom:12px; transform:translateX(-50%);
      z-index:1000; background:#111; color:#fff; border:0; border-radius:999px;
      padding:14px 18px; font-weight:700; box-shadow:0 6px 18px rgba(0,0,0,.25);
      display:none; /* se muestra cuando hay lat/lng en m√≥vil */
    }

    /* Marcador emoji (c√°mbialo por PNG cuando quieras) */
    .emoji-marker{ background:transparent; border:none; font-size:28px; line-height:28px; transform:translate(-14px,-28px); pointer-events:none; }
    .leaflet-marker-icon[src*="marker-icon"]{ display:none!important; }
    .leaflet-marker-shadow{ display:none!important; }

    /* Tabs m√≥vil */
    .tabs { display:none; }
    .view { display:block; }

    /* Responsive m√≥vil */
    @media (max-width: 900px) {
      .wrap { display:block; }
      .tabs {
        position:sticky; top:56px; z-index:1500; display:flex; gap:6px; padding:8px; background:#fff; border-bottom:1px solid #eee;
      }
      .tabs button {
        flex:1; padding:10px; border-radius:10px; border:1px solid #ddd; background:#f6f6f6; font-weight:700;
      }
      .tabs button.active { background:#111; color:#fff; border-color:#111; }
      .view { display:none; }
      .view.active { display:block; }
      .view-map { height: calc(100dvh - 56px - 54px); }
      #map { height: 100%; }
      .panel { width:auto; border-left:0; border-top:1px solid #eee; min-height:calc(100dvh - 56px - 54px); }

      /* Oculta el bot√≥n del formulario en m√≥vil */
      #plantBtn { display:none; }
      /* El flotante aparecer√° seg√∫n estado de JS */
    }

    /* Contador de caracteres */
    .char-counter { font-size:.85rem; color:#666; text-align:right; }
  </style>
</head>
<body>
<header>
  <div class="logo">üå∏ FLOVERMAPS</div>
  <nav>
    <a href="#" onclick="switchView('plant');return false;">PLANTAR</a>
    <a href="#" onclick="switchView('map');return false;">MAPA</a>
  </nav>
</header>

<!-- Tabs (solo m√≥vil) -->
<div class="tabs" id="tabs">
  <button id="tab-plant" class="active" onclick="switchView('plant')">PLANTAR</button>
  <button id="tab-map" onclick="switchView('map')">MAPA</button>
</div>

<div class="wrap">
  <!-- MAPA -->
  <section class="view view-map" id="view-map">
    <div id="map">
      <div class="top-center-banner" id="counter">üå∏ PLANTADAS: 0</div>
      <button class="fab-plant" id="fabPlant">‚úÖ Plantar aqu√≠</button>
    </div>
  </section>

  <!-- FORMULARIO -->
  <section class="view panel active" id="view-plant">
    <h1>Planta una flor üå∏</h1>

    <label>¬øQui√©n la env√≠a?</label>
    <input id="fromName" placeholder="Tu nombre" />

    <label>¬øPara qui√©n?</label>
    <input id="toName" placeholder="Nombre del destinatario" />

    <div class="field-row">
      <label style="margin:10px 0 6px;">Mensaje</label>
      <div class="char-counter"><span id="charsLeft">90</span>/90</div>
    </div>
    <textarea id="message" placeholder="Escribe algo bonito‚Ä¶" maxlength="90"></textarea>

    <label>Ubicaci√≥n</label>
    <input id="place" placeholder="Ej. Sagrada Fam√≠lia, Barcelona" list="suggestions" />
    <datalist id="suggestions"></datalist>

    <div class="small">Confirma la direcci√≥n y luego **arrastra la flor** sobre el punto exacto. En m√≥vil plantar√°s desde el **bot√≥n del mapa**.</div>
    <div style="display:flex; gap:10px; margin-top:8px;">
      <button id="confirmBtn" type="button" style="background:#444;">‚úÖ Confirmar ubicaci√≥n</button>
      <button id="geoBtn" type="button" style="background:#444;">üìç Usar mi ubicaci√≥n</button>
    </div>

    <!-- ocultos -->
    <input id="lat" type="hidden" />
    <input id="lng" type="hidden" />

    <!-- Bot√≥n del formulario (visible en escritorio) -->
    <button id="plantBtn">Plantar flor</button>

    <button id="shareBtn" style="display:none; background:#0066cc;">üîó Compartir flor</button>
    <button id="resetBtn" style="display:none; background:#666;">‚ûï Plantar otra</button>

    <div id="status" class="small"></div>
  </section>
</div>

<script>
  /* === CONFIG === */
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxKcq4xqM1PB_wfIXibeotizuxw0-UgrPJ0LN70U-bva2Isk8EMwdsWeOk8l2w1DvFmJQ/exec";
  const NOMINATIM_EMAIL = "gracia.david@gmail.com";

  /* MAPA CARTO Voyager */
  const voyager = L.tileLayer("https://basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png", { attribution:'¬© OpenStreetMap ¬© CARTO', maxZoom:19 });
  const map = L.map("map", { layers:[voyager], zoomControl:true }).setView([40.4168,-3.7038], 13);

  /* Marcador (emoji) ‚Äì cambia a PNG cuando quieras */
  const flowerIcon = L.divIcon({ html:"üå∏", className:"emoji-marker", iconSize:[28,28], iconAnchor:[14,28] });

  let editMarker = null;      // marcador ARR√ÅSTRABLE para edici√≥n
  const seen = new Set();     // para no duplicar flores cargadas

  const $ = sel => document.querySelector(sel);
  const statusEl = $("#status");
  const counterEl = $("#counter");
  const charsLeftEl = $("#charsLeft");
  const fabPlant = $("#fabPlant");

  /* --- Responsive: pesta√±as en m√≥vil --- */
  function isMobile(){ return window.matchMedia("(max-width: 900px)").matches; }
  function switchView(which){
    const plant = $("#view-plant"), mapV = $("#view-map");
    const tabBar = $("#tabs"), tPlant=$("#tab-plant"), tMap=$("#tab-map");

    if(isMobile()){
      tabBar.style.display = "flex";
      if(which === "map"){
        plant.classList.remove("active");
        mapV.classList.add("active");
        tPlant.classList.remove("active");
        tMap.classList.add("active");
        setTimeout(()=>map.invalidateSize(),150);
      } else {
        mapV.classList.remove("active");
        plant.classList.add("active");
        tMap.classList.remove("active");
        tPlant.classList.add("active");
      }
      (which==="map" ? mapV : plant).scrollIntoView({behavior:"smooth", block:"start"});
    } else {
      tabBar.style.display = "none";
    }
  }
  window.addEventListener("resize", ()=>switchView("plant"));
  document.addEventListener("DOMContentLoaded", ()=>switchView("plant"));

  /* --- Utilidades --- */
  function setStatus(msg,cls=""){ statusEl.className="small "+cls; statusEl.textContent=msg; }
  function escapeHtml(s){ return String(s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
  function fmtDate(d){ return `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}/${d.getFullYear()}`; }
  function popupHtml(from,to,msg,dateStr){ return `De ${escapeHtml(from)}<br>Para ${escapeHtml(to)}<br>üå∏ ${escapeHtml(msg)}${dateStr?`<br><small>üìÖ ${dateStr}</small>`:""}`; }
  function updateLatLng(lat, lon){ $("#lat").value=lat; $("#lng").value=lon; }

  // Crea/actualiza el marcador ARR√ÅSTRABLE para edici√≥n
  function setPoint(lat, lon, zoomOverride){
    updateLatLng(lat, lon);
    if(editMarker){
      editMarker.setLatLng([lat, lon]);
    } else {
      editMarker = L.marker([lat, lon], { icon: flowerIcon, draggable: true }).addTo(map);
      // al soltar, actualiza coords
      editMarker.on("dragend", (e)=>{
        const p = e.target.getLatLng();
        updateLatLng(p.lat.toFixed(6), p.lng.toFixed(6));
      });
    }
    const z = (typeof zoomOverride === "number") ? zoomOverride : 14;
    map.setView([lat, lon], z);
    // En m√≥vil, muestra el bot√≥n flotante al tener coords
    if(isMobile()) fabPlant.style.display = "inline-block";
  }

  // Marcadores (no arrastrables) que hacen ZOOM 19 al clic
  function addFlower(lat, lng, html, openNow=false){
    const m = L.marker([+lat, +lng], { icon: flowerIcon }).addTo(map).bindPopup(html);
    m.on("click", ()=>{ map.setView(m.getLatLng(), 19); m.openPopup(); });
    if(openNow){ map.setView([+lat, +lng], 19); m.openPopup(); }
    return m;
  }

  /* --- L√≠mite de 90 caracteres y contador --- */
  const messageEl = $("#message");
  const MAX_LEN = 90;
  function refreshCounter(){
    const left = MAX_LEN - messageEl.value.length;
    charsLeftEl.textContent = left;
  }
  messageEl.addEventListener("input", ()=>{
    if(messageEl.value.length > MAX_LEN) messageEl.value = messageEl.value.slice(0, MAX_LEN);
    refreshCounter();
  });
  refreshCounter();

  /* --- B√∫squeda/confirmaci√≥n de ubicaci√≥n (zoom 18 al confirmar) --- */
  async function fillSuggestions(q){
    try{
      const url="https://nominatim.openstreetmap.org/search?format=json&limit=5&q="+encodeURIComponent(q)+"&email="+encodeURIComponent(NOMINATIM_EMAIL);
      const res=await fetch(url,{ headers:{ 'Accept':'application/json' }});
      return await res.json();
    }catch{ return []; }
  }
  async function searchAndFix(q){
    if(!q) return setStatus("Escribe una direcci√≥n o usa el mapa/GPS","error");
    setStatus("Buscando‚Ä¶");
    const r=await fillSuggestions(q);
    if(r.length>0){
      const f=r[0];
      setPoint(Number(f.lat).toFixed(6), Number(f.lon).toFixed(6), 18); // üëà zoom 18 para comprobar
      setStatus("Ubicaci√≥n confirmada. Arrastra la flor para ajustar el punto y planta desde el mapa.");
      if(isMobile()) switchView('map');
    } else setStatus("No se encontr√≥ esa ubicaci√≥n","error");
  }

  $("#confirmBtn").onclick=()=>searchAndFix($("#place").value.trim());
  $("#geoBtn").onclick=()=>navigator.geolocation && navigator.geolocation.getCurrentPosition(p=>{
    setPoint(p.coords.latitude.toFixed(6), p.coords.longitude.toFixed(6), 18);
    setStatus("Ubicaci√≥n por GPS. Ajusta arrastrando la flor y planta desde el mapa.");
    if(isMobile()) switchView('map');
  });
  map.on("click",e=>{
    setPoint(e.latlng.lat.toFixed(6), e.latlng.lng.toFixed(6), 18);
    setStatus("Punto elegido en el mapa. Ajusta arrastrando la flor y planta desde el mapa.");
    if(isMobile()) switchView('map');
  });

  /* --- Cargar flores existentes + contador ‚Äúüå∏ PLANTADAS:‚Äù --- */
  async function loadFlowers(){
    try{
      const res=await fetch(SCRIPT_URL);
      const data=await res.json();
      (data.items||[]).forEach(f=>{
        if(!f.lat||!f.lng) return;
        const k = `${+f.lat},${+f.lng}|${f.fromName||''}|${f.toName||''}|${f.message||''}|${f.timestamp||''}`;
        if(seen.has(k)) return;
        seen.add(k);
        const dateStr = f.timestamp ? fmtDate(new Date(f.timestamp)) : "";
        addFlower(f.lat, f.lng, popupHtml(f.fromName||"", f.toName||"", f.message||"", dateStr), false);
      });
      counterEl.textContent = `üå∏ PLANTADAS: ${seen.size}`;
    }catch{}
  }

  /* --- Guardar flor (funci√≥n com√∫n) --- */
  async function saveFlower(){
    let from=$("#fromName").value.trim(), to=$("#toName").value.trim(), msg=$("#message").value.trim(),
        place=$("#place").value.trim(), lat=$("#lat").value.trim(), lng=$("#lng").value.trim();

    if(msg.length > MAX_LEN) msg = msg.slice(0, MAX_LEN);
    if(!from||!to||!msg||!place||!lat||!lng) { setStatus("Completa todos los campos y confirma/ajusta la ubicaci√≥n","error"); return false; }

    setStatus("Guardando‚Ä¶");
    try{
      const body=new URLSearchParams({fromName:from,toName:to,message:msg,place,lat,lng}).toString();
      const res=await fetch(SCRIPT_URL,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body});
      const data=await res.json();
      if(data.ok){
        const dateStr=fmtDate(new Date());
        addFlower(lat, lng, popupHtml(from,to,msg,dateStr), true); // zoom 19 + popup
        counterEl.textContent = `üå∏ PLANTADAS: ${seen.size}`;
        setStatus("¬°Flor plantada!","ok");
        // mostrar botones
        $("#shareBtn").style.display="block";
        $("#resetBtn").style.display="block";
        const iso = new Date().toISOString().slice(0,10);
        const url=`${location.origin}${location.pathname}?lat=${lat}&lng=${lng}&from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&msg=${encodeURIComponent(msg)}&d=${iso}`;
        $("#shareBtn").onclick=()=>{ navigator.clipboard.writeText(url); setStatus("Enlace copiado ‚úÖ","ok"); };
        $("#resetBtn").onclick=()=>{ $("#fromName").value=""; $("#toName").value=""; $("#message").value=""; $("#place").value=""; $("#lat").value=""; $("#lng").value=""; refreshCounter(); $("#shareBtn").style.display="none"; $("#resetBtn").style.display="none"; setStatus("Formulario listo para otra flor."); if(editMarker){ map.removeLayer(editMarker); editMarker=null; } if(isMobile()) fabPlant.style.display="none"; };
        // limpiar marcador de edici√≥n y ocultar FAB
        if(editMarker){ map.removeLayer(editMarker); editMarker=null; }
        if(isMobile()) fabPlant.style.display="none";
        return true;
      } else { setStatus("Error: "+(data.error||"Desconocido"),"error"); return false; }
    }catch{ setStatus("Error de red","error"); return false; }
  }

  /* --- Click del bot√≥n del formulario (escritorio) --- */
  $("#plantBtn").onclick = saveFlower;

  /* --- Click del bot√≥n flotante (m√≥vil) --- */
  fabPlant.onclick = async ()=>{
    fabPlant.disabled = true;
    fabPlant.textContent = "Plantando‚Ä¶";
    const ok = await saveFlower();
    if(!ok){ fabPlant.disabled = false; fabPlant.textContent = "‚úÖ Plantar aqu√≠"; }
  };

  /* --- Deep-link: abrir flor compartida --- */
  (function(){
    const p=new URLSearchParams(location.search);
    if(p.has("lat") && p.has("lng")){
      const lat=p.get("lat"), lng=p.get("lng"), from=p.get("from")||"", to=p.get("to")||"", msg=p.get("msg")||"", d=p.get("d")||"";
      let dateStr=""; if(d){ const dd=new Date(d); if(!isNaN(dd)) dateStr=fmtDate(dd); }
      addFlower(lat, lng, popupHtml(from,to,msg,dateStr), true);
      if(isMobile()) switchView("map");
    }
    loadFlowers();
    setInterval(loadFlowers, 30000);
  })();
</script>
</body>
</html>
