<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Flovermaps - Plant a Flower Change the World</title>
<meta name="theme-color" content="#f6fff9" />
<meta name="description" content="Planta una flor solidaria en el mapa y dedica un mensaje. Tu aportaci√≥n es √≠ntegra para la ONG elegida, excepto 0,90 ‚Ç¨ para el mantenimiento de tu flor para siempre.">
<!-- BUILD: FM-frontend-3.2.2 (debug overlay + fixes) -->

<!-- Redirecci√≥n can√≥nica: www ‚Üí apex -->
<script>
  (function(){
    try{
      var apex="flovermaps.com";
      if(location.hostname==="www."+apex){
        location.replace("https://"+apex+location.pathname+location.search+location.hash);
      }
    }catch(e){}
  })();
</script>

<!-- Favicon coraz√≥n -->
<link rel="icon" type="image/svg+xml"
  href='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><path fill="%23c73737" d="M32 57c-1.1 0-2.1-.3-3-.9C20.7 51.7 4 39.7 4 22.8 4 14 11 7 19.8 7c4.8 0 9.1 2.2 12.2 5.7C35.1 9.2 39.4 7 44.2 7 53 7 60 14 60 22.8c0 16.9-16.7 28.9-25 33.3-.9.6-1.9.9-3 .9z"/></svg>' />

<!-- Perf: preconnect -->
<link rel="preconnect" href="https://api.stripe.com" crossorigin>
<link rel="preconnect" href="https://js.stripe.com" crossorigin>
<link rel="preconnect" href="https://flovermaps-stripe-backend.onrender.com" crossorigin>
<link rel="dns-prefetch" href="https://api.stripe.com">
<link rel="dns-prefetch" href="https://js.stripe.com">
<link rel="dns-prefetch" href="https://flovermaps-stripe-backend.onrender.com">

<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">

<!-- Leaflet CSS + JS (sin defer para asegurar orden) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha512-y4UQvRZV9tTg0l0nF2HnVv7m0XH1bU0G4l7jXb1G5TQ4t7lJ9xgM0iWmQXf3sHn8c0qU9J5Zp8gqz2lG0n8mQ==" crossorigin="">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha512-pkG5Yw2m1o0a8q1R7oZ1lA6m1mB3n8s8m1Y8Cw5mC2kqkqX7c9p4nH8e2z6r3d9kZlK3pK1oYxQ7nC5J9T9V7Q=="
        crossorigin=""></script>

<style>
  :root{ --ink:#0f172a; --muted:#64748b; --green:#22c55e; --blue:#0066cc; --bg:#f6fff9; --safe-b:env(safe-area-inset-bottom,0px); --safe-t:env(safe-area-inset-top,0px); }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:'Plus Jakarta Sans',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:linear-gradient(180deg,#f6fff9 0%,#ecfaf2 60%,#e8f8ef 100%);overflow:hidden}

  .site-header{ position:fixed; z-index:1000; top:0; inset:auto 0 auto 0; display:flex; justify-content:center; padding:8px 10px; padding-top:calc(8px + var(--safe-t)); pointer-events:none; }
  .brand{ pointer-events:auto; background:#fff; border:1px solid #e6e6e8; border-radius:12px; padding:6px 16px; box-shadow:0 6px 18px rgba(2,6,12,.06); cursor:pointer }
  .brand img{ height:84px; display:block }

  #mapWrap{ position:fixed; inset:0; }
  #map{ position:absolute; inset:0; width:100%; height:100vh; height:100dvh; }

  .controls{ position:fixed; z-index:900; left:50%; transform:translateX(-50%); bottom:calc(18px + var(--safe-b)); width:min(94vw,960px); display:flex; flex-direction:column; gap:10px }
  .row{ display:flex; gap:10px }
  .tool-btn{ flex:1; background:#fff; border:1px solid #e6e6e6; border-radius:12px; padding:12px 14px; font-size:1rem; cursor:pointer; box-shadow:0 6px 14px rgba(0,0,0,.04); display:flex; align-items:center; justify-content:center; gap:8px }

  .searchRow{ display:flex; gap:10px }
  .searchRow .input{ flex:1; display:flex; align-items:center; gap:8px; background:#fff; border:1px solid #e6e6e6; border-radius:12px; padding:12px 14px; box-shadow:0 6px 14px rgba(0,0,0,.04) }
  .searchRow input{ border:0; outline:none; width:100%; font:inherit; background:transparent; color:var(--ink) }

  .slist{ position:fixed; left:50%; transform:translateX(-50%); bottom:calc(84px + var(--safe-b)); width:min(94vw,960px); background:#fff; border:1px solid #e6e6e6; border-radius:12px; max-height:260px; overflow:auto; display:none; z-index:920; box-shadow:0 6px 14px rgba(0,0,0,.06) }
  .sitem{ padding:12px 14px; border-bottom:1px solid #f3f3f3; cursor:pointer; font-size:1rem }
  .addr-badge{ position:fixed; left:50%; transform:translateX(-50%); bottom:calc(160px + var(--safe-b)); z-index:880; background:#fff; border:1px solid #e6e6e6; border-radius:999px; padding:8px 12px; font-size:1rem; font-weight:700; max-width:min(92vw,520px); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; box-shadow:0 8px 24px rgba(0,0,0,.10); display:none }

  .pin-cta{ position:absolute; z-index:930; display:none; background:linear-gradient(180deg,#26d166,#1fb057); color:#fff; border:0; border-radius:16px; padding:14px 18px; font-size:1.05rem; font-weight:700; box-shadow:0 16px 36px rgba(0,0,0,.22); cursor:pointer; transform:translate(-50%,10px) }

  .leaflet-marker-icon[src*="marker-icon"], .leaflet-marker-shadow{ display:none!important }
  .emoji-marker .e{ font-size:44px; line-height:44px; text-shadow:0 1px 0 #fff,0 -1px 0 #fff,1px 0 0 #fff,-1px 0 0 #fff,0 0 4px rgba(0,0,0,.25) }
  .drag-ring{ position:absolute; width:64px; height:64px; border-radius:999px; border:3px solid #22c55e; box-shadow:0 0 0 10px rgba(34,197,94,.14), inset 0 0 0 3px rgba(255,255,255,.9); pointer-events:none; z-index:850; display:none; transform:translate(-50%,-50%) }

  .sheet{ position:fixed; left:0; right:0; bottom:0; z-index:1001; transform:translateY(100%); transition:transform .25s ease; background:#fff; border-top-left-radius:16px; border-top-right-radius:16px; box-shadow:0 -20px 60px rgba(0,0,0,.25); max-height:85dvh; display:flex; flex-direction:column }
  .sheet.open{ transform:translateY(0) }
  .sheet .handle{ align-self:center; width:54px; height:5px; border-radius:999px; background:#e5e7eb; margin:8px 0 4px }
  .sheet .body{ padding:10px 14px 16px; overflow:auto; -webkit-overflow-scrolling:touch }
  .row2{ display:grid; grid-template-columns:1fr 1fr; gap:8px }
  label{ display:block; margin:6px 0 4px; font-size:.92rem }
  input,.btn,select{ width:100%; padding:12px; border:1px solid #ddd; border-radius:10px; font-size:1rem }
  .btn{ border:0; cursor:pointer }
  .btn-green{ background:var(--green); color:#fff }
  .muted{ color:#64748b; font-size:.95rem }

  .chips{ display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 }
  .chip{ padding:8px 10px; border:1px solid #e6e6e6; border-radius:999px; cursor:pointer }
  .chip.active{ background:var(--green); color:#fff; border-color:var(--green) }

  .toast{ position:fixed; left:50%; bottom:calc(100px + var(--safe-b)); transform:translateX(-50%); background:#111; color:#fff; padding:10px 12px; border-radius:10px; z-index:1500; opacity:0; pointer-events:none; transition:opacity .18s,bottom .18s }
  .toast.show{ opacity:1; bottom:calc(110px + var(--safe-b)) }

  .veil{ position:fixed; inset:0; background:rgba(246,255,249,.85); display:none; align-items:center; justify-content:center; z-index:2000; }
  .veil .box{ background:#fff; border:1px solid #e6e6e6; border-radius:14px; padding:14px 18px; box-shadow:0 12px 36px rgba(0,0,0,.12); font-weight:700 }
</style>

<!-- ===== DEBUG OVERLAY (temporal) ===== -->
<style>
  #dbgErr{position:fixed;inset:auto 8px 8px 8px;background:#1b1b1b;color:#fff;
    font:14px/1.35 ui-monospace,Menlo,Consolas,monospace;border-radius:10px;
    padding:10px 12px;z-index:99999;max-height:40vh;overflow:auto;display:none;box-shadow:0 8px 30px rgba(0,0,0,.35)}
  #dbgErr b{color:#ff8}
  #dbgErr .note{color:#8bb}
</style>
<script>
(function(){
  function show(msg){
    var el=document.getElementById('dbgErr');
    if(!el){ el=document.createElement('div'); el.id='dbgErr'; document.body.appendChild(el); }
    el.style.display='block';
    el.innerHTML += '<div>'+msg+'</div>';
  }
  window.addEventListener('error', function(e){
    show('<b>JS Error:</b> '+(e.message||e.error)+'<br><span class="note">'+(e.filename||'')+':'+(e.lineno||'')+'</span>');
  });
  window.addEventListener('unhandledrejection', function(e){
    show('<b>Promise Rejection:</b> '+(e.reason&&e.reason.message||e.reason));
  });
  document.addEventListener('DOMContentLoaded', function(){
    try{
      show('<b>Build:</b> DEBUG overlay activo');
      show('<b>Leaflet presente:</b> '+(!!window.L));
      var mapDiv = document.getElementById('map');
      show('<b>#map existe:</b> '+(!!mapDiv));
    }catch(err){ show('<b>Overlay error:</b> '+err.message); }
  });
})();
</script>
<!-- ===== /DEBUG OVERLAY ===== -->

</head>
<body>

<header class="site-header">
  <div class="brand" id="logoBtn"><img src="logo.png" alt="FLOVERMAPS" onerror="this.style.display='none'"></div>
</header>

<main id="mapWrap" aria-label="Mapa">
  <div id="map"></div>
  <div id="dragRing" class="drag-ring"></div>
  <button id="pinCta" class="pin-cta">Plantar</button>
</main>

<div class="controls" id="controls" aria-label="Controles">
  <div class="row">
    <button id="tapBtn" class="tool-btn">üå∏ Plantar desde el mapa</button>
    <button id="gpsBtn" class="tool-btn">üìç Mi ubicaci√≥n</button>
  </div>
  <div class="searchRow">
    <div class="input">
      <span aria-hidden="true">üîé</span>
      <input id="searchInput" placeholder="Buscar un lugar (calle, ciudad‚Ä¶)" autocomplete="off" aria-autocomplete="list" aria-controls="slist" />
    </div>
  </div>
</div>

<div id="slist" class="slist" role="listbox" aria-label="Sugerencias de lugares"></div>
<div id="addrBadge" class="addr-badge" aria-live="polite"></div>

<section id="sheet" class="sheet" aria-modal="true" role="dialog" aria-labelledby="sheetTitle" aria-hidden="true">
  <div class="handle"></div>
  <div id="sheetBody" class="body">
    <div id="formView">
      <h3 id="sheetTitle">Tu dedicatoria</h3>
      <div class="row2">
        <div><label for="fromName">¬øQui√©n la env√≠a?</label><input id="fromName" placeholder="Tu nombre" required></div>
        <div><label for="toName">¬øPara qui√©n?</label><input id="toName" placeholder="Nombre del destinatario" required></div>
      </div>
      <label for="message" style="margin-top:8px">Mensaje <span class="muted" id="chars">(0/30)</span></label>
      <input id="message" maxlength="30" placeholder="Ese rinc√≥n especial‚Ä¶ (m√°x. 30)" inputmode="text" autocomplete="off" required />
      <label for="ngo" style="margin-top:10px">ONG</label>
      <select id="ngo">
        <option value="msf" selected>M√©dicos Sin Fronteras</option>
        <option value="stc">Save the Children</option>
        <option value="aecc">Asociaci√≥n Espa√±ola contra el C√°ncer</option>
        <option value="unicef">UNICEF</option>
      </select>
      <div style="margin-top:10px">
        <div class="chips" id="chips">
          <button class="chip" data-amount="2">2 ‚Ç¨</button>
          <button class="chip active" data-amount="9">9 ‚Ç¨</button>
          <button class="chip" data-amount="10">10 ‚Ç¨</button>
          <button class="chip" data-amount="other">Otro</button>
        </div>
        <div id="otherRow" style="display:none">
          <label for="otherAmount" class="muted">Importe personalizado</label>
          <input id="otherAmount" type="number" min="1" step="0.01" placeholder="Ej. 25,00" inputmode="decimal" />
        </div>
        <div id="splitCopy" class="muted" style="margin-top:6px"></div>
      </div>
      <div style="margin-top:12px">
        <button id="payAndPlantBtn" class="btn btn-green" style="width:100%;font-size:1.05rem;padding:14px 18px">Pagar y plantar ‚Äî 9,00 ‚Ç¨</button>
      </div>
    </div>
  </div>
</section>

<div id="toast" class="toast" role="status" aria-live="polite"></div>
<div id="veil" class="veil"><div class="box">Preparando la semilla‚Ä¶</div></div>

<script>
/* === CONFIG === */
const SCRIPT_URL  = "https://script.google.com/macros/s/AKfycbzhi7PdPv_g4GifrGXWzwsPxKMIFhPilMpc14vB-ruwrO9NW0pAlFd1vS72K1KNPO8NIg/exec";
const BACKEND_URL = "https://flovermaps-stripe-backend.onrender.com";
const STREET_ZOOM = 17;
const MAX_ZOOM = 19;

const PROD_ORIGIN = "https://flovermaps.com";
function shareUrlFor(id){
  const origin = (typeof PROD_ORIGIN === 'string' && PROD_ORIGIN) || location.origin;
  return origin.replace(/\/$/,'') + '/?id=' + encodeURIComponent(String(id||''));
}

/* === FLAGS URL (antes de mapa) === */
const URL_NOW = new URL(location.href);
const RETURNING_FROM_STRIPE = (URL_NOW.searchParams.get('success')==='1' && URL_NOW.searchParams.get('session_id'));
const HAS_DEEPLINK = !!(URL_NOW.searchParams.get('id') || (location.pathname.match(/\/f\/([^\/?#]+)/)));

/* === HELPERS === */
function toast(m,ok=true){const t=document.getElementById('toast');t.textContent=m;t.style.background=ok?"#111":"#b30000";t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1800)}
function fmt(n){return (Number(n)||0).toFixed(2).replace('.',',')}
function fmtDate(ts){try{ return new Intl.DateTimeFormat('es-ES',{timeZone:'Europe/Madrid',day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit',hour12:false}).format(new Date(Number(ts)||Date.now())).replace(',',''); }catch{return ''}}
function emojiIcon(){ return L.divIcon({className:'emoji-marker', html:'<span class="e" role="img" aria-label="flor">üå∏</span>', iconSize:[44,44], iconAnchor:[22,44], popupAnchor:[0,-46]}); }
function escHtml(s){return String(s||'').replace(/[&<>\"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]))}
function jsonp(url,timeoutMs=12000){return new Promise((resolve,reject)=>{const cb='__cb_'+Math.random().toString(36).slice(2);const s=document.createElement('script');const sep=url.includes('?')?'&':'?';s.src=url+sep+'callback='+cb+'&_ts='+Date.now();let to;function cleanup(){clearTimeout(to);try{delete window[cb]}catch{};s.remove()}window[cb]=(d)=>{cleanup();resolve(d)};s.onerror=()=>{cleanup();reject(new Error('jsonp'))};document.head.appendChild(s);to=setTimeout(()=>{cleanup();reject(new Error('timeout'))},timeoutMs)})}

/* === ENFOQUE CALLE ROBUSTO === */
function focusToStreet(lat,lng){
  const z=Math.min(MAX_ZOOM,STREET_ZOOM);
  try{
    map.setView([lat,lng], z, {animate:false});
    setTimeout(()=>{ try{ map.flyTo([lat,lng], z, {duration:.5}); }catch{} }, 80);
  }catch{}
}

/* === ESTADO === */
let map, baseTiles, fallbackTiles;
let selectedMarker=null, selectedLat=null, selectedLng=null;
let flowersCache=[], lastTs=0, plantMode=false;
let amount=9;

/* === DOM === */
const slist=document.getElementById('slist'), addrBadge=document.getElementById('addrBadge'), dragRing=document.getElementById('dragRing'), pinCta=document.getElementById('pinCta');
const fromInput=document.getElementById('fromName'), toInput=document.getElementById('toName'), msgInput=document.getElementById('message'), ngoSel=document.getElementById('ngo');
const chips=document.getElementById('chips'), otherRow=document.getElementById('otherRow'), otherAmount=document.getElementById('otherAmount'), payBtn=document.getElementById('payAndPlantBtn');

/* === Keep-alive backend === */
setInterval(()=>{ fetch(`${BACKEND_URL}/health`,{mode:'no-cors'}).catch(()=>{}) }, 240000);

/* === MAPA === */
window.addEventListener('load', ()=>{
  if(!window.L){ alert('No se pudo cargar Leaflet.'); return; }

  baseTiles = L.tileLayer('https://basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',{ attribution:'¬© OpenStreetMap ¬© CARTO', maxZoom:MAX_ZOOM });
  baseTiles.on('tileerror', ()=>{ try{ map.removeLayer(baseTiles); }catch{}; fallbackTiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'¬© OpenStreetMap', maxZoom:MAX_ZOOM }); fallbackTiles.addTo(map); });

  map = L.map('map',{layers:[baseTiles],zoomControl:true,worldCopyJump:true,maxZoom:MAX_ZOOM});

  // Vista inicial SOLO si no vienes de Stripe ni hay deep link
  if(!RETURNING_FROM_STRIPE && !HAS_DEEPLINK){
    try{ map.setView([40.4168,-3.7038],5,{animate:false}); }catch{}
  }

  setTimeout(()=>{ try{ map.invalidateSize(); }catch{} }, 200);

  map.on('click', e=>{ if(!plantMode) return; setSelectedPoint(e.latlng.lat,e.latlng.lng,true); });
  map.on('move zoom', ()=>{ if(selectedMarker){ positionRing(); positionCta(); } });
  window.addEventListener('resize', ()=>setTimeout(()=>{ try{ map.invalidateSize(); }catch{} }, 120));

  bindUI();
  refetch(false);
  setInterval(()=>refetch(true),15000);

  deepLink();
  afterStripe();
});

/* === UI === */
document.getElementById('logoBtn').addEventListener('click', ()=>location.reload());
document.getElementById('tapBtn').addEventListener('click', ()=>{ plantMode=true; toast('Toca el mapa para elegir el punto'); });
document.getElementById('gpsBtn').addEventListener('click', ()=>{
  plantMode=true;
  if(!('geolocation' in navigator)) return toast('Tu dispositivo no permite geolocalizaci√≥n', false);
  navigator.geolocation.getCurrentPosition(pos=>{
    setSelectedPoint(pos.coords.latitude,pos.coords.longitude,true);
    focusToStreet(pos.coords.latitude, pos.coords.longitude);
  }, ()=>toast('No se pudo obtener tu ubicaci√≥n', false), {timeout:8000});
});
pinCta.addEventListener('click', ()=>{ if(!selectedLat||!selectedLng) return toast('Elige un punto del mapa primero', false); openSheet(); });

function openSheet(){ const s=document.getElementById('sheet'); s.classList.add('open'); s.setAttribute('aria-hidden','false'); try{ map.dragging.disable(); map.scrollWheelZoom.disable(); map.doubleClickZoom.disable(); }catch{}; updateSplit(); }
function closeSheet(){ const s=document.getElementById('sheet'); s.classList.remove('open'); s.setAttribute('aria-hidden','true'); try{ map.dragging.enable(); map.scrollWheelZoom.enable(); map.doubleClickZoom.enable(); }catch{}; }

document.getElementById('chars').textContent='(0/30)';
msgInput.addEventListener('input', ()=>{ msgInput.value=msgInput.value.replace(/\r?\n/g,'').slice(0,30); document.getElementById('chars').textContent='('+msgInput.value.length+'/30)'; });
msgInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); } });

/* === B√öSQUEDA === */
let suggestTimer=null, abortCtrl=null, currentSuggest=[];
const searchInput=document.getElementById('searchInput');
searchInput.addEventListener('input', e=>{
  const q=e.target.value.trim(); clearTimeout(suggestTimer);
  if(!q){ slist.style.display='none'; return; }
  suggestTimer=setTimeout(()=>runSuggest(q),260);
});
document.addEventListener('click', e=>{ if(!slist.contains(e.target) && e.target!==searchInput) slist.style.display='none'; });
searchInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); if(currentSuggest.length){ selectSuggest(0); } } });

async function runSuggest(q){
  if(abortCtrl) abortCtrl.abort();
  abortCtrl=new AbortController(); const sig=abortCtrl.signal;
  slist.innerHTML='<div class="sitem">Buscando‚Ä¶</div>'; slist.style.display='block';
  try{
    const r=await fetch('https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=10&accept-language=es,en&q='+encodeURIComponent(q),{signal:sig});
    const list=await r.json(); currentSuggest=list||[]; renderSuggest(list);
  }catch{ currentSuggest=[]; renderSuggest([]); }
}
function renderSuggest(list){
  slist.innerHTML='';
  (list||[]).forEach((it,i)=>{
    const dn=String(it.display_name||'').split(',');
    const primary=dn[0]||'';
    const meta=[dn[1]||'',dn[2]||''].filter(Boolean).join(', ');
    const el=document.createElement('div'); el.className='sitem';
    el.textContent=primary+(meta?(' ¬∑ '+meta):'');
    el.onclick=()=>selectSuggest(i); slist.appendChild(el);
  });
  slist.style.display=(list&&list.length)?'block':'none';
}
function selectSuggest(i){
  const it=currentSuggest[i]; if(!it) return; slist.style.display='none';
  plantMode=true;
  const lat=Number(it.lat), lng=Number(it.lon);
  setSelectedPoint(lat,lng,true);
  focusToStreet(lat,lng);
}

/* === SELECCI√ìN PUNTO === */
function setSelectedPoint(lat,lng,animate){
  if(!selectedMarker){
    selectedMarker=L.marker([lat,lng],{icon:emojiIcon(), draggable:true, zIndexOffset:2000}).addTo(map);
    selectedMarker.bindTooltip('Arrastra para ajustar',{permanent:true, direction:'top', offset:[0,-52], className:'drag-tip'}).openTooltip();
    selectedMarker.on('drag', ()=>{ positionRing(); positionCta(); });
    selectedMarker.on('dragend', e=>{
      const p=e.target.getLatLng(); selectedLat=p.lat.toFixed(6); selectedLng=p.lng.toFixed(6);
      reverseAt(selectedLat, selectedLng); positionRing(); positionCta();
      focusToStreet(+selectedLat, +selectedLng);
    });
  } else { selectedMarker.setLatLng([lat,lng]); }
  selectedLat=Number(lat).toFixed(6); selectedLng=Number(lng).toFixed(6);
  if(animate){ focusToStreet(+selectedLat, +selectedLng); }
  reverseAt(selectedLat,selectedLng);
  addrBadge.style.display='block';
  showRing(); positionRing(); showCta();
}
function reverseAt(lat,lng){
  addrBadge.textContent='Buscando direcci√≥n‚Ä¶';
  fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&accept-language=es,en&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`)
    .then(r=>r.json()).then(j=>{
      const a=j.address||{}; const road=a.road||a.pedestrian||a.path||a.neighbourhood||''; const hn=a.house_number||a.housenumber||''; const city=a.city||a.town||a.village||a.state||'';
      addrBadge.textContent=[[road,hn].filter(Boolean).join(' '),city].filter(Boolean).join(', ')||j.display_name||'Ubicaci√≥n aproximada';
    }).catch(()=>addrBadge.textContent='Ubicaci√≥n aproximada');
}
function positionRing(){
  if(!selectedMarker) return;
  const p=map.latLngToContainerPoint(selectedMarker.getLatLng());
  dragRing.style.left=p.x+'px'; dragRing.style.top=(p.y-22)+'px';
}
function positionCta(){ const p=map.latLngToContainerPoint(selectedMarker.getLatLng()); pinCta.style.left=p.x+'px'; pinCta.style.top=(p.y+52)+'px'; }
function showRing(){ dragRing.style.display='block'; } function hideRing(){ dragRing.style.display='none'; }
function showCta(){ positionCta(); pinCta.style.display='inline-block'; } function hideCta(){ pinCta.style.display='none'; }

/* === IMPORTE/COPY === */
function updateSplit(){ document.getElementById('splitCopy').innerHTML=`Tu aportaci√≥n es √≠ntegra para <strong>${escHtml(ngoSel.options[ngoSel.selectedIndex]?.text||'la ONG')}</strong>, excepto <strong>0,90 ‚Ç¨</strong> para el mantenimiento de tu flor para siempre.`; }
chips.addEventListener('click', e=>{
  const b=e.target.closest('.chip'); if(!b) return;
  chips.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); b.classList.add('active');
  const v=b.dataset.amount;
  if(v==='other'){
    otherRow.style.display='block';
    amount = 25; otherAmount.value = amount.toFixed(2); otherAmount.focus();
  } else {
    otherRow.style.display='none';
    amount = Number(v)||9;
  }
  payBtn.textContent=`Pagar y plantar ‚Äî ${fmt(amount)} ‚Ç¨`; updateSplit();
});
otherAmount.addEventListener('input', ()=>{ let v=Number(String(otherAmount.value||'').replace(',','.')); if(!isFinite(v)) return; amount=v; payBtn.textContent=`Pagar y plantar ‚Äî ${fmt(amount)} ‚Ç¨`; });
otherAmount.addEventListener('blur',  ()=>{ let v=Number(String(otherAmount.value||'').replace(',','.')); if(!isFinite(v)||v<1) v=1; amount=v; otherAmount.value=amount.toFixed(2); payBtn.textContent=`Pagar y plantar ‚Äî ${fmt(amount)} ‚Ç¨`; });
ngoSel.addEventListener('change', updateSplit);

/* === STRIPE === */
const veil=document.getElementById('veil');
payBtn.addEventListener('click', async ()=>{
  if(!selectedLat||!selectedLng) return toast('Coloca la flor en el mapa', false);
  const from=fromInput.value.trim(), to=toInput.value.trim(), msg=msgInput.value.trim();
  if(!from||!to||!msg) return toast('Completa tu dedicatoria', false);
  if(otherRow.style.display!=='none'){ let v=Number(String(otherAmount.value||'').replace(',','.')); if(!isFinite(v)||v<1) v=25; amount=v; otherAmount.value=amount.toFixed(2); payBtn.textContent=`Pagar y plantar ‚Äî ${fmt(amount)} ‚Ç¨`; }

  veil.style.display='flex';
  payBtn.disabled=true;
  try{
    const body={ lat:+selectedLat, lng:+selectedLng, place:addrBadge.textContent||'', fromName:from, toName:to, message:msg, ngo:String(ngoSel.value||''), ngo_label:ngoSel.options[ngoSel.selectedIndex]?.text||'', amount_total:+(+amount).toFixed(2) };
    const r=await fetch(`${BACKEND_URL}/create-checkout-session`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body), cache:'no-store'});
    const j=await r.json().catch(()=>null);
    if(!j||!j.ok||!j.url){ veil.style.display='none'; return toast('Error creando pago', false); }
    window.location.assign(j.url);
  }catch{ veil.style.display='none'; toast('Fallo de red', false); } finally{ payBtn.disabled=false; }
});

/* === RETORNO DE STRIPE: pintar, enfocar y abrir === */
async function afterStripe(){
  if(!RETURNING_FROM_STRIPE) return;
  const sid=URL_NOW.searchParams.get('session_id');
  try{
    const r=await fetch(`${BACKEND_URL}/session?id=${encodeURIComponent(sid)}`,{cache:'no-store'});
    const j=await r.json();
    if(j&&j.ok&&j.id){
      const d=await jsonp(`${SCRIPT_URL}?action=get&id=${encodeURIComponent(j.id)}`).catch(()=>null);
      if(d&&d.ok&&d.item){
        const it=d.item; const dt=fmtDate(it.timestamp);
        const shareUrl = shareUrlFor(it.id);
        const mk=L.marker([+it.lat,+it.lng],{icon:emojiIcon(),zIndexOffset:1600}).addTo(map)
          .bindPopup(popupHtml(it.fromName||'',it.toName||'',it.message||'',dt,shareUrl, +it.amount_total||+it.amountTotal||0));
        mk._isFlower=true; mk._fid=String(it.id||'');

        map.whenReady(()=>{ focusToStreet(+it.lat, +it.lng); setTimeout(()=>mk.openPopup(), 120); });

        // Cache local + render
        upsertCache([{ id:String(it.id), lat:+it.lat, lng:+it.lng, fromName:it.fromName||'', toName:it.toName||'', message:it.message||'', timestamp:+it.timestamp||Date.now(), amount_total:+it.amount_total||+it.amountTotal||0 }]);
        persistCache(); render(flowersCache);

        setTimeout(()=>toast('¬°Gracias! Flor plantada üå∏'), 150);
      }
    }
  }catch{}
  // limpia la query
  URL_NOW.searchParams.delete('success'); URL_NOW.searchParams.delete('session_id');
  history.replaceState({},'',URL_NOW.toString());
  setTimeout(()=>refetch(true),1200);
}

/* === Popup === */
function popupHtml(from,to,msg,dt,shareUrl,total){
  const safeFrom=escHtml(from), safeTo=escHtml(to), safeMsg=escHtml(msg);
  const url=shareUrl||`${location.origin}${location.pathname}`;
  const tt=fmt(total||0);
  return `
    <div style="min-width:260px;max-width:320px">
      <div class="muted" style="margin-bottom:6px">${dt||''}</div>
      <div style="margin-bottom:6px"><strong>De ${safeFrom}</strong> para <strong>${safeTo}</strong></div>
      <div style="margin-bottom:10px">${safeMsg}</div>
      <div class="muted" style="margin-bottom:12px">Donaci√≥n: <strong>${tt} ‚Ç¨</strong></div>
      <button onclick="shareAny('${url.replace(/'/g,'&#39;')}')" style="width:100%;border:0;border-radius:10px;padding:10px 12px;font-size:.95rem;background:#0066cc;color:#fff;cursor:pointer">üîó Compartir</button>
    </div>`;
}
async function shareAny(url){
  try{
    if(navigator.share){ await navigator.share({title:'Flovermaps', text:'He plantado esta üå∏ en un lugar del Mundo, especialmente para ti.', url}); }
    else{ await navigator.clipboard.writeText(url); toast('Enlace copiado'); }
  }catch{}
}
window.shareAny = shareAny;

/* === CACHE / RENDER === */
function normalize(items){
  const out=[];
  for(const f of (items||[])){
    const lat=+f.lat, lng=+f.lng; if(!isFinite(lat)||!isFinite(lng)) continue;
    out.push({ id:String(f.id||''), lat,lng, fromName:f.fromName||'', toName:f.toName||'', message:f.message||'', timestamp:+f.timestamp||0, amount_total: isFinite(+f.amount_total)?+f.amount_total : (isFinite(+f.amountTotal)?+f.amountTotal:0) });
  }
  return out;
}
function upsertCache(newList){ const m=new Map(flowersCache.map(x=>[x.id,x])); for(const it of (newList||[])) m.set(it.id,it); flowersCache = Array.from(m.values()); }
function persistCache(){ try{ localStorage.setItem('flowers_cache', JSON.stringify(flowersCache)); }catch{} }
function loadCache(){ try{ const c=localStorage.getItem('flowers_cache'); flowersCache = c?JSON.parse(c):[]; }catch{ flowersCache=[]; } }

function render(list){
  const data=list||flowersCache||[]; if(!map) return;
  const toRemove=[]; map.eachLayer(l=>{ if(l&&l._isFlower) toRemove.push(l); });
  toRemove.forEach(l=>map.removeLayer(l));
  for(const f of data){
    const dt=f.timestamp?fmtDate(f.timestamp):'';
    const shareUrl = shareUrlFor(f.id);
    const mk=L.marker([f.lat,f.lng],{icon:emojiIcon(),zIndexOffset:1200});
    mk._isFlower=true; mk._fid=String(f.id||'');
    mk.bindPopup(popupHtml(f.fromName,f.toName,f.message,dt,shareUrl,f.amount_total));
    mk.addTo(map);
  }
}

async function refetch(incr){
  if(!flowersCache.length){ loadCache(); if(flowersCache.length) render(flowersCache); }
  try{
    const url = SCRIPT_URL + '?action=list' + (incr&&lastTs?('&since='+encodeURIComponent(lastTs)):'');
    const d = await jsonp(url,12000);
    if(d && Array.isArray(d.items)){
      const norm=normalize(d.items);
      if(incr){ if(!norm.length) return; upsertCache(norm); persistCache(); render(flowersCache); }
      else { flowersCache = norm; persistCache(); render(flowersCache); }
      for(const it of d.items){ const t=+it.timestamp||0; if(t>lastTs) lastTs=t; }
      return;
    }
  }catch{}
  if(flowersCache.length){ render(flowersCache); }
}

/* === Deep link === */
async function deepLink(){
  const u=new URL(location.href);
  let id = u.searchParams.get('id');
  if(!id){
    const m=location.pathname.match(/\/f\/([^\/?#]+)/);
    if(m&&m[1]) id=decodeURIComponent(m[1]);
  }
  if(id){
    try{
      const d=await jsonp(`${SCRIPT_URL}?action=get&id=${encodeURIComponent(id)}`);
      if(d&&d.ok&&d.item){
        const it=d.item; const dt=fmtDate(it.timestamp);
        const shareUrl = shareUrlFor(id);
        const mk=L.marker([+it.lat,+it.lng],{icon:emojiIcon(),zIndexOffset:1600}).addTo(map)
          .bindPopup(popupHtml(it.fromName||'',it.toName||'',it.message||'',dt,shareUrl, +it.amount_total||+it.amountTotal||0));
        mk._isFlower=true; mk._fid=String(it.id||'');
        map.whenReady(()=>{ focusToStreet(+it.lat, +it.lng); setTimeout(()=>mk.openPopup(), 120); });
        return;
      }
    }catch{}
  }
}

/* === Miscel√°nea === */
function bindUI(){
  document.addEventListener('keydown', e=>{ if(e.key==='Escape'){ slist.style.display='none'; } });
  updateSplit();
}
</script>
</body>
</html>
