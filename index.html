<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Flovermaps ‚Äì Planta una flor</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  :root { --banner-bg: rgba(255,255,255,0.94); --pink:#ffe6f0; }
  *{box-sizing:border-box}
  body{margin:0;font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--pink);color:#111}

  header{display:flex;align-items:center;gap:.75rem;padding:10px 16px;background:#fff;border-bottom:1px solid #eee;position:sticky;top:0;z-index:2000}
  .logo{font-weight:700;font-size:1.1rem;display:flex;align-items:center;gap:.5rem}

  /* Counter (odometer + carousel) */
  .global-counter{margin:8px 12px 0;padding:10px 16px;border-radius:14px;background:var(--banner-bg);box-shadow:0 4px 14px rgba(0,0,0,.08)}
  .counter-line{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .label{font-weight:800}
  .odometer{display:flex;gap:4px;align-items:center}
  .digit{position:relative;min-width:26px;height:36px;border-radius:6px;background:#f5f5f5;box-shadow:inset 0 -1px 0 #ddd,0 1px 2px rgba(0,0,0,.06);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:1.05rem}
  .digit.sep{min-width:12px;background:transparent;box-shadow:none}
  .digit:not(.sep)::after{content:"";position:absolute;left:4px;right:4px;top:50%;height:1px;background:#ddd;transform:translateY(-.5px)}
  .carousel{margin-top:2px;font-size:.85rem;color:#444;line-height:1.3;overflow:hidden;white-space:nowrap;font-weight:400}
  .carousel-track{display:inline-block;padding-left:100%;will-change:transform;animation:marquee 14s linear infinite}
  @keyframes marquee{0%{transform:translateX(0)}100%{transform:translateX(-100%)}}
  @media (prefers-reduced-motion:reduce){.carousel-track{animation:none;padding-left:0}}

  /* Layout */
  .wrap{display:flex;gap:0;min-height:calc(100vh - 56px)}
  .panel{width:420px;max-width:100%;padding:12px;border-right:1px solid #eee;background:#fff;overflow:auto;order:2}
  .card{border:1px solid #e5e5e5;border-radius:14px;padding:12px;box-shadow:0 4px 14px rgba(0,0,0,.04);background:#fff}
  h1{font-size:1.06rem;margin:0 0 10px}
  label{display:block;margin:6px 0 4px;font-size:.9rem}
  input,textarea,button{width:100%;padding:9px 10px;font-size:.92rem;border:1px solid #ddd;border-radius:10px}
  textarea{min-height:52px;max-height:72px;resize:vertical}
  .small{color:#666;font-size:.78rem}
  button{cursor:pointer;background:#111;color:#fff;border:0;border-radius:10px;margin-top:8px;font-weight:600}

  .row-two{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .help-line{font-size:.76rem;color:#666;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .row-actions{display:flex;gap:6px;margin-top:6px;align-items:center;flex-wrap:wrap}
  .row-actions button{padding:8px 10px;font-size:.88rem;line-height:1;white-space:nowrap}

  /* Suggestions dropdown */
  .suggest-box{position:relative}
  .suggest-list{
    position:absolute;z-index:1500;left:0;right:0;top:100%;margin-top:4px;max-height:220px;overflow:auto;
    background:#fff;border:1px solid #e6e6e6;border-radius:10px;box-shadow:0 10px 24px rgba(0,0,0,.08);display:none
  }
  .suggest-item{padding:9px 10px;cursor:pointer;border-bottom:1px solid #f1f1f1}
  .suggest-item:last-child{border-bottom:0}
  .suggest-item small{color:#666}
  .suggest-item:hover{background:#f9f9f9}

  /* Map */
  .view-map{flex:1;position:relative;padding:10px 12px 12px;order:1}
  .map-frame{position:relative;border:1px solid #e5e5e5;border-radius:16px;overflow:hidden;background:linear-gradient(135deg,#f8fbff,#f6f0ff);box-shadow:0 6px 20px rgba(0,0,0,.06);height:100%}
  #map{position:absolute;top:5px;right:5px;bottom:5px;left:5px;border-radius:12px}
  .actions-below-map{display:flex;gap:8px;justify-content:center;padding:10px 12px 0;flex-wrap:wrap}
  #plantHereBtn{max-width:260px;display:none}
  #shareBtn{background:#0066cc;max-width:260px;display:none}

  /* Marker + animation */
  .emoji-marker{background:transparent;border:none;font-size:28px;line-height:28px;transform:translate(-14px,-28px);pointer-events:none}
  .sprout{animation:sprout 800ms ease-out;transform-origin:bottom center}
  @keyframes sprout{0%{transform:translate(-14px,-28px) scale(.1) rotate(-10deg);opacity:0}60%{transform:translate(-14px,-28px) scale(1.15) rotate(2deg);opacity:1}100%{transform:translate(-14px,-28px) scale(1) rotate(0);opacity:1}}
  .leaflet-marker-icon[src*="marker-icon"]{display:none!important}.leaflet-marker-shadow{display:none!important}

  /* Mobile */
  @media (max-width:900px){
    .wrap{flex-direction:column}
    .panel{order:1;width:auto;border-right:0;border-bottom:1px solid #eee;padding:12px}
    .view-map{order:2}
    .map-frame{height:50vh}
    input,textarea,button{font-size:.9rem;padding:8px 10px}
    .row-actions button{padding:7px 9px;font-size:.86rem}
  }
</style>
</head>
<body>
<header><div class="logo">üå∏ FLOVERMAPS</div></header>

<!-- Counter -->
<div class="global-counter">
  <div class="counter-line">
    <div class="label">PLANTADAS</div>
    <div id="odo" class="odometer" aria-label="Flores plantadas"></div>
  </div>
  <div class="carousel"><span id="carouselTrack" class="carousel-track">A√∫n no hay flores plantadas.</span></div>
</div>

<div class="wrap">
  <!-- Formulario -->
  <section class="panel" id="view-plant">
    <div class="card">
      <h1>Planta una flor üå∏</h1>

      <div class="row-two">
        <div><label>¬øQui√©n la env√≠a?</label><input id="fromName" placeholder="Tu nombre"></div>
        <div><label>¬øPara qui√©n?</label><input id="toName" placeholder="Nombre del destinatario"></div>
      </div>

      <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-top:8px;">
        <label style="margin:6px 0 4px;">Mensaje</label>
        <div class="small"><span id="charsLeft">90</span>/90</div>
      </div>
      <textarea id="message" placeholder="Escribe algo bonito‚Ä¶" maxlength="90"></textarea>

      <label style="margin-top:8px;">Ubicaci√≥n</label>
      <div class="suggest-box">
        <input id="place" placeholder="Ej. Sagrada Fam√≠lia, Barcelona" autocomplete="off">
        <div id="suggestList" class="suggest-list"></div>
      </div>
      <div id="help" class="help-line">Introduce una direcci√≥n y ajusta el sitio exacto en el mapa.</div>

      <!-- Esta fila define la altura del mapa en desktop -->
      <div id="confirmRow" class="row-actions">
        <button id="confirmBtn" type="button" style="background:#444;">‚úÖ Confirmar direcci√≥n</button>
        <button id="geoBtn" type="button" style="background:#444;">üìç Usar mi ubicaci√≥n</button>
        <span id="fixedBadge" class="small" style="color:#0a7d25;display:none;">‚úÖ Direcci√≥n fijada</span>
      </div>

      <input id="lat" type="hidden"><input id="lng" type="hidden">
    </div>
  </section>

  <!-- Mapa -->
  <section class="view-map" id="view-map">
    <div class="map-frame" id="mapFrame"><div id="map"></div></div>
    <div class="actions-below-map">
      <button id="plantHereBtn">‚úÖ Plantar aqu√≠</button>
      <button id="shareBtn">üîó Compartir</button>
    </div>
  </section>
</div>

<script>
  /* CONFIG */
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxKcq4xqM1PB_wfIXibeotizuxw0-UgrPJ0LN70U-bva2Isk8EMwdsWeOk8l2w1DvFmJQ/exec";
  const NOMINATIM_EMAIL = "gracia.david@gmail.com";

  /* Leaflet */
  const voyager = L.tileLayer("https://basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png",{attribution:"¬© OpenStreetMap ¬© CARTO",maxZoom:19});
  const map = L.map("map",{layers:[voyager],zoomControl:true}).setView([40.4168,-3.7038],13);
  const flowerIcon = L.divIcon({html:"üå∏",className:"emoji-marker",iconSize:[28,28],iconAnchor:[14,28]});

  let editMarker=null; const seen=new Set();
  let usedGPS=false, usedMapClick=false;
  let lastLatest=null; // ‚Üê recordaremos SIEMPRE la √∫ltima flor para el carrusel

  const $=s=>document.querySelector(s);
  const mapFrame=$("#mapFrame"), plantHereBtn=$("#plantHereBtn"), shareBtn=$("#shareBtn");
  const suggestList=$("#suggestList"), fixedBadge=$("#fixedBadge");
  let carouselTrack=$("#carouselTrack");

  /* ODOMETER */
  function fmtThousands(n){ return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g,"."); }
  function renderOdometer(n){ const odo=$("#odo"); odo.innerHTML=""; for(const ch of fmtThousands(n)){ const d=document.createElement("div"); d.className="digit"+(ch==="."?" sep":""); d.textContent=ch; odo.appendChild(d);} }

  /* Sound */
  function chime(){ try{const ctx=new (window.AudioContext||window.webkitAudioContext)();const o=ctx.createOscillator();const g=ctx.createGain();o.type="sine";o.frequency.value=880;o.connect(g);g.connect(ctx.destination);const t=ctx.currentTime;g.gain.setValueAtTime(0.0001,t);g.gain.exponentialRampToValueAtTime(0.15,t+0.02);g.gain.exponentialRampToValueAtTime(0.0001,t+0.35);o.start(t);o.stop(t+0.4);}catch{} }

  /* Utils */
  function isMobile(){ return matchMedia("(max-width: 900px)").matches; }
  const MAX_LEN=90;
  $("#message").addEventListener("input",()=>{const t=$("#message");if(t.value.length>MAX_LEN)t.value=t.value.slice(0,MAX_LEN);$("#charsLeft").textContent=MAX_LEN-t.value.length;syncMapHeight();});
  function fmtDate(d){return `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}/${d.getFullYear()}`;}
  function fmtTime(d){return `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}:${String(d.getSeconds()).padStart(2,"0")}`;}
  function escapeHtml(s){return String(s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;","&gt;":">","\"":"&quot;","'":"&#39;"}[m]) );}
  function popupHtml(from,to,msg,dateStr){return `De ${escapeHtml(from)}<br>Para ${escapeHtml(to)}<br>üå∏ ${escapeHtml(msg)}${dateStr?`<br><small>üìÖ ${dateStr}</small>`:""}`;}

  async function reverseCity(lat,lon){
    try{
      const url=`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&email=${encodeURIComponent(NOMINATIM_EMAIL)}`;
      const r=await fetch(url); const j=await r.json(); const a=j.address||{};
      return a.city || a.town || a.village || a.municipality || a.locality || a.county || a.state || "‚Äî";
    }catch{return "‚Äî";}
  }
  function cityFromPlace(place){
    if(!place) return "‚Äî";
    const p=place.split(",").map(s=>s.trim()).filter(Boolean);
    const first=p[0]||place.trim(); if(p.length>1 && (/\d/.test(first)||first.length>30)) return p[1]; return first;
  }

  /* Carousel text */
  function setCarousel(from,to,city,date,msg){
    lastLatest = {from,to,city,date,msg};
    const text=`Flor plantada por ${from||"‚Äî"} para ${to||"‚Äî"} en ${city||"‚Äî"} a las ${fmtTime(date||new Date())}. ${msg?`‚Äú${msg}‚Äù`:""}`;
    const span=document.createElement("span"); span.className="carousel-track"; span.textContent="   "+text+"   ";
    carouselTrack.replaceWith(span); carouselTrack=span; span.style.animation="none"; span.offsetHeight; span.style.animation=null;
  }
  function keepLastCarouselIfAny(){
    if(lastLatest){
      setCarousel(lastLatest.from,lastLatest.to,lastLatest.city,lastLatest.date,lastLatest.msg);
    }
  }

  /* Heights */
  function syncMapHeight(){
    if(isMobile()){ mapFrame.style.height="50vh"; setTimeout(()=>map.invalidateSize(),50); return; }
    const confirmRow=$("#confirmRow"); const h=confirmRow.offsetTop+confirmRow.offsetHeight+12; mapFrame.style.height=h+"px"; setTimeout(()=>map.invalidateSize(),50);
  }
  addEventListener("resize",syncMapHeight); document.addEventListener("DOMContentLoaded",syncMapHeight);

  /* Edit point */
  function updateLatLng(lat,lon){ $("#lat").value=lat; $("#lng").value=lon; }
  function setPoint(lat,lon,z=18){
    updateLatLng(lat,lon);
    fixedBadge.style.display="inline"; // marcado como fijado
    if(editMarker){ editMarker.setLatLng([lat,lon]); }
    else{
      editMarker=L.marker([lat,lon],{icon:flowerIcon,draggable:true}).addTo(map);
      editMarker.on("dragend",e=>{const p=e.target.getLatLng();updateLatLng(p.lat.toFixed(6),p.lng.toFixed(6));});
    }
    map.setView([lat,lon],z); plantHereBtn.style.display="inline-block";
  }

  /* Map interactions */
  map.on("click",e=>{usedMapClick=true;usedGPS=false;setPoint(e.latlng.lat.toFixed(6),e.latlng.lng.toFixed(6)); if(isMobile())$("#view-map").scrollIntoView({behavior:"smooth"});});

  function addFlower(lat,lng,html,open=false,animate=false){
    const m=L.marker([+lat,+lng],{icon:flowerIcon}).addTo(map).bindPopup(html);
    m.on("click",()=>{map.setView(m.getLatLng(),19);m.openPopup();});
    if(open){map.setView([+lat,+lng],19);m.openPopup();}
    if(animate){setTimeout(()=>{const icons=document.querySelectorAll(".emoji-marker");if(icons.length){const el=icons[icons.length-1];el.classList.add("sprout");el.addEventListener("animationend",()=>el.classList.remove("sprout"),{once:true});}},10);}
    return m;
  }

  /* Search & suggestions */
  let suggestTimer=null;
  async function searchPlaces(q){
    try{
      const url=`https://nominatim.openstreetmap.org/search?format=json&limit=6&q=${encodeURIComponent(q)}&addressdetails=1&email=${encodeURIComponent(NOMINATIM_EMAIL)}`;
      const r=await fetch(url); return await r.json();
    }catch{return [];}
  }
  $("#place").addEventListener("input", e=>{
    fixedBadge.style.display="none";
    const q=e.target.value.trim();
    clearTimeout(suggestTimer);
    if(!q){ suggestList.style.display="none"; return; }
    suggestTimer=setTimeout(async()=>{
      const res=await searchPlaces(q);
      if(!res.length){ suggestList.style.display="none"; return; }
      suggestList.innerHTML="";
      res.forEach(it=>{
        const li=document.createElement("div");
        const city = (it.address?.city || it.address?.town || it.address?.village || it.address?.municipality || "");
        li.className="suggest-item";
        li.innerHTML=`${escapeHtml(it.display_name.split(",")[0])} <small>${escapeHtml(city || it.type || "")}</small>`;
        li.onclick=()=>{ $("#place").value = it.display_name; suggestList.style.display="none"; usedGPS=false; usedMapClick=false; setPoint(Number(it.lat).toFixed(6),Number(it.lon).toFixed(6)); if(isMobile())$("#view-map").scrollIntoView({behavior:"smooth"}); };
        suggestList.appendChild(li);
      });
      suggestList.style.display="block";
    }, 220);
  });
  document.addEventListener("click",e=>{ if(!$(".suggest-box").contains(e.target)) suggestList.style.display="none"; });

  async function confirmFromInput(){
    const q=$("#place").value.trim(); if(!q) return;
    const r=await searchPlaces(q); if(r.length>0){ const f=r[0]; usedGPS=false; usedMapClick=false; setPoint(Number(f.lat).toFixed(6),Number(f.lon).toFixed(6)); if(isMobile())$("#view-map").scrollIntoView({behavior:"smooth"}); }
  }
  $("#confirmBtn").onclick=confirmFromInput;

  $("#geoBtn").onclick=()=>navigator.geolocation&&navigator.geolocation.getCurrentPosition(p=>{
    usedGPS=true; usedMapClick=false; fixedBadge.style.display="inline";
    setPoint(p.coords.latitude.toFixed(6),p.coords.longitude.toFixed(6));
    if(isMobile())$("#view-map").scrollIntoView({behavior:"smooth"});
  });

  /* Load existing */
  async function loadFlowers(){
    try{
      const res=await fetch(SCRIPT_URL); const data=await res.json();
      let latest=lastLatest; // ‚Üê empezamos con la √∫ltima conocida (si existe)
      (data.items||[]).forEach(f=>{
        if(!f.lat||!f.lng) return;
        const k=`${+f.lat},${+f.lng}|${f.fromName||''}|${f.toName||''}|${f.message||''}|${f.timestamp||''}`;
        if(seen.has(k)) return;
        seen.add(k);
        const dateStr = f.timestamp ? fmtDate(new Date(f.timestamp)) : "";
        addFlower(f.lat, f.lng, popupHtml(f.fromName||"", f.toName||"", f.message||"", dateStr), false, false);
        if(f.timestamp){
          const ts=new Date(f.timestamp);
          if(!latest || ts > (latest.date||0)){
            latest = {from:f.fromName||"‚Äî", to:f.toName||"‚Äî", city:cityFromPlace(f.place||""), date:ts, msg:f.message||""};
          }
        }
      });
      renderOdometer(seen.size);
      if(latest){ setCarousel(latest.from, latest.to, latest.city, latest.date, latest.msg); } else { keepLastCarouselIfAny(); }
      syncMapHeight();
    }catch{ keepLastCarouselIfAny(); }
  }

  /* Save flower */
  async function saveFlower(){
    let from=$("#fromName").value.trim(), to=$("#toName").value.trim(), msg=$("#message").value.trim(),
        place=$("#place").value.trim(), lat=$("#lat").value.trim(), lng=$("#lng").value.trim();
    const placeOk = place || usedGPS || usedMapClick;
    if(msg.length>90) msg=msg.slice(0,90);
    if(!from||!to||!msg||!lat||!lng||!placeOk) return false;

    if(!place && usedGPS) place="Mi ubicaci√≥n";
    if(!place && usedMapClick) place="Punto del mapa";

    try{
      plantHereBtn.disabled=true; plantHereBtn.textContent="Plantando‚Ä¶";
      const body=new URLSearchParams({fromName:from,toName:to,message:msg,place,lat,lng}).toString();
      const res=await fetch(SCRIPT_URL,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body});
      const data=await res.json();
      if(data.ok){
        const now=new Date();
        addFlower(lat, lng, popupHtml(from,to,msg,fmtDate(now)), true, true);
        chime();

        seen.add(`${+lat},${+lng}|${from}|${to}|${msg}|${now.toISOString()}`);
        renderOdometer(seen.size);

        // ciudad para carrusel: si place viene de GPS/mapa, intentar reverse
        let city = (usedGPS||usedMapClick) ? await reverseCity(lat,lng) : cityFromPlace(place);
        setCarousel(from, to, city, now, msg);

        // compartir
        const shareUrl=`${location.origin}${location.pathname}?lat=${lat}&lng=${lng}&from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&msg=${encodeURIComponent(msg)}&d=${now.toISOString().slice(0,10)}`;
        shareBtn.style.display="inline-block";
        shareBtn.onclick=async()=>{
          try{
            if(navigator.share){ await navigator.share({title:"Flovermaps",text:`Una flor para ${to}`,url:shareUrl}); }
            else{ await navigator.clipboard.writeText(shareUrl); shareBtn.textContent="‚úÖ Copiado"; setTimeout(()=>shareBtn.textContent="üîó Compartir",1500); }
          }catch{}
        };

        // limpiar UI de plantado
        if(editMarker){ map.removeLayer(editMarker); editMarker=null; }
        plantHereBtn.style.display="none"; plantHereBtn.disabled=false; plantHereBtn.textContent="‚úÖ Plantar aqu√≠";
        fixedBadge.style.display="none";
        return true;
      }else{
        plantHereBtn.disabled=false; plantHereBtn.textContent="‚úÖ Plantar aqu√≠"; return false;
      }
    }catch{
      plantHereBtn.disabled=false; plantHereBtn.textContent="‚úÖ Plantar aqu√≠"; return false;
    }
  }
  plantHereBtn.onclick=saveFlower;

  /* Misc */
  function syncMapHeight(){ if(isMobile()){ mapFrame.style.height="50vh"; setTimeout(()=>map.invalidateSize(),50); return;} const confirmRow=$("#confirmRow"); const h=confirmRow.offsetTop+confirmRow.offsetHeight+12; mapFrame.style.height=h+"px"; setTimeout(()=>map.invalidateSize(),50); }
  addEventListener("resize",syncMapHeight); document.addEventListener("DOMContentLoaded",syncMapHeight);

  /* Init */
  (function(){ renderOdometer(0); loadFlowers(); setInterval(loadFlowers,30000); })();
</script>
</body>
</html>
