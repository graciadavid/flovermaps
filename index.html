<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Flovermaps ‚Äî Planta una flor solidaria</title>

<link rel="icon" type="image/svg+xml" href='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 64 64"><text x="6" y="54" font-size="52">üå∏</text></svg>'>
<meta name="theme-color" content="#f6fff9" />
<meta name="description" content="Planta una flor solidaria en el mapa y dedica un mensaje. Tu aportaci√≥n es √≠ntegra para la ONG elegida, excepto 0,90 ‚Ç¨ para el mantenimiento de la flor para siempre." />

<link rel="preconnect" href="https://nominatim.openstreetmap.org">
<link rel="preconnect" href="https://tile.openstreetmap.org">
<link rel="preconnect" href="https://basemaps.cartocdn.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  :root{ --ink:#0f172a; --muted:#64748b; --green:#22c55e; --blue:#0066cc; --bg:#f6fff9; --safe-b: env(safe-area-inset-bottom, 0px); --safe-t: env(safe-area-inset-top, 0px); }
  *{box-sizing:border-box}
  html, body { height:100%; }
  body{ margin:0; font-family:'Plus Jakarta Sans',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--ink); background: linear-gradient(180deg, #f6fff9 0%, #ecfaf2 60%, #e8f8ef 100%); overflow:hidden; }

  .site-header{ position:fixed; z-index:1000; inset:auto 0 auto 0; top:0; display:flex; justify-content:center; padding:8px 10px; padding-top:calc(8px + var(--safe-t)); pointer-events:none; }
  .brand{ pointer-events:auto; background:#fff; border:1px solid #e8e8e8; border-radius:12px; padding:6px 16px; box-shadow:0 6px 18px rgba(2,6,12,.06); cursor:pointer }
  .brand img{ height:84px; display:block }

  #mapWrap{ position:fixed; inset:0; }
  #map{ position:absolute; inset:0; width:100%; height:100vh; height:100dvh; }
  .map-error{ position:fixed; z-index:1500; left:50%; transform:translateX(-50%); bottom:25%; width:min(92vw,560px); background:#fff; border:1px solid #eee; border-radius:12px; padding:14px 16px; box-shadow:0 10px 30px rgba(0,0,0,.12); display:none }

  .controls{ position:fixed; z-index:900; left:50%; transform:translateX(-50%); bottom:calc(18px + var(--safe-b)); width:min(94vw,960px); display:flex; flex-direction:column; gap:10px; }
  .row{ display:flex; gap:10px; }
  .tool-btn{ flex:1 1 0; background:#fff; border:1px solid #e6e6e6; border-radius:12px; padding:12px 14px; font-size:1rem; cursor:pointer; box-shadow:0 6px 14px rgba(0,0,0,.04); display:flex; align-items:center; justify-content:center; gap:8px; }
  .tool-btn:active{ transform:translateY(1px) }

  .searchRow{ display:flex; gap:10px; }
  .searchRow .input{ flex:1 1 auto; display:flex; align-items:center; gap:8px; background:#fff; border:1px solid #e6e6e6; border-radius:12px; padding:12px 14px; box-shadow:0 6px 14px rgba(0,0,0,.04); }
  .searchRow input{ border:0; outline:none; width:100%; font: inherit; background:transparent; color:var(--ink); }

  .slist{ position:fixed; left:50%; transform:translateX(-50%); bottom:calc(84px + var(--safe-b)); width:min(94vw,960px); background:#fff; border:1px solid #e6e6e6; border-radius:12px; max-height:260px; overflow:auto; display:none; z-index:920; box-shadow:0 6px 14px rgba(0,0,0,.06) }
  .sitem{ padding:12px 14px; border-bottom:1px solid #f3f3f3; cursor:pointer; font-size:1rem }
  .sitem:last-child{ border-bottom:0 }

  /* Etiqueta (pill con flecha) */
  .addr-badge{ position:fixed; left:50%; transform:translateX(-50%); bottom:calc(160px + var(--safe-b)); z-index:880; background:#fff; border:1px solid #e6e6e6; border-radius:999px; padding:8px 12px; font-size:1rem; font-weight:700; color:#0e1935; max-width:min(92vw,520px); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; box-shadow:0 8px 24px rgba(0,0,0,.10); display:none; }
  .addr-badge::after{ content:""; position:absolute; left:50%; transform:translateX(-50%); bottom:-8px; border-left:8px solid transparent; border-right:8px solid transparent; border-top:8px solid #fff; filter:drop-shadow(0 1px 0 rgba(0,0,0,.08)); }

  /* CTA pegada al pin */
  .pin-cta{ position:absolute; z-index:930; display:none; background:linear-gradient(180deg,#26d166,#1fb057); color:#fff; border:0; border-radius:16px; padding:14px 18px; font-size:1.05rem; font-weight:700; letter-spacing:.2px; box-shadow:0 16px 36px rgba(0,0,0,.22); cursor:pointer; transform:translate(-50%, 10px); }
  .pin-cta:active{ transform:translate(-50%, 12px); }

  /* Flor y anillo */
  .leaflet-marker-icon[src*="marker-icon"], .leaflet-marker-shadow{ display:none!important }
  .emoji-marker{ background:transparent; }
  .emoji-marker .e{ font-size:44px; line-height:44px; text-shadow:0 1px 0 #fff,0 -1px 0 #fff,1px 0 0 #fff,-1px 0 0 #fff,0 0 4px rgba(0,0,0,.25) }
  .drag-ring{ position:absolute; width:64px; height:64px; border-radius:999px; border:3px solid #22c55e; box-shadow:0 0 0 10px rgba(34,197,94,.14), inset 0 0 0 3px rgba(255,255,255,.9); pointer-events:none; z-index:850; display:none; transform:translate(-50%, -50%); background:radial-gradient(circle at 50% 50%, rgba(34,197,94,.12), rgba(34,197,94,.06) 60%, rgba(34,197,94,0) 70%); }

  /* Tooltip de arrastre (pill con flecha) */
  .leaflet-tooltip.drag-tip{ background:#fff; color:#0f172a; border:1px solid #e6e6e6; border-radius:999px; padding:6px 12px; box-shadow:0 8px 24px rgba(0,0,0,.12); font-size:1rem; font-weight:700; }
  .leaflet-tooltip.drag-tip::after{ content:""; position:absolute; left:50%; transform:translateX(-50%); bottom:-8px; border-left:8px solid transparent; border-right:8px solid transparent; border-top:8px solid #fff; filter:drop-shadow(0 1px 0 rgba(0,0,0,.08)); }

  .sheet{ position:fixed; left:0; right:0; bottom:0; z-index:1001; transform:translateY(100%); transition:transform .25s ease; background:#fff; border-top-left-radius:16px; border-top-right-radius:16px; box-shadow:0 -20px 60px rgba(0,0,0,.25); max-height:85dvh; display:flex; flex-direction:column; }
  .sheet.open{ transform:translateY(0) }
  .sheet .handle{ align-self:center; width:54px; height:5px; border-radius:999px; background:#e5e7eb; margin:8px 0 4px }
  .sheet .body{ padding:10px 14px 16px; overflow:auto; -webkit-overflow-scrolling: touch; }
  .sheet h3{ margin:8px 0 10px }
  .row2{ display:grid; grid-template-columns:1fr 1fr; gap:8px }
  label{ display:block; margin:6px 0 4px; font-size:.92rem }
  input,.btn,select{ width:100%; padding:12px; border:1px solid #ddd; border-radius:10px; font-size:1rem }
  .btn{ border:0; cursor:pointer }
  .btn-green{ background:var(--green); color:#fff }
  .muted{ color:var(--muted); font-size:.95rem }

  .chips{ display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 }
  .chip{ padding:8px 10px; border:1px solid #e6e6e6; border-radius:999px; cursor:pointer; }
  .chip.active{ background:var(--green); color:#fff; border-color:var(--green) }

  .toast{ position:fixed; left:50%; bottom:calc(100px + var(--safe-b)); transform:translateX(-50%); background:#111; color:#fff; padding:10px 12px; border-radius:10px; z-index:1500; opacity:0; pointer-events:none; transition:opacity .18s, bottom .18s }
  .toast.show{ opacity:1; bottom:calc(110px + var(--safe-b)) }

  .plant-seq{ position:absolute; z-index:940; font-size:20px; background:#fff; border:1px solid #e6e6e6; border-radius:999px; padding:4px 8px; box-shadow:0 6px 12px rgba(0,0,0,.12); transform:translate(-50%, -50%); }
  .ping{ position:absolute; width:22px; height:22px; border-radius:999px; background:rgba(34,197,94,0.35); pointer-events:none; transform:translate(-50%,-50%); animation:ping 0.9s ease-out 2; }
  @keyframes ping{ 0%{ transform:translate(-50%,-50%) scale(0.7); opacity:.9 } 100%{ transform:translate(-50%,-50%) scale(2.1); opacity:0 } }
</style>
</head>
<body>

<header class="site-header">
  <div class="brand" id="logoBtn"><img src="logo.png" alt="FLOVERMAPS" onerror="this.style.display='none'"></div>
</header>

<main id="mapWrap" aria-label="Mapa">
  <div id="map"></div>
  <div id="dragRing" class="drag-ring"></div>
  <button id="pinCta" class="pin-cta">Continuar</button>
</main>

<div id="mapError" class="map-error"></div>

<div class="controls" id="controls" aria-label="Controles">
  <div class="row">
    <button id="tapBtn" class="tool-btn">üå∏ Plantar desde el mapa</button>
    <button id="gpsBtn" class="tool-btn">üìç Mi ubicaci√≥n</button>
  </div>
  <div class="searchRow">
    <div class="input">
      <span aria-hidden="true">üîé</span>
      <input id="searchInput" placeholder="Buscar un lugar (calle, ciudad‚Ä¶)" autocomplete="off" aria-autocomplete="list" aria-controls="slist" />
    </div>
  </div>
</div>

<div id="slist" class="slist" role="listbox" aria-label="Sugerencias de lugares"></div>
<div id="addrBadge" class="addr-badge" aria-live="polite"></div>

<section id="sheet" class="sheet" aria-modal="true" role="dialog" aria-labelledby="sheetTitle" aria-hidden="true">
  <div class="handle"></div>
  <div id="sheetBody" class="body">
    <div id="formView">
      <h3 id="sheetTitle">Tu dedicatoria</h3>
      <div class="row2">
        <div><label for="fromName">¬øQui√©n la env√≠a?</label><input id="fromName" placeholder="Tu nombre" required></div>
        <div><label for="toName">¬øPara qui√©n?</label><input id="toName" placeholder="Nombre del destinatario" required></div>
      </div>
      <label for="message" style="margin-top:8px">Mensaje <span class="muted" id="chars">(0/30)</span></label>
      <input id="message" maxlength="30" placeholder="Ese rinc√≥n especial‚Ä¶ (m√°x. 30)" inputmode="text" autocomplete="off" required />

      <label for="ngo" style="margin-top:10px">ONG</label>
      <select id="ngo">
        <option value="msf" selected>M√©dicos Sin Fronteras</option>
        <option value="stc">Save the Children</option>
        <option value="aecc">Asociaci√≥n Espa√±ola contra el C√°ncer</option>
        <option value="unicef">UNICEF</option>
      </select>

      <div style="margin-top:10px">
        <div class="chips" id="chips">
          <button class="chip" data-amount="1.9">1,90 ‚Ç¨</button>
          <button class="chip active" data-amount="5.9">5,90 ‚Ç¨</button>
          <button class="chip" data-amount="24.9">24,90 ‚Ç¨</button>
          <button class="chip" data-amount="other">Otro</button>
        </div>
        <div id="otherRow" style="display:none">
          <label for="otherAmount" class="muted">Importe personalizado</label>
          <input id="otherAmount" type="number" min="0.9" step="0.01" placeholder="Ej. 3,50" inputmode="decimal" />
        </div>
        <div id="splitCopy" class="muted" style="margin-top:6px"></div>
      </div>

      <div style="margin-top:12px">
        <button id="payAndPlantBtn" class="btn btn-green" style="width:100%; font-size:1.05rem; padding:14px 18px">Pagar y plantar ‚Äî 5,90 ‚Ç¨</button>
      </div>
    </div>
  </div>
</section>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* === CONFIG === */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxhGMS7D1i76f59sBjHim9P6PaNuCibePYkkXk297nQ_7asT0LJxPmIC_mKx8B5G3UhDQ/exec";
const MAINTENANCE_FEE_EUR = 0.90; // fee fijo
const SELECT_ZOOM = 10;   // zoom al elegir punto
const FINAL_ZOOM  = 17;   // zoom de calle

/* === helpers === */
function jsonp(url, timeoutMs=12000){
  return new Promise((resolve, reject)=>{
    const cb='__fp_cb_'+Math.random().toString(36).slice(2);
    const s=document.createElement('script'); const sep=url.includes('?')?'&':'?';
    s.src=url+sep+'callback='+cb+'&_ts='+Date.now(); s.id=cb; s.async=true;
    let to; function cleanup(){ clearTimeout(to); try{ delete window[cb]; }catch{}; s.remove(); }
    window[cb]=(data)=>{ cleanup(); resolve(data); };
    s.onerror=()=>{ cleanup(); reject(new Error('JSONP load failed')); };
    document.head.appendChild(s);
    to=setTimeout(()=>{ cleanup(); reject(new Error('JSONP timeout')); }, timeoutMs);
  });
}
const loadScript=(src)=>new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=src; s.async=true; s.onload=res; s.onerror=rej; document.head.appendChild(s); setTimeout(()=>rej(new Error('timeout:'+src)),18000); });
const loadCSS=(href)=>new Promise((res,rej)=>{ const l=document.createElement('link'); l.rel='stylesheet'; l.href=href; l.onload=res; l.onerror=rej; document.head.appendChild(l); setTimeout(()=>rej(new Error('timeout:'+href)),18000); });

/* === STATE & DOM === */
let map, tileLayer, tileIdx=0; const tileCandidates=[
  {url:'https://tile.openstreetmap.org/{z}/{x}/{y}.png', att:'¬© OpenStreetMap contributors'},
  {url:'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', att:'¬© OpenStreetMap contributors'},
  {url:'https://basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', att:'¬© OpenStreetMap ¬∑ ¬© CARTO'},
  {url:'https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', att:'¬© OpenStreetMap France'}
];
let flowersLayer=null; let selectedMarker=null, selectedLat=null, selectedLng=null; let lastTs=0; window._lastItems=[]; let abortRev=null, abortCtrl=null, currentSuggest=[]; let saving=false, lastShareUrl='', paymentRef=''; let amount=5.9; let userInteracted=false;

const $=s=>document.querySelector(s);
const controls=$('#controls'), tapBtn=$('#tapBtn'), gpsBtn=$('#gpsBtn');
const searchInput=$('#searchInput'), slist=$('#slist');
const addrBadge=$('#addrBadge'), dragRing=$('#dragRing'), pinCta=$('#pinCta');
const sheet=$('#sheet'), fromInput=$('#fromName'), toInput=$('#toName'), msgInput=$('#message'), ngoSel=$('#ngo');
const chips=$('#chips'), otherRow=$('#otherRow'), otherAmount=$('#otherAmount'), payBtn=$('#payAndPlantBtn');
const toastEl=$('#toast'), mapError=$('#mapError');

const ACCEPT_LANG = (()=>{ try{ const langs=(navigator.languages&&navigator.languages.length)?navigator.languages:[navigator.language||'es']; const set=Array.from(new Set([...langs.map(l=>String(l||'').split('-')[0]), 'es','en'])); return set.join(','); }catch{ return 'es,en'; }})();
function toast(msg, ok=true){ const t=toastEl; t.textContent=msg; t.style.background=ok?"#111":"#b30000"; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2200); }
function fmt(n){ return (Number(n)||0).toFixed(2).replace('.',','); }
function parseAmountInput(v){ return Number(String(v||'').replace(',','.')); }
function fmtDateTimeFromTs(ts){ const n=Number(ts); if(!isFinite(n)) return ''; try{ return new Intl.DateTimeFormat('es-ES',{timeZone:'Europe/Madrid', day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit', hour12:false}).format(new Date(n)).replace(',', ''); }catch{return '';} }
function emojiIcon(){ return L.divIcon({className:'emoji-marker', html:'<span class="e" role="img" aria-label="flor">üå∏</span>', iconSize:[44,44], iconAnchor:[22,44], popupAnchor:[0,-46]}); }
function escAttr(s){ return encodeURIComponent(String(s||'')); }
function escHtml(s){ return String(s||'').replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
function ngoFullLabel(code){ switch(String(code||'').toLowerCase()){ case 'msf': return 'M√©dicos Sin Fronteras'; case 'stc': return 'Save the Children'; case 'aecc': return 'Asociaci√≥n Espa√±ola contra el C√°ncer'; case 'unicef': return 'UNICEF'; default: return 'ONG'; } }

/* === UI pin exacto === */
const RING_OFFSET_X = 0; const RING_OFFSET_Y = -22; const CTA_OFFSET_Y = 58;
function positionRingFromMarker(){ if(!selectedMarker) return; const p = map.latLngToContainerPoint(selectedMarker.getLatLng()); dragRing.style.left=(p.x+RING_OFFSET_X)+'px'; dragRing.style.top=(p.y+RING_OFFSET_Y)+'px'; }
function positionPinCtaFromMarker(){ if(!selectedMarker) return; const p = map.latLngToContainerPoint(selectedMarker.getLatLng()); pinCta.style.left=p.x+'px'; pinCta.style.top=(p.y+CTA_OFFSET_Y)+'px'; }
function showRing(){ dragRing.style.display='block'; } function hideRing(){ dragRing.style.display='none'; }
function showPinCtaFromMarker(){ positionPinCtaFromMarker(); pinCta.style.display='inline-block'; } function hidePinCta(){ pinCta.style.display='none'; }

/* === MAP === */
function addTiles(){ if(tileLayer){ try{ map.removeLayer(tileLayer);}catch{} } const cfg=tileCandidates[tileIdx]||tileCandidates[0]; tileLayer=L.tileLayer(cfg.url,{attribution:cfg.att,maxZoom:19}); tileLayer.on('tileerror', ()=>{ if(tileIdx < tileCandidates.length-1){ tileIdx++; addTiles(); } }); tileLayer.addTo(map); }
function initMap(){ map=L.map('map',{zoomControl:true, worldCopyJump:true}); map.setView([40.4168,-3.7038],5); addTiles(); flowersLayer = L.layerGroup().addTo(map);
  map.on('click', e=>{ userInteracted=true; setSelectedPoint(e.latlng.lat, e.latlng.lng, true); });
  map.on('movestart', ()=>{ userInteracted=true; });
  map.on('move zoom', ()=>{ if(selectedMarker){ positionRingFromMarker(); positionPinCtaFromMarker(); } });
  window.addEventListener('resize', ()=>setTimeout(()=>map.invalidateSize(),100)); setTimeout(()=>map.invalidateSize(),150); }

function setSelectedPoint(lat,lng,animate=false, forceZoom=null){ if(!selectedMarker){ selectedMarker=L.marker([lat,lng],{icon:emojiIcon(), draggable:true, zIndexOffset:2000}).addTo(map); selectedMarker.bindTooltip('Arrastra para ajustar',{permanent:true, direction:'top', offset:[0,-50], className:'drag-tip'}).openTooltip(); selectedMarker.on('drag', ()=>{ positionRingFromMarker(); positionPinCtaFromMarker(); }); selectedMarker.on('dragend', e=>{ const p=e.target.getLatLng(); selectedLat=p.lat.toFixed(6); selectedLng=p.lng.toFixed(6); reverseAt(selectedLat, selectedLng); positionRingFromMarker(); positionPinCtaFromMarker(); }); } else { selectedMarker.setLatLng([lat,lng]); }
  selectedLat=Number(lat).toFixed(6); selectedLng=Number(lng).toFixed(6);
  const z = forceZoom ?? Math.max(map.getZoom(), SELECT_ZOOM); try{ if(animate){ map.flyTo([lat,lng], z, {duration:0.5}); } else { map.setView([lat,lng], z, {animate:false}); } }catch{}
  reverseAt(selectedLat, selectedLng); addrBadge.style.display='block'; showRing(); positionRingFromMarker(); showPinCtaFromMarker(); }

async function reverseAt(lat,lng){ if(abortRev){ try{ abortRev.abort(); }catch{} } const ctl=new AbortController(); abortRev=ctl; addrBadge.textContent='Buscando direcci√≥n‚Ä¶'; try{ const url=`https://nominatim.openstreetmap.org/reverse?format=jsonv2&accept-language=${encodeURIComponent(ACCEPT_LANG)}&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`; const r=await fetch(url,{signal:ctl.signal}); if(!r.ok) throw 0; const j=await r.json(); const a=j.address||{}; const road=a.road||a.pedestrian||a.cycleway||a.footway||a.path||a.neighbourhood||a.suburb||a.city_district||""; const hn=a.house_number||a.housenumber||""; const city=a.city||a.town||a.village||a.municipality||a.state||""; const label=[[road,hn].filter(Boolean).join(" "),city].filter(Boolean).join(", "); addrBadge.textContent = label || (j.display_name||'Ubicaci√≥n aproximada'); }catch{ addrBadge.textContent='Ubicaci√≥n aproximada'; } }

/* === Controles === */
 tapBtn.addEventListener('click', ()=>toast('Toca el mapa para continuar'));
 gpsBtn.addEventListener('click', ()=>{ if(!('geolocation' in navigator)) return toast('Tu dispositivo no permite geolocalizaci√≥n', false); navigator.geolocation.getCurrentPosition(pos=>{ userInteracted=true; setSelectedPoint(pos.coords.latitude, pos.coords.longitude, true, 17); }, ()=>toast('No se pudo obtener tu ubicaci√≥n (revisa permisos)', false), {timeout:8000}); });

/* === Buscador === */
let suggestTimer=null; let abortCtrl=null; async function searchPlacesPlain(q,sig){ const url='https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=10&accept-language='+encodeURIComponent(ACCEPT_LANG)+'&q='+encodeURIComponent(q); const r=await fetch(url,{signal:sig}); if(!r.ok) throw 0; return r.json(); }
function renderSuggest(list, searching){ if(searching){ slist.innerHTML='<div class="sitem">Buscando‚Ä¶</div>'; slist.style.display='block'; return;} slist.innerHTML=''; list.forEach((it,idx)=>{ const row=document.createElement('div'); row.className='sitem'; row.setAttribute('role','option'); const dn=(it.display_name||'').split(',').map(s=>s.trim()); const primary=dn[0]||''; const city=it.address?.city||it.address?.town||it.address?.village||it.address?.municipality||''; const state=it.address?.state||it.address?.province||it.address?.state_district||''; const meta=[city||dn[1]||'', state||dn[2]||''].filter(Boolean).join(', '); row.innerHTML=primary+(meta?` <small>${meta}</small>`:''); row.onclick=()=>selectSuggest(idx); slist.appendChild(row); }); slist.style.display=list.length?'block':'none'; }
async function runSuggest(q){ if(abortCtrl) abortCtrl.abort(); abortCtrl=new AbortController(); const sig=abortCtrl.signal; renderSuggest([],true); try{ const list=await searchPlacesPlain(q,sig).catch(()=>[]); currentSuggest=list||[]; renderSuggest(currentSuggest,false); }catch{ currentSuggest=[]; renderSuggest([],false); } }
async function selectSuggest(i){ const it=currentSuggest[i]; if(!it) return; slist.style.display='none'; userInteracted=true; setSelectedPoint(Number(it.lat), Number(it.lon), true); }
searchInput.addEventListener('input', (e)=>{ const q=e.target.value.trim(); clearTimeout(suggestTimer); if(!q){ slist.style.display='none'; return; } suggestTimer=setTimeout(()=>runSuggest(q),260); });
searchInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); if(currentSuggest.length){ selectSuggest(0); } } });
 document.addEventListener('click', e=>{ if(!slist.contains(e.target) && e.target!==searchInput) slist.style.display='none'; });

 pinCta.addEventListener('click', ()=>{ if(!selectedLat||!selectedLng) return toast('Elige un punto del mapa primero', false); openSheet(); });

function openSheet(){ sheet.classList.add('open'); sheet.setAttribute('aria-hidden','false'); try{ map.dragging.disable(); map.scrollWheelZoom.disable(); map.doubleClickZoom.disable(); }catch{} updateSplitCopy(); }
function closeSheet(){ sheet.classList.remove('open'); sheet.setAttribute('aria-hidden','true'); try{ map.dragging.enable(); map.scrollWheelZoom.enable(); map.doubleClickZoom.enable(); }catch{} }

const chars=$('#chars');
msgInput.addEventListener('input', ()=>{ msgInput.value=msgInput.value.replace(/
?
/g,'').slice(0,30); chars.textContent='(' + msgInput.value.length + '/30)'; });
msgInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); }});

chips.addEventListener('click', (e)=>{ const b=e.target.closest('.chip'); if(!b) return; chips.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); b.classList.add('active'); const v=b.dataset.amount; if(v==='other'){ otherRow.style.display='block'; otherAmount.focus(); } else { otherRow.style.display='none'; amount=Number(v)||5.9; updatePayBtn(); updateSplitCopy(); } });
otherAmount.addEventListener('input', ()=>{ const val=Math.max(0.9, parseAmountInput(otherAmount.value||0)); amount=isFinite(val)?val:5.9; updatePayBtn(); updateSplitCopy(); });
function updatePayBtn(){ $('#payAndPlantBtn').textContent = `Pagar y plantar ‚Äî ${fmt(amount)} ‚Ç¨`; }
function ngoLabel(){ const o=ngoSel.options[ngoSel.selectedIndex]; return o?o.textContent:'la ONG'; }
function updateSplitCopy(){ $('#splitCopy').innerHTML = `Tu aportaci√≥n es √≠ntegra para <strong>${escHtml(ngoLabel())}</strong>, excepto <strong>0,90 ‚Ç¨</strong> para el mantenimiento de tu flor para siempre.`; }
ngoSel.addEventListener('change', updateSplitCopy);

payBtn.addEventListener('click', async ()=>{ if(!selectedLat||!selectedLng) return toast('Coloca la flor en el mapa', false); const from=fromInput.value.trim(), to=toInput.value.trim(), msg=msgInput.value.trim(); if(!from||!to||!msg){ toast('Completa tu dedicatoria', false); return; } payBtn.disabled=true; const prev=payBtn.textContent; payBtn.textContent='Plantando‚Ä¶'; await new Promise(r=>setTimeout(r, 500)); paymentRef='demo_'+Date.now(); await actuallySaveFlower(from,to,msg); payBtn.disabled=false; payBtn.textContent=prev; });

async function actuallySaveFlower(from,to,msg){ if(saving) return; saving=true; const placeText=addrBadge.textContent||''; const total=amount; const amountFm=+(MAINTENANCE_FEE_EUR).toFixed(2); const amountOng=Math.max(0, +(total-amountFm).toFixed(2)); const ngoCode=(ngoSel.value||'msf'); const payload={ fromName:from,toName:to,message:msg,place:placeText, lat:selectedLat,lng:selectedLng, ngo:ngoCode,ngo_label:ngoFullLabel(ngoCode), amount_total:total,amount_total_cents:Math.round(total*100), amount_ong:amountOng,amount_ong_cents:Math.round(amountOng*100), amount_fm:amountFm,amount_fm_cents:Math.round(amountFm*100), paymentRef:paymentRef||'demo' };
  try{ const params=new URLSearchParams({action:'add',...payload}); const url=SCRIPT_URL+'?'+params.toString(); const data=await jsonp(url); let shareUrl=''; if(data&&data.id){ shareUrl=`${location.origin}/f/${encodeURIComponent(data.id)}`; } else { const lat=+selectedLat,lng=+selectedLng; shareUrl=`${location.origin}${location.pathname}?lat=${lat}&lng=${lng}`; } lastShareUrl=shareUrl; const lat=+selectedLat,lng=+selectedLng; plantingAnimationAtLatLng([lat,lng]); const dt=(data&&data.ts)?Number(data.ts):Date.now(); const dtStr=fmtDateTimeFromTs(dt); const html=popupHtml(from,to,msg,dtStr,shareUrl,total,amountFm,ngoFullLabel(ngoCode)); const pos=L.latLng(lat,lng); if(selectedMarker){ try{ map.removeLayer(selectedMarker);}catch{} } hideRing(); hidePinCta(); addrBadge.style.display='none'; const finalMk=L.marker(pos,{icon:emojiIcon(), zIndexOffset:1600}).bindPopup(html); flowersLayer.addLayer(finalMk); try{ map.flyTo(pos, FINAL_ZOOM, {duration:0.5}); }catch{} finalMk.openPopup(); setTimeout(()=>refetch(true), 50); closeSheet(); toast('Flor plantada üå∏'); selectedMarker=null; selectedLat=null; selectedLng=null; }catch(e){ console.error(e); toast('Error al plantar', false); } saving=false; }

function popupHtml(from,to,msg,dtStr,shareUrl,total,fmOverride,ngoLabelStr){ const safeFrom=escHtml(from), safeTo=escHtml(to), safeMsg=escHtml(msg); const url=shareUrl||`${location.origin}${location.pathname}`; const t=Number(total)||0; const fm=isFinite(Number(fmOverride))?Number(fmOverride):MAINTENANCE_FEE_EUR; const ongVal=Math.max(0,t-fm); const ong=ongVal.toFixed(2).replace('.',','); const fmStr=fm.toFixed(2).replace('.',','); const tt=t.toFixed(2).replace('.',','); const ngoText=escHtml(ngoLabelStr||'ONG'); return `<div style="min-width:260px;max-width:300px;font:inherit;color:inherit;"> <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px"> <div style="font-size:18px">üå∏</div> <div style="font-weight:700">${safeFrom}</div> <div class=muted style="opacity:.8">‚Üí</div> <div style="font-weight:700">${safeTo}</div> </div> ${dtStr?`<div class=muted style=margin-bottom:6px>${dtStr}</div>`:''} <div style=margin-bottom:10px>${safeMsg}</div> <div style="display:flex;align-items:center;gap:8px;margin:8px 0 10px"><span style="padding:.25rem .55rem;border-radius:999px;border:1px solid #e6e6e6;background:#f7f7f7;font-size:.85rem">ONG: ${ngoText}</span></div> <div style=margin-bottom:10px>Donaci√≥n total: ${tt} ‚Ç¨ ¬∑ ONG: ${ong} ‚Ç¨ ¬∑ Mantenimiento: ${fmStr} ‚Ç¨</div> <button onclick="shareAny('${escAttr(url)}')" style="width:100%;border:0;border-radius:10px;padding:10px 12px;font-size:.95rem;background:#0066cc;color:#fff;cursor:pointer">üîó Compartir</button> <div style="margin-top:8px; text-align:center"><button onclick=plantAnother() class=btn style="padding:8px 10px;border-radius:10px;border:1px solid #e6e6e6;background:#fff;cursor:pointer">Plantar otra</button></div> </div>`; }
async function shareAny(url){ try{ if(navigator.share){ await navigator.share({title:'Flovermaps', text:`He plantado esta üå∏ en un lugar del Mundo, especialmente para ti. M√≠rala: ${url}`, url}); } else { await navigator.clipboard.writeText(`He plantado esta üå∏ en un lugar del Mundo, especialmente para ti. M√≠rala: ${url}`); toast('Enlace copiado'); } }catch{} }
window.shareAny=shareAny;
window.plantAnother=function(){ try{ map.closePopup(); }catch{} controls.style.display=''; slist.style.display='none'; hideRing(); hidePinCta(); addrBadge.style.display='none'; selectedMarker=null; selectedLat=null; selectedLng=null; try{ map.flyTo([40.4168,-3.7038],5,{duration:0.5}); }catch{} };

function plantingAnimationAtLatLng(latlng){ try{ const p=map.latLngToContainerPoint(latlng); const wrap=document.getElementById('mapWrap'); const seq=document.createElement('div'); seq.className='plant-seq'; seq.style.left=p.x+'px'; seq.style.top=(p.y-26)+'px'; wrap.appendChild(seq); const ring=document.createElement('div'); ring.className='ping'; ring.style.left=p.x+'px'; ring.style.top=p.y+'px'; wrap.appendChild(ring); const stages=['üå±','üå±üå±','üå±üå±üå±','üå∏']; let i=0; seq.textContent=stages[i++]; const iv=setInterval(()=>{ if(i<stages.length){ seq.textContent=stages[i++]; } else { clearInterval(iv); setTimeout(()=>{ try{ seq.remove(); ring.remove(); }catch{} }, 280); } }, 220); }catch{} }

async function tryOpenShared(){ const u2=new URL(location.href); const latParam=u2.searchParams.get('lat'), lngParam=u2.searchParams.get('lng'); if(latParam && lngParam){ const lat=+latParam, lng=+lngParam; map.setView([lat,lng], FINAL_ZOOM); } }

function normalizeItems(items){ const out=[]; for(const f of (items||[])){ const lat=Number(f.lat); const lng=Number(f.lng); if(!isFinite(lat)||!isFinite(lng)) continue; const id=String(f.id ?? `${lat},${lng},${f.timestamp ?? ''}`); const fromName=f.fromName ?? ''; const toName=f.toName ?? ''; const message=f.message ?? ''; const timestamp=f.timestamp ?? ''; const amount_total=Number(f.amount_total)||0; const amount_fm=isFinite(Number(f.amount_fm))?Number(f.amount_fm):null; const ngo=f.ngo||''; const ngo_label=f.ngo_label||ngoFullLabel(ngo); out.push({id,lat,lng,fromName,toName,message,timestamp,amount_total,amount_fm,ngo,ngo_label}); } return out; }
function mergeUniqueById(oldList,newList){ const m=new Map(); for(const it of (oldList||[])) m.set(it.id,it); for(const it of (newList||[])) m.set(it.id,it); return Array.from(m.values()); }
function renderAllMarkers(list){ if(!map) return; try{ flowersLayer.clearLayers(); }catch{} let i=0,n=list.length; (function chunk(){ const t0=performance.now(); const batch=[]; while(i<n && (performance.now()-t0)<24){ const f=list[i++]; const lat=f.lat, lng=f.lng; if(!isFinite(lat)||!isFinite(lng)) continue; const dtStr=f.timestamp?fmtDateTimeFromTs(f.timestamp):''; const shareUrl=`${location.origin}/f/${escAttr(f.id)}`; const fmVal=isFinite(Number(f.amount_fm))?Number(f.amount_fm):MAINTENANCE_FEE_EUR; const html=popupHtml(f.fromName||'',f.toName||'',(f.message||''),dtStr,shareUrl,f.amount_total||0,fmVal,f.ngo_label); const mk=L.marker([lat,lng],{icon:emojiIcon(), zIndexOffset:1200}).bindPopup(html); batch.push(mk); } batch.forEach(m=>flowersLayer.addLayer(m)); if(i<n){ requestAnimationFrame(chunk); } })(); }

async function refetch(incremental=false){ try{ const url=SCRIPT_URL+'?action=list'+(incremental&&lastTs?('&since='+encodeURIComponent(lastTs)):''); const data=await jsonp(url,12000); if(data && Array.isArray(data.items)){ const norm=normalizeItems(data.items); window._lastItems = incremental && window._lastItems.length ? mergeUniqueById(window._lastItems,norm) : norm; renderAllMarkers(window._lastItems); for(const it of data.items){ const t=Number(it.timestamp)||0; if(t>lastTs) lastTs=t; } try{ localStorage.setItem('flowers_cache', JSON.stringify(window._lastItems||[])); }catch{} return; } }catch(e){} const cached=localStorage.getItem('flowers_cache'); if(cached){ window._lastItems=JSON.parse(cached); renderAllMarkers(window._lastItems); } }

/* ====== ARRANQUE con loader robusto de Leaflet ====== */
(async function boot(){ const cssCDN=[ 'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css', 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css', 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css' ]; const jsCDN=[ 'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js', 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js', 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js' ]; try{ for(const href of cssCDN){ try{ await loadCSS(href); break; }catch{} } for(const src of jsCDN){ try{ await loadScript(src); if(window.L) break; }catch{} } if(!window.L) throw new Error('Leaflet no disponible'); initMap(); refetch(false); setInterval(()=>refetch(true),15000); tryOpenShared(); document.addEventListener('keydown', e=>{ if(e.key==='Escape'){ slist.style.display='none'; }}); }catch(e){ console.error(e); mapError.style.display='block'; mapError.innerHTML='No se pudo cargar el mapa. Posibles causas: bloqueador/CSP. Intenta desactivar el bloqueador o permitir cdn.jsdelivr.net / unpkg.com / cloudflare CDN.'; } })();

// Logo ‚Üí refrescar
$('#logoBtn').addEventListener('click', ()=>location.reload());
</script>
</body>
</html>
