<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flovermaps ‚Äî Plant Love Forever</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#111823; --accent:#26c281; --accent-2:#ff6fa9; --text:#e6eef7; --muted:#9fb3c8; --border:#1f2a3a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:500 15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial}
    a{color:var(--accent)}
    .wrap{display:grid;grid-template-columns:1.5fr 1fr;gap:0;min-height:100vh}
    #map{height:100vh;width:100%;}
    .panel{background:linear-gradient(180deg, #0e1420 0%, #0b0f14 100%);border-left:1px solid var(--border);display:flex;flex-direction:column}
    header{padding:14px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
    .badge{background:#0f1a28;border:1px solid var(--border);padding:4px 8px;border-radius:999px;color:var(--muted);font-size:12px}
    form{padding:16px;display:grid;gap:12px}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{width:100%;background:#0e1622;border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:12px;outline:none}
    input::placeholder,textarea::placeholder{color:#6b7f96}
    textarea{min-height:84px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 14px;background:var(--accent);color:#041215;font-weight:700;cursor:pointer}
    .btn.secondary{background:#142031;color:var(--text);border:1px solid var(--border)}
    .hint{color:var(--muted);font-size:12px}
    .donation{background:#0f1826;border-top:1px solid var(--border);padding:12px 16px;color:#b9c8d9}
    .donation strong{color:var(--text)}
    .list{padding:12px 16px 18px 16px;border-top:1px solid var(--border);}
    .item{padding:10px 0;border-bottom:1px dashed var(--border);}
    .item:last-child{border-bottom:0}
    .ok{color:#86f3be}
    @media (max-width: 960px){ .wrap{grid-template-columns:1fr; } #map{height:56vh} }
  </style>
</head>
<body>
  <div class="wrap">
    <div id="map"></div>

    <aside class="panel">
      <header>
        <div style="width:10px;height:10px;border-radius:999px;background:var(--accent)"></div>
        <div style="font-weight:700">Flovermaps</div>
        <div class="badge">Plant Love Forever</div>
      </header>

      <form id="flowerForm" autocomplete="off">
        <div>
          <label for="address">Ubicaci√≥n (Google Places)</label>
          <input id="address" name="address" placeholder="Calle, ciudad‚Ä¶" />
          <div class="row" style="margin-top:8px">
            <button type="button" class="btn secondary" id="btnUseLocation">Usar mi ubicaci√≥n</button>
            <button type="button" class="btn secondary" id="btnConfirmAddress">Confirmar direcci√≥n</button>
          </div>
          <div class="hint">Mueve el pin si necesitas ajustar unos metros.</div>
        </div>

        <div class="row">
          <div>
            <label for="from">¬øQui√©n env√≠a?</label>
            <input id="from" name="from" placeholder="Tu nombre" />
          </div>
          <div>
            <label for="to">¬øPara qui√©n?</label>
            <input id="to" name="to" placeholder="Nombre del destinatario" />
          </div>
        </div>

        <div>
          <label for="message">Mensaje</label>
          <textarea id="message" name="message" placeholder="Escribe unas palabras bonitas‚Ä¶"></textarea>
        </div>

        <div class="row">
          <div>
            <label for="ngo">ONG</label>
            <select id="ngo" name="ngo">
              <option value="">‚Äî Elige una ONG ‚Äî</option>
              <option>CRUZ ROJA</option>
              <option>M√âDICOS SIN FRONTERAS</option>
              <option>UNICEF</option>
              <option>WWF</option>
              <option>ACNUR</option>
            </select>
          </div>
          <div>
            <label for="amount">Donaci√≥n (‚Ç¨)</label>
            <input id="amount" name="amount" type="number" inputmode="decimal" min="0" step="0.5" placeholder="5" />
          </div>
        </div>

        <input type="hidden" id="lat" name="lat" />
        <input type="hidden" id="lng" name="lng" />
        <input type="hidden" id="city" name="city" />

        <button type="submit" class="btn" id="btnPlant">üå∏ Plantar flor</button>
        <div class="hint">Al plantar, te quedar√°s en el zoom de calle para leer el mensaje y compartirlo al instante.</div>
      </form>

      <div class="donation">
        <div><strong>C√≥mo funciona la donaci√≥n</strong></div>
        <div>El <strong>100% de tu aportaci√≥n</strong> va a la ONG elegida <strong>menos 0,90 ‚Ç¨</strong> de mantenimiento web.</div>
        <div class="hint">Ejemplo: si aportas 10 ‚Ç¨, la ONG recibe 9,10 ‚Ç¨.</div>
      </div>

      <div class="list" id="recent">
        <div class="hint" style="margin-bottom:8px">√öltimas flores plantadas (cerca de ti)</div>
        <div id="items"></div>
      </div>
    </aside>
  </div>

  <script>
    // =============== CONFIG ===============
    const GOOGLE_MAPS_API_KEY = 'PON_AQUI_TU_API_KEY_DE_BROWSER';
    const WEB_APP_URL = 'PON_AQUI_TU_URL_DE_DEPLOY_DE_APPS_SCRIPT';
    const MIN_STREET_ZOOM = 17;
    const FIXED_FEE = 0.90; // ‚Ç¨

    // =============== STATE ===============
    let map, gMarker, gInfo;
    let autocomplete;

    // Icono seguro (creado tras cargar Maps)
    function getFlowerIcon(){
      return {
        url: 'data:image/svg+xml;utf8,' + encodeURIComponent(`
          <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 48 48">
            <defs><filter id="s" x="-50%" y="-50%" width="200%" height="200%"><feDropShadow dx="0" dy="1" stdDeviation="1.5" flood-color="#000" flood-opacity="0.35"/></filter></defs>
            <circle cx="24" cy="24" r="18" fill="#1bc27a" filter="url(#s)"/>
            <g transform="translate(24,24) scale(0.85)">
              <circle cx="0" cy="0" r="3.2" fill="#ffd7e6"/>
              <path d="M0,-11 C5,-11 6,-7 0,-6 C-6,-7 -5,-11 0,-11z" fill="#ff6fa9"/>
              <path d="M11,0 C11,5 7,6 6,0 C7,-6 11,-5 11,0z" fill="#ff6fa9"/>
              <path d="M0,11 C-5,11 -6,7 0,6 C6,7 5,11 0,11z" fill="#ff6fa9"/>
              <path d="M-11,0 C-11,-5 -7,-6 -6,0 C-7,6 -11,5 -11,0z" fill="#ff6fa9"/>
            </g>
          </svg>
        `),
        scaledSize: new google.maps.Size(40, 40),
        anchor: new google.maps.Point(20, 20)
      };
    }

    function mountScript(src){
      return new Promise((resolve, reject)=>{
        const s=document.createElement('script'); s.src=src; s.async=true; s.defer=true;
        s.onload=resolve; s.onerror=reject; document.head.appendChild(s);
      });
    }

    function initAutocomplete(){
      const input = document.getElementById('address');
      autocomplete = new google.maps.places.Autocomplete(input, { fields: ["address_components","geometry","formatted_address","name"] });
      autocomplete.addListener('place_changed', ()=>{
        const place = autocomplete.getPlace();
        if(!place || !place.geometry) return;
        const loc = place.geometry.location;
        const latLng = { lat: loc.lat(), lng: loc.lng() };
        setMarker(latLng);
        document.getElementById('address').value = place.formatted_address || place.name || document.getElementById('address').value;
        document.getElementById('city').value = extractCity(place.address_components);
      });
    }

    function initMap(){
      map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: 40.4168, lng: -3.7038}, // Madrid
        zoom: 12,
        disableDefaultUI: false,
        clickableIcons: true
      });
      gInfo = new google.maps.InfoWindow();
      initAutocomplete();
      tryLoadNearby();
    }

    function extractCity(components){
      if(!components) return '';
      for(const c of components){
        if(c.types.includes('locality')) return c.long_name;
        if(c.types.includes('postal_town')) return c.long_name;
        if(c.types.includes('administrative_area_level_2')) return c.long_name;
      }
      return '';
    }

    function setMarker(latLng){
      if(!gMarker){
        gMarker = new google.maps.Marker({ map, position: latLng, draggable: true, icon: getFlowerIcon() });
        gMarker.addListener('dragend', ()=>{
          const p = gMarker.getPosition();
          document.getElementById('lat').value = p.lat().toFixed(6);
          document.getElementById('lng').value = p.lng().toFixed(6);
        });
      } else {
        gMarker.setPosition(latLng);
      }
      document.getElementById('lat').value = latLng.lat.toFixed(6);
      document.getElementById('lng').value = latLng.lng.toFixed(6);

      if(map.getZoom() < MIN_STREET_ZOOM) map.setZoom(MIN_STREET_ZOOM);
      map.panTo(latLng);
    }

    function useMyLocation(){
      if(!navigator.geolocation){ alert('Tu navegador no permite geolocalizaci√≥n.'); return; }
      navigator.geolocation.getCurrentPosition(pos => {
        const latLng = {lat: pos.coords.latitude, lng: pos.coords.longitude};
        setMarker(latLng);
      }, _ => alert('No se pudo obtener tu ubicaci√≥n.'), { enableHighAccuracy:true, timeout:8000, maximumAge:0 });
    }

    function confirmAddress(){
      const addr = document.getElementById('address').value?.trim();
      if(!addr) { alert('Escribe una direcci√≥n o usa tu ubicaci√≥n.'); return; }
      const geocoder = new google.maps.Geocoder();
      geocoder.geocode({ address: addr }, (res, status)=>{
        if(status !== 'OK' || !res || !res[0]){ alert('No se pudo confirmar esa direcci√≥n.'); return; }
        const r = res[0];
        document.getElementById('address').value = r.formatted_address;
        document.getElementById('city').value = extractCity(r.address_components);
        const loc = r.geometry.location;
        setMarker({lat: loc.lat(), lng: loc.lng()});
      });
    }

    function addListItem(data){
      const el = document.createElement('div');
      el.className = 'item';
      const net = Math.max(0, (+data.amount||0) - FIXED_FEE).toFixed(2);
      el.innerHTML = `<div><strong>${escapeHtml(data.to||'ALGUIEN')}</strong> en ${escapeHtml(data.city||'')} ‚Äî <span class="ok">+${net}‚Ç¨ a ONG</span></div>
                      <div class="hint">${new Date(data.timestamp||Date.now()).toLocaleString()}</div>`;
      el.addEventListener('click', ()=>{
        if(data.lat && data.lng){
          const latLng = {lat: +data.lat, lng: +data.lng};
          setMarker(latLng);
          openInfo(latLng, data);
        }
      });
      document.getElementById('items').prepend(el);
    }

    function openInfo(latLng, data){
      const net = Math.max(0, (+data.amount||0) - FIXED_FEE).toFixed(2);
      const fee = FIXED_FEE.toFixed(2);
      const html = `
        <div style="max-width:260px">
          <div style="font-weight:800;margin-bottom:6px">üå∏ Flor para ${escapeHtml(data.to||'ALGUIEN')}</div>
          <div style="margin-bottom:6px;color:#b9c8d9">${escapeHtml(data.message||'')}</div>
          <div class="hint">Por ${escapeHtml(data.from||'An√≥nimo')} en ${escapeHtml(data.city||'')}</div>
          <hr style="border:none;border-top:1px solid #234; margin:8px 0" />
          <div style="font-size:13px">Donaci√≥n: <strong>${(+data.amount||0).toFixed(2)} ‚Ç¨</strong><br>
            ONG recibe: <strong>${net} ‚Ç¨</strong> <span class="hint">(se descuenta ${fee} ‚Ç¨ de mantenimiento web)</span>
          </div>
          <div style="margin-top:8px"><a target="_blank" href="https://www.google.com/maps?q=${latLng.lat},${latLng.lng}">Abrir en Google Maps</a></div>
        </div>`;
      gInfo.setContent(html);
      gInfo.open({map, anchor: gMarker});
    }

    // ======= Guardar / Listar en Apps Script =======
    async function saveFlower(payload){
      const res = await fetch(WEB_APP_URL + '?action=create', {
        method:'POST',
        headers:{ 'Content-Type':'text/plain;charset=utf-8' }, // evita preflight CORS
        body: JSON.stringify(payload)
      });
      if(!res.ok) throw new Error('Error de red al guardar');
      return res.json();
    }

    async function listFlowersNear(lat,lng){
      const url = new URL(WEB_APP_URL);
      url.searchParams.set('action','list');
      if(lat && lng){ url.searchParams.set('lat', lat); url.searchParams.set('lng', lng); }
      const res = await fetch(url.toString());
      if(!res.ok) throw new Error('Error al listar');
      return res.json();
    }

    async function tryLoadNearby(){
      try{
        if(navigator.geolocation){
          navigator.geolocation.getCurrentPosition(async pos=>{
            const {latitude,longitude} = pos.coords;
            const data = await listFlowersNear(latitude, longitude);
            (data.items||[]).slice(0,20).forEach(addListItem);
          }, async _=>{
            const data = await listFlowersNear();
            (data.items||[]).slice(0,20).forEach(addListItem);
          }, {timeout:4000});
        } else {
          const data = await listFlowersNear();
          (data.items||[]).slice(0,20).forEach(addListItem);
        }
      }catch(e){ console.warn(e); }
    }

    const escapeHtml = s => (s+"").replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));

    document.addEventListener('click', (e)=>{
      if(e.target.id==='btnUseLocation'){ e.preventDefault(); useMyLocation(); }
      if(e.target.id==='btnConfirmAddress'){ e.preventDefault(); confirmAddress(); }
    });

    document.getElementById('flowerForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const from = document.getElementById('from').value.trim();
      const to   = document.getElementById('to').value.trim();
      const message = document.getElementById('message').value.trim();
      const address = document.getElementById('address').value.trim();
      const ngo = document.getElementById('ngo').value.trim();
      const amount = parseFloat(document.getElementById('amount').value || '0') || 0;
      const lat = parseFloat(document.getElementById('lat').value);
      const lng = parseFloat(document.getElementById('lng').value);
      const city= document.getElementById('city').value.trim();

      if(!address || Number.isNaN(lat) || Number.isNaN(lng)) { alert('Selecciona una ubicaci√≥n v√°lida.'); return; }

      const payload = { from, to, message, address, city, lat, lng, ngo, amount, fee: FIXED_FEE };

      try{
        // Plantar y mostrar sin refrescar
        setMarker({lat, lng});
        openInfo({lat, lng}, payload);

        // Guardar en la hoja
        const out = await saveFlower(payload);
        if(out && out.ok){
          addListItem({ ...payload, timestamp: out.timestamp });
        } else {
          alert('Guardado parcial: la flor se ve, pero no se guard√≥ en la hoja.');
        }
      }catch(err){
        console.error(err);
        alert('No se pudo guardar en la hoja. La flor se ha plantado en el mapa localmente.');
      }
    });

    (async function(){
      await mountScript(`https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places`);
      initMap();
    })();
  </script>
</body>
</html>
