<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Flovermaps ‚Äî Planta una flor</title>
<meta name="theme-color" content="#eef7e8" />
<meta name="description" content="Planta una flor en el mapa y dedica un mensaje.">
<!-- BUILD: FM-PLANT-ONLY-MOBILE-SEARCH-LAYOUT-HIDE-CONTROLS-ON-ACTION-2025-10-31 -->

<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  :root{
    --ink:#0f172a; --muted:#64748b; --green:#22c55e; --bg:#f6fff9;
    --safe-b:env(safe-area-inset-bottom,0); --safe-t:env(safe-area-inset-top,0);
    --navbar:#eef7e8; --brand:#0f172a;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; font-family:'Plus Jakarta Sans',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--ink);
    background:linear-gradient(180deg,#f6fff9 0%,#ecfaf2 60%,#e8f8ef 100%); overflow:hidden
  }

  /* NAVBAR: logo centrado */
  .site-header{
    position:fixed; z-index:1000; top:0; left:0; right:0;
    height:88px; background:var(--navbar); display:flex; align-items:center; justify-content:center;
    padding-top:var(--safe-t); border-bottom:1px solid #dfead6;
  }
  .nav{ width:100%; max-width:1280px; margin:0 auto; display:flex; align-items:center; justify-content:center; padding:0 16px; }
  .brand{ display:flex; align-items:center; cursor:pointer }
  .brand img{ height:96px; display:block }

  /* MAPA */
  #map{ position:fixed; inset:0; width:100%; height:100vh; height:100dvh }
  .leaflet-bottom.leaflet-right{ right:12px; bottom:calc(18px + var(--safe-b)); z-index:1100; }
  .leaflet-control-zoom a{ border-radius:10px !important; }

  /* CONTROLES INFERIORES */
  .controls{
    position:fixed; z-index:1050; left:50%;
    bottom:calc(18px + var(--safe-b)); width:min(94vw,1000px);
    display:flex; flex-direction:column; gap:10px;
    transform:translate(-50%,0);
    transition:transform .28s ease, opacity .28s ease;
  }
  .controls.hide{
    transform:translate(-50%, calc(100% + 28px));
    opacity:0; pointer-events:none;
  }

  /* Buscador: desktop = 3 columnas; m√≥vil = 2 columnas (Pa√≠s+Ciudad) + fila Lugar+btn */
  .search3{
    background:#fff; border:1px solid #e6e6e6; border-radius:12px; padding:10px;
    box-shadow:0 6px 14px rgba(0,0,0,.04); display:grid; gap:8px;
    grid-template-columns:1fr 1fr 1fr; align-items:end;
  }
  .search3 .field{ display:flex; flex-direction:column; gap:6px; }
  .search3 label{ font-size:.85rem }
  .search3 input{ width:100%; padding:10px 12px; border:1px solid #ddd; border-radius:10px; font-size:.95rem }

  /* Lugar + bot√≥n peque√±o a la derecha */
  .placeRow{ display:grid; grid-template-columns:1fr auto; gap:8px; align-items:end; }
  .btn-small{
    padding:10px 12px; border-radius:10px; border:1px solid #e6e6e6; background:#fff; cursor:pointer;
    font-weight:800; font-size:.9rem; box-shadow:0 6px 14px rgba(0,0,0,.04)
  }

  /* Acciones (siempre dos columnas, tambi√©n en m√≥vil) */
  .actions{ display:grid; grid-template-columns:1fr 1fr; gap:8px }
  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    border:1px solid #e6e6e6; background:#fff; color:#111; font-weight:800;
    border-radius:12px; padding:12px; font-size:.95rem; cursor:pointer; box-shadow:0 6px 14px rgba(0,0,0,.04)
  }

  .addr-badge{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:calc(190px + var(--safe-b)); z-index:1040; background:#fff; border:1px solid #e6e6e6; border-radius:999px; padding:8px 12px; font-size:1rem; font-weight:700; max-width:min(92vw,520px); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; box-shadow:0 8px 24px rgba(0,0,0,.10); display:none
  }

  /* Marker + ring */
  .leaflet-div-icon{ background:transparent!important; border:none!important; }
  .emoji-marker .e{ font-size:44px; line-height:44px; text-shadow:0 1px 0 #fff,0 -1px 0 #fff,1px 0 0 #fff,-1px 0 0 #fff,0 0 4px rgba(0,0,0,.25) }
  .ring{ width:64px; height:64px; border-radius:999px; border:3px solid #22c55e; box-shadow:0 0 0 10px rgba(34,197,94,.14), inset 0 0 0 3px rgba(255,255,255,.9) }
  .leaflet-marker-icon[src*="marker-icon"], .leaflet-marker-shadow{ display:none!important }

  /* CTA popup (Plantar aqu√≠) */
  .leaflet-popup.pin-cta .leaflet-popup-content-wrapper{ background:transparent; box-shadow:none; border:none }
  .leaflet-popup.pin-cta .leaflet-popup-content{ margin:0 }
  .leaflet-popup.pin-cta .leaflet-popup-tip{ display:none!important; }
  .pin-cta-btn{
    position:relative; background:linear-gradient(180deg,#26d166,#1fb057); color:#fff; border:0; border-radius:14px;
    padding:9px 14px; font-size:.95rem; font-weight:800; box-shadow:0 16px 36px rgba(0,0,0,.22); cursor:pointer
  }
  .pin-cta-btn::before{
    content:""; position:absolute; top:-10px; left:50%; transform:translateX(-50%);
    width:0; height:0; border-left:10px solid transparent; border-right:10px solid transparent; border-bottom:10px solid #fff;
    filter:drop-shadow(0 1px 1px rgba(0,0,0,.08));
  }

  /* Sheet */
  .sheet{ position:fixed; left:0; right:0; bottom:0; z-index:1060; transform:translateY(100%); transition:transform .25s ease; background:#fff; border-top-left-radius:16px; border-top-right-radius:16px; box-shadow:0 -20px 60px rgba(0,0,0,.25); max-height:85dvh; display:flex; flex-direction:column }
  .sheet.open{ transform:translateY(0) }
  .sheet .handle{ align-self:center; width:54px; height:5px; border-radius:999px; background:#e5e7eb; margin:8px 0 4px }
  .sheet .body{ padding:10px 14px 16px; overflow:auto; -webkit-overflow-scrolling:touch }
  .row2{ display:grid; grid-template-columns:1fr 1fr; gap:8px }
  label{ display:block; margin:6px 0 4px; font-size:.92rem }
  input{ width:100%; padding:12px; border:1px solid #ddd; border-radius:10px; font-size:1rem }
  .btn-wide{ width:100%; font-size:1.05rem; padding:14px 18px; border-radius:10px; background:#111; color:#fff; border:0; cursor:pointer }

  /* Toast + veil */
  .toast{ position:fixed; left:50%; bottom:calc(100px + var(--safe-b)); transform:translateX(-50%); background:#111; color:#fff; padding:10px 12px; border-radius:10px; z-index:1500; opacity:0; pointer-events:none; transition:opacity .18s,bottom .18s }
  .toast.show{ opacity:1; bottom:calc(110px + var(--safe-b)) }
  .veil{ position:fixed; inset:0; background:rgba(246,255,249,.85); display:none; align-items:center; justify-content:center; z-index:1600 }
  .veil .box{ background:#fff; border:1px solid #e6e6e6; border-radius:14px; padding:14px 18px; box-shadow:0 12px 36px rgba(0,0,0,.12); font-weight:700 }

  /* M√≥vil: dos columnas para Pa√≠s+Ciudad; Lugar+bot√≥n en fila aparte */
  @media (max-width:640px){
    .brand img{ height:84px; }
    .search3{ grid-template-columns:1fr 1fr; }
    .field.placeWrap{ grid-column:1 / span 2; }
    .actions{ grid-template-columns:1fr 1fr; }
  }
</style>
</head>
<body>

<!-- NAV -->
<header class="site-header">
  <nav class="nav">
    <div class="brand" id="logoBtn" aria-label="Inicio">
      <img src="logo.png" alt="Flovermaps" onerror="this.style.display='none'">
    </div>
  </nav>
</header>

<!-- MAP -->
<div id="map" aria-label="Mapa"></div>

<!-- CONTROLES INFERIORES -->
<div class="controls" aria-label="Controles">
  <!-- Buscador -->
  <div class="search3">
    <div class="field">
      <label for="srCountry">Pa√≠s</label>
      <input id="srCountry" placeholder="Ej. Espa√±a">
    </div>
    <div class="field">
      <label for="srCity">Ciudad</label>
      <input id="srCity" placeholder="Ej. Barcelona">
    </div>
    <div class="field placeWrap">
      <label for="srPlace">Lugar</label>
      <div class="placeRow">
        <input id="srPlace" placeholder="Barrio, calle, punto‚Ä¶">
        <button id="srGoBtn" class="btn-small" title="Buscar/Plantar">Plantar</button>
      </div>
    </div>
  </div>

  <!-- Acciones -->
  <div class="actions">
    <button id="btnFromMap" class="btn">üå∏ Plantar desde el mapa</button>
    <button id="btnGps" class="btn">üìç Mi ubicaci√≥n</button>
  </div>
</div>

<div id="addrBadge" class="addr-badge" aria-live="polite"></div>

<!-- Sheet dedicatoria -->
<section id="sheet" class="sheet" role="dialog" aria-labelledby="sheetTitle" aria-hidden="true">
  <div class="handle"></div>
  <div class="body">
    <h3 id="sheetTitle">Tu dedicatoria</h3>
    <div class="row2">
      <div><label for="fromName">¬øQui√©n la env√≠a?</label><input id="fromName" placeholder="Tu nombre" required></div>
      <div><label for="toName">¬øPara qui√©n?</label><input id="toName" placeholder="Nombre del destinatario" required></div>
    </div>
    <label for="message" style="margin-top:8px">Mensaje <span class="muted" id="chars">(0/30)</span></label>
    <input id="message" maxlength="30" placeholder="Ese rinc√≥n especial‚Ä¶ (m√°x. 30)" inputmode="text" autocomplete="off" required />
    <div style="margin-top:12px">
      <button id="plantBtn" class="btn-wide">Plantar</button>
    </div>
  </div>
</section>

<div id="toast" class="toast" role="status" aria-live="polite"></div>
<div id="veil" class="veil"><div class="box" id="veilText">Plantando‚Ä¶</div></div>

<script>
/* === CONFIG (solo Sheets) === */
const SCRIPT_URL  = "https://script.google.com/macros/s/AKfycbzhi7PdPv_g4GifrGXWzwsPxKMIFhPilMpc14vB-ruwrO9NW0pAlFd1vS72K1KNPO8NIg/exec";
const STREET_ZOOM = 17;
const SHARE_ZOOM  = 17;
const NEW_ZOOM    = 18;

/* === HELPERS === */
const $=id=>document.getElementById(id);
function toast(m,ok=true){const t=$('toast');t.textContent=m;t.style.background=ok?"#111":"#b30000";t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1700)}
function fmtDate(ts){try{return new Intl.DateTimeFormat('es-ES',{timeZone:'Europe/Madrid',day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit',hour12:false}).format(new Date(+ts||Date.now())).replace(',','');}catch{return ''}}
function escHtml(s){return String(s||'').replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":"&#39;"}[m]))}
function emojiIcon(){ return L.divIcon({className:'emoji-marker', html:'<span class="e" role="img" aria-label="flor">üå∏</span>', iconSize:[44,44], iconAnchor:[22,22], popupAnchor:[0,-22]}); }
function ringIcon(){ return L.divIcon({html:'<div class="ring"></div>', iconSize:[64,64], iconAnchor:[32,32]}); }
function jsonp(url,timeoutMs=10000){return new Promise((resolve,reject)=>{const cb='__cb_'+Math.random().toString(36).slice(2);const s=document.createElement('script');const sep=url.includes('?')?'&':'?';s.src=url+sep+'callback='+cb+'&_ts='+Date.now();let to;function end(fn){clearTimeout(to);try{delete window[cb]}catch{};s.remove();fn&&fn()}window[cb]=(d)=>{end();resolve(d)};s.onerror=()=>{end(()=>reject(new Error('jsonp')))};document.head.appendChild(s);to=setTimeout(()=>end(()=>reject(new Error('timeout'))),timeoutMs)})}
function genId(){ if(window.crypto?.randomUUID) return window.crypto.randomUUID(); const s=()=>Math.floor((1+Math.random())*0x10000).toString(16).slice(1); return `fm-${s()}${s()}-${s()}-${s()}-${s()}${s()}${s()}`; }

/* === STATE === */
let map, tiles, selectedMarker, ringMarker, ctaPopup;
let selectedLat=null, selectedLng=null, lastTs=0, plantMode=false, flowersCache=[];
let flowerMarkers=[];
const controlsEl = document.querySelector('.controls');

/* === INIT === */
window.addEventListener('load', ()=>{
  if(!window.L) return alert('No se pudo cargar Leaflet.');

  map = L.map('map', { zoomControl:false, worldCopyJump:true });
  tiles = L.tileLayer('https://basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',{
    attribution:'¬© OpenStreetMap ¬© CARTO', maxZoom:19
  }).addTo(map);
  L.control.zoom({ position:'bottomright' }).addTo(map);

  map.setView([40.4168,-3.7038],5);
  setTimeout(()=>{ try{ map.invalidateSize(); }catch{} }, 120);

  $('logoBtn').onclick=()=>location.href='/';

  // Buscador: Enter o bot√≥n "Plantar"
  ['srCountry','srCity','srPlace'].forEach(id=>{
    $(id).addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); runBottomSearch(); } });
  });
  $('srGoBtn').addEventListener('click', runBottomSearch);

  // Acciones de plantar
  $('btnFromMap').onclick=()=>{
    plantMode=true;
    const c=map.getCenter();
    setPoint(c.lat,c.lng,false);
    map.setView(c, Math.max(map.getZoom(), STREET_ZOOM), {animate:false});
    hideControls();
  };
  $('btnGps').onclick=()=>{
    plantMode=true;
    if(!navigator.geolocation) return toast('Tu dispositivo no permite geolocalizaci√≥n', false);
    navigator.geolocation.getCurrentPosition(p=>{
      setPoint(p.coords.latitude,p.coords.longitude,true);
      map.setView([p.coords.latitude,p.coords.longitude], STREET_ZOOM, {animate:false});
      hideControls();
    }, ()=>toast('No se pudo obtener tu ubicaci√≥n', false), {timeout:8000});
  };
  map.on('click', e=>{ if(plantMode){ setPoint(e.latlng.lat,e.latlng.lng,true); map.setView(e.latlng, STREET_ZOOM, {animate:false}); } });

  // Formulario
  $('chars').textContent='(0/30)';
  $('message').addEventListener('input', ()=>{ const m=$('message'); m.value=m.value.replace(/\r?\n/g,'').slice(0,30); $('chars').textContent='('+m.value.length+'/30)'; });
  $('plantBtn').onclick = plantNow;

  // Datos iniciales y deep link
  refetch(false); setInterval(()=>refetch(true),15000); deepLink();
});

/* === Mostrar/Ocultar controles === */
function hideControls(){ try{ controlsEl.classList.add('hide'); }catch{} }
function showControls(){ try{ controlsEl.classList.remove('hide'); }catch{} }

/* === BUSCADOR inferior (3 campos) === */
async function runBottomSearch(){
  const country = $('srCountry').value.trim();
  const city    = $('srCity').value.trim();
  const place   = $('srPlace').value.trim();
  const parts = [place, city, country].filter(Boolean);
  if(!parts.length) return toast('Escribe pa√≠s, ciudad o lugar', false);

  const q = parts.join(', ');
  try{
    const url = 'https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=1&accept-language=es,en&q=' + encodeURIComponent(q);
    const r   = await fetch(url);
    const arr = await r.json();
    if(!arr || !arr.length) return toast('No encontrado', false);

    const it = arr[0];
    const lat = +it.lat, lon = +it.lon;
    const bbox = it.boundingbox; // [south, north, west, east]
    if(bbox && bbox.length===4){
      const south=+bbox[0], north=+bbox[1], west=+bbox[2], east=+bbox[3];
      const b = L.latLngBounds([[south,west],[north,east]]);
      map.fitBounds(b, { padding:[40,40] });
    } else {
      map.setView([lat,lon], Math.max(12, STREET_ZOOM), {animate:false});
    }

    hideControls(); // << oculta controles tras usar el buscador

    setTimeout(()=>{
      try{
        const c = countFlowersInBounds();
        toast(c===1 ? '1 flor encontrada en esta zona' : `${c} flores encontradas en esta zona`);
      }catch{}
    }, 150);
  }catch{
    toast('Error buscando', false);
  }
}
function countFlowersInBounds(){
  const b = map.getBounds(); let n=0;
  for(const mk of (flowerMarkers||[])){
    if(mk && mk.getLatLng && b.contains(mk.getLatLng())) n++;
  }
  return n;
}

/* === PIN / SELECCI√ìN === */
function ensureRing(lat,lng){
  if(!ringMarker) ringMarker = L.marker([lat,lng], {icon:ringIcon(), interactive:false, keyboard:false}).addTo(map);
  else ringMarker.setLatLng([lat,lng]);
}
function ensureCta(lat,lng){
  const html = `<button id="pinCtaBtn" class="pin-cta-btn">Plantar aqu√≠</button>`;
  if(!ctaPopup){
    ctaPopup = L.popup({closeButton:false, autoClose:false, closeOnClick:false, offset:[0,104], className:'pin-cta'})
      .setLatLng([lat,lng]).setContent(html).openOn(map);
  } else { ctaPopup.setLatLng([lat,lng]); ctaPopup.setContent(html); ctaPopup.openOn(map); }
  setTimeout(()=>{ const b=$('pinCtaBtn'); if(b) b.onclick = ()=>{ if(!selectedLat) return toast('Elige un punto primero', false); openSheet(); }; },0);
}
function setPoint(lat,lng){
  if(!selectedMarker){
    selectedMarker = L.marker([lat,lng], {icon:emojiIcon(), draggable:true}).addTo(map);
    selectedMarker.bindTooltip('Arrastra para ajustar',{permanent:true, direction:'top', offset:[0,-34]});
    selectedMarker.on('drag', e=>{ const p=e.target.getLatLng(); ensureRing(p.lat,p.lng); ensureCta(p.lat,p.lng); });
    selectedMarker.on('dragend', e=>{ const p=e.target.getLatLng(); selectedLat=p.lat.toFixed(6); selectedLng=p.lng.toFixed(6); reverseAt(selectedLat,selectedLng); });
  } else selectedMarker.setLatLng([lat,lng]);
  selectedLat=Number(lat).toFixed(6); selectedLng=Number(lng).toFixed(6);
  ensureRing(lat,lng); ensureCta(lat,lng);
  reverseAt(selectedLat,selectedLng); $('addrBadge').style.display='block';
}

function openSheet(){ $('sheet').classList.add('open'); try{ map.dragging.disable(); map.scrollWheelZoom.disable(); }catch{} }
function closeSheet(){ $('sheet').classList.remove('open'); try{ map.dragging.enable(); map.scrollWheelZoom.enable(); }catch{} }

function reverseAt(lat,lng){
  $('addrBadge').textContent='Buscando direcci√≥n‚Ä¶';
  fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&accept-language=es,en&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`)
    .then(r=>r.json()).then(j=>{
      const a=j.address||{}; const road=a.road||a.pedestrian||a.path||a.neighbourhood||''; const hn=a.house_number||a.housenumber||''; const city=a.city||a.town||a.village||a.state||'';
      $('addrBadge').textContent=[[road,hn].filter(Boolean).join(' '),city].filter(Boolean).join(', ')||j.display_name||'Ubicaci√≥n aproximada';
    }).catch(()=>$('addrBadge').textContent='Ubicaci√≥n aproximada');
}

/* === GUARDAR (sin pagos) === */
async function plantNow(){
  if(!selectedLat||!selectedLng) return toast('Coloca la flor en el mapa', false);
  const from= $('fromName').value.trim();
  const to  = $('toName').value.trim();
  const msg = $('message').value.trim();
  if(!from||!to||!msg) return toast('Completa tu dedicatoria', false);

  const id = genId();
  const place = $('addrBadge').textContent||'';

  $('veil').style.display='flex';
  try{
    const url = `${SCRIPT_URL}?action=add&id=${encodeURIComponent(id)}&lat=${encodeURIComponent(selectedLat)}&lng=${encodeURIComponent(selectedLng)}&place=${encodeURIComponent(place)}&fromName=${encodeURIComponent(from)}&toName=${encodeURIComponent(to)}&message=${encodeURIComponent(msg)}`;
    const r = await jsonp(url, 10000);
    if(!(r && r.ok)){
      $('veil').style.display='none';
      return toast('No se pudo plantar. Prueba de nuevo.', false);
    }

    closeSheet();
    if(selectedMarker){ map.removeLayer(selectedMarker); selectedMarker=null; }
    if(ringMarker){ map.removeLayer(ringMarker); ringMarker=null; }
    if(ctaPopup){ map.closePopup(ctaPopup); ctaPopup=null; }
    $('addrBadge').style.display='none';

    const lat = +selectedLat, lng = +selectedLng;
    const shareUrl = `${location.origin}/?id=${encodeURIComponent(id)}`;

    const mk=L.marker([lat,lng],{icon:emojiIcon(),zIndexOffset:1400}).addTo(map);
    mk.bindPopup(`<div style="min-width:260px;max-width:320px">
      <div class="muted" style="margin-bottom:6px">${fmtDate(Date.now())}</div>
      <div style="margin-bottom:6px"><strong>De ${escHtml(from)}</strong> para <strong>${escHtml(to)}</strong></div>
      <div style="margin-bottom:10px">${escHtml(msg)}</div>
      <button onclick="shareAny('${shareUrl.replace(/'/g,'&#39;')}')" style="width:100%;border:0;border-radius:10px;padding:10px 12px;font-size:.95rem;background:#111;color:#fff;cursor:pointer">üîó Compartir</button>
    </div>`, {autoClose:false,closeOnClick:false});
    map.setView([lat,lng], NEW_ZOOM, {animate:false});
    mk.openPopup();

    setTimeout(()=>refetch(true), 800);
    toast('¬°Flor plantada! üå∏');
  }catch(e){
    toast('Error de red', false);
  }finally{
    $('veil').style.display='none';
  }
}

/* === Compartir === */
async function shareAny(url){
  try{
    if(navigator.share){ await navigator.share({title:'Flovermaps', text:'He plantado esta üå∏ en un lugar del Mundo, especialmente para ti.', url}); }
    else { await navigator.clipboard.writeText(url); toast('Enlace copiado'); }
  }catch{}
}
window.shareAny=shareAny;

/* === Popup render/list === */
function popupHtml(from,to,msg,dt,shareUrl){
  return `<div style="min-width:260px;max-width:320px">
    <div class="muted" style="margin-bottom:6px">${dt||''}</div>
    <div style="margin-bottom:6px"><strong>De ${escHtml(from)}</strong> para <strong>${escHtml(to)}</strong></div>
    <div style="margin-bottom:10px">${escHtml(msg)}</div>
    <button onclick="shareAny('${shareUrl.replace(/'/g,'&#39;')}')" style="width:100%;border:0;border-radius:10px;padding:10px 12px;font-size:.95rem;background:#111;color:#fff;cursor:pointer">üîó Compartir</button>
  </div>`;
}

/* === Datos (Sheets) === */
function normalize(items){
  const out=[];
  for(const f of (items||[])){
    const lat=+f.lat,lng=+f.lng; if(!isFinite(lat)||!isFinite(lng)) continue;
    out.push({ id:String(f.id||''),lat,lng,fromName:f.fromName||'',toName:f.toName||'',message:f.message||'',timestamp:+f.timestamp||0 });
  }
  return out;
}
function render(list){
  if(!map) return;
  const toRemove=[]; map.eachLayer(l=>{ if(l&&l._isFlower) toRemove.push(l); });
  toRemove.forEach(l=>map.removeLayer(l));
  flowerMarkers=[];
  for(const f of (list||[])){
    const shareUrl=`${location.origin}/?id=${encodeURIComponent(f.id)}`;
    const mk=L.marker([f.lat,f.lng],{icon:emojiIcon(),zIndexOffset:1000});
    mk._isFlower=true;
    mk.bindPopup(popupHtml(f.fromName,f.toName,f.message,fmtDate(f.timestamp),shareUrl),{autoClose:false,closeOnClick:false});
    mk.addTo(map);
    flowerMarkers.push(mk);
  }
}
async function refetch(incr){
  try{
    const d=await jsonp(SCRIPT_URL+'?action=list'+(incr&&lastTs?('&since='+encodeURIComponent(lastTs)):''));
    if(d&&Array.isArray(d.items)){
      const norm=normalize(d.items);
      if(incr){ if(!norm.length) return; const m=new Map([...flowersCache,...norm].map(x=>[x.id,x])); flowersCache=[...m.values()]; }
      else { flowersCache=norm; }
      render(flowersCache);
      for(const it of d.items){ const t=+it.timestamp||0; if(t>lastTs) lastTs=t; }
    }
  }catch{}
}

/* === Deep link: abrir flor compartida con zoom cercano === */
async function deepLink(){
  const u=new URL(location.href);
  let id=u.searchParams.get('id');
  if(!id){
    const m=location.pathname.match(/\/f\/([^\/?#]+)/);
    if(m&&m[1]) id=decodeURIComponent(m[1]);
  }
  if(!id) return;

  try{
    const d=await jsonp(`${SCRIPT_URL}?action=get&id=${encodeURIComponent(id)}`);
    if(d&&d.ok&&d.item){
      const it=d.item, lat=+it.lat, lng=+it.lng;
      const mk=L.marker([lat,lng],{icon:emojiIcon(),zIndexOffset:1200}).addTo(map);
      const shareUrl=`${location.origin}/?id=${encodeURIComponent(String(id))}`;
      mk.bindPopup(popupHtml(it.fromName||'',it.toName||'',it.message||'',fmtDate(it.timestamp),shareUrl),{autoClose:false,closeOnClick:false});
      map.setView([lat,lng], SHARE_ZOOM, {animate:false});
      mk.openPopup();
      setTimeout(()=>{ try{ map.invalidateSize(); map.setView([lat,lng], SHARE_ZOOM, {animate:false}); }catch{} }, 140);
    }
  }catch{}
}
</script>
</body>
</html>
