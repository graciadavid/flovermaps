<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Flovermaps</title>

<!-- Favicon üå∏ -->
<link rel="icon" type="image/svg+xml" href='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 64 64"><text x="6" y="54" font-size="52">üå∏</text></svg>'>

<meta name="theme-color" content="#f6fff9" />
<meta name="description" content="Planta flores en el mapa y dedica mensajes bonitos." />

<!-- Tipograf√≠a tipo Balgin -->
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Heatmap plugin -->
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<style>
  :root{
    --ink:#0f172a; --muted:#64748b;
    --accent:#01c064; --accent-weak: rgba(1,192,100,.08);
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:'Plus Jakarta Sans', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--ink);
    background:
      radial-gradient(circle at 12% 18%, var(--accent-weak) 1.2px, transparent 1.2px) 0 0/18px 18px,
      radial-gradient(circle at 70% 40%, rgba(1,192,100,.06) 1.4px, transparent 1.4px) 0 0/22px 22px,
      linear-gradient(180deg, #f6fff9 0%, #ecfaf2 60%, #e8f8ef 100%);
  }

  /* Header con marco blanco */
  .site-header{position:sticky; top:0; z-index:10000; display:flex; align-items:center; justify-content:center; padding:12px;}
  .header-card{display:flex; align-items:center; justify-content:center; background:#fff; border:1px solid #e8e8e8; border-radius:12px; padding:8px 14px; min-height:64px; box-shadow:0 6px 18px rgba(2,6,12,.06)}
  .logo-img{display:block; height:72px; width:auto; max-width:100%; object-fit:contain}
  @media (min-width:900px){ .logo-img{height:96px} }
  .logo-fallback{font-weight:800;letter-spacing:1px; display:none; color:#111}

  /* HERO: Contador vivo gigante */
  .hero{
    margin:14px 12px 0; padding:18px 14px; border-radius:16px; background:#fff; border:1px solid #eee;
    display:flex; gap:12px; align-items:center; justify-content:center; flex-wrap:wrap; text-align:center;
    box-shadow:0 6px 18px rgba(2,6,12,.05)
  }
  .hero .flower{font-size:28px}
  .hero .count{font-weight:800; font-size:clamp(24px, 4.5vw, 42px); letter-spacing:.5px}
  .hero .label{font-weight:600; color:var(--muted); font-size:clamp(14px, 2.5vw, 18px)}

  /* ‚Äú√∫ltima flor‚Äù carrusel */
  .carousel{margin:8px 12px 0; border-radius:14px; background:#fff; border:1px solid #eee; overflow:hidden; box-shadow:0 6px 18px rgba(2,6,12,.05)}
  .marquee{white-space:nowrap; will-change:transform; display:block; color:var(--ink); padding:10px 12px; animation:marq 16s linear infinite}
  .marquee:hover{animation-play-state:paused}
  @keyframes marq{ 0%{transform:translateX(100%)} 100%{transform:translateX(-100%)} }

  /* Layout */
  .wrap{display:flex; gap:0; min-height:calc(100vh - 52px - 56px)}
  .panel{width:420px; max-width:100%; padding:14px; border-right:0; overflow:auto; background:transparent}
  .card{border:1px solid #e8e8e8; border-radius:12px; padding:14px; background:#fff; color:var(--ink); margin:4px; box-shadow:0 6px 18px rgba(2,6,12,.05)}
  h1{font-size:1.25rem; margin:0 0 8px}
  label{display:block; margin:6px 0 4px; font-size:.92rem}
  input,button{width:100%; padding:10px; border:1px solid #ddd; border-radius:10px; font-size:.95rem}
  .muted{color:var(--muted); font-size:.85rem}
  .row2{display:grid; grid-template-columns:1fr 1fr; gap:8px}
  .actions{display:flex; gap:8px; flex-direction:column; margin-top:8px}
  @media (min-width:900px){ .actions{flex-direction:row; align-items:center} }
  .btn{border:0; border-radius:10px; cursor:pointer}
  .btn-dark{background:#444;color:#fff}
  .btn-share{background:#0066cc;color:#fff}
  .badge{display:none; color:#0a7d25; font-size:.85rem; margin-top:6px}
  .choice{display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:8px}
  .choice input{display:none}
  .choice label{border:1px solid #ddd; border-radius:10px; padding:10px; text-align:center; cursor:pointer; background:#fafafa; user-select:none}
  .choice input:checked + label{border-color:#22c55e; background:#eafff2; font-weight:600}
  .choice label.disabled{opacity:.55; cursor:not-allowed}

  /* Autocomplete */
  .sbox{position:relative}
  .slist{position:absolute; left:0; right:0; top:100%; margin-top:4px; background:#fff; border:1px solid #e6e6e6; border-radius:10px; max-height:260px; overflow:auto; display:none; z-index:20}
  .sitem{padding:8px 10px; border-bottom:1px solid #f3f3f3; cursor:pointer; font-size:.95rem}
  .sitem:last-child{border-bottom:0}
  .sitem small{color:#777}
  .hl{font-weight:700}

  /* Mapa */
  .mapArea{flex:1; padding:14px}
  .frame{position:relative; border:1px solid #e8e8e8; border-radius:12px; overflow:hidden; background:#fff; margin:4px; box-shadow:0 6px 18px rgba(2,6,12,.05)}
  #map{width:100%; height:560px}
  @media (max-width:1024px){
    #map{height:44vh}
    .wrap{flex-direction:column;}
    .panel{width:100%; border-right:0;}
  }

  /* Botones flotantes sobre el mapa */
  .map-fab{
    position:absolute; z-index:902; display:none; align-items:center; gap:8px;
    padding:6px 10px; border-radius:999px; border:0; cursor:pointer;
    background:#22c55e; color:#fff; box-shadow:0 6px 20px rgba(0,0,0,.18);
    transform:translate(-50%, 0); pointer-events:auto; transition:transform .15s ease, opacity .15s ease;
    width:auto; white-space:nowrap; font-size:.88rem;
  }
  .map-fab:disabled{opacity:.6; cursor:not-allowed}
  .map-fab::after{content:"Plantar aqu√≠"}
  @keyframes bounceIn{0%{transform:translate(-50%,10px) scale(.9)}60%{transform:translate(-50%,0) scale(1.05)}100%{transform:translate(-50%,0) scale(1)}}
  .map-fab.pop{animation:bounceIn .28s ease}
  .city-zoom{
    position:absolute; z-index:903; top:10px; left:10px; background:#111; color:#fff; border:0; border-radius:10px; padding:8px 10px; cursor:pointer;
    box-shadow:0 6px 18px rgba(0,0,0,.18); font-size:.9rem
  }

  /* Marcador emoji de edici√≥n */
  .leaflet-marker-icon[src*="marker-icon"], .leaflet-marker-shadow{display:none!important}
  .emoji-marker{background:transparent; border:none; display:flex; align-items:center; justify-content:center; transform:translate(-14px,-28px)}
  .emoji-marker .e{font-size:30px; line-height:30px; text-shadow: 0 1px 0 #fff, 0 -1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff, 0 0 4px rgba(0,0,0,.25)}
  @media (min-width:900px){ .emoji-marker .e{font-size:34px; line-height:34px} }
  .emoji-marker.is-selected .e{transform:translateY(-1px) scale(1.05)}

  /* Puntos brillantes (twinkles) */
  .spark-wrap{pointer-events:none}
  .spark{
    display:block; border-radius:50%;
    background: radial-gradient(closest-side, rgba(255,105,180,.95), rgba(255,105,180,.35));
    box-shadow:0 0 12px rgba(255,105,180,.6), 0 0 28px rgba(255,105,180,.35);
    animation:pulse 2.2s ease-in-out infinite;
  }
  @keyframes pulse{
    0%  { transform:scale(.85); box-shadow:0 0 10px rgba(255,105,180,.5), 0 0 26px rgba(255,105,180,.28); }
    50% { transform:scale(1.1);  box-shadow:0 0 16px rgba(255,105,180,.65), 0 0 36px rgba(255,105,180,.4); }
    100%{ transform:scale(.85); box-shadow:0 0 10px rgba(255,105,180,.5), 0 0 26px rgba(255,105,180,.28); }
  }

  /* Toast */
  .toast{position:fixed; left:50%; bottom:82px; transform:translateX(-50%); background:#111; color:#fff; padding:10px 12px; border-radius:10px; z-index:11000; opacity:0; pointer-events:none; transition:opacity .18s, bottom .18s}
  .toast.show{opacity:1; bottom:92px}
</style>
</head>
<body>

<header class="site-header">
  <div class="header-card">
    <img src="logo.png" alt="FLOVERMAPS" class="logo-img" onerror="this.style.display='none'; document.getElementById('logoFallback').style.display='inline-block'">
    <span id="logoFallback" class="logo-fallback">FLOVERMAPS</span>
  </div>
</header>

<!-- HERO: Contador vivo -->
<div class="hero">
  <div class="flower">üå∏</div>
  <div class="count"><span id="heroCount">0</span></div>
  <div class="label">flores plantadas en el mundo</div>
</div>

<!-- √öltima flor en carrusel -->
<div class="carousel"><div class="marquee" id="marqueeText">A√∫n no hay flores plantadas. ¬°S√© el primero! üå∏</div></div>

<div class="wrap">
  <!-- FORMULARIO -->
  <section class="panel" id="panel">
    <div class="card">
      <h1>Planta una flor</h1>
      <div class="row2">
        <div><label for="fromName">¬øQui√©n la env√≠a?</label><input id="fromName" placeholder="Tu nombre"></div>
        <div><label for="toName">¬øPara qui√©n?</label><input id="toName" placeholder="Nombre del destinatario"></div>
      </div>
      <label for="message" style="margin-top:8px">Mensaje <span class="muted" id="chars">(0/30)</span></label>
      <input id="message" maxlength="30" placeholder="Escribe algo bonito‚Ä¶" inputmode="text" autocomplete="off" />
      <div class="choice" aria-label="Tipo de flor">
        <input type="radio" id="flowerBasic" name="flowerType" value="basic" checked>
        <label for="flowerBasic">üå∏ Flor</label>
        <input type="radio" id="flowerPremium" name="flowerType" value="premium" disabled>
        <label for="flowerPremium" class="disabled">üåπ Flor Premium</label>
      </div>
      <div class="muted" style="margin-top:4px">La opci√≥n Premium estar√° disponible pr√≥ximamente.</div>

      <label for="place" style="margin-top:8px">Ubicaci√≥n</label>
      <div class="sbox">
        <input id="place" placeholder="Ej. Puerta del Sol, Madrid" autocomplete="off">
        <div id="slist" class="slist"></div>
      </div>
      <div class="muted" id="help">Escribe y elige una sugerencia, o haz clic en el mapa. Al arrastrar, actualizamos la direcci√≥n.</div>
      <div class="badge" id="fixed">‚úÖ Ubicaci√≥n fijada</div>

      <div class="actions">
        <button id="confirmBtn" type="button" class="btn btn-dark">‚úÖ Confirmar direcci√≥n</button>
        <button id="gpsBtn" type="button" class="btn btn-dark" style="display:none">üìç Ver flores en tu ciudad</button>
      </div>

      <input type="hidden" id="lat"><input type="hidden" id="lng">
    </div>
  </section>

  <!-- MAPA MUNDIAL -->
  <section class="mapArea">
    <div class="frame">
      <div id="map"></div>
      <button id="plantFab" class="map-fab" type="button">‚úÖ</button>
      <button id="cityZoomBtn" class="city-zoom">Ver flores en tu ciudad</button>
    </div>
    <div class="below" style="display:flex;justify-content:center;padding:10px 0">
      <button id="shareBtn" class="btn btn-share" style="display:none">üîó Compartir</button>
    </div>
  </section>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* === CONFIG === */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxhGMS7D1i76f59sBjHim9P6PaNuCibePYkkXk297nQ_7asT0LJxPmIC_mKx8B5G3UhDQ/exec";

/* === JSONP helper === */
function jsonp(url, timeoutMs=12000){
  return new Promise((resolve, reject)=>{
    const cbName = '__fp_cb_'+Math.random().toString(36).slice(2);
    const sep = url.includes('?') ? '&' : '?';
    const src = url + sep + 'callback=' + cbName + '&_ts=' + Date.now();
    let to, done=false;
    function cleanup(){
      clearTimeout(to); try{ delete window[cbName]; }catch{}
      const el = document.getElementById(cbName); if(el && el.parentNode) el.parentNode.removeChild(el);
    }
    window[cbName] = (data)=>{ if(done) return; done=true; cleanup(); resolve(data); };
    const s = document.createElement('script'); s.id = cbName; s.async = true; s.src = src;
    s.onerror = ()=>{ if(done) return; done=true; cleanup(); reject(new Error('JSONP load failed')); };
    (document.head || document.documentElement).appendChild(s);
    to = setTimeout(()=>{ if(done) return; done=true; cleanup(); reject(new Error('JSONP timeout')); }, timeoutMs);
  });
}

/* === STATE / DOM === */
const seen = new Set();
let editMarker = null, usedGPS = false, usedMapClick = false;
let map, baseTiles, fallbackTiles, tileFallbackUsed=false;
let heatLayer = null, twinkleMarkers = [];
let allFlowers = [];
let currentCityName = "", pollTimer = null, consecutiveFails = 0;
let renderQueue = []; // por si el mapa tarda
let serverCount = 0, displayCount = 0; // contador vivo

const $ = s => document.querySelector(s);
const slist = $("#slist"), place = $("#place");
const plantFab = $("#plantFab"), shareBtn = $("#shareBtn"), fixedBadge = $("#fixed");
const marquee = $("#marqueeText");
const heroCountEl = $("#heroCount");

/* === Helpers === */
function toast(msg, ok=true){ const t=$("#toast"); t.textContent=msg; t.style.background=ok?"#111":"#b30000"; t.classList.add("show"); setTimeout(()=>t.classList.remove('show'),1400); }
function fmtDateTime(d){
  try{
    return new Intl.DateTimeFormat('es-ES',{timeZone:'Europe/Madrid', day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit', hour12:false}).format(d).replace(',', '');
  }catch{
    const dd=String(d.getDate()).padStart(2,"0"); const mm=String(d.getMonth()+1).padStart(2,"0"); const yy=d.getFullYear();
    const hh=String(d.getHours()).padStart(2,"0"); const mi=String(d.getMinutes()).padStart(2,"0");
    return `${dd}/${mm}/${yy} ${hh}:${mi}`;
  }
}
function norm(s){ return String(s||'').trim().toLowerCase(); }
function makeKey(lat,lng,from,to,msg){ return `${(+lat).toFixed(5)},${(+lng).toFixed(5)}|${norm(from)}|${norm(to)}|${norm(msg)}`; }
function setMarquee(text){ marquee.textContent = text || "A√∫n no hay flores plantadas. ¬°S√© el primero! üå∏"; }

/* === Reverse geocoding para arrastre === */
async function reverseGeocodeAddress(lat,lng){
  try{
    const url=`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}&addressdetails=1`;
    const r=await fetch(url,{headers:{'Accept':'application/json','Cache-Control':'no-cache'}});
    if(!r.ok) return { display:`${lat}, ${lng}`, city:"" };
    const j=await r.json(); const a=j.address||{};
    const road = a.road || a.pedestrian || a.cycleway || a.footway || a.path || a.neighbourhood || a.suburb || "";
    const hn   = a.house_number || a.housenumber || "";
    const city = a.city || a.town || a.village || a.municipality || a.state || "";
    const display = [ [road, hn].filter(Boolean).join(" "), city ].filter(Boolean).join(", ");
    return { display, city };
  }catch{ return { display:`${lat}, ${lng}`, city:"" }; }
}

/* === Popup formateado (nombres en negrita) === */
function popupHtml(from,to,msg,dtStr){
  const esc = s => String(s||'').replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); 
  return `<div>${esc(dtStr)} <strong>${esc(from)}</strong> para <strong>${esc(to)}</strong>: ${esc(msg)}.</div>`;
}

/* === Iconos/markers === */
function emojiIcon(){ const html = '<span class="e" role="img" aria-label="flor">üå∏</span>'; return L.divIcon({className:'emoji-marker', html, iconSize:[28,28], iconAnchor:[14,28], popupAnchor:[0,-30]}); }

/* === MAPA (vista mundo) === */
function initMap(){
  if(!window.L){ toast('Mapa no disponible (Leaflet no carg√≥)', false); return; }
  if(map){ return; }
  baseTiles = L.tileLayer('https://basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',{attribution:'¬© OpenStreetMap ¬© CARTO',maxZoom:19});
  baseTiles.on('tileerror', ()=>{
    if(!tileFallbackUsed){
      tileFallbackUsed=true;
      try{ map && map.removeLayer(baseTiles); }catch(e){}
      fallbackTiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap contributors', maxZoom:19});
      fallbackTiles.addTo(map);
    }
  });
  map = L.map('map',{layers:[baseTiles],zoomControl:true, worldCopyJump:true});
  map.setView([20,0], 2); // vista mundo
  setTimeout(()=>map.invalidateSize(), 150);
  addEventListener('resize', ()=> setTimeout(()=>map.invalidateSize(), 120));
  map.on('click', e=>{ usedMapClick=true; usedGPS=false; setEditPoint(e.latlng.lat.toFixed(6), e.latlng.lng.toFixed(6), 14, true); });
  map.on('move zoom zoomend', updateFabPosition);

  // Heat layer inicial
  try{ heatLayer = L.heatLayer([], {radius: 22, blur: 28, minOpacity: 0.18}); heatLayer.addTo(map); }catch{}
  flushRenderQueue();
}

/* === Bot√≥n ‚ÄúVer flores en tu ciudad‚Äù === */
function zoomToMyCity(){
  if(!navigator.geolocation){ toast('Activa la geolocalizaci√≥n', false); return; }
  navigator.geolocation.getCurrentPosition(
    pos=>{
      const lat=pos.coords.latitude, lng=pos.coords.longitude;
      map && map.flyTo([lat,lng], 12, {duration:.8});
    },
    ()=>toast('Permiso de ubicaci√≥n denegado', false),
    {enableHighAccuracy:false, maximumAge:60000, timeout:6000}
  );
}

/* === Edici√≥n/arrastre === */
async function setEditPoint(lat,lng,zoom=14,showHint=false){
  $("#lat").value=lat; $("#lng").value=lng;
  if(editMarker){ editMarker.setLatLng([lat,lng]); }
  else{
    editMarker = L.marker([lat,lng],{icon:emojiIcon(),draggable:true}).addTo(map);
    const lockMap = ()=>{ if(map && map.dragging) map.dragging.disable(); };
    const unlockMap = ()=>{ if(map && map.dragging) map.dragging.enable(); };
    editMarker.on('mousedown', lockMap);
    editMarker.on('touchstart', lockMap, {passive:true});
    editMarker.on('dragstart', lockMap);
    editMarker.on('mouseup', unlockMap);
    editMarker.on('touchend', unlockMap, {passive:true});
    editMarker.on('dragend', async e=>{
      unlockMap();
      const p=e.target.getLatLng();
      const lat2=p.lat.toFixed(6), lng2=p.lng.toFixed(6);
      $("#lat").value=lat2; $("#lng").value=lng2;
      fixedBadge.style.display='inline';
      updateFabPosition();
      const info = await reverseGeocodeAddress(lat2,lng2);
      if(info.display) place.value = info.display;
      if(info.city) currentCityName = info.city;
    });
    if(showHint){ editMarker.bindTooltip('Arrastra para ajustar',{permanent:true, direction:'top', offset:[0,-24]}).openTooltip(); }
    editMarker.on('drag', updateFabPosition);
  }
  map.setView([lat,lng], zoom);
  showFab();
}

/* === FAB dentro del mapa (junto a la flor) === */
function updateFabPosition(){
  if(!plantFab || !editMarker || !map) return;
  const mapEl = map.getContainer(), frameEl = mapEl.parentElement;
  const p = map.latLngToContainerPoint(editMarker.getLatLng());
  const mapRect = mapEl.getBoundingClientRect(), frameRect = frameEl.getBoundingClientRect();
  const left = p.x + (mapRect.left - frameRect.left);
  const top  = p.y + (mapRect.top  - frameRect.top) + 34;
  const pad = 8, maxX = frameRect.width - pad, maxY = frameRect.height - pad;
  plantFab.style.left = Math.max(pad, Math.min(left, maxX)) + 'px';
  plantFab.style.top  = Math.max(pad, Math.min(top,  maxY)) + 'px';
}
function showFab(){ if(!plantFab) return; updateFabPosition(); plantFab.style.display='inline-flex'; plantFab.classList.remove('pop'); void plantFab.offsetWidth; plantFab.classList.add('pop'); }
function hideFab(){ if(!plantFab) return; plantFab.style.display='none'; }

/* === AUTOCOMPLETE (con n√∫meros priorizados) === */
let suggestTimer=null, abortCtrl=null, currentSuggest=[];
function hasNumber(s){ return /[0-9]/.test(s); }
function extractNumber(s){ const m=s.match(/([0-9]{1,5})/); return m? m[1]:null; }
function normalizeStreet(q){ const hasType=/(carrer|calle|avinguda|av\.|avenida|paseo|ps\.|pla√ßa|plaza)/i.test(q); if(hasType) return [q]; const base=q.replace(/\s+/g,' ').trim(); return ['Calle '+base,'Carrer de '+base,'Avinguda '+base,base]; }
async function searchPlacesPlain(q, signal){ const url='https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=7&countrycodes=es&q='+encodeURIComponent(q); const r=await fetch(url,{signal, headers:{'Accept':'application/json','Cache-Control':'no-cache'}}); if(!r.ok) throw new Error('nominatim'); return r.json(); }
async function searchPlacesStructured(q, signal){
  let raw=q, city=''; if(q.includes(',')){ const parts=q.split(','); raw=parts[0].trim(); city=parts.slice(1).join(',').trim(); }
  const variants = normalizeStreet(raw); const all=[];
  for(const street of variants){
    const url='https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=7&countrycodes=es&street='+encodeURIComponent(street)+'&city='+encodeURIComponent(city);
    const r=await fetch(url,{signal, headers:{'Accept':'application/json','Cache-Control':'no-cache'}}).catch(()=>null);
    if(r && r.ok){ all.push(...(await r.json())); }
  }
  return all;
}
async function searchPhoton(q, signal){
  const url='https://photon.komoot.io/api/?lang=es&limit=7&q='+encodeURIComponent(q);
  const r=await fetch(url,{signal, headers:{'Accept':'application/json','Cache-Control':'no-cache'}}).catch(()=>null);
  if(!r || !r.ok) return [];
  const j=await r.json();
  return (j.features||[]).map(f=>({
    place_id: 'ph'+(f.properties.osm_id||Math.random()),
    lat: f.geometry.coordinates[1],
    lon: f.geometry.coordinates[0],
    display_name: f.properties.name+', '+(f.properties.city||f.properties.town||f.properties.village||'')+', '+(f.properties.state||''),
    address: { road: f.properties.street || f.properties.name, housenumber: f.properties.housenumber, house_number: f.properties.housenumber, city: f.properties.city||f.properties.town||f.properties.village, state: f.properties.state }
  }));
}
async function searchPlaces(q){
  if(abortCtrl) abortCtrl.abort();
  abortCtrl = new AbortController();
  const sig=abortCtrl.signal;
  try{
    const hasNum = hasNumber(q);
    const A = await searchPlacesPlain(q, sig).catch(()=>[]);
    const B = hasNum ? await searchPlacesStructured(q, sig).catch(()=>[]) : [];
    const C = hasNum ? await searchPhoton(q, sig).catch(()=>[]) : [];
    const list=[...A, ...B, ...C];
    const seenIds=new Set(); const merged=[];
    for(const it of list){ const id=(it.place_id||it.lat+'|'+it.lon); if(!seenIds.has(id)){ seenIds.add(id); merged.push(it); } }
    if(hasNum){
      const num=extractNumber(q);
      merged.sort((x,y)=>{
        const xn=(x.address&& (x.address.house_number||x.address.housenumber))||'';
        const yn=(y.address&& (y.address.house_number||y.address.housenumber))||'';
        const xs=(String(xn)===String(num))?1:0; const ys=(String(yn)===String(num))?1:0;
        return ys-xs;
      });
    }
    return merged.slice(0,10);
  } catch(e){ return []; }
}
function renderSuggest(list){
  const q=place.value.trim(); const num=extractNumber(q);
  slist.innerHTML=""; list.forEach((it,idx)=>{
    const row=document.createElement('div'); row.className='sitem';
    const road = it.address?.road || it.address?.pedestrian || it.address?.footway || it.address?.residential || it.address?.path || it.address?.neighbourhood || '';
    const hn = it.address?.house_number || it.address?.housenumber || '';
    let primary = (road||hn) ? (road + (hn? ' '+hn: '')) : (it.display_name||'').split(',')[0];
    const city = it.address?.city || it.address?.town || it.address?.village || it.address?.municipality || '';
    const state = it.address?.state || it.address?.province || it.address?.state_district || '';
    const meta = [city, state].filter(Boolean).join(', ');
    if(num){ primary = primary.replace(new RegExp('('+num+')'),' <span class="hl">$1</span> '); }
    row.innerHTML = primary + (meta? ' <small>'+meta+'</small>': '');
    row.onclick=()=>selectSuggest(idx);
    slist.appendChild(row);
  });
  slist.style.display = list.length ? 'block' : 'none';
}
async function selectSuggest(idx){
  const it=currentSuggest[idx]; if(!it) return;
  place.value = it.display_name; slist.style.display='none';
  usedGPS=false; usedMapClick=false;
  const lat = Number(it.lat).toFixed(6), lng = Number(it.lon).toFixed(6);
  setEditPoint(lat,lng,14,true);
  fixedBadge.style.display='inline';
  currentCityName = it.address?.city || it.address?.town || it.address?.village || currentCityName;
}
place.addEventListener('input', e=>{
  fixedBadge.style.display='none';
  const q=e.target.value.trim();
  clearTimeout(suggestTimer);
  if(!q){ slist.style.display='none'; return; }
  suggestTimer=setTimeout(async()=>{
    try{ currentSuggest = await searchPlaces(q); renderSuggest(currentSuggest); }
    catch{}
  }, 250);
});
addEventListener('click', e=>{ const box=document.querySelector('.sbox'); if(box && !box.contains(e.target)) slist.style.display='none'; });

/* === CONFIRMAR === */
$("#confirmBtn").onclick = async ()=>{
  const q=place.value.trim(); if(!q){ toast('Escribe una direcci√≥n', false); return; }
  try{
    const r=await searchPlaces(q);
    if(r.length){ const f=r[0]; setEditPoint(Number(f.lat).toFixed(6), Number(f.lon).toFixed(6), 14, true); fixedBadge.style.display='inline'; currentCityName = f.address?.city || f.address?.town || f.address?.village || currentCityName; }
    else toast('No encontrada', false);
  }catch{}
};

/* === Bot√≥n ciudad (cabecera + overlay) === */
const gpsBtn = $("#gpsBtn");
function maybeShowGPS(){
  if('geolocation' in navigator){
    if(navigator.permissions && navigator.permissions.query){
      navigator.permissions.query({name:'geolocation'}).then(st=>{
        if(st.state !== 'denied'){ gpsBtn.style.display='inline-block'; }
        st.onchange = ()=>{ gpsBtn.style.display = (st.state !== 'denied') ? 'inline-block' : 'none'; };
      }).catch(()=>{ gpsBtn.style.display='inline-block'; });
    } else { gpsBtn.style.display='inline-block'; }
  }
}
maybeShowGPS();
gpsBtn.onclick = zoomToMyCity;
document.getElementById('cityZoomBtn').onclick = zoomToMyCity;

/* === MENSAJE: 1 l√≠nea, 30 chars === */
const msgInput = document.getElementById('message');
msgInput.addEventListener('input', ()=>{ msgInput.value = msgInput.value.replace(/\r?\n/g,'').slice(0,30); document.getElementById('chars').textContent='(' + msgInput.value.length + '/30)'; });
msgInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); }});

/* === PLANTAR (JSONP) === */
async function saveFlower(){
  const from=$("#fromName").value.trim(),
        to=$("#toName").value.trim(),
        msg=msgInput.value.trim(),
        type=(document.querySelector('input[name=\"flowerType\"]:checked')||{}).value||'basic';
  const lat=$("#lat").value.trim(), lng=$("#lng").value.trim();
  let placeText = place.value.trim();
  if(!from||!to||!msg||!lat||!lng){ toast('Completa los campos y fija ubicaci√≥n', false); return; }
  if(msg.length>30){ toast('M√°ximo 30 caracteres', false); return; }

  plantFab.disabled=true; const prevTxt=plantFab.textContent; plantFab.textContent='‚è≥';
  try{
    const url = SCRIPT_URL
      + '?action=add'
      + '&fromName=' + encodeURIComponent(from)
      + '&toName='   + encodeURIComponent(to)
      + '&message='  + encodeURIComponent(msg)
      + '&place='    + encodeURIComponent(placeText)
      + '&lat='      + encodeURIComponent(lat)
      + '&lng='      + encodeURIComponent(lng)
      + '&flowerType='+encodeURIComponent(type);

    const data = await jsonp(url);
    if(data && data.ok){
      if(editMarker){ map.removeLayer(editMarker); editMarker=null; }
      const dtStr = fmtDateTime(new Date());
      const html  = popupHtml(from, to, msg, dtStr);
      const m=L.marker([+lat,+lng],{icon:emojiIcon()}).addTo(map).bindPopup(html);
      m.on('click',()=>{ map.setView(m.getLatLng(),19); m.openPopup(); });
      map.setView([+lat,+lng],19); m.openPopup();

      const item={lat:+lat,lng:+lng,fromName:from,toName:to,message:msg,timestamp:Date.now(), place:placeText, type};
      const key = makeKey(lat, lng, from, to, msg);
      seen.add(key); allFlowers.push(item); updateVisualizations(); updateServerCountGuess();
      setMarquee(`${dtStr} ${from} para ${to}: ${msg}.`);

      const shareUrl=`${location.origin}${location.pathname}?lat=${lat}&lng=${lng}&from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&msg=${encodeURIComponent(msg)}`;
      shareBtn.style.display='inline-block';
      shareBtn.onclick=async()=>{ try{ if(navigator.share){ await navigator.share({title:'Flovermaps',text:`Una flor para ${to}`,url:shareUrl}); } else { await navigator.clipboard.writeText(shareUrl); shareBtn.textContent='‚úÖ Copiado'; setTimeout(()=>shareBtn.textContent='üîó Compartir',1200); } }catch{} };

      hideFab(); $("#lat").value=''; $("#lng").value=''; fixedBadge.style.display='none';
      setTimeout(refetch, 500);
    }
  }catch(err){ /* silencioso */ }
  plantFab.disabled=false; plantFab.textContent=prevTxt;
}
if(plantFab){ plantFab.addEventListener('click', saveFlower); }

/* === Dibujo de marcador (si mapa no listo, encola) === */
async function addMarkerWithCity(f){
  const lat=+f.lat, lng=+f.lng;
  const dtStr = f.timestamp ? fmtDateTime(new Date(f.timestamp)) : "";
  const html = popupHtml(f.fromName||'', f.toName||'', (f.message||'').slice(0,30), dtStr);
  const draw = ()=>{
    const mk=L.marker([lat,lng],{icon:emojiIcon()}).addTo(map).bindPopup(html);
    mk.on('click',()=>{map.setView(mk.getLatLng(),19); mk.openPopup();});
  };
  if(!map){ renderQueue.push(draw); } else { draw(); }
}

/* === Heatmap + Twinkles === */
function updateVisualizations(){
  // Heat
  const pts = allFlowers.slice(-8000).map(f=>[f.lat, f.lng, 0.6]);
  if(heatLayer){ heatLayer.setLatLngs(pts); }

  // Twinkles: agrupa por celda ~0.1¬∫
  twinkleMarkers.forEach(mk=>{ try{ map.removeLayer(mk); }catch{} });
  twinkleMarkers = [];
  const grid = new Map();
  const cell = 0.1;
  for(const f of allFlowers){
    const latc = Math.round(f.lat/cell)*cell;
    const lngc = Math.round(f.lng/cell)*cell;
    const key = latc.toFixed(1)+','+lngc.toFixed(1);
    const g = grid.get(key) || {lat:latc, lng:lngc, n:0};
    g.n++; grid.set(key, g);
  }
  // Solo las m√°s intensas para no saturar
  const groups = Array.from(grid.values()).sort((a,b)=>b.n-a.n).slice(0,500);
  for(const g of groups){
    const size = Math.max(6, Math.min(22, Math.sqrt(g.n)*3));
    const speed = Math.max(1.1, 2.4 - Math.log(g.n+1));
    const html = `<span class="spark" style="width:${size}px;height:${size}px; animation-duration:${speed}s"></span>`;
    const icon = L.divIcon({className:'spark-wrap', html, iconSize:[size,size], iconAnchor:[size/2,size/2]});
    const mk = L.marker([g.lat, g.lng], {icon, interactive:false, keyboard:false});
    mk.addTo(map); twinkleMarkers.push(mk);
  }
}

/* === Procesado de items (hoja o cach√©) === */
function processItems(items){
  let added = 0; const normalized = [];
  for(const f of (items||[])){
    if(!f.lat||!f.lng) continue;
    const key = makeKey(f.lat, f.lng, f.fromName||'', f.toName||'', (f.message||'').slice(0,30));
    if(seen.has(key)) continue; seen.add(key);
    normalized.push({
      lat:+f.lat, lng:+f.lng,
      fromName:f.fromName||'', toName:f.toName||'',
      message:(f.message||'').slice(0,30), place:f.place||'',
      timestamp: f.timestamp ? +new Date(f.timestamp) : Date.now(),
      type:f.flowerType||'basic'
    });
  }
  (async ()=>{
    for(const f of normalized){ await addMarkerWithCity(f); added++; }
    if(added>0){
      allFlowers.push(...normalized);
      updateVisualizations();
      updateServerCountGuess();
      const last = [...allFlowers].sort((a,b)=>b.timestamp-a.timestamp)[0];
      if(last){ setMarquee(`${fmtDateTime(new Date(last.timestamp))} ${last.fromName} para ${last.toName}: ${last.message}.`); }
      saveCache();
    }
  })();
}

/* === Carga desde hoja (JSONP) con reintentos silenciosos === */
async function refetch(){
  try{
    const data = await jsonp(SCRIPT_URL + '?action=list', 12000);
    if(data && data.items){
      processItems(data.items);
      consecutiveFails = 0;
    }
  }catch(e){
    consecutiveFails++;
    const retry = Math.min(30000, 4000 * consecutiveFails);
    setTimeout(refetch, retry);
    return;
  }
}
function startPolling(){
  if(pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(refetch, 12000);
  document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) refetch(); });
}

/* === Cach√© local === */
const CACHE_KEY = 'flovermaps_cache_v1';
function loadCache(){ try{ const raw=localStorage.getItem(CACHE_KEY); if(!raw) return []; const arr=JSON.parse(raw); return Array.isArray(arr)?arr:[]; }catch{return [];} }
function saveCache(){
  try{
    const minimal = allFlowers.slice(-12000).map(f=>({
      lat:f.lat, lng:f.lng, fromName:f.fromName, toName:f.toName,
      message:f.message, place:f.place, timestamp:f.timestamp, type:f.type||'basic'
    }));
    localStorage.setItem(CACHE_KEY, JSON.stringify(minimal));
  }catch{}
}

/* === Contador vivo === */
function formatES(n){ try{ return new Intl.NumberFormat('es-ES').format(n); }catch{return String(n); } }
function updateServerCountGuess(){ serverCount = seen.size; }
function tickLiveCounter(){
  const diff = serverCount - displayCount;
  if(diff > 0){
    // alcanza el servidor con aceleraci√≥n suave
    const step = Math.max(1, Math.ceil(diff/7));
    displayCount += step;
  }else{
    // movimiento social: +1/segundo con control de sobrepaso
    displayCount += 1;
    const overshoot = displayCount - serverCount;
    if(overshoot > 300){ displayCount = serverCount + Math.floor(overshoot/2); }
  }
  heroCountEl.textContent = formatES(displayCount);
}
setInterval(tickLiveCounter, 1000);

/* === Arranque: mapa, cach√©, servidor === */
document.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('chars').textContent='(0/30)';
  if(window.L){ initMap(); } else {
    (function waitLeaflet(attempts=20){ if(window.L){ initMap(); } else { if(attempts<=0) return; setTimeout(()=>waitLeaflet(attempts-1), 200);} })();
  }
  processItems(loadCache());  // pinta cach√©
  updateServerCountGuess();   // fija contador base
  refetch();                  // sincroniza con servidor
  startPolling();             // polling peri√≥dico
});
</script>
</body>
</html>
