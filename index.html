<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Flovermaps ‚Äî Planta una flor en el lugar que lo cambi√≥ todo</title>

<link rel="icon" type="image/svg+xml" href='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 64 64"><text x="6" y="54" font-size="52">üå∏</text></svg>'>
<meta name="theme-color" content="#f6fff9" />
<meta name="description" content="Elige un sitio del mapa, dedica un mensaje y comp√°rtalo con un enlace." />
<meta property="og:title" content="Planta una flor en el lugar que lo cambi√≥ todo ‚Äî Flovermaps">
<meta property="og:description" content="Toca el mapa para elegir un lugar, dedica un mensaje y comp√°rtalo con un enlace.">
<meta property="og:type" content="website">
<meta property="og:image" content='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="630" viewBox="0 0 1200 630"><rect width="100%" height="100%" fill="%23f6fff9"/><text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle" font-size="300">üå∏</text></svg>'>
<meta name="twitter:card" content="summary_large_image">

<link rel="preconnect" href="https://unpkg.com">
<link rel="preconnect" href="https://basemaps.cartocdn.com">
<link rel="preconnect" href="https://nominatim.openstreetmap.org">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- MarkerCluster (solo si hay muchas flores) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
<script defer src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<style>
  :root{
    --ink:#0f172a; --muted:#64748b; --accent:#22c55e; --bg:#f6fff9;
    --safe-b: env(safe-area-inset-bottom, 0px);
    --safe-t: env(safe-area-inset-top, 0px);
  }
  *{ box-sizing:border-box; }

  html, body { height:100%; }
  body{
    margin:0; font-family:'Plus Jakarta Sans', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--ink);
    background: linear-gradient(180deg, #f6fff9 0%, #ecfaf2 60%, #e8f8ef 100%);
    overflow:hidden; /* el body NO scrollea, solo los sheets */
    overscroll-behavior-y: none; /* evita bounce global */
  }
  body.noscroll{ position:fixed; inset:0; overflow:hidden; } /* lock scroll cuando hay sheet */

  /* Header minimal (logo) */
  .site-header{
    position:fixed; z-index:1200; left:0; right:0; top:0;
    display:flex; justify-content:center; padding:8px 10px; padding-top:calc(8px + var(--safe-t)); pointer-events:none;
  }
  .brand{ pointer-events:auto; background:#fff; border:1px solid #e8e8e8; border-radius:12px; padding:6px 12px; box-shadow:0 6px 18px rgba(2,6,12,.06); cursor:pointer }
  .brand img{ height:40px; display:block }
  @media (min-width:900px){ .brand img{ height:56px } }

  /* MAPA full pantalla */
  #mapWrap{ position:fixed; inset:0; }
  #map{ position:absolute; inset:0; width:100%; height:100dvh; min-height:100vh; }

  /* Search bar + GPS (overlay) */
  .search-bar{
    position:fixed; z-index:1201; left:12px; right:56px; top:calc(62px + var(--safe-t));
    display:flex; gap:6px; align-items:center;
  }
  .search{ position:relative; flex:1 1 auto }
  .search input{
    width:100%; padding:10px 42px 10px 12px; border:1px solid #e6e6e6; border-radius:12px; background:#fff; font-size:0.95rem;
    box-shadow:0 6px 14px rgba(0,0,0,.04);
  }
  .search .gps{
    position:absolute; right:6px; top:50%; transform:translateY(-50%);
    border:0; background:#f3f4f6; border-radius:10px; padding:6px 8px; cursor:pointer
  }
  .slist{ position:absolute; left:0; right:0; top:100%; margin-top:6px; background:#fff; border:1px solid #e6e6e6; border-radius:12px; max-height:260px; overflow:auto; display:none; z-index:1202 }
  .sitem{ padding:8px 10px; border-bottom:1px solid #f3f3f3; cursor:pointer; font-size:.95rem }
  .sitem:last-child{ border-bottom:0 }

  /* Bot√≥n √öltimas (esquina) */
  .latest-trigger{
    position:fixed; right:12px; top:calc(62px + var(--safe-t));
    z-index:1201; border:1px solid #e6e6e6; background:#fff; border-radius:12px; padding:8px 10px; cursor:pointer;
    box-shadow:0 6px 14px rgba(0,0,0,.04); font-size:.95rem;
  }

  /* Coach + direcci√≥n bajo el pin + FAB */
  .coach{
    position:fixed; left:50%; transform:translateX(-50%); bottom:calc(110px + var(--safe-b)); z-index:1200;
    background:#fff; border:1px solid #e8e8e8; border-radius:999px; padding:8px 12px; font-size:.95rem; box-shadow:0 6px 16px rgba(0,0,0,.08);
  }
  .addr-badge{
    position:fixed; left:50%; transform:translateX(-50%); bottom:calc(72px + var(--safe-b)); z-index:1200;
    background:#fff; border:1px solid #e6e6e6; border-radius:999px; padding:6px 10px; font-size:.9rem;
    max-width:min(90%,520px); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; box-shadow:0 4px 12px rgba(0,0,0,.06); display:none;
  }
  .fab{
    position:fixed; left:50%; transform:translateX(-50%); bottom:calc(20px + var(--safe-b)); z-index:1200;
    background:var(--accent); color:#fff; border:0; border-radius:14px; padding:12px 16px; font-size:1rem; min-width:180px;
    box-shadow:0 12px 24px rgba(0,0,0,.22); cursor:pointer; opacity:.92;
  }
  .fab:disabled{ opacity:.5; cursor:not-allowed }

  /* Marcador emoji */
  .leaflet-marker-icon[src*="marker-icon"], .leaflet-marker-shadow{ display:none!important }
  .emoji-marker{ background:transparent; transform:translate(-14px,-28px) }
  .emoji-marker .e{ font-size:34px; line-height:34px; text-shadow:0 1px 0 #fff,0 -1px 0 #fff,1px 0 0 #fff,-1px 0 0 #fff,0 0 4px rgba(0,0,0,.25) }
  @media (min-width:900px){ .emoji-marker .e{ font-size:38px; line-height:38px } }

  /* Bottom-sheet (form + √©xito + √∫ltimas) */
  .sheet{
    position:fixed; left:0; right:0; bottom:0; z-index:1300;
    transform:translateY(100%); transition:transform .25s ease;
    background:#fff; border-top-left-radius:16px; border-top-right-radius:16px; box-shadow:0 -20px 60px rgba(0,0,0,.25);
    max-height:85dvh; display:flex; flex-direction:column;
  }
  .sheet.open{ transform:translateY(0) }
  .sheet .handle{ align-self:center; width:54px; height:5px; border-radius:999px; background:#e5e7eb; margin:8px 0 4px }
  .sheet .body{ padding:10px 14px 16px; overflow:auto; overscroll-behavior: contain; -webkit-overflow-scrolling: touch; }
  .sheet h3{ margin:8px 0 10px }
  .row2{ display:grid; grid-template-columns:1fr 1fr; gap:8px }
  label{ display:block; margin:6px 0 4px; font-size:.92rem }
  input,.btn{ width:100%; padding:10px; border:1px solid #ddd; border-radius:10px; font-size:.95rem }
  .btn{ border:0; cursor:pointer }
  .btn-green{ background:#22c55e; color:#fff }
  .btn-outline{ background:#fff; color:#0f172a; border:1px solid #e6e6e6 }
  .muted{ color:var(--muted); font-size:.95rem }
  .btn-xxs{ padding:6px 8px; font-size:.86rem; border-radius:10px }

  /* Splash (solo primera vez) */
  .splash{
    position:fixed; inset:0; z-index:1400; display:flex; align-items:stretch; justify-content:center; background:#000;
    cursor:pointer;
  }
  .splash picture, .splash img{ width:100%; height:100%; object-fit:cover; object-position:center; display:block; }
  .splash .hint{
    position:absolute; left:50%; transform:translateX(-50%); bottom:calc(18px + var(--safe-b));
    background:rgba(255,255,255,.85); color:#111; padding:6px 10px; border-radius:999px; font-size:.95rem;
  }
  .splash .skip{
    position:absolute; right:12px; top:calc(12px + var(--safe-t));
    background:rgba(255,255,255,.85); color:#111; padding:6px 10px; border-radius:999px; font-size:.9rem;
  }

  /* Toast */
  .toast{
    position:fixed; left:50%; bottom:calc(100px + var(--safe-b)); transform:translateX(-50%);
    background:#111; color:#fff; padding:10px 12px; border-radius:10px; z-index:1500; opacity:0; pointer-events:none; transition:opacity .18s, bottom .18s
  }
  .toast.show{ opacity:1; bottom:calc(110px + var(--safe-b)) }
</style>
</head>
<body>

<!-- Header (logo) -->
<header class="site-header">
  <div class="brand" id="logoBtn"><img src="logo.png" alt="FLOVERMAPS" onerror="this.style.display='none'"></div>
</header>

<!-- MAPA -->
<main id="mapWrap" aria-label="Mapa">
  <div id="map"></div>
</main>

<!-- BARRA DE B√öSQUEDA + GPS -->
<div class="search-bar" role="search" aria-label="Buscar lugar">
  <div class="search">
    <input id="place" placeholder="üîé Buscar un lugar (ej. Calle Alcal√° 42, Madrid)" autocomplete="off" aria-autocomplete="list" aria-controls="slist">
    <button id="gpsBtn" class="gps" title="Usar mi ubicaci√≥n">üìç</button>
    <div id="slist" class="slist" role="listbox" aria-label="Sugerencias de lugares"></div>
  </div>
</div>

<!-- √öLTIMAS (trigger) -->
<button id="openLatest" class="latest-trigger" title="Ver √∫ltimas">üå∏ √öltimas</button>

<!-- COACH + DIRECCI√ìN + FAB -->
<div id="coach" class="coach">Toca el mapa para colocar la flor</div>
<div id="addrBadge" class="addr-badge" aria-live="polite"></div>
<button id="fab" class="fab" disabled>Plantar</button>

<!-- SHEET principal (formulario / √©xito) -->
<section id="sheet" class="sheet" aria-modal="true" role="dialog" aria-labelledby="sheetTitle" aria-hidden="true">
  <div class="handle"></div>
  <div id="sheetBody" class="body">
    <!-- Form view -->
    <div id="formView">
      <h3 id="sheetTitle">Tu dedicatoria</h3>
      <div class="row2">
        <div>
          <label for="fromName">¬øQui√©n la env√≠a?</label>
          <input id="fromName" placeholder="Tu nombre" required>
        </div>
        <div>
          <label for="toName">¬øPara qui√©n?</label>
          <input id="toName" placeholder="Nombre del destinatario" required>
        </div>
      </div>
      <label for="message" style="margin-top:8px">Mensaje <span class="muted" id="chars">(0/30)</span></label>
      <input id="message" maxlength="30" placeholder="Ese rinc√≥n especial‚Ä¶ (m√°x. 30)" inputmode="text" autocomplete="off" required />
      <div style="display:flex; gap:8px; margin-top:10px">
        <button id="saveBtn" class="btn btn-green" style="flex:1 1 auto">Plantar flor</button>
        <button id="cancelSheet" class="btn btn-outline" style="flex:0 0 auto">Cancelar</button>
      </div>
      <p class="muted" style="margin-top:10px">Podr√°s compartirla con un enlace.</p>
    </div>
    <!-- Success view -->
    <div id="successView" style="display:none">
      <h3>üéâ ¬°Tu flor ya florece aqu√≠!</h3>
      <p class="muted" id="successText">Comparte el enlace o abre la flor.</p>
      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px">
        <button id="mShare" class="btn btn-outline">üîó Compartir</button>
        <button id="mOpen" class="btn btn-green">ü™Ñ Ver flor ahora</button>
      </div>
    </div>
  </div>
</section>

<!-- SHEET de √öltimas -->
<section id="latestSheet" class="sheet" aria-modal="true" role="dialog" aria-labelledby="latestTitle" aria-hidden="true">
  <div class="handle"></div>
  <div class="body">
    <h3 id="latestTitle" style="margin:8px 0 10px">√öltimas dedicatorias</h3>
    <div id="latestList"></div>
    <div style="display:flex; gap:8px; justify-content:center; margin-top:8px">
      <button id="prevPage" class="btn btn-outline btn-xxs">‚óÄÔ∏é</button>
      <button id="nextPage" class="btn btn-outline btn-xxs">‚ñ∂Ô∏é</button>
    </div>
  </div>
</section>

<!-- SPLASH (primera vez / entrada) -->
<section id="splash" class="splash" role="dialog" aria-label="Pantalla de bienvenida" style="display:none;">
  <button class="skip" id="skipSplash" aria-label="Saltar">Saltar</button>
  <div class="hint">Toca para empezar</div>
  <picture>
    <!-- Sustituye estos assets por los tuyos -->
    <source srcset="splash-desktop.avif" type="image/avif" media="(min-width:768px)">
    <source srcset="splash-desktop.webp" type="image/webp" media="(min-width:768px)">
    <source srcset="splash-mobile.avif" type="image/avif">
    <source srcset="splash-mobile.webp" type="image/webp">
    <img src="splash-mobile.jpg" alt="Pareja caminando sobre un mapa con flores plantadas">
  </picture>
</section>

<!-- Toast -->
<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* === CONFIG === */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxhGMS7D1i76f59sBjHim9P6PaNuCibePYkkXk297nQ_7asT0LJxPmIC_mKx8B5G3UhDQ/exec";

/* === JSONP helper === */
function jsonp(url, timeoutMs=12000){
  return new Promise((resolve, reject)=>{
    const cb='__fp_cb_'+Math.random().toString(36).slice(2);
    const s=document.createElement('script'); const sep=url.includes('?')?'&':'?';
    s.src=url+sep+'callback='+cb+'&_ts='+Date.now(); s.id=cb; s.async=true;
    let to; function cleanup(){ clearTimeout(to); try{ delete window[cb]; }catch{}; s.remove(); }
    window[cb]=(data)=>{ cleanup(); resolve(data); };
    s.onerror=()=>{ cleanup(); reject(new Error('JSONP load failed')); };
    document.head.appendChild(s);
    to=setTimeout(()=>{ cleanup(); reject(new Error('JSONP timeout')); }, timeoutMs);
  });
}

/* === STATE === */
let map, baseTiles, fallbackTiles, tileFallbackUsed=false;
let flowersLayer=null; let useCluster=null;
let selectedMarker=null; let selectedLat=null; let selectedLng=null;
let saving=false; let plantedOnce=false; let lastShareUrl=''; let lastTs=0;
let latestItems=[]; let page=0; const pageSize=8;
let abortRev=null;

/* === DOM === */
const $=s=>document.querySelector(s);
const mapEl=$("#map"), addrBadge=$("#addrBadge"), coach=$("#coach"), fab=$("#fab");
const place=$("#place"), slist=$("#slist"), gpsBtn=$("#gpsBtn");
const sheet=$("#sheet"), formView=$("#formView"), successView=$("#successView"), saveBtn=$("#saveBtn"), cancelSheet=$("#cancelSheet");
const fromInput=$("#fromName"), toInput=$("#toName"), msgInput=$("#message"), chars=$("#chars");
const mShare=$("#mShare"), mOpen=$("#mOpen");
const latestSheet=$("#latestSheet"), latestList=$("#latestList"), openLatest=$("#openLatest"), prevPage=$("#prevPage"), nextPage=$("#nextPage");
const splash=$("#splash"), skipSplash=$("#skipSplash");
const toastEl=$("#toast");

/* === Utils === */
const ACCEPT_LANG = (()=>{ 
  try{
    const langs = (navigator.languages && navigator.languages.length) ? navigator.languages : [navigator.language || 'es'];
    const set = Array.from(new Set([...langs.map(l=>String(l||'').split('-')[0]), 'es','en']));
    return set.join(',');
  }catch{ return 'es,en'; }
})();
function toast(msg, ok=true){ const t=toastEl; t.textContent=msg; t.style.background=ok?"#111":"#b30000"; t.classList.add("show"); setTimeout(()=>t.classList.remove('show'),1600); }
function fmtDateTime(d){ try{ return new Intl.DateTimeFormat('es-ES',{timeZone:'Europe/Madrid', day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit', hour12:false}).format(d).replace(',', ''); }catch{ const dd=String(d.getDate()).padStart(2,"0"), mm=String(d.getMonth()+1).padStart(2,"0"), yy=d.getFullYear(), hh=String(d.getHours()).padStart(2,"0"), mi=String(d.getMinutes()).padStart(2,"0"); return `${dd}/${mm}/${yy} ${hh}:${mi}`; } }
function emojiIcon(){ const html='<span class="e" role="img" aria-label="flor">üå∏</span>'; return L.divIcon({className:'emoji-marker', html, iconSize:[28,28], iconAnchor:[14,28], popupAnchor:[0,-30]}); }
function escAttr(s){ return encodeURIComponent(String(s||'')); }
function unescAttr(s){ return decodeURIComponent(String(s||'')); }
function relTime(ts){ const t=Number(ts)||Date.parse(ts)||Date.now(); const s=Math.max(1, Math.floor((Date.now()-t)/1000)); if(s<60) return `hace ${s} s`; const m=Math.floor(s/60); if(m<60) return `hace ${m} min`; const h=Math.floor(m/60); if(h<24) return `hace ${h} h`; const d=Math.floor(h/24); return `hace ${d} d`; }

/* === SCROLL LOCK helpers === */
function lockBodyScroll(){ document.body.classList.add('noscroll'); }
function unlockBodyScroll(){ document.body.classList.remove('noscroll'); }

/* === MAP === */
function initMap(){
  baseTiles=L.tileLayer('https://basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',{attribution:'¬© OpenStreetMap ¬© CARTO',maxZoom:19});
  baseTiles.on('tileerror', ()=>{ if(!tileFallbackUsed){ tileFallbackUsed=true; try{ map && map.removeLayer(baseTiles);}catch{} fallbackTiles=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap contributors',maxZoom:19}); fallbackTiles.addTo(map);} });
  map=L.map('map',{layers:[baseTiles],zoomControl:true, worldCopyJump:true});
  map.setView([40.4168,-3.7038],6);

  flowersLayer = L.layerGroup().addTo(map); useCluster=false;

  map.on('click', e=>{
    if(plantedOnce) { toast('Ya has plantado una flor en esta sesi√≥n.', false); return; }
    setSelectedPoint(e.latlng.lat, e.latlng.lng, true);
  });

  setTimeout(()=>map.invalidateSize(),150);
  window.addEventListener('resize', ()=>setTimeout(()=>map.invalidateSize(),100));
}

function setSelectedPoint(lat,lng,animate=false){
  selectedLat=Number(lat).toFixed(6); selectedLng=Number(lng).toFixed(6);
  if(selectedMarker){ selectedMarker.setLatLng([lat,lng]); }
  else{
    selectedMarker=L.marker([lat,lng],{icon:emojiIcon(), draggable:true, zIndexOffset:2000}).addTo(map);
    selectedMarker.on('dragend', e=>{
      const p=e.target.getLatLng();
      selectedLat=p.lat.toFixed(6); selectedLng=p.lng.toFixed(6);
      reverseAt(selectedLat, selectedLng);
    });
  }
  if(animate){ try{ map.flyTo([lat,lng], 16, {duration:0.6}); }catch{ map.setView([lat,lng],16); } }
  reverseAt(selectedLat, selectedLng);
  coach.style.display='none';
  fab.disabled=false; fab.textContent='Continuar';
  addrBadge.style.display='block';
}

async function reverseAt(lat,lng){
  if(abortRev){ try{ abortRev.abort(); }catch{} }
  const ctl=new AbortController(); abortRev=ctl;
  addrBadge.textContent='Buscando direcci√≥n‚Ä¶';
  try{
    const url=`https://nominatim.openstreetmap.org/reverse?format=jsonv2&accept-language=${encodeURIComponent(ACCEPT_LANG)}&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`;
    const r=await fetch(url,{signal:ctl.signal});
    if(!r.ok) throw 0;
    const j=await r.json(); const a=j.address||{};
    const road=a.road||a.pedestrian||a.cycleway||a.footway||a.path||a.neighbourhood||a.suburb||a.city_district||"";
    const hn=a.house_number||a.housenumber||"";
    const city=a.city||a.town||a.village||a.municipality||a.state||"";
    const label=[[road,hn].filter(Boolean).join(" "),city].filter(Boolean).join(", ");
    addrBadge.textContent = label || (j.display_name||'Ubicaci√≥n aproximada');
  }catch{ addrBadge.textContent='Ubicaci√≥n aproximada'; }
}

/* === SEARCH + GPS === */
let suggestTimer=null, abortCtrl=null, currentSuggest=[];
function hasNumber(s){ return /[0-9]/.test(s); }
function extractNumber(s){ const m=s.match(/([0-9]{1,6})/); return m? m[1]:null; }
function containsStreetType(q){
  return /(calle|carrer|avenida|av\.?|avinguda|paseo|ps\.?|pla√ßa|plaza|street|st\.?|road|rd\.?|avenue|ave\.?|blvd\.?|boulevard|place|square|piazza|rua|rue|stra√üe|strasse|ulica|via|cours|allee)/i.test(q);
}
function normalizeStreet(q){
  const base=q.replace(/\s+/g,' ').trim();
  if(!base) return [];
  if(containsStreetType(base)) return [base];
  return [ base, `Calle ${base}`, `Avenida ${base}`, `Carrer de ${base}`, `Street ${base}`, `Avenue ${base}`, `Road ${base}`, `Boulevard ${base}`, `Rue ${base}`, `Rua ${base}`, `Via ${base}` ];
}
async function searchPlacesPlain(q, sig){
  const url = 'https://nominatim.openstreetmap.org/search'
    + '?format=json&addressdetails=1&limit=10'
    + '&accept-language=' + encodeURIComponent(ACCEPT_LANG)
    + '&q=' + encodeURIComponent(q);
  const r = await fetch(url, {signal:sig}); if(!r.ok) throw new Error('nominatim');
  return r.json();
}
async function searchPlacesStructured(q, sig){
  let raw=q, tail='';
  if(q.includes(',')){ const parts=q.split(','); raw=parts[0].trim(); tail=parts.slice(1).join(',').trim(); }
  const variants=normalizeStreet(raw);
  const tasks = variants.map(street => {
    const url = 'https://nominatim.openstreetmap.org/search'
      + '?format=json&addressdetails=1&limit=7'
      + '&accept-language=' + encodeURIComponent(ACCEPT_LANG)
      + '&street=' + encodeURIComponent(street)
      + (tail ? ('&city=' + encodeURIComponent(tail)) : '');
    return fetch(url, {signal:sig}).then(r=>r.ok?r.json():[]).catch(()=>[]);
  });
  const results = await Promise.allSettled(tasks);
  return results.flatMap(r => r.status==='fulfilled' ? r.value : []);
}
async function searchPlaces(q){
  if(abortCtrl) abortCtrl.abort();
  abortCtrl=new AbortController(); const sig=abortCtrl.signal;
  try{
    const withNum=hasNumber(q);
    const [A,B] = await Promise.all([
      searchPlacesPlain(q,sig).catch(()=>[]),
      withNum? searchPlacesStructured(q,sig).catch(()=>[]) : Promise.resolve([])
    ]);
    const list=[...A,...B]; const seen=new Set(); const merged=[];
    for(const it of list){ const id=(it.place_id||it.lat+'|'+it.lon); if(!seen.has(id)){ seen.add(id); merged.push(it); } }
    if(withNum){ 
      const num=extractNumber(q);
      merged.sort((x,y)=>{
        const xn=(x.address&&(x.address.house_number||x.address.housenumber))||'';
        const yn=(y.address&&(y.address.house_number||y.address.housenumber))||'';
        return (String(yn)===String(num)) - (String(xn)===String(num));
      }); 
    }
    return merged.slice(0,10);
  }catch{ return []; }
}
function renderSuggest(list){
  slist.innerHTML="";
  list.forEach((it,idx)=>{
    const row=document.createElement('div'); row.className='sitem'; row.setAttribute('role','option');
    const dn = (it.display_name||'').split(',').map(s=>s.trim());
    const primary = dn[0] || '';
    const city = it.address?.city || it.address?.town || it.address?.village || it.address?.municipality || '';
    const state = it.address?.state || it.address?.province || it.address?.state_district || '';
    const meta = [city || dn[1] || '', state || dn[2] || ''].filter(Boolean).join(', ');
    row.innerHTML = primary + (meta?` <small>${meta}</small>`:'');
    row.onclick=()=>selectSuggest(idx);
    slist.appendChild(row);
  });
  slist.style.display = list.length ? 'block' : 'none';
}
async function selectSuggest(i){
  const it=currentSuggest[i]; if(!it) return;
  place.value=it.display_name; slist.style.display='none';
  setSelectedPoint(Number(it.lat), Number(it.lon), true);
}
place.addEventListener('input', e=>{
  const q=e.target.value.trim();
  clearTimeout(suggestTimer);
  if(!q){ slist.style.display='none'; return; }
  suggestTimer=setTimeout(async()=>{ try{ currentSuggest=await searchPlaces(q); renderSuggest(currentSuggest);}catch{} }, 250);
});
document.addEventListener('click', e=>{ if(!$('.search').contains(e.target)) slist.style.display='none'; });

/* GPS */
gpsBtn.addEventListener('click', ()=>{
  if(!('geolocation' in navigator)) return toast('Tu dispositivo no permite geolocalizaci√≥n', false);
  navigator.geolocation.getCurrentPosition(pos=>{
    setSelectedPoint(pos.coords.latitude, pos.coords.longitude, true);
  }, ()=>toast('No se pudo obtener tu ubicaci√≥n (revisa permisos)', false), {timeout:8000});
});

/* === FAB ‚Üí abre sheet de formulario === */
fab.addEventListener('click', ()=>{
  if(plantedOnce) return toast('Ya has plantado una flor en esta sesi√≥n.', false);
  if(!selectedLat||!selectedLng) return toast('Coloca la flor tocando el mapa', false);
  openSheet('form');
});

/* === SHEETS control (lock scroll, disable map drag) === */
function openSheet(kind){
  sheet.classList.add('open'); sheet.setAttribute('aria-hidden','false');
  if(kind==='form'){ formView.style.display='block'; successView.style.display='none'; }
  if(kind==='success'){ formView.style.display='none'; successView.style.display='block'; }
  lockBodyScroll();
  try{ map.dragging.disable(); map.scrollWheelZoom.disable(); map.doubleClickZoom.disable(); }catch{}
}
function closeSheet(){
  sheet.classList.remove('open'); sheet.setAttribute('aria-hidden','true');
  unlockBodyScroll();
  try{ map.dragging.enable(); map.scrollWheelZoom.enable(); map.doubleClickZoom.enable(); }catch{}
}
cancelSheet.addEventListener('click', closeSheet);

/* === Form: validaciones m√≠nimas === */
msgInput.addEventListener('input', ()=>{ msgInput.value=msgInput.value.replace(/\r?\n/g,'').slice(0,30); chars.textContent='(' + msgInput.value.length + '/30)'; });
msgInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); }});

/* === Guardar flor === */
async function saveFlower(){
  if(saving) return;
  if(!selectedLat||!selectedLng){ toast('Coloca la flor en el mapa', false); return; }
  const from=fromInput.value.trim(), to=toInput.value.trim(), msg=msgInput.value.trim();
  if(!from||!to||!msg){ toast('Completa tu dedicatoria', false); return; }
  saving=true; saveBtn.disabled=true; saveBtn.textContent='Guardando‚Ä¶';
  try{
    const url = SCRIPT_URL + '?action=add'
      + '&fromName='+encodeURIComponent(from)
      + '&toName='  +encodeURIComponent(to)
      + '&message=' +encodeURIComponent(msg)
      + '&place='   +encodeURIComponent(addrBadge.textContent || '')
      + '&lat='     +encodeURIComponent(selectedLat)
      + '&lng='     +encodeURIComponent(selectedLng);
    const data = await jsonp(url);

    if(data && data.ok){
      // A√±adimos marcador visible y popup
      const dtStr=fmtDateTime(new Date());
      const mk=L.marker([+selectedLat,+selectedLng],{icon:emojiIcon(), zIndexOffset:1500}).bindPopup(`<div>${dtStr} <strong>${from}</strong> para <strong>${to}</strong>: ${String(msg).replace(/[&<>"']/g,'')}</div>`);
      flowersLayer ? flowersLayer.addLayer(mk) : mk.addTo(map);
      try{ map.flyTo([+selectedLat,+selectedLng], 17, {duration:0.6}); }catch{ map.setView([+selectedLat,+selectedLng], 17); }
      mk.openPopup();

      // Enlace de compartir SIEMPRE con par√°metros de tu dominio
      lastShareUrl = `${location.origin}${location.pathname}?lat=${selectedLat}&lng=${selectedLng}&from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&msg=${encodeURIComponent(msg)}`;

      // Bloquear nuevas plantaciones (solo sesi√≥n actual)
      plantedOnce=true;
      fab.disabled=true; fab.textContent='Plantada';

      // Mostrar √©xito
      $("#successText").textContent = `De ${from} para ${to}.`;
      openSheet('success');

      await refetch(true);
    } else {
      toast('No se pudo guardar', false);
    }
  }catch(e){
    toast('Error al plantar', false);
  }
  saving=false; saveBtn.disabled=false; saveBtn.textContent='Plantar flor';
}
saveBtn.addEventListener('click', saveFlower);

/* === Compartir (√©xito) === */
mShare.addEventListener('click', async ()=>{
  try{
    if(lastShareUrl){
      if(navigator.share){ await navigator.share({title:'Flovermaps', text:'Mira esta flor üå∏', url:lastShareUrl}); }
      else{ await navigator.clipboard.writeText(lastShareUrl); toast('Enlace copiado'); }
    }
  }catch{}
  closeSheet();
});
mOpen.addEventListener('click', ()=>{
  try{ if(lastShareUrl) window.open(lastShareUrl,'_blank'); }catch{}
  closeSheet();
});

/* === √öltimas (sheet secundario) === */
openLatest.addEventListener('click', ()=>{ openLatestSheet(); });
latestSheet.addEventListener('click', e=>{ if(e.target===latestSheet) closeLatestSheet(); });
function openLatestSheet(){ latestSheet.classList.add('open'); latestSheet.setAttribute('aria-hidden','false'); lockBodyScroll(); }
function closeLatestSheet(){ latestSheet.classList.remove('open'); latestSheet.setAttribute('aria-hidden','true'); unlockBodyScroll(); }

prevPage.addEventListener('click', ()=>{ page=Math.max(0, page-1); renderLatest(); });
nextPage.addEventListener('click', ()=>{ const maxPage=Math.max(0, Math.ceil(latestItems.length/pageSize)-1); page=Math.min(maxPage, page+1); renderLatest(); });

function renderLatest(){
  const start=page*pageSize, slice=latestItems.slice(start,start+pageSize);
  if(!slice.length){ latestList.innerHTML='<div class="muted">A√∫n no hay flores recientes.</div>'; return; }
  latestList.innerHTML = slice.map(it=>{
    const escHtml=s=>String(s||'').replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;","&quot;":"&quot;","'":"&#39;",">":"&gt;"}[m]));
    const escAttrVal=s=>escAttr(String(s||''));
    const shareUrl = `${location.origin}${location.pathname}?lat=${it.lat}&lng=${it.lng}&from=${escAttrVal(it.fromName)}&to=${escAttrVal(it.toName)}&msg=${escAttrVal(it.message)}`;
    return `<div style="border:1px solid #e8e8e8; border-radius:12px; padding:10px; background:#fff; box-shadow:0 4px 12px rgba(0,0,0,.05); margin-bottom:8px">
      <div><strong>${escHtml(it.fromName||'‚Äî')}</strong> ‚Üí <strong>${escHtml(it.toName||'‚Äî')}</strong></div>
      <div class="muted" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escHtml(it.message||'')}</div>
      <div class="muted" style="font-size:.9rem">${relTime(it.timestamp)}</div>
      <div style="display:flex; gap:8px; margin-top:6px">
        <button class="btn btn-outline btn-xxs" onclick="viewFlower('${it.lat}','${it.lng}','${escAttrVal(it.fromName)}','${escAttrVal(it.toName)}','${escAttrVal(it.message)}','${escAttrVal(it.timestamp)}')">Ver</button>
        <button class="btn btn-outline btn-xxs" onclick="shareAny('${shareUrl}')">Compartir</button>
      </div>
    </div>`;
  }).join('');
}

/* Ayudas de compartir/ver para Latest */
window.shareAny = async function(url){
  try{
    if(navigator.share){ await navigator.share({title:'Flovermaps', text:'Mira esta flor üå∏', url}); }
    else{ await navigator.clipboard.writeText(url); toast('Enlace copiado'); }
  }catch{}
};
window.viewFlower = function(lat,lng,fromEnc,toEnc,msgEnc,tsEnc){
  const from=unescAttr(fromEnc), to=unescAttr(toEnc), msg=unescAttr(msgEnc);
  const dtStr = fmtDateTime(new Date(Number(tsEnc)||Date.parse(tsEnc)||Date.now()));
  const html = `<div>${dtStr} <strong>${from}</strong> para <strong>${to}</strong>: ${String(msg).replace(/[&<>"']/g,'')}</div>`;
  const mk=L.marker([+lat,+lng],{icon:emojiIcon(), zIndexOffset:1600}).addTo(map).bindPopup(html);
  try{ map.flyTo([+lat,+lng], 17, {duration:0.6}); }catch{ map.setView([+lat,+lng], 17); }
  mk.openPopup();
  setTimeout(()=>{ try{ map.removeLayer(mk); }catch{} }, 12000);
  closeLatestSheet();
};

/* === Lista y render de todas las flores === */
function normalizeItems(items){
  const out=[];
  for(const f of (items||[])){
    const lat = Number(f.lat ?? f.latitude ?? f.Latitude ?? f.LAT ?? f.latitud ?? f.y ?? f.Y ?? f.Lat);
    const lng = Number(f.lng ?? f.lon ?? f.long ?? f.longitude ?? f.Longitude ?? f.LON ?? f.longitud ?? f.x ?? f.X ?? f.Lng);
    if(!isFinite(lat)||!isFinite(lng)) continue;
    const id       = String(f.id ?? f.ID ?? f.Id ?? `${lat},${lng},${f.timestamp ?? ''}`);
    const fromName = f.fromName ?? f.from ?? f.de ?? f.sender ?? f.quien ?? '';
    const toName   = f.toName   ?? f.to   ?? f.para ?? f.recipient ?? f.destinatario ?? '';
    const message  = (f.message ?? f.msg  ?? f.text ?? f.mensaje ?? f.note ?? '');
    const place    = f.place    ?? f.address ?? f.direccion ?? f.location ?? '';
    const timestamp= f.timestamp?? f.ts ?? f.time ?? f.fecha ?? f.createdAt ?? f.created_at ?? '';
    out.push({ id, lat, lng, fromName, toName, message, place, timestamp });
  }
  return out;
}
function ensureFlowersLayer(wantCluster){
  if(useCluster===wantCluster && flowersLayer){ try{flowersLayer.clearLayers();}catch{} return; }
  if(flowersLayer){ try{ map.removeLayer(flowersLayer);}catch{} }
  flowersLayer = wantCluster
    ? L.markerClusterGroup({ showCoverageOnHover:false, spiderfyOnEveryZoom:false, disableClusteringAtZoom:16, maxClusterRadius:60 })
    : L.layerGroup();
  flowersLayer.addTo(map);
  useCluster=wantCluster;
}
function renderAllMarkers(list){
  if(!map) return;
  const wantCluster = list.length >= 10;
  ensureFlowersLayer(wantCluster);
  try{ flowersLayer.clearLayers(); }catch{}
  const bounds=L.latLngBounds();
  let i=0, n=list.length;
  (function chunk(){
    const t0=performance.now();
    const batch=[];
    while(i<n && (performance.now()-t0)<24){
      const f=list[i++]; const lat=f.lat, lng=f.lng;
      if(!isFinite(lat)||!isFinite(lng)) continue;
      const dtStr=f.timestamp?fmtDateTime(new Date(Number(f.timestamp)||Date.parse(f.timestamp)||Date.now())):"";
      const html=`<div>${dtStr} <strong>${(f.fromName||'')}</strong> para <strong>${(f.toName||'')}</strong>: ${String((f.message||'')).replace(/[&<>"']/g,'')}</div>`;
      const mk=L.marker([lat,lng],{icon:emojiIcon(), zIndexOffset:1200}).bindPopup(html);
      batch.push(mk); bounds.extend([lat,lng]);
    }
    if(batch.length){ if(useCluster) flowersLayer.addLayers(batch); else batch.forEach(m=>flowersLayer.addLayer(m)); }
    if(i<n){ requestAnimationFrame(chunk); }
    else{ try{ useCluster && flowersLayer.refreshClusters(); }catch{} if(list.length){ map.fitBounds(bounds.pad(0.15), {maxZoom:7}); } }
  })();
}

/* Incremental fetch */
async function refetch(incremental=false){
  try{
    const url = SCRIPT_URL + '?action=list' + (incremental && lastTs ? ('&since='+encodeURIComponent(lastTs)) : '');
    const data = await jsonp(url, 12000);
    if (data && Array.isArray(data.items)) {
      const norm = normalizeItems(data.items);
      if(incremental && window._lastItems){ window._lastItems = mergeUniqueById(window._lastItems, norm); }
      else { window._lastItems = norm; }
      latestItems = window._lastItems.slice().sort((a,b)=>(Number(b.timestamp)||0)-(Number(a.timestamp)||0));
      renderAllMarkers(window._lastItems);
      renderLatest();
      for (const it of data.items) { const t=Number(it.timestamp)||Date.parse(it.timestamp)||0; if(t>lastTs) lastTs=t; }
      try{ localStorage.setItem('flowers_cache', JSON.stringify(window._lastItems||[])); }catch{}
      return;
    }
  } catch(e){ /* usa cache si hay */ }
  const cached=localStorage.getItem('flowers_cache');
  if(cached){
    window._lastItems = JSON.parse(cached);
    latestItems = window._lastItems.slice().sort((a,b)=>(Number(b.timestamp)||0)-(Number(a.timestamp)||0));
    renderAllMarkers(window._lastItems);
    renderLatest();
  }
}
function mergeUniqueById(oldList, newList){
  const m=new Map(); for(const it of (oldList||[])) m.set(it.id,it); for(const it of (newList||[])) m.set(it.id,it);
  return Array.from(m.values());
}

/* SPLASH control (solo primera vez) */
function maybeShowSplash(){
  const u=new URL(location.href);
  const hasDeep = u.searchParams.has('lat') && u.searchParams.has('lng');
  const seen = localStorage.getItem('hasSeenSplash')==='1';
  if(hasDeep) return; // si viene con flor ‚Üí no mostrar
  if(!seen){
    splash.style.display='flex';
    lockBodyScroll();
    const close=()=>{ splash.style.display='none'; unlockBodyScroll(); localStorage.setItem('hasSeenSplash','1'); };
    splash.addEventListener('click', close, {once:true});
    skipSplash.addEventListener('click', (e)=>{ e.stopPropagation(); close(); }, {once:true});
    setTimeout(close, 5000); // auto a los 5s
  }
}

/* Deep link: abrir flor compartida con ?lat&lng&from&to&msg */
function tryOpenShared(){
  const u=new URL(location.href);
  const lat=u.searchParams.get('lat'), lng=u.searchParams.get('lng');
  const from=u.searchParams.get('from')||'', to=u.searchParams.get('to')||'', msg=u.searchParams.get('msg')||'';
  if(lat && lng){
    setSelectedPoint(+lat,+lng,true);
    const html = `<div>${fmtDateTime(new Date())} <strong>${unescAttr(from)}</strong> para <strong>${unescAttr(to)}</strong>: ${unescAttr(msg)}</div>`;
    const mk=L.marker([+lat,+lng],{icon:emojiIcon(), zIndexOffset:1600}).addTo(map).bindPopup(html);
    mk.openPopup();
  }
}

/* Logo ‚Üí refrescar */
$("#logoBtn").addEventListener('click', ()=>{ location.reload(); });

/* Inicio */
document.addEventListener('DOMContentLoaded', ()=>{
  // UI b√°sica
  initMap();
  refetch(false);
  setInterval(()=>refetch(true), 15000);

  // accesibilidad: cerrar lista de sugerencias con Escape
  document.addEventListener('keydown', e=>{
    if(e.key==='Escape'){ slist.style.display='none'; }
  });

  // deep link si llega
  tryOpenShared();

  // Splash primera vez
  maybeShowSplash();
});
</script>
</body>
</html>
