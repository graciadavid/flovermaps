<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Flovermaps</title>

<!-- Favicon y meta -->\n<link rel="icon" href="https://drive.google.com/uc?export=view&id=1M6rOGfSV-YotIBXnYT_KCiXKSLmL5SzW" type="image/png">
<meta name="theme-color" content="#ffffff" />
<meta name="description" content="Planta flores en el mapa y dedica mensajes bonitos." />

<!-- Tipograf√≠a y Leaflet CSS -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- Leaflet JS primario + fallbacks -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" id="leaflet-cdn"></script>
<script>
  (function ensureLeaflet(){
    if(window.L) return; // unpkg ok
    var a=document.createElement('script');
    a.src='https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js';
    a.onload=function(){ console.log('Leaflet desde cdnjs'); };
    a.onerror=function(){
      var b=document.createElement('script');
      b.src='https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js';
      b.onload=function(){ console.log('Leaflet desde jsDelivr'); };
      document.head.appendChild(b);
    };
    document.head.appendChild(a);
  })();
</script>

<style>
  :root{--ink:#111;--muted:#666; --pink:#ffe6f0; --green:#22c55e}
  *{box-sizing:border-box}
  body{margin:0;font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--pink);color:var(--ink)}

  /* Header simple y robusto (solo logo local) */
  .site-header{position:sticky; top:0; z-index:10000; display:flex; align-items:center; justify-content:center; gap:10px; padding:16px 18px; background:#fff; border-bottom:1px solid #eee; min-height:88px}
  .logo-img{display:block; height:64px; width:auto; max-width:100%; object-fit:contain}
  @media (min-width:900px){ .logo-img{height:96px} }
  .logo-fallback{font-weight:800;letter-spacing:1px; display:none}

  /* Contador mejorado */
  .counter{margin:8px 12px 0; padding:10px 12px; border-radius:14px; background:#fff; border:1px solid #eee; display:flex; align-items:center; justify-content:space-between; gap:12px; position:relative}
  .count-main{display:flex; align-items:baseline; gap:8px}
  .count-num{font-weight:800; font-size:1.2rem}
  .count-label{color:var(--muted); font-size:.9rem}
  .live{display:flex; align-items:center; gap:10px}
  .dot{width:10px;height:10px;border-radius:50%;background:#bbb; position:relative}
  .dot.active{background:#12b886}
  .dot.active::after{content:""; position:absolute; inset:-6px; border:2px solid rgba(18,184,134,.5); border-radius:50%; animation:pulse 1.6s infinite}
  @keyframes pulse{0%{transform:scale(.6);opacity:.9}70%{transform:scale(1.2);opacity:.2}100%{transform:scale(1.4);opacity:0}}
  .chip{background:#f1fff7; color:#0a7d25; border:1px solid #bff0cc; padding:4px 8px; border-radius:999px; font-size:.82rem; white-space:nowrap}
  .ticker{flex:1; min-width:0; color:#555; font-size:.85rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
  .spark{position:absolute; right:12px; top:-8px; font-size:16px; opacity:0; transform:translateY(-6px); pointer-events:none}
  .spark.show{animation:sparkle .9s ease}
  @keyframes sparkle{0%{opacity:0; transform:translateY(-6px) rotate(-10deg)}30%{opacity:1; transform:translateY(0) rotate(0)}100%{opacity:0; transform:translateY(-10px) rotate(10deg)}}

  /* Layout */
  .wrap{display:flex; gap:0; min-height:calc(100vh - 52px - 56px)}
  .panel{width:420px; max-width:100%; padding:12px; border-right:1px solid #eee; overflow:auto; background:var(--pink)}
  .card{border:1px solid #e8e8e8; border-radius:12px; padding:12px; background:#fff}
  h1{font-size:1.25rem; margin:0 0 8px}
  label{display:block; margin:6px 0 4px; font-size:.92rem}
  input,textarea,button{width:100%; padding:10px; border:1px solid #ddd; border-radius:10px; font-size:.95rem}
  textarea{min-height:56px; resize:vertical}
  .muted{color:var(--muted); font-size:.85rem}
  .row2{display:grid; grid-template-columns:1fr 1fr; gap:8px}

  /* Acciones: en m√≥vil columna; en desktop fila */
  .actions{display:flex; gap:8px; flex-direction:column; margin-top:8px}
  @media (min-width:900px){ .actions{flex-direction:row; align-items:center} }
  .btn{border:0; border-radius:10px; cursor:pointer}
  .btn-dark{background:#444;color:#fff}
  .btn-green{background:var(--green); color:#fff}
  .badge{display:none; color:#0a7d25; font-size:.85rem; margin-top:6px}

  /* Autocomplete */
  .sbox{position:relative}
  .slist{position:absolute; left:0; right:0; top:100%; margin-top:4px; background:#fff; border:1px solid #e6e6e6; border-radius:10px; max-height:260px; overflow:auto; display:none; z-index:20}
  .sitem{padding:8px 10px; border-bottom:1px solid #f3f3f3; cursor:pointer; font-size:.95rem}
  .sitem:last-child{border-bottom:0}
  .sitem small{color:#777}
  .hl{font-weight:700}

  /* Mapa */
  .mapArea{flex:1; padding:10px 12px; background:var(--pink)}
  .frame{position:relative; border:1px solid #e8e8e8; border-radius:12px; overflow:hidden; background:#fff}
  #map{width:100%; height:520px}
  @media (max-width:1024px){ #map{height:50vh} .wrap{flex-direction:column;} .panel{width:100%; border-right:0;} }

  /* Pins */
  .leaflet-marker-icon[src*="marker-icon"], .leaflet-marker-shadow{display:none!important}
/* Pins (emoji) */
.emoji-marker{background:transparent; border:none; display:flex; align-items:center; justify-content:center; transform:translate(-14px,-28px)}
.emoji-marker .e{font-size:30px; line-height:30px; text-shadow: 0 1px 0 #fff, 0 -1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff, 0 0 4px rgba(0,0,0,.25)}
@media (min-width:900px){ .emoji-marker .e{font-size:34px; line-height:34px} }
.emoji-marker.is-selected .e{transform:translateY(-1px) scale(1.05)}

  /* Toast */
  .toast{position:fixed; left:50%; bottom:82px; transform:translateX(-50%); background:#111; color:#fff; padding:10px 12px; border-radius:10px; z-index:11000; opacity:0; pointer-events:none; transition:opacity .18s, bottom .18s}
  .toast.show{opacity:1; bottom:92px}
</style>
</head>
<body>

<!-- Header con logo (solo local para m√°xima fiabilidad) -->
<header class="site-header">
  <img src="logo.png" alt="FLOVERMAPS" class="logo-img" onerror="this.style.display='none'; document.getElementById('logoFallback').style.display='inline-block'" />
  <span id="logoFallback" class="logo-fallback">FLOVERMAPS</span>
</header>

<!-- Contador mejorado -->
<div class="counter" id="counter">
  <div class="count-main">
    <div class="count-num" id="countNum">0</div>
    <div class="count-label">flores plantadas</div>
  </div>
  <div class="ticker" id="ticker">‚Äî</div>
  <div class="live">
    <div class="dot" id="liveDot" title="Actividad en vivo"></div>
    <div class="chip" id="liveChip">√öltimos 5 min: 0</div>
  </div>
  <div class="spark" id="spark">‚ú®</div>
</div>

<div class="wrap">
  <!-- FORMULARIO -->
  <section class="panel" id="panel">
    <div class="card">
      <h1>Planta una flor</h1>

      <div class="row2">
        <div><label for="fromName">¬øQui√©n la env√≠a?</label><input id="fromName" placeholder="Tu nombre" /></div>
        <div><label for="toName">¬øPara qui√©n?</label><input id="toName" placeholder="Nombre del destinatario" /></div>
      </div>

      <label for="message" style="margin-top:8px">Mensaje <span class="muted" id="chars">(0/90)</span></label>
      <textarea id="message" maxlength="90" placeholder="Escribe algo bonito‚Ä¶"></textarea>

      <label for="place" style="margin-top:8px">Ubicaci√≥n</label>
      <div class="sbox">
        <input id="place" placeholder="Ej. Puerta del Sol, Madrid" autocomplete="off" />
        <div id="slist" class="slist"></div>
      </div>
      <div class="muted" id="help">Escribe y elige una sugerencia, o haz clic en el mapa.</div>
      <div class="badge" id="fixed">‚úÖ Ubicaci√≥n fijada</div>

      <div class="actions">
        <button id="confirmBtn" type="button" class="btn btn-dark">‚úÖ Confirmar direcci√≥n</button>
        <button id="gpsBtn" type="button" class="btn btn-dark" style="display:none">üìç Usar mi ubicaci√≥n</button>
        <button id="plantBtn" class="btn btn-green" style="display:none">üå± Plantar aqu√≠</button>
      </div>

      <input type="hidden" id="lat"><input type="hidden" id="lng">
    </div>
  </section>

  <!-- MAPA -->
  <section class="mapArea">
    <div class="frame"><div id="map"></div></div>
    <div class="below" style="display:flex;justify-content:center;padding:10px 0"><button id="shareBtn" class="btn btn-dark" style="display:none">üîó Compartir</button></div>
  </section>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* === CONFIG === */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxKcq4xqM1PB_wfIXibeotizuxw0-UgrPJ0LN70U-bva2Isk8EMwdsWeOk8l2w1DvFmJQ/exec";

/* === STATE === */
const seen = new Set();
let editMarker = null; // √∫nica
let usedGPS = false, usedMapClick = false;
let map, baseTiles, fallbackTiles, tileFallbackUsed=false;
let lastFetchTime = 0;
let allFlowers = []; // cache de items para actividad

/* === DOM helpers === */
const $ = s => document.querySelector(s);
const slist = $("#slist"), place = $("#place");
const plantBtn = $("#plantBtn"), shareBtn = $("#shareBtn"), fixedBadge = $("#fixed");
const countNum = $("#countNum"), liveDot = $("#liveDot"), liveChip = $("#liveChip"), ticker = $("#ticker"), spark = $("#spark");

/* === Utils === */
function toast(msg, ok=true){ const t=$("#toast"); t.textContent=msg; t.style.background=ok?"#111":"#b30000"; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),1600); }
function esc(s){ return String(s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
function popupHtml(from,to,msg,dateStr){ return `De ${esc(from)}<br>Para ${esc(to)}<br>üå∏ ${esc(msg)}${dateStr?`<br><small>üìÖ ${dateStr}</small>`:""}`; }
function fmtDate(d){ return `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}/${d.getFullYear()}`; }
function animateNumber(el, to){
  const from = Number(el.textContent.replace(/\D/g,'')) || 0;
  const start = performance.now();
  const dur = 400;
  function step(t){
    const k = Math.min(1, (t-start)/dur);
    el.textContent = Math.round(from+(to-from)*k);
    if(k<1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}
function showSpark(){ spark.classList.remove('show'); void spark.offsetWidth; spark.classList.add('show'); }

/* === Icono UX === */
function emojiIcon(){
  const html = '<span class="e" role="img" aria-label="flor">üå∏</span>';
  return L.divIcon({className:'emoji-marker', html, iconSize:[28,28], iconAnchor:[14,28], popupAnchor:[0,-30]});
});
}

/* === MAPA (robusto) === */
function initMap(){
  if(!window.L){ toast('Mapa no disponible (Leaflet no carg√≥)', false); return; }
  if(map){ return; }
  baseTiles = L.tileLayer('https://basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',{attribution:'¬© OpenStreetMap ¬© CARTO',maxZoom:19});
  baseTiles.on('tileerror', ()=>{
    if(!tileFallbackUsed){
      tileFallbackUsed=true;
      try{ map && map.removeLayer(baseTiles); }catch(e){}
      fallbackTiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap contributors', maxZoom:19});
      fallbackTiles.addTo(map);
      toast('Usando mapa alternativo OSM', true);
    }
  });
  map = L.map('map',{layers:[baseTiles],zoomControl:true});
  map.setView([40.41694, -3.70361], 13); // Puerta del Sol, Madrid
  setTimeout(()=>map.invalidateSize(), 150);
  addEventListener('resize', ()=> setTimeout(()=>map.invalidateSize(), 120));

  map.on('popupopen', e=>{ const mk=e.popup && e.popup._source; if(mk && mk._icon) mk._icon.classList.add('is-selected'); });
  map.on('popupclose', e=>{ const mk=e.popup && e.popup._source; if(mk && mk._icon) mk._icon.classList.remove('is-selected'); });
}

function setEditPoint(lat,lng,zoom=18,showHint=false){
  $("#lat").value=lat; $("#lng").value=lng; plantBtn.style.display="inline-block";
  if(editMarker){ editMarker.setLatLng([lat,lng]); }
  else{
    editMarker = L.marker([lat,lng],{icon:emojiIcon(),draggable:true}).addTo(map);
    if(showHint){ editMarker.bindTooltip('Arrastra para ajustar',{permanent:true, direction:'top', offset:[0,-24]}).openTooltip(); }
    editMarker.on('dragend', e=>{
      const p=e.target.getLatLng(); $("#lat").value=p.lat.toFixed(6); $("#lng").value=p.lng.toFixed(6); fixedBadge.style.display='inline';
    });
  }
  map.setView([lat,lng], zoom);
}

/* === SUGERENCIAS === */
let suggestTimer=null, abortCtrl=null, currentSuggest=[];
function hasNumber(s){ return /[0-9]/.test(s); }
function extractNumber(s){ const m=s.match(/([0-9]{1,5})/); return m? m[1]:null; }
function normalizeStreet(q){
  const hasType = /(carrer|calle|avinguda|av\.|avenida|paseo|ps\.|pla√ßa|plaza)/i.test(q);
  if(hasType) return [q];
  const base=q.replace(/\s+/g,' ').trim();
  return ['Calle '+base,'Carrer de '+base,'Avinguda '+base,base];
}
async function searchPlacesPlain(q, signal){
  const url='https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=7&countrycodes=es&q='+encodeURIComponent(q);
  const r=await fetch(url,{signal, headers:{'Accept':'application/json'}}); if(!r.ok) throw new Error('nominatim'); return r.json();
}
async function searchPlacesStructured(q, signal){
  let raw=q, city='';
  if(q.includes(',')){ const parts=q.split(','); raw=parts[0].trim(); city=parts.slice(1).join(',').trim(); }
  const variants = normalizeStreet(raw);
  const all=[];
  for(const street of variants){
    const url='https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=7&countrycodes=es&street='+encodeURIComponent(street)+'&city='+encodeURIComponent(city);
    const r=await fetch(url,{signal, headers:{'Accept':'application/json'}}).catch(()=>null);
    if(r && r.ok){ all.push(...(await r.json())); }
  }
  return all;
}
async function searchPhoton(q, signal){
  const url='https://photon.komoot.io/api/?lang=es&limit=7&q='+encodeURIComponent(q);
  const r=await fetch(url,{signal, headers:{'Accept':'application/json'}}).catch(()=>null);
  if(!r || !r.ok) return [];
  const j=await r.json();
  return (j.features||[]).map(f=>({
    place_id: 'ph'+(f.properties.osm_id||Math.random()),
    lat: f.geometry.coordinates[1],
    lon: f.geometry.coordinates[0],
    display_name: f.properties.name+', '+(f.properties.city||f.properties.town||f.properties.village||'')+', '+(f.properties.state||''),
    address: {
      road: f.properties.street || f.properties.name,
      house_number: f.properties.housenumber,
      city: f.properties.city||f.properties.town||f.properties.village,
      state: f.properties.state
    }
  }));
}
async function searchPlaces(q){
  if(abortCtrl) abortCtrl.abort();
  abortCtrl = new AbortController();
  const sig=abortCtrl.signal;
  try{
    const hasNum = hasNumber(q);
    const A = await searchPlacesPlain(q, sig).catch(()=>[]);
    const B = hasNum ? await searchPlacesStructured(q, sig).catch(()=>[]) : [];
    const C = hasNum ? await searchPhoton(q, sig).catch(()=>[]) : [];
    const list=[...A, ...B, ...C];
    const seenIds=new Set();
    const merged=[]; for(const it of list){ const id=(it.place_id||it.lat+'|'+it.lon); if(!seenIds.has(id)){ seenIds.add(id); merged.push(it); } }
    if(hasNum){
      const num=extractNumber(q);
      merged.sort((x,y)=>{
        const xn=(x.address&&x.address.house_number)||''; const yn=(y.address&&y.address.house_number)||'';
        const xs=(String(xn)===String(num))?1:0; const ys=(String(yn)===String(num))?1:0;
        return ys-xs;
      });
    }
    return merged.slice(0,10);
  } catch(e){ return []; }
}
function renderSuggest(list){
  const q=place.value.trim(); const num=extractNumber(q);
  slist.innerHTML=""; list.forEach((it,idx)=>{
    const row=document.createElement('div'); row.className='sitem';
    const road = it.address?.road || it.address?.pedestrian || it.address?.footway || it.address?.residential || it.address?.path || it.address?.neighbourhood || '';
    const hn = it.address?.house_number || '';
    let primary = (road||hn) ? (road + (hn? ' '+hn: '')) : (it.display_name||'').split(',')[0];
    const city = it.address?.city || it.address?.town || it.address?.village || it.address?.municipality || '';
    const state = it.address?.state || it.address?.province || it.address?.state_district || '';
    const meta = [city, state].filter(Boolean).join(', ');
    if(num){ primary = primary.replace(new RegExp('('+num+')'),' <span class="hl">$1</span> '); }
    row.innerHTML = primary + (meta? ' <small>'+meta+'</small>': '');
    row.onclick=()=>selectSuggest(idx);
    slist.appendChild(row);
  });
  slist.style.display = list.length ? 'block' : 'none';
}
async function selectSuggest(idx){
  const it=currentSuggest[idx]; if(!it) return;
  place.value = it.display_name; slist.style.display='none';
  usedGPS=false; usedMapClick=false;
  const lat = Number(it.lat).toFixed(6), lng = Number(it.lon).toFixed(6);
  setEditPoint(lat,lng,18,true);
  fixedBadge.style.display='inline';
}
place.addEventListener('input', e=>{
  fixedBadge.style.display='none';
  const q=e.target.value.trim();
  clearTimeout(suggestTimer);
  if(!q){ slist.style.display='none'; return; }
  suggestTimer=setTimeout(async()=>{
    try{ currentSuggest = await searchPlaces(q); renderSuggest(currentSuggest); }
    catch{}
  }, 250);
});
addEventListener('click', e=>{ const box=document.querySelector('.sbox'); if(box && !box.contains(e.target)) slist.style.display='none'; });

/* === CONFIRMAR / GPS === */
$("#confirmBtn").onclick = async ()=>{
  const q=place.value.trim(); if(!q){ toast('Escribe una direcci√≥n', false); return; }
  try{
    const r=await searchPlaces(q);
    if(r.length){ const f=r[0]; setEditPoint(Number(f.lat).toFixed(6), Number(f.lon).toFixed(6), 18, true); fixedBadge.style.display='inline'; }
    else toast('No encontrada', false);
  }catch{ toast('Error buscando direcci√≥n', false); }
};
const gpsBtn = $("#gpsBtn");
if('geolocation' in navigator){
  if(navigator.permissions && navigator.permissions.query){
    navigator.permissions.query({name:'geolocation'}).then(st=>{ if(st.state !== 'denied'){ gpsBtn.style.display='inline-block'; } st.onchange = ()=>{ gpsBtn.style.display = (st.state !== 'denied') ? 'inline-block' : 'none'; }; }).catch(()=>{ gpsBtn.style.display='inline-block'; });
  } else { gpsBtn.style.display='inline-block'; }
}
gpsBtn.onclick = ()=> navigator.geolocation && navigator.geolocation.getCurrentPosition(pos=>{
  const lat=pos.coords.latitude.toFixed(6), lng=pos.coords.longitude.toFixed(6);
  usedGPS=true; usedMapClick=false; setEditPoint(lat,lng,18,true); fixedBadge.style.display='inline';
}, ()=>{ toast('Ubicaci√≥n no disponible (activa permisos)', false); gpsBtn.remove(); });

/* === PLANTAR === */
$("#message").addEventListener('input', ()=>{
  const m=$("#message"); if(m.value.length>90) m.value=m.value.slice(0,90);
  $("#chars").textContent='('+m.value.length+'/90)';
});
async function saveFlower(){
  const from=$("#fromName").value.trim(), to=$("#toName").value.trim(), msg=$("#message").value.trim();
  const lat=$("#lat").value.trim(), lng=$("#lng").value.trim();
  let placeText = place.value.trim();
  if(!from||!to||!msg||!lat||!lng){ toast('Completa los campos y fija ubicaci√≥n', false); return; }
  if(!placeText && usedGPS) placeText='Mi ubicaci√≥n';
  if(!placeText && usedMapClick) placeText='Punto del mapa';

  plantBtn.disabled=true; plantBtn.textContent='Plantando‚Ä¶';
  try{
    const body=new URLSearchParams({fromName:from,toName:to,message:msg,place:placeText,lat,lng}).toString();
    const res=await fetch(SCRIPT_URL,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},body});
    const data=await res.json();
    if(data.ok){
      if(editMarker){ map.removeLayer(editMarker); editMarker=null; }
      const html = popupHtml(from,to,msg,fmtDate(new Date()));
      const m=L.marker([+lat,+lng],{icon:emojiIcon()}).addTo(map).bindPopup(html);
      m.on('click',()=>{ map.setView(m.getLatLng(),19); m.openPopup(); });
      map.setView([+lat,+lng],19); m.openPopup();
      const key=`${lat},${lng}|${from}|${to}|${msg}|${Date.now()}`;
      seen.add(key); allFlowers.push({lat:+lat,lng:+lng,fromName:from,toName:to,message:msg,timestamp:Date.now()});
      updateCounterUI();
      toast('Flor plantada üå∏');
      const shareUrl=`${location.origin}${location.pathname}?lat=${lat}&lng=${lng}&from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&msg=${encodeURIComponent(msg)}`;
      shareBtn.style.display='inline-block';
      shareBtn.onclick=async()=>{
        try{ if(navigator.share){ await navigator.share({title:'Flovermaps',text:`Una flor para ${to}`,url:shareUrl}); } else { await navigator.clipboard.writeText(shareUrl); shareBtn.textContent='‚úÖ Copiado'; setTimeout(()=>shareBtn.textContent='üîó Compartir',1200); } }catch{}
      };
      plantBtn.style.display='none'; plantBtn.disabled=false; plantBtn.textContent='üå± Plantar aqu√≠';
      fixedBadge.style.display='none'; $("#lat").value=''; $("#lng").value='';
    }else{ toast('No se pudo guardar', false); plantBtn.disabled=false; plantBtn.textContent='üå± Plantar aqu√≠'; }
  }catch{ toast('Error de red', false); plantBtn.disabled=false; plantBtn.textContent='üå± Plantar aqu√≠'; }
}
plantBtn.onclick = saveFlower;

/* === Cargar flores existentes + actividad === */
async function loadFlowersOnce(){
  try{
    const r=await fetch(SCRIPT_URL, {headers:{'Accept':'application/json','Cache-Control':'no-cache'}}); const data=await r.json();
    const items=(data.items||[]);
    items.forEach(f=>{
      if(!f.lat||!f.lng) return;
      const key=`${+f.lat},${+f.lng}|${f.fromName||''}|${f.toName||''}|${f.message||''}|${f.timestamp||''}`;
      if(seen.has(key)) return; seen.add(key);
      const dateStr = f.timestamp ? new Date(f.timestamp).toLocaleDateString('es-ES') : '';
      const m=L.marker([+f.lat,+f.lng],{icon:emojiIcon()}).addTo(map).bindPopup(popupHtml(f.fromName||'', f.toName||'', f.message||'', dateStr));
      m.on('click',()=>{map.setView(m.getLatLng(),19); m.openPopup();});
    });
    allFlowers = items.map(f=>({lat:+f.lat,lng:+f.lng,fromName:f.fromName||'',toName:f.toName||'',message:f.message||'',timestamp: f.timestamp ? +new Date(f.timestamp) : Date.now()}));
    updateCounterUI(true);
    lastFetchTime = Date.now();
  }catch{}
}

function updateCounterUI(initial=false){
  const total = seen.size; animateNumber(countNum, total);
  // actividad √∫ltimos 5 minutos
  const now = Date.now();
  const recent = allFlowers.filter(f=> now - f.timestamp <= 5*60*1000 );
  liveChip.textContent = `√öltimos 5 min: ${recent.length}`;
  liveDot.classList.toggle('active', recent.length>0);
  // ticker: √∫ltimos 3 nombres
  const sorted = [...allFlowers].sort((a,b)=>b.timestamp-a.timestamp).slice(0,3);
  const txt = sorted.length? sorted.map(f=> `${esc(f.fromName||'Alguien')} ‚Üí ${esc(f.toName||'alguien')}`).join('  ‚Ä¢  ') : '‚Äî';
  ticker.textContent = txt;
  if(!initial){ showSpark(); }
}

// Polling suave para actividad
async function poll(){
  try{
    const r=await fetch(SCRIPT_URL, {headers:{'Accept':'application/json','Cache-Control':'no-cache'}}); const data=await r.json();
    const items=(data.items||[]);
    let newOnes=0;
    items.forEach(f=>{
      if(!f.lat||!f.lng) return;
      const key=`${+f.lat},${+f.lng}|${f.fromName||''}|${f.toName||''}|${f.message||''}|${f.timestamp||''}`;
      if(seen.has(key)) return;
      seen.add(key); newOnes++;
      const dateStr = f.timestamp ? new Date(f.timestamp).toLocaleDateString('es-ES') : '';
      const m=L.marker([+f.lat,+f.lng],{icon:emojiIcon()}).addTo(map).bindPopup(popupHtml(f.fromName||'', f.toName||'', f.message||'', dateStr));
      m.on('click',()=>{map.setView(m.getLatLng(),19); m.openPopup();});
    });
    // actualiza cache de actividad
    allFlowers = items.map(f=>({lat:+f.lat,lng:+f.lng,fromName:f.fromName||'',toName:f.toName||'',message:f.message||'',timestamp: f.timestamp ? +new Date(f.timestamp) : Date.now()}));
    if(newOnes>0){ updateCounterUI(); }
  }catch{}
}

/* === Arranque === */
document.addEventListener('DOMContentLoaded', ()=>{
  $("#chars").textContent='(0/90)';
  (function waitLeaflet(attempts=12){ if(window.L){ initMap(); loadFlowersOnce(); setInterval(poll, 15000); } else { if(attempts<=0){ toast('No se pudo inicializar el mapa', false); return; } setTimeout(()=>waitLeaflet(attempts-1), 250); } })();

  // clicks mapa para fijar punto
  document.addEventListener('click', e=>{ const box=document.querySelector('.sbox'); if(box && !box.contains(e.target)) slist.style.display='none'; });

  // click en mapa
  if(window.L){
    // se define en initMap el setEditPoint
    const mapEl=document.getElementById('map');
    if(!mapEl) toast('No se encontr√≥ el contenedor del mapa', false);
  }
});
</script>
</body>
</html>
